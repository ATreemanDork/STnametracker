(()=>{"use strict";var e={56(e,n,t){e.exports=function(e){var n=t.nc;n&&e.setAttribute("nonce",n)}},72(e){var n=[];function t(e){for(var t=-1,r=0;r<n.length;r++)if(n[r].identifier===e){t=r;break}return t}function r(e,r){for(var o={},i=[],s=0;s<e.length;s++){var c=e[s],l=r.base?c[0]+r.base:c[0],d=o[l]||0,m="".concat(l," ").concat(d);o[l]=d+1;var g=t(m),u={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==g)n[g].references++,n[g].updater(u);else{var h=a(u,r);r.byIndex=s,n.splice(s,0,{identifier:m,updater:h,references:1})}i.push(m)}return i}function a(e,n){var t=n.domAPI(n);t.update(e);return function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap&&n.supports===e.supports&&n.layer===e.layer)return;t.update(e=n)}else t.remove()}}e.exports=function(e,a){var o=r(e=e||[],a=a||{});return function(e){e=e||[];for(var i=0;i<o.length;i++){var s=t(o[i]);n[s].references--}for(var c=r(e,a),l=0;l<o.length;l++){var d=t(o[l]);0===n[d].references&&(n[d].updater(),n.splice(d,1))}o=c}}},83(e,n,t){t.d(n,{A:()=>s});var r=t(354),a=t.n(r),o=t(314),i=t.n(o)()(a());i.push([e.id,"/* Styles for the Name Tracker extension */\n\n.name-tracker-settings {\n    padding: 5px;\n}\n\n.name-tracker_block {\n    margin-bottom: 10px;\n}\n\n.name-tracker_block h4 {\n    margin-top: 10px;\n    margin-bottom: 10px;\n    font-weight: bold;\n}\n\n/* Status Display */\n.name-tracker-status-block {\n    background-color: var(--SmartThemeBlurTintColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    padding: 10px;\n}\n\n.name-tracker-status {\n    font-weight: bold;\n    color: var(--SmartThemeBodyColor);\n    padding: 5px;\n    text-align: center;\n}\n\n/* Character List */\n.name-tracker-character-list {\n    max-height: 400px;\n    overflow-y: auto;\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    padding: 5px;\n    margin-top: 5px;\n}\n\n.name-tracker-character {\n    padding: 10px;\n    margin-bottom: 10px;\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    background-color: var(--SmartThemeBlurTintColor);\n}\n\n.name-tracker-character:last-child {\n    margin-bottom: 0;\n}\n\n/* Active/loaded character styling (characters that are loaded in SillyTavern) */\n.name-tracker-character.main-character {\n    border-left: 3px solid #4CAF50;\n    background-color: rgba(76, 175, 80, 0.05);\n}\n\n.character-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 5px;\n}\n\n.character-name {\n    font-weight: bold;\n    font-size: 1.1em;\n    color: var(--SmartThemeBodyColor);\n}\n\n.character-name .fa-user {\n    color: #4CAF50;\n    margin-right: 5px;\n}\n\n.character-name.ignored {\n    color: var(--SmartThemeQuoteColor);\n    text-decoration: line-through;\n}\n\n.character-badge {\n    display: inline-block;\n    padding: 2px 8px;\n    border-radius: 3px;\n    font-size: 0.75em;\n    font-weight: bold;\n    margin-left: 5px;\n}\n\n.character-badge.main-char {\n    background-color: #4CAF50;\n    color: #fff;\n}\n\n.character-badge.ignored {\n    background-color: #666;\n    color: #fff;\n}\n\n.character-badge.unresolved {\n    background-color: #ff9800;\n    color: #000;\n}\n\n/* Lorebook entry editor modal */\n.lorebook-entry-editor h3 {\n    margin-top: 0;\n    margin-bottom: 20px;\n    color: var(--SmartThemeBodyColor);\n}\n\n.editor-section {\n    margin-bottom: 15px;\n}\n\n.editor-section label {\n    display: block;\n    font-weight: bold;\n    margin-bottom: 5px;\n    color: var(--SmartThemeBodyColor);\n}\n\n.editor-section small {\n    display: block;\n    margin-top: 3px;\n    color: var(--SmartThemeQuoteColor);\n    font-size: 0.85em;\n}\n\n.editor-section input,\n.editor-section textarea {\n    width: 100%;\n    box-sizing: border-box;\n}\n\n.character-aliases {\n    font-size: 0.9em;\n    color: var(--SmartThemeQuoteColor);\n    margin-bottom: 8px;\n    font-style: italic;\n}\n\n.lorebook-entry-id {\n    display: inline-block;\n    margin-left: 10px;\n    padding: 2px 6px;\n    background: var(--SmartThemeBlurTintColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 3px;\n    font-family: monospace;\n    font-size: 0.85em;\n    font-style: normal;\n    color: var(--SmartThemeQuoteColor);\n}\n\n.character-details {\n    font-size: 0.85em;\n    color: var(--SmartThemeBodyColor);\n    margin: 8px 0;\n    padding: 8px;\n    background: var(--SmartThemeBlurTintColor);\n    border-left: 2px solid var(--SmartThemeBorderColor);\n    border-radius: 3px;\n    line-height: 1.4;\n}\n\n.character-actions {\n    display: flex;\n    gap: 5px;\n    flex-wrap: wrap;\n    margin-top: 8px;\n}\n\n.character-actions .menu_button {\n    flex: 1;\n    min-width: 100px;\n    padding: 5px 10px;\n    font-size: 0.9em;\n}\n\n.menu_button.compact {\n    padding: 5px 10px;\n    font-size: 0.9em;\n}\n\n.name-tracker-empty {\n    color: var(--SmartThemeQuoteColor);\n    font-style: italic;\n    text-align: center;\n    padding: 20px;\n}\n\n/* Ollama Settings */\n.ollama-settings {\n    background-color: var(--SmartThemeBlurTintColor);\n    border-left: 3px solid var(--SmartThemeBorderColor);\n    padding: 10px;\n    margin-top: 5px;\n    border-radius: 5px;\n}\n\n/* Merge Dialog */\n.merge-dialog {\n    padding: 15px;\n}\n\n.merge-dialog p {\n    margin-bottom: 10px;\n}\n\n.merge-dialog strong {\n    color: var(--SmartThemeBodyColor);\n    font-weight: bold;\n}\n\n.merge-warning {\n    color: #ff9800;\n    font-size: 0.9em;\n    margin-top: 10px;\n    padding: 10px;\n    background-color: rgba(255, 152, 0, 0.1);\n    border-left: 3px solid #ff9800;\n    border-radius: 3px;\n}\n\n/* Button states */\nbutton:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n}\n\n/* Flex utilities */\n.flexGap5 {\n    gap: 5px;\n}\n\n.flex1 {\n    flex: 1;\n}\n\n/* Progress indicator */\n.name-tracker-progress {\n    margin: 10px 0;\n    padding: 10px;\n    background-color: var(--SmartThemeBlurTintColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    text-align: center;\n}\n\n.name-tracker-progress .progress-text {\n    margin-bottom: 5px;\n    font-weight: bold;\n}\n\n.name-tracker-progress .progress-bar {\n    width: 100%;\n    height: 20px;\n    background-color: var(--black50a);\n    border-radius: 10px;\n    overflow: hidden;\n}\n\n.name-tracker-progress .progress-fill {\n    height: 100%;\n    background-color: var(--SmartThemeQuoteColor);\n    transition: width 0.3s ease;\n}\n\n/* Character details preview (for potential future use) */\n.character-details {\n    display: none;\n    margin-top: 10px;\n    padding: 10px;\n    background-color: var(--black30a);\n    border-radius: 5px;\n    font-size: 0.9em;\n}\n\n.character-details.expanded {\n    display: block;\n}\n\n.character-details-section {\n    margin-bottom: 8px;\n}\n\n.character-details-section:last-child {\n    margin-bottom: 0;\n}\n\n.character-details-label {\n    font-weight: bold;\n    color: var(--SmartThemeQuoteColor);\n    margin-right: 5px;\n}\n\n/* Responsive adjustments */\n@media (max-width: 768px) {\n    .character-actions {\n        flex-direction: column;\n    }\n    \n    .character-actions .menu_button {\n        width: 100%;\n    }\n}\n\n/* Animation for new characters */\n@keyframes fadeIn {\n    from {\n        opacity: 0;\n        transform: translateY(-10px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.name-tracker-character.new {\n    animation: fadeIn 0.3s ease;\n}\n\n/* System Prompt Editor */\n.system-prompt-editor h3 {\n    margin-top: 0;\n    margin-bottom: 10px;\n    color: var(--SmartThemeBodyColor);\n}\n\n.system-prompt-editor p {\n    margin-bottom: 10px;\n    color: var(--SmartThemeQuoteColor);\n    font-size: 0.9em;\n}\n\n#system_prompt_editor {\n    background-color: var(--SmartThemeBlurTintColor);\n    color: var(--SmartThemeBodyColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 3px;\n    padding: 10px;\n    resize: vertical;\n}\n\n#system_prompt_editor:focus {\n    outline: none;\n    border-color: var(--SmartThemeEmColor);\n}\n\n.system-prompt-actions button {\n    min-width: 100px;\n}\n\n#system_prompt_reset {\n    margin-right: auto;\n}\n\n\n","",{version:3,sources:["webpack://./style.css"],names:[],mappings:"AAAA,0CAA0C;;AAE1C;IACI,YAAY;AAChB;;AAEA;IACI,mBAAmB;AACvB;;AAEA;IACI,gBAAgB;IAChB,mBAAmB;IACnB,iBAAiB;AACrB;;AAEA,mBAAmB;AACnB;IACI,gDAAgD;IAChD,8CAA8C;IAC9C,kBAAkB;IAClB,aAAa;AACjB;;AAEA;IACI,iBAAiB;IACjB,iCAAiC;IACjC,YAAY;IACZ,kBAAkB;AACtB;;AAEA,mBAAmB;AACnB;IACI,iBAAiB;IACjB,gBAAgB;IAChB,8CAA8C;IAC9C,kBAAkB;IAClB,YAAY;IACZ,eAAe;AACnB;;AAEA;IACI,aAAa;IACb,mBAAmB;IACnB,8CAA8C;IAC9C,kBAAkB;IAClB,gDAAgD;AACpD;;AAEA;IACI,gBAAgB;AACpB;;AAEA,gFAAgF;AAChF;IACI,8BAA8B;IAC9B,yCAAyC;AAC7C;;AAEA;IACI,aAAa;IACb,8BAA8B;IAC9B,mBAAmB;IACnB,kBAAkB;AACtB;;AAEA;IACI,iBAAiB;IACjB,gBAAgB;IAChB,iCAAiC;AACrC;;AAEA;IACI,cAAc;IACd,iBAAiB;AACrB;;AAEA;IACI,kCAAkC;IAClC,6BAA6B;AACjC;;AAEA;IACI,qBAAqB;IACrB,gBAAgB;IAChB,kBAAkB;IAClB,iBAAiB;IACjB,iBAAiB;IACjB,gBAAgB;AACpB;;AAEA;IACI,yBAAyB;IACzB,WAAW;AACf;;AAEA;IACI,sBAAsB;IACtB,WAAW;AACf;;AAEA;IACI,yBAAyB;IACzB,WAAW;AACf;;AAEA,gCAAgC;AAChC;IACI,aAAa;IACb,mBAAmB;IACnB,iCAAiC;AACrC;;AAEA;IACI,mBAAmB;AACvB;;AAEA;IACI,cAAc;IACd,iBAAiB;IACjB,kBAAkB;IAClB,iCAAiC;AACrC;;AAEA;IACI,cAAc;IACd,eAAe;IACf,kCAAkC;IAClC,iBAAiB;AACrB;;AAEA;;IAEI,WAAW;IACX,sBAAsB;AAC1B;;AAEA;IACI,gBAAgB;IAChB,kCAAkC;IAClC,kBAAkB;IAClB,kBAAkB;AACtB;;AAEA;IACI,qBAAqB;IACrB,iBAAiB;IACjB,gBAAgB;IAChB,0CAA0C;IAC1C,8CAA8C;IAC9C,kBAAkB;IAClB,sBAAsB;IACtB,iBAAiB;IACjB,kBAAkB;IAClB,kCAAkC;AACtC;;AAEA;IACI,iBAAiB;IACjB,iCAAiC;IACjC,aAAa;IACb,YAAY;IACZ,0CAA0C;IAC1C,mDAAmD;IACnD,kBAAkB;IAClB,gBAAgB;AACpB;;AAEA;IACI,aAAa;IACb,QAAQ;IACR,eAAe;IACf,eAAe;AACnB;;AAEA;IACI,OAAO;IACP,gBAAgB;IAChB,iBAAiB;IACjB,gBAAgB;AACpB;;AAEA;IACI,iBAAiB;IACjB,gBAAgB;AACpB;;AAEA;IACI,kCAAkC;IAClC,kBAAkB;IAClB,kBAAkB;IAClB,aAAa;AACjB;;AAEA,oBAAoB;AACpB;IACI,gDAAgD;IAChD,mDAAmD;IACnD,aAAa;IACb,eAAe;IACf,kBAAkB;AACtB;;AAEA,iBAAiB;AACjB;IACI,aAAa;AACjB;;AAEA;IACI,mBAAmB;AACvB;;AAEA;IACI,iCAAiC;IACjC,iBAAiB;AACrB;;AAEA;IACI,cAAc;IACd,gBAAgB;IAChB,gBAAgB;IAChB,aAAa;IACb,wCAAwC;IACxC,8BAA8B;IAC9B,kBAAkB;AACtB;;AAEA,kBAAkB;AAClB;IACI,YAAY;IACZ,mBAAmB;AACvB;;AAEA,mBAAmB;AACnB;IACI,QAAQ;AACZ;;AAEA;IACI,OAAO;AACX;;AAEA,uBAAuB;AACvB;IACI,cAAc;IACd,aAAa;IACb,gDAAgD;IAChD,8CAA8C;IAC9C,kBAAkB;IAClB,kBAAkB;AACtB;;AAEA;IACI,kBAAkB;IAClB,iBAAiB;AACrB;;AAEA;IACI,WAAW;IACX,YAAY;IACZ,iCAAiC;IACjC,mBAAmB;IACnB,gBAAgB;AACpB;;AAEA;IACI,YAAY;IACZ,6CAA6C;IAC7C,2BAA2B;AAC/B;;AAEA,yDAAyD;AACzD;IACI,aAAa;IACb,gBAAgB;IAChB,aAAa;IACb,iCAAiC;IACjC,kBAAkB;IAClB,gBAAgB;AACpB;;AAEA;IACI,cAAc;AAClB;;AAEA;IACI,kBAAkB;AACtB;;AAEA;IACI,gBAAgB;AACpB;;AAEA;IACI,iBAAiB;IACjB,kCAAkC;IAClC,iBAAiB;AACrB;;AAEA,2BAA2B;AAC3B;IACI;QACI,sBAAsB;IAC1B;;IAEA;QACI,WAAW;IACf;AACJ;;AAEA,iCAAiC;AACjC;IACI;QACI,UAAU;QACV,4BAA4B;IAChC;IACA;QACI,UAAU;QACV,wBAAwB;IAC5B;AACJ;;AAEA;IACI,2BAA2B;AAC/B;;AAEA,yBAAyB;AACzB;IACI,aAAa;IACb,mBAAmB;IACnB,iCAAiC;AACrC;;AAEA;IACI,mBAAmB;IACnB,kCAAkC;IAClC,gBAAgB;AACpB;;AAEA;IACI,gDAAgD;IAChD,iCAAiC;IACjC,8CAA8C;IAC9C,kBAAkB;IAClB,aAAa;IACb,gBAAgB;AACpB;;AAEA;IACI,aAAa;IACb,sCAAsC;AAC1C;;AAEA;IACI,gBAAgB;AACpB;;AAEA;IACI,kBAAkB;AACtB",sourcesContent:["/* Styles for the Name Tracker extension */\r\n\r\n.name-tracker-settings {\r\n    padding: 5px;\r\n}\r\n\r\n.name-tracker_block {\r\n    margin-bottom: 10px;\r\n}\r\n\r\n.name-tracker_block h4 {\r\n    margin-top: 10px;\r\n    margin-bottom: 10px;\r\n    font-weight: bold;\r\n}\r\n\r\n/* Status Display */\r\n.name-tracker-status-block {\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    padding: 10px;\r\n}\r\n\r\n.name-tracker-status {\r\n    font-weight: bold;\r\n    color: var(--SmartThemeBodyColor);\r\n    padding: 5px;\r\n    text-align: center;\r\n}\r\n\r\n/* Character List */\r\n.name-tracker-character-list {\r\n    max-height: 400px;\r\n    overflow-y: auto;\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    padding: 5px;\r\n    margin-top: 5px;\r\n}\r\n\r\n.name-tracker-character {\r\n    padding: 10px;\r\n    margin-bottom: 10px;\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n}\r\n\r\n.name-tracker-character:last-child {\r\n    margin-bottom: 0;\r\n}\r\n\r\n/* Active/loaded character styling (characters that are loaded in SillyTavern) */\r\n.name-tracker-character.main-character {\r\n    border-left: 3px solid #4CAF50;\r\n    background-color: rgba(76, 175, 80, 0.05);\r\n}\r\n\r\n.character-header {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    margin-bottom: 5px;\r\n}\r\n\r\n.character-name {\r\n    font-weight: bold;\r\n    font-size: 1.1em;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.character-name .fa-user {\r\n    color: #4CAF50;\r\n    margin-right: 5px;\r\n}\r\n\r\n.character-name.ignored {\r\n    color: var(--SmartThemeQuoteColor);\r\n    text-decoration: line-through;\r\n}\r\n\r\n.character-badge {\r\n    display: inline-block;\r\n    padding: 2px 8px;\r\n    border-radius: 3px;\r\n    font-size: 0.75em;\r\n    font-weight: bold;\r\n    margin-left: 5px;\r\n}\r\n\r\n.character-badge.main-char {\r\n    background-color: #4CAF50;\r\n    color: #fff;\r\n}\r\n\r\n.character-badge.ignored {\r\n    background-color: #666;\r\n    color: #fff;\r\n}\r\n\r\n.character-badge.unresolved {\r\n    background-color: #ff9800;\r\n    color: #000;\r\n}\r\n\r\n/* Lorebook entry editor modal */\r\n.lorebook-entry-editor h3 {\r\n    margin-top: 0;\r\n    margin-bottom: 20px;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.editor-section {\r\n    margin-bottom: 15px;\r\n}\r\n\r\n.editor-section label {\r\n    display: block;\r\n    font-weight: bold;\r\n    margin-bottom: 5px;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.editor-section small {\r\n    display: block;\r\n    margin-top: 3px;\r\n    color: var(--SmartThemeQuoteColor);\r\n    font-size: 0.85em;\r\n}\r\n\r\n.editor-section input,\r\n.editor-section textarea {\r\n    width: 100%;\r\n    box-sizing: border-box;\r\n}\r\n\r\n.character-aliases {\r\n    font-size: 0.9em;\r\n    color: var(--SmartThemeQuoteColor);\r\n    margin-bottom: 8px;\r\n    font-style: italic;\r\n}\r\n\r\n.lorebook-entry-id {\r\n    display: inline-block;\r\n    margin-left: 10px;\r\n    padding: 2px 6px;\r\n    background: var(--SmartThemeBlurTintColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 3px;\r\n    font-family: monospace;\r\n    font-size: 0.85em;\r\n    font-style: normal;\r\n    color: var(--SmartThemeQuoteColor);\r\n}\r\n\r\n.character-details {\r\n    font-size: 0.85em;\r\n    color: var(--SmartThemeBodyColor);\r\n    margin: 8px 0;\r\n    padding: 8px;\r\n    background: var(--SmartThemeBlurTintColor);\r\n    border-left: 2px solid var(--SmartThemeBorderColor);\r\n    border-radius: 3px;\r\n    line-height: 1.4;\r\n}\r\n\r\n.character-actions {\r\n    display: flex;\r\n    gap: 5px;\r\n    flex-wrap: wrap;\r\n    margin-top: 8px;\r\n}\r\n\r\n.character-actions .menu_button {\r\n    flex: 1;\r\n    min-width: 100px;\r\n    padding: 5px 10px;\r\n    font-size: 0.9em;\r\n}\r\n\r\n.menu_button.compact {\r\n    padding: 5px 10px;\r\n    font-size: 0.9em;\r\n}\r\n\r\n.name-tracker-empty {\r\n    color: var(--SmartThemeQuoteColor);\r\n    font-style: italic;\r\n    text-align: center;\r\n    padding: 20px;\r\n}\r\n\r\n/* Ollama Settings */\r\n.ollama-settings {\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    border-left: 3px solid var(--SmartThemeBorderColor);\r\n    padding: 10px;\r\n    margin-top: 5px;\r\n    border-radius: 5px;\r\n}\r\n\r\n/* Merge Dialog */\r\n.merge-dialog {\r\n    padding: 15px;\r\n}\r\n\r\n.merge-dialog p {\r\n    margin-bottom: 10px;\r\n}\r\n\r\n.merge-dialog strong {\r\n    color: var(--SmartThemeBodyColor);\r\n    font-weight: bold;\r\n}\r\n\r\n.merge-warning {\r\n    color: #ff9800;\r\n    font-size: 0.9em;\r\n    margin-top: 10px;\r\n    padding: 10px;\r\n    background-color: rgba(255, 152, 0, 0.1);\r\n    border-left: 3px solid #ff9800;\r\n    border-radius: 3px;\r\n}\r\n\r\n/* Button states */\r\nbutton:disabled {\r\n    opacity: 0.5;\r\n    cursor: not-allowed;\r\n}\r\n\r\n/* Flex utilities */\r\n.flexGap5 {\r\n    gap: 5px;\r\n}\r\n\r\n.flex1 {\r\n    flex: 1;\r\n}\r\n\r\n/* Progress indicator */\r\n.name-tracker-progress {\r\n    margin: 10px 0;\r\n    padding: 10px;\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    text-align: center;\r\n}\r\n\r\n.name-tracker-progress .progress-text {\r\n    margin-bottom: 5px;\r\n    font-weight: bold;\r\n}\r\n\r\n.name-tracker-progress .progress-bar {\r\n    width: 100%;\r\n    height: 20px;\r\n    background-color: var(--black50a);\r\n    border-radius: 10px;\r\n    overflow: hidden;\r\n}\r\n\r\n.name-tracker-progress .progress-fill {\r\n    height: 100%;\r\n    background-color: var(--SmartThemeQuoteColor);\r\n    transition: width 0.3s ease;\r\n}\r\n\r\n/* Character details preview (for potential future use) */\r\n.character-details {\r\n    display: none;\r\n    margin-top: 10px;\r\n    padding: 10px;\r\n    background-color: var(--black30a);\r\n    border-radius: 5px;\r\n    font-size: 0.9em;\r\n}\r\n\r\n.character-details.expanded {\r\n    display: block;\r\n}\r\n\r\n.character-details-section {\r\n    margin-bottom: 8px;\r\n}\r\n\r\n.character-details-section:last-child {\r\n    margin-bottom: 0;\r\n}\r\n\r\n.character-details-label {\r\n    font-weight: bold;\r\n    color: var(--SmartThemeQuoteColor);\r\n    margin-right: 5px;\r\n}\r\n\r\n/* Responsive adjustments */\r\n@media (max-width: 768px) {\r\n    .character-actions {\r\n        flex-direction: column;\r\n    }\r\n    \r\n    .character-actions .menu_button {\r\n        width: 100%;\r\n    }\r\n}\r\n\r\n/* Animation for new characters */\r\n@keyframes fadeIn {\r\n    from {\r\n        opacity: 0;\r\n        transform: translateY(-10px);\r\n    }\r\n    to {\r\n        opacity: 1;\r\n        transform: translateY(0);\r\n    }\r\n}\r\n\r\n.name-tracker-character.new {\r\n    animation: fadeIn 0.3s ease;\r\n}\r\n\r\n/* System Prompt Editor */\r\n.system-prompt-editor h3 {\r\n    margin-top: 0;\r\n    margin-bottom: 10px;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.system-prompt-editor p {\r\n    margin-bottom: 10px;\r\n    color: var(--SmartThemeQuoteColor);\r\n    font-size: 0.9em;\r\n}\r\n\r\n#system_prompt_editor {\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    color: var(--SmartThemeBodyColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 3px;\r\n    padding: 10px;\r\n    resize: vertical;\r\n}\r\n\r\n#system_prompt_editor:focus {\r\n    outline: none;\r\n    border-color: var(--SmartThemeEmColor);\r\n}\r\n\r\n.system-prompt-actions button {\r\n    min-width: 100px;\r\n}\r\n\r\n#system_prompt_reset {\r\n    margin-right: auto;\r\n}\r\n\r\n\r\n"],sourceRoot:""}]);const s=i},102(e,n,t){t.d(n,{A:()=>s,r:()=>i});var r=t(806),a=t(462);const o=r.Ay.createModuleLogger("Context");const i=new class{constructor(){this._context=null,this._lastUpdate=0,this._updateInterval=1e3}getContext(){const e=Date.now();if(!this._context||e-this._lastUpdate>this._updateInterval)try{this._context=SillyTavern.getContext(),this._lastUpdate=e}catch(e){throw o.error("Failed to get SillyTavern context:",e),new Error("SillyTavern context not available")}return this._context}getChat(){return this.getContext().chat||[]}getChatMetadata(){return this.getContext().chatMetadata||{}}getChatId(){return this.getContext().chatId||null}getCharacterId(){return this.getContext().characterId}getCharacters(){return this.getContext().characters||[]}getUserName(){return this.getContext().name1||"User"}getExtensionSettings(){return this.getContext().extensionSettings||{}}async saveExtensionSettings(){return a.r_.withErrorBoundary("Context",async()=>{const e=this.getContext();e.saveSettingsDebounced?e.saveSettingsDebounced():o.warn("saveSettingsDebounced not available")},{silent:!0})}async saveChatMetadata(){return a.r_.withErrorBoundary("Context",async()=>{const e=this.getContext();e.saveMetadata?await e.saveMetadata():o.warn("saveMetadata not available")},{silent:!0})}async generateQuietPrompt(e){return a.r_.withErrorBoundary("Context",async()=>{const n=this.getContext();if(!n.generateQuietPrompt)throw new Error("generateQuietPrompt not available");return await n.generateQuietPrompt(e)},{retries:1})}async loadWorldInfo(e){return a.r_.withErrorBoundary("Context",async()=>{const n=this.getContext();if(!n.loadWorldInfo)throw new Error("loadWorldInfo not available");return await n.loadWorldInfo(e)})}async saveWorldInfo(e,n,t=!1){return a.r_.withErrorBoundary("Context",async()=>{const r=this.getContext();if(!r.saveWorldInfo)throw new Error("saveWorldInfo not available");return await r.saveWorldInfo(e,n,t)})}async saveWorldInfoEntry(e,n){return a.r_.withErrorBoundary("Context",async()=>{const t=this.getContext();if(!t.saveWorldInfoEntry)throw new Error("saveWorldInfoEntry not available");return await t.saveWorldInfoEntry(e,n)})}getEventSource(){return this.getContext().eventSource}getEventTypes(){return this.getContext().event_types}async callGenericPopup(e,n,t="",r={}){return a.r_.withErrorBoundary("Context",async()=>{const a=this.getContext();if(!a.callGenericPopup)throw new Error("callGenericPopup not available");return await a.callGenericPopup(e,n,t,r)})}isContextAvailable(){try{return!!this.getContext()}catch{return!1}}clearCache(){this._context=null,this._lastUpdate=0,o.debug("Cleared context cache")}getStatus(){return{available:this.isContextAvailable(),cached:!!this._context,lastUpdate:this._lastUpdate,chatId:this.getChatId(),characterId:this.getCharacterId()}}},s=i},113(e){e.exports=function(e,n){if(n.styleSheet)n.styleSheet.cssText=e;else{for(;n.firstChild;)n.removeChild(n.firstChild);n.appendChild(document.createTextNode(e))}}},134(e,n,t){t.d(n,{TQ:()=>u,WF:()=>g,_Z:()=>h});var r=t(806),a=t(462),o=t(548),i=t(102),s=t(854),c=t(695);let l;console.log("[LOREBOOK] Starting module load..."),console.log("[LOREBOOK] Imports completed. Types:"),console.log("[LOREBOOK] createModuleLogger:",typeof r.Xv),console.log("[LOREBOOK] withErrorBoundary:",typeof a.Xc),console.log("[LOREBOOK] NameTrackerError:",typeof a.S_);try{console.log("[LOREBOOK] About to call createModuleLogger..."),l=(0,r.Xv)("lorebook"),console.log("[LOREBOOK] Debug logger created successfully:",l)}catch(e){console.error("[LOREBOOK] Failed to create debug logger:",e),console.error("[LOREBOOK] Error stack:",e.stack),l={log:console.log.bind(console,"[LOREBOOK]"),error:console.error.bind(console,"[LOREBOOK]"),warn:console.warn.bind(console,"[LOREBOOK]"),debug:console.debug.bind(console,"[LOREBOOK]")}}const d=new c.h("Lorebook Management");let m=null;async function g(){return(0,a.Xc)("initializeLorebook",async()=>{const e=i.r.getContext();if(!e.chatId)return l.log("No active chat, skipping lorebook initialization"),m=null,null;const n="world_info",t=e.chatMetadata;if(!t)return l.log("No chat metadata available, skipping lorebook initialization"),m=null,null;if(t[n])return m=t[n],l.log(`Using existing chat lorebook: ${m}`),m;const r=`NameTracker_${e.chatId}`.replace(/[^a-z0-9 -]/gi,"_").replace(/_{2,}/g,"_").substring(0,64);l.log(`Creating new chat lorebook: ${r}`),m=r,t[n]=m;try{await e.saveMetadata(),l.log(`Bound lorebook to chat: ${m}`);await e.loadWorldInfo(m)||(l.log(),await e.saveWorldInfo(m,{entries:{}},!0)),d.info(`Chat lorebook "${m}" created and bound to this chat`,{timeOut:5e3})}catch(e){throw console.error("Failed to initialize lorebook:",e),m=null,new a.S_(`Failed to initialize lorebook: ${e.message}`)}return m})}async function u(e,n){return(0,a.Xc)("updateLorebookEntry",async()=>{if(l.log(`updateLorebookEntry called for: ${n}`),l.log("  Character data:",e),!m)return void l.log("No lorebook initialized, skipping entry update");const t=i.r.getContext(),r=(0,o.gf)(),a=[];if(e.physicalAge||e.mentalAge){const n=[];e.physicalAge&&n.push(`Physical: ${e.physicalAge}`),e.mentalAge&&n.push(`Mental: ${e.mentalAge}`),a.push(`**Age:** ${n.join(", ")}`)}e.physical&&a.push(`\n**Physical Description:**\n${e.physical}`),e.personality&&a.push(`\n**Personality:**\n${e.personality}`),e.sexuality&&a.push(`\n**Sexuality:**\n${e.sexuality}`),e.raceEthnicity&&a.push(`**Race/Ethnicity:** ${e.raceEthnicity}`),e.roleSkills&&a.push(`\n**Role & Skills:**\n${e.roleSkills}`),e.lastInteraction&&a.push(`\n**Last Interaction with {{user}}:**\n${e.lastInteraction}`),e.relationships&&e.relationships.length>0&&(a.push("\n**Relationships:**"),e.relationships.forEach(e=>{a.push(`- ${e}`)}));const c=a.join("\n"),d=[e.preferredName];e.aliases&&d.push(...e.aliases);let g=await t.loadWorldInfo(m);g||(l.log(),g={entries:{}});const u=(0,o.TJ)("messageFrequency",10),h=Math.max(1,Math.floor(.75*u));let p=null;if(e.lorebookEntryId&&g.entries&&g.entries[e.lorebookEntryId]){p=e.lorebookEntryId;const n=g.entries[p];n.key=d,n.content=c,n.enabled=r.enabled,n.position=r.position,n.probability=r.probability,n.depth=r.depth,n.scanDepth=r.scanDepth,n.cooldown=h,l.log()}else{const n=(0,s.cv)(),t={uid:n,key:d,keysecondary:[],comment:`Auto-generated entry for ${e.preferredName}`,content:c,constant:!1,selective:!0,contextConfig:{prefix:"",suffix:"",tokenBudget:0,reservedTokens:0,budgetPriority:400,trimDirection:"doNotTrim",insertionOrder:0,maximumTrimType:"sentence",insertionPosition:"before"},enabled:r.enabled,position:r.position,excludeRecursion:!1,preventRecursion:!1,delayUntilRecursion:!1,probability:r.probability,useProbability:!0,depth:r.depth,selectiveLogic:0,group:"",scanDepth:r.scanDepth,caseSensitive:null,matchWholeWords:null,useGroupScoring:null,automationId:"",role:0,vectorized:!1,sticky:0,cooldown:h,delay:0};g.entries[n]=t,e.lorebookEntryId=n,l.log()}try{await t.saveWorldInfo(m,g,!0);const n=await t.loadWorldInfo(m),r=p||e.lorebookEntryId;n&&n.entries&&n.entries[r]?l.log():console.error("[Name Tracker] WARNING: Lorebook verification failed - entries may not have been saved!"),l.log()}catch(e){throw console.error("[Name Tracker] Error saving lorebook:",e),l.log(),e}})}async function h(e){return(0,a.Xc)("viewInLorebook",async()=>{if(!(0,o.qN)(e))throw new a.S_("Character not found");if(!m)return void d.warning("No active chat or lorebook");const n=i.r.getContext();"function"==typeof n.openWorldInfoEditor?(await n.openWorldInfoEditor(m),d.success(`Opened lorebook for ${e}`)):($("#WorldInfo").click(),d.info(`Please select "${m}" from the World Info panel`))})}},314(e){e.exports=function(e){var n=[];return n.toString=function(){return this.map(function(n){var t="",r=void 0!==n[5];return n[4]&&(t+="@supports (".concat(n[4],") {")),n[2]&&(t+="@media ".concat(n[2]," {")),r&&(t+="@layer".concat(n[5].length>0?" ".concat(n[5]):""," {")),t+=e(n),r&&(t+="}"),n[2]&&(t+="}"),n[4]&&(t+="}"),t}).join("")},n.i=function(e,t,r,a,o){"string"==typeof e&&(e=[[null,e,void 0]]);var i={};if(r)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(i[c]=!0)}for(var l=0;l<e.length;l++){var d=[].concat(e[l]);r&&i[d[0]]||(void 0!==o&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=o),t&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=t):d[2]=t),a&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=a):d[4]="".concat(a)),n.push(d))}},n}},354(e){e.exports=function(e){var n=e[1],t=e[3];if(!t)return n;if("function"==typeof btoa){var r=btoa(unescape(encodeURIComponent(JSON.stringify(t)))),a="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(r),o="/*# ".concat(a," */");return[n].concat([o]).join("\n")}return[n].join("\n")}},462(e,n,t){t.d(n,{S_:()=>a,Xc:()=>i,r_:()=>o});const r=t(806).Ay.createModuleLogger("ErrorHandler");class a extends Error{constructor(e,n,t,r=!0){super(e),this.name="NameTrackerError",this.code=n,this.module=t,this.recoverable=r,this.timestamp=Date.now()}}const o=new class{constructor(){this.errorHistory=[],this.transactionStack=[],this.recoveryStrategies=new Map,this.criticalErrorCallbacks=[]}async withErrorBoundary(e,n,t={}){const{fallback:a=null,retries:o=0,silent:i=!1,operationId:s=null}=t;let c=null;const l=Date.now();s&&r.trace(s,`Starting operation in ${e}`);for(let t=0;t<=o;t++)try{const t=await n();return s&&r.trace(s,`Operation completed successfully in ${e}`),t}catch(n){if(console.log(`[STnametracker] Error caught in ${e}:`,n),c=n,t<o){console.log(`[STnametracker] Retrying operation in ${e}, attempt ${t+1}/${o+1}:`,n.message),r.warn(`Retrying operation in ${e}, attempt ${t+1}/${o+1}:`,n.message),await this.delay(100*Math.pow(2,t));continue}}console.log(`[STnametracker] All retries failed in ${e}, tracking error:`,c);const d=this.trackError(c,e,{operation:n.name||"anonymous",duration:Date.now()-l,retries:o,operationId:s});if(i||(console.log(`[STnametracker] Notifying user of error in ${e}`),this.notifyUser(d)),a)try{return r.debug(`Attempting fallback for ${e}:`,d.code),await a(d)}catch(n){r.error(`Fallback failed for ${e}:`,n)}const m=this.recoveryStrategies.get(d.code);if(m)try{return await m(d)}catch(e){r.error(`Recovery strategy failed for ${d.code}:`,e)}throw d}trackError(e,n,t={}){let o;if(e instanceof a)o=e;else{const t=this.categorizeError(e,n);o=new a(e.message,t,n,this.isRecoverable(e,t))}return o.context=t,this.errorHistory.push(o),this.errorHistory.length>100&&this.errorHistory.shift(),r.error(`Error in ${n}:`,{code:o.code,message:o.message,context:t}),o}categorizeError(e,n){return e.message.includes("fetch")||e.message.includes("network")?"NETWORK_ERROR":e.message.includes("JSON")||e.message.includes("parse")?"DATA_FORMAT_ERROR":e.message.includes("context")||e.message.includes("SillyTavern")?"CONTEXT_ERROR":"TypeError"===e.name?"TYPE_ERROR":"LLM"===n&&(e.message.includes("quota")||e.message.includes("rate"))?"API_LIMIT_ERROR":"UNKNOWN_ERROR"}isRecoverable(e,n){return!["CONTEXT_ERROR","TYPE_ERROR"].includes(n)}startTransaction(e,n){this.transactionStack.push({id:e,state:JSON.stringify(n),timestamp:Date.now()}),r.debug(`Started transaction: ${e}`)}commitTransaction(e){const n=this.transactionStack.findIndex(n=>n.id===e);-1!==n&&(this.transactionStack.splice(n,1),r.debug(`Committed transaction: ${e}`))}rollbackTransaction(e){const n=this.transactionStack.findIndex(n=>n.id===e);if(-1!==n){const t=this.transactionStack.splice(n,1)[0];return r.debug(`Rolled back transaction: ${e}`),JSON.parse(t.state)}return null}registerRecoveryStrategy(e,n){this.recoveryStrategies.set(e,n),r.debug(`Registered recovery strategy for: ${e}`)}onCriticalError(e){this.criticalErrorCallbacks.push(e)}notifyUser(e){const n=`Name Tracker: ${e.message}`;e.recoverable?toastr.warning(n,"Warning",{timeOut:5e3}):(toastr.error(n,"Error",{timeOut:8e3}),this.criticalErrorCallbacks.forEach(n=>{try{n(e)}catch(e){r.error("Critical error callback failed:",e)}}))}getRecentErrors(e=10){return this.errorHistory.slice(-e)}clearHistory(){this.errorHistory=[],r.debug("Cleared error history")}delay(e){return new Promise(n=>setTimeout(n,e))}},i=o.withErrorBoundary.bind(o)},540(e){e.exports=function(e){var n=document.createElement("style");return e.setAttributes(n,e.attributes),e.insert(n,e.options),n}},548(e,n,t){t.d(n,{PL:()=>A,TJ:()=>l,ZC:()=>f,bg:()=>m,e7:()=>b,eU:()=>C,gf:()=>k,nF:()=>h,nT:()=>d,qN:()=>y,sr:()=>p,yb:()=>x,zB:()=>u});var r=t(462),a=t(806);const o="STnametracker",i=(0,a.Xv)("Settings"),s=Object.freeze({enabled:!0,autoAnalyze:!0,messageFrequency:10,llmSource:"sillytavern",ollamaEndpoint:"http://localhost:11434",ollamaModel:"",confidenceThreshold:70,lorebookPosition:0,lorebookDepth:1,lorebookCooldown:5,lorebookScanDepth:1,lorebookProbability:100,lorebookEnabled:!0,debugMode:!1,systemPrompt:null,lastScannedMessageId:-1,totalCharactersDetected:0,lastAnalysisTime:null,analysisCache:new Map}),c=Object.freeze({characters:{},lastScannedMessageId:-1,analysisHistory:[],lorebookEntries:{},processingStats:{totalProcessed:0,charactersFound:0,lastProcessedTime:null}});function l(){return r.r_.withErrorBoundary("Settings",()=>{if("undefined"==typeof extension_settings)return console.warn("[STnametracker] extension_settings not available"),{...s};extension_settings[o]||(extension_settings[o]={...s});return{...s,...extension_settings[o]}},{...s})}function d(e){return r.r_.withErrorBoundary("Settings",()=>{"undefined"!=typeof extension_settings?(extension_settings[o]||(extension_settings[o]={...s}),Object.assign(extension_settings[o],e),"undefined"!=typeof saveSettingsDebounced&&saveSettingsDebounced()):console.warn("[STnametracker] extension_settings not available for saving")})}function m(){return r.r_.withErrorBoundary("Settings",()=>"undefined"==typeof chat_metadata?(console.warn("[STnametracker] chat_metadata not available"),{}):(chat_metadata[o]||(chat_metadata[o]={...c}),chat_metadata[o].characters||{}),{})}function g(e){return r.r_.withErrorBoundary("Settings",()=>{"undefined"!=typeof chat_metadata?(chat_metadata[o]||(chat_metadata[o]={...c}),chat_metadata[o].characters=e,"undefined"!=typeof saveMetadataDebounced&&saveMetadataDebounced()):console.warn("[STnametracker] chat_metadata not available for saving")})}function u(){return r.r_.withErrorBoundary("Settings",()=>"undefined"==typeof chat_metadata?(console.warn("[STnametracker] chat_metadata not available"),{...c}):(chat_metadata[o]||(chat_metadata[o]={...c}),chat_metadata[o]),{...c})}function h(e){return r.r_.withErrorBoundary("Settings",()=>{"undefined"!=typeof chat_metadata?(chat_metadata[o]||(chat_metadata[o]={...c}),Object.assign(chat_metadata[o],e),"undefined"!=typeof saveMetadataDebounced&&saveMetadataDebounced()):console.warn("[STnametracker] chat_metadata not available for saving")})}function p(e){return r.r_.withErrorBoundary("Settings",()=>{const n=m();delete n[e],g(n)})}function A(e,n){const t=l();return void 0!==t[e]?t[e]:n}function f(e,n){const t={};t[e]=n,d(t)}function y(e){return r.r_.withErrorBoundary("Settings",()=>{if(!e||"string"!=typeof e)return console.warn("[STnametracker] Invalid character name:",e),null;return m()[e]||null},null)}function b(e,n){return r.r_.withErrorBoundary("Settings",()=>{if(!e||"string"!=typeof e)throw new Error("Character name must be a non-empty string");if(!n||"object"!=typeof n)throw new Error("Character data must be an object");const t={...m()};t[e]=n,g(t),i.log(`Set character: ${e}`)})}function C(){return r.r_.withErrorBoundary("Settings",()=>({source:A("llmSource"),ollamaEndpoint:A("ollamaEndpoint"),ollamaModel:A("ollamaModel"),systemPrompt:A("systemPrompt")}),{source:"sillytavern",ollamaEndpoint:"http://localhost:11434",ollamaModel:"",systemPrompt:null})}function k(){return r.r_.withErrorBoundary("Settings",()=>({position:A("lorebookPosition"),depth:A("lorebookDepth"),cooldown:A("lorebookCooldown"),scanDepth:A("lorebookScanDepth"),probability:A("lorebookProbability"),enabled:A("lorebookEnabled")}),{position:0,depth:1,cooldown:5,scanDepth:1,probability:100,enabled:!0})}function x(e,n){return r.r_.withErrorBoundary("Settings",()=>{"undefined"!=typeof chat_metadata?(chat_metadata[o]||(chat_metadata[o]={...c}),chat_metadata[o][e]=n,i.log(`Updated chat data ${e}`),"undefined"!=typeof saveMetadataDebounced&&saveMetadataDebounced()):console.warn("[STnametracker] chat_metadata not available for saving")})}},551(e,n,t){t.d(n,{OW:()=>f,_$:()=>u,eY:()=>g,el:()=>k,g9:()=>x,lF:()=>b,pp:()=>w,rL:()=>h,t9:()=>y,undoLastMerge:()=>C,vu:()=>v});var r=t(134),a=t(806),o=t(462),i=t(548),s=(t(854),t(695));const c=(0,a.Xv)("characters"),l=new s.h("Character Management");function d(e,n=null){console.log(`[NT-Characters] ${e}`,n||"")}let m=[];function g(e){return(0,o.Xc)("isIgnoredCharacter",()=>{const n=(0,i.bg)();return Object.values(n).some(n=>n.ignored&&(n.preferredName===e||n.aliases.includes(e)))})}function u(e){return(0,o.Xc)("findExistingCharacter",()=>{const n=(0,i.bg)(),t=Object.values(n).find(n=>n.preferredName===e||n.aliases.includes(e))||null;return d(`[FindChar] Searching for '${e}': ${t?"FOUND as "+t.preferredName:"NOT FOUND"}`),t})}async function h(e){return(0,o.Xc)("findPotentialMatch",async()=>{const n=(0,i.bg)(),t=(0,i.TJ)("confidenceThreshold",70);c.log();for(const r of Object.values(n)){if(p(e.name,r.preferredName)>=t)return c.log(),r;for(const n of r.aliases){if(p(e.name,n)>=t)return c.log(),r}}return null})}function p(e,n){return(0,o.Xc)("calculateNameSimilarity",()=>{if(e=e.toLowerCase(),n=n.toLowerCase(),e===n)return 100;if(e.includes(n)||n.includes(e))return 85;const t=e.split(/\s+/),r=n.split(/\s+/);return t.filter(e=>r.includes(e)).length>0?70:0})}function A(e,n){return(0,o.Xc)("cleanAliases",()=>{if(!e||!Array.isArray(e))return[];const t=["son","daughter","mother","father","mom","dad","parent","brother","sister","sibling","cousin","uncle","aunt","friend","boyfriend","girlfriend","husband","wife","spouse","boss","employee","coworker","colleague","partner","neighbor","roommate","child","kid","baby","man","woman","person","guy","girl","boy","user","{{user}}","char","{{char}}"],r=n.toLowerCase();return e.filter(e=>{if(!e||"string"!=typeof e)return!1;const n=e.trim().toLowerCase();return n!==r&&(!t.includes(n)&&!(n.length<2))}).map(e=>e.trim()).filter((e,n,t)=>t.indexOf(e)===n)})}async function f(e,n=!1){return(0,o.Xc)("createCharacter",async()=>{c.log();const t=A(e.aliases||[],e.name),a={preferredName:e.name,aliases:t,physicalAge:e.physicalAge||"",mentalAge:e.mentalAge||"",physical:e.physical||"",personality:e.personality||"",sexuality:e.sexuality||"",raceEthnicity:e.raceEthnicity||"",roleSkills:e.roleSkills||"",lastInteraction:e.lastInteraction||"",relationships:e.relationships||[],ignored:!1,confidence:e.confidence||50,lorebookEntryId:null,lastUpdated:Date.now(),isMainChar:n||!1,lastMessageProcessed:-1};return c.log(),(0,i.e7)(a.preferredName,a),await(0,r.TQ)(a,a.preferredName),c.log(),a})}async function y(e,n,t=!1,r=!1){return(0,o.Xc)("updateCharacter",async()=>{if(c.log(),r&&(e.isMainChar=!0),t&&n.name!==e.preferredName&&(e.aliases||(e.aliases=[]),e.aliases.includes(n.name)||n.name.toLowerCase()===e.preferredName.toLowerCase()||e.aliases.push(n.name)),e.aliases=A(e.aliases||[],e.preferredName),n.physicalAge&&(e.physicalAge=n.physicalAge),n.mentalAge&&(e.mentalAge=n.mentalAge),n.physical&&(e.physical=n.physical),n.personality&&(e.personality=n.personality),n.sexuality&&(e.sexuality=n.sexuality),n.raceEthnicity&&(e.raceEthnicity=n.raceEthnicity),n.roleSkills&&(e.roleSkills=n.roleSkills),n.lastInteraction&&(e.lastInteraction=n.lastInteraction),n.relationships&&Array.isArray(n.relationships)){e.relationships||(e.relationships=[]);for(const t of n.relationships)e.relationships.includes(t)||e.relationships.push(t)}return n.confidence&&(e.confidence=Math.round((e.confidence+n.confidence)/2)),e.lastUpdated=Date.now(),(0,i.e7)(e.preferredName,e),c.log(),e})}async function b(e,n){return(0,o.Xc)("mergeCharacters",async()=>{const t=(0,i.bg)(),r=t[e],a=t[n];if(!r||!a)throw new o.S_("One or both characters not found");const s={operation:"merge",timestamp:Date.now(),sourceName:e,targetName:n,sourceData:JSON.parse(JSON.stringify(r)),targetDataBefore:JSON.parse(JSON.stringify(a))};m.push(s),m.length>3&&m.shift();for(const e of r.aliases)a.aliases.includes(e)||a.aliases.push(e);r.preferredName===a.preferredName||a.aliases.includes(r.preferredName)||a.aliases.push(r.preferredName),r.physicalAge&&!a.physicalAge&&(a.physicalAge=r.physicalAge),r.mentalAge&&!a.mentalAge&&(a.mentalAge=r.mentalAge),r.physical&&!a.physical&&(a.physical=r.physical),r.personality&&!a.personality&&(a.personality=r.personality),r.sexuality&&!a.sexuality&&(a.sexuality=r.sexuality),r.raceEthnicity&&!a.raceEthnicity&&(a.raceEthnicity=r.raceEthnicity),r.roleSkills&&!a.roleSkills&&(a.roleSkills=r.roleSkills),r.lastInteraction&&!a.lastInteraction&&(a.lastInteraction=r.lastInteraction);for(const e of r.relationships)a.relationships.includes(e)||a.relationships.push(e);return a.lastUpdated=Date.now(),(0,i.e7)(a.preferredName,a),(0,i.sr)(e),c.log(),l.success(`Merged ${e} into ${n}`),s})}async function C(){return(0,o.Xc)("undoLastMerge",async()=>{if(0===m.length)return l.warning("No merge operations to undo"),!1;const e=m.pop();return"merge"!==e.operation?(l.error("Last operation was not a merge"),!1):((0,i.e7)(e.sourceName,e.sourceData),(0,i.e7)(e.targetName,e.targetDataBefore),c.log(),l.success("Merge undone successfully"),!0)})}async function k(e){return(0,o.Xc)("toggleIgnoreCharacter",async()=>{const n=(0,i.qN)(e);if(!n)throw new o.S_("Character not found");n.ignored=!n.ignored,(0,i.e7)(e,n);const t=n.ignored?"ignored":"unignored";return l.info(`${e} ${t}`),c.log(),n.ignored})}async function x(e){return(0,o.Xc)("createNewCharacter",async()=>{if(!e||!e.trim())throw new o.S_("Character name is required");const n=e.trim();if((0,i.qN)(n))throw new o.S_(`Character "${n}" already exists`);const t={name:n,aliases:[],physicalAge:"",mentalAge:"",physical:"",personality:"",sexuality:"",raceEthnicity:"",roleSkills:"",lastInteraction:"",relationships:[],confidence:100},r=await f(t,!1);return c.log(),l.success(`Created character: ${n}`),r})}async function v(){return(0,o.Xc)("purgeAllCharacters",async()=>{const e=(0,i.bg)(),n=Object.keys(e).length;return 0===n?(l.info("No characters to purge"),0):((0,i.yb)("characters",{}),m=[],c.log(),l.success(`Purged ${n} characters`),n)})}function w(e){return(0,o.Xc)("hasUnresolvedRelationships",()=>{if(!e.relationships||0===e.relationships.length)return!1;const n=(0,i.bg)(),t=Object.values(n).reduce((e,n)=>(e.add(n.preferredName.toLowerCase()),n.aliases.forEach(n=>e.add(n.toLowerCase())),e),new Set);return e.relationships.some(e=>e.toLowerCase().split(/\s+/).some(e=>e.length>2&&!t.has(e)))})}},659(e){var n={};e.exports=function(e,t){var r=function(e){if(void 0===n[e]){var t=document.querySelector(e);if(window.HTMLIFrameElement&&t instanceof window.HTMLIFrameElement)try{t=t.contentDocument.head}catch(e){t=null}n[e]=t}return n[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(t)}},695(e,n,t){t.d(n,{A:()=>i,h:()=>a});const r=t(806).Ay.createModuleLogger("Notifications");class a{constructor(){this.defaultOptions={timeOut:5e3,extendedTimeOut:2e3,closeButton:!0,progressBar:!0,preventDuplicates:!0},this.prefix="Name Tracker: "}success(e,n="Success",t={}){const a={...this.defaultOptions,...t};toastr.success(this.prefix+e,n,a),r.debug("Success notification:",e)}info(e,n="Info",t={}){const a={...this.defaultOptions,...t};toastr.info(this.prefix+e,n,a),r.debug("Info notification:",e)}warning(e,n="Warning",t={}){const a={...this.defaultOptions,timeOut:8e3,...t};toastr.warning(this.prefix+e,n,a),r.debug("Warning notification:",e)}error(e,n="Error",t={}){const a={...this.defaultOptions,timeOut:1e4,extendedTimeOut:5e3,...t};toastr.error(this.prefix+e,n,a),r.error("Error notification:",e)}persistent(e,n="Notice",t="info"){const a={...this.defaultOptions,timeOut:0,extendedTimeOut:0};switch(t){case"success":toastr.success(this.prefix+e,n,a);break;case"warning":toastr.warning(this.prefix+e,n,a);break;case"error":toastr.error(this.prefix+e,n,a);break;default:toastr.info(this.prefix+e,n,a)}r.debug("Persistent notification:",e)}progress(e,n=0,t=null){const a=t||`progress_${Date.now()}`,o=`\n            <div style="margin-bottom: 8px;">${this.prefix}${e}</div>\n            <div style="background: #333; border-radius: 3px; overflow: hidden;">\n                <div style="background: #007acc; height: 6px; width: ${n}%; transition: width 0.3s ease;"></div>\n            </div>\n            <div style="text-align: center; font-size: 11px; margin-top: 4px;">${n}%</div>\n        `,i={timeOut:0,extendedTimeOut:0,closeButton:!1,progressBar:!1,preventDuplicates:!1,toastId:a};return toastr.remove(),toastr.info(o,"",i),r.debug("Progress notification:",e,`${n}%`),a}clear(){toastr.clear(),r.debug("Cleared all notifications")}confirm(e,n,t=null,a="Confirm"){const o=`confirm_${Date.now()}`,i=`\n            <div style="margin-bottom: 12px;">${e}</div>\n            <div style="text-align: right;">\n                <button class="btn btn-sm btn-secondary me-2" onclick="nameTrackerNotifications.handleConfirmCancel('${o}')">Cancel</button>\n                <button class="btn btn-sm btn-primary" onclick="nameTrackerNotifications.handleConfirmOk('${o}')">Confirm</button>\n            </div>\n        `;window.nameTrackerNotifications=window.nameTrackerNotifications||{},window.nameTrackerNotifications.confirmCallbacks=window.nameTrackerNotifications.confirmCallbacks||{},window.nameTrackerNotifications.confirmCallbacks[o]={onConfirm:n,onCancel:t},window.nameTrackerNotifications.handleConfirmOk=e=>{const n=window.nameTrackerNotifications.confirmCallbacks[e];n&&n.onConfirm&&n.onConfirm(),delete window.nameTrackerNotifications.confirmCallbacks[e],toastr.clear()},window.nameTrackerNotifications.handleConfirmCancel=e=>{const n=window.nameTrackerNotifications.confirmCallbacks[e];n&&n.onCancel&&n.onCancel(),delete window.nameTrackerNotifications.confirmCallbacks[e],toastr.clear()};const s={timeOut:0,extendedTimeOut:0,closeButton:!1,progressBar:!1,preventDuplicates:!1,toastId:o};return toastr.info(i,this.prefix+a,s),r.debug("Confirmation notification:",e),o}getStatus(){return{defaultOptions:this.defaultOptions,prefix:this.prefix,activeConfirms:Object.keys(window.nameTrackerNotifications?.confirmCallbacks||{}).length}}}const o=new a;r.debug("Notifications module loaded");const i=o},806(e,n,t){t.d(n,{Ay:()=>o,Xv:()=>a});const r=new class{constructor(){this.modules=new Map,this.performanceMarks=new Map,this.operationTraces=new Map}createModuleLogger(e){if(this.modules.has(e))return this.modules.get(e);const n={log:(...n)=>this.log(e,"log",...n),warn:(...n)=>this.log(e,"warn",...n),error:(...n)=>this.log(e,"error",...n),debug:(...n)=>this.log(e,"debug",...n),trace:(n,t)=>this.addTrace(e,n,t),startTimer:n=>this.startTimer(e,n),endTimer:n=>this.endTimer(e,n)};return this.modules.set(e,n),n}log(e,n,...t){if(!this.isDebugEnabled())return;const r=`[STnametracker:${e}] ${(new Date).toLocaleTimeString()}`;switch(n){case"error":console.error(r,...t);break;case"warn":console.warn(r,...t);break;case"debug":console.debug(r,...t);break;default:console.log(r,...t)}}addTrace(e,n,t){this.isDebugEnabled()&&(this.operationTraces.has(n)||this.operationTraces.set(n,[]),this.operationTraces.get(n).push({module:e,timestamp:Date.now(),message:t}))}getTrace(e){return this.operationTraces.get(e)||[]}startTimer(e,n){const t=`${e}:${n}`;this.performanceMarks.set(t,performance.now())}endTimer(e,n){const t=`${e}:${n}`,r=this.performanceMarks.get(t);if(void 0===r)return this.log(e,"warn",`Timer '${n}' was not started`),0;const a=performance.now()-r;return this.performanceMarks.delete(t),this.log(e,"debug",`Timer '${n}': ${a.toFixed(2)}ms`),a}isDebugEnabled(){return!0}clear(){this.operationTraces.clear(),this.performanceMarks.clear()}getPerformanceSummary(){return{activeTimers:this.performanceMarks.size,activeTraces:this.operationTraces.size,modules:Array.from(this.modules.keys())}}};function a(e){return r.createModuleLogger(e)}const o=r},825(e){e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var n=e.insertStyleElement(e);return{update:function(t){!function(e,n,t){var r="";t.supports&&(r+="@supports (".concat(t.supports,") {")),t.media&&(r+="@media ".concat(t.media," {"));var a=void 0!==t.layer;a&&(r+="@layer".concat(t.layer.length>0?" ".concat(t.layer):""," {")),r+=t.css,a&&(r+="}"),t.media&&(r+="}"),t.supports&&(r+="}");var o=t.sourceMap;o&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),n.styleTagTransform(r,e,n.options)}(n,e,t)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(n)}}}},854(e,n,t){t.d(n,{ZD:()=>a,cv:()=>o,tx:()=>r});function r(e){let n=0;for(let t=0;t<e.length;t++){n=(n<<5)-n+e.charCodeAt(t),n&=n}return n.toString(36)}function a(e){if("string"!=typeof e)return"";const n=document.createElement("div");return n.textContent=e,n.innerHTML}function o(){return Date.now().toString(36)+Math.random().toString(36).substr(2,9)}t(806).Ay.createModuleLogger("Utils").debug("Utils module loaded")}},n={};function t(r){var a=n[r];if(void 0!==a)return a.exports;var o=n[r]={id:r,exports:{}};return e[r](o,o.exports,t),o.exports}t.n=e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},t.d=(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},t.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n),t.nc=void 0;var r=t(72),a=t.n(r),o=t(825),i=t.n(o),s=t(659),c=t.n(s),l=t(56),d=t.n(l),m=t(540),g=t.n(m),u=t(113),h=t.n(u),p=t(83),A={};A.styleTagTransform=h(),A.setAttributes=d(),A.insert=c().bind(null,"head"),A.domAPI=i(),A.insertStyleElement=g();a()(p.A,A);p.A&&p.A.locals&&p.A.locals;var f=t(806),y=t(462),b=t(102),C=t(548),k=t(695),x=t(854),v=t(551);const w=(0,f.Xv)("llm"),B=new k.h("LLM Integration");function I(e,n=null){console.log(`[NT-LLM] ${e}`,n||"")}const T=new Map;let S=[];async function _(e){return(0,y.Xc)("getOllamaModelContext",async()=>{const n=(0,C.TJ)("ollamaEndpoint","http://localhost:11434");if(!e)return w.log(),4096;try{const t=await fetch(`${n}/api/show`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!t.ok)throw new Error(`Failed to fetch model info: ${t.statusText}`);const r=await t.json();if(r.parameters&&Array.isArray(r.parameters))for(const e of r.parameters){const n=e.match(/num_ctx\\s+(\\d+)/);if(n){const e=parseInt(n[1]);return w.log(),e}}if(r.model_info&&r.model_info.num_ctx){const e=parseInt(r.model_info.num_ctx);return w.log(),e}return w.log(),4096}catch(e){return console.error("Error fetching Ollama model context:",e),w.log(),4096}})}function E(){return(0,y.Xc)("buildCharacterRoster",()=>{const e=(0,C.bg)(),n=Object.keys(e);if(0===n.length)return"";return`\\n\\n[KNOWN CHARACTERS]\\nThe following characters have already been identified. If you encounter them again, use the same name and add any new details:\\n${n.map(n=>{const t=e[n];return`  - ${n}${t.aliases&&t.aliases.length>0?` (also known as: ${t.aliases.join(", ")})`:""}${t.relationships&&t.relationships.length>0?`\\n    Relationships: ${t.relationships.join("; ")}`:""}`}).join("\\n")}\\n`})}async function M(){return(0,y.Xc)("getMaxPromptLength",async()=>{const e=(0,C.eU)();let n=4096;if("ollama"===e.source&&e.ollamaModel)n=await _(e.ollamaModel);else{n=b.r.getContext().maxContext||4096}const t=Math.floor(.5*n);return w.log(),Math.max(1e3,Math.min(t,25e3))})}async function O(e){return(0,y.Xc)("calculateMessageTokens",async()=>{const n=b.r.getContext();let t=0;for(const r of e)if(r&&"object"==typeof r&&r.extra&&"number"==typeof r.extra.token_count)t+=r.extra.token_count;else{const e=r?.mes||r?.message||String(r);if(e&&n.getTokenCountAsync)try{t+=await n.getTokenCountAsync(e)}catch(n){w.log(),t+=Math.ceil(e.length/4)}else t+=Math.ceil(e.length/4)}return t})}function N(e){return(0,y.Xc)("parseJSONResponse",()=>{if(!e||"string"!=typeof e)throw console.error("Invalid response text:",e),new y.S_("LLM returned empty or invalid response");const n=(e=e.trim()).match(/```(?:json)?\\s*([\\s\\S]*?)```/);n&&(e=n[1].trim());const t=e.indexOf("{"),r=e.lastIndexOf("}");-1!==t&&-1!==r&&r>t&&(e=e.substring(t,r+1)),e=(e=e.replace(/^(?:Here's the analysis:|Here is the JSON:|Result:|Output:)\\s*/i,"")).trim();try{const n=JSON.parse(e);return n.characters&&Array.isArray(n.characters)?n:(console.warn("Response missing characters array, returning empty:",n),{characters:[]})}catch(n){if(console.error("Failed to parse JSON response. Original text:",e),console.error("Parse error:",n.message),e.includes('"characters"')&&!e.trim().endsWith("}")){w.log(),w.log();let n=e;const t=(e.match(/\{/g)||[]).length,r=(e.match(/\}/g)||[]).length,a=(e.match(/\[/g)||[]).length,o=(e.match(/\]/g)||[]).length;n.match(/"[^"]*$/)&&(n+='"');for(let e=0;e<a-o;e++)n+="]";for(let e=0;e<t-r;e++)n+="}";try{const e=JSON.parse(n);return w.log(),e}catch(e){w.log()}}const t=e.match(/\\{[\\s\\S]*"characters"[\\s\\S]*\\}/);if(t)try{return JSON.parse(t[0])}catch(e){w.log()}throw new y.S_("Failed to parse LLM response as JSON. The response may be too long or truncated. Try analyzing fewer messages at once.")}})}async function z(e,n="",t=0,r=0){return(0,y.Xc)("callLLMAnalysis",async()=>{const a=(0,C.eU)(),o=await M();w.log();const i=e.map(e=>"string"==typeof e?e:e.mes?e.mes:e.message?e.message:JSON.stringify(e)),s=(0,x.tx)(i.join("\\n")+a.source+a.ollamaModel);if(T.has(s))return w.log(),T.get(s);const c=i.map((e,n)=>`Message ${n+1}:\\n${e}`).join("\\n\\n"),l=`${`[SYSTEM INSTRUCTION - DO NOT ROLEPLAY]\\n${(0,C.TJ)("systemPrompt")||'Extract character information from messages and return ONLY a JSON object.\n\nCRITICAL: Your entire response must be a single JSON object starting with { and ending with }\n\nDO NOT include:\n- Any text before the JSON\n- Any text after the JSON  \n- Code block markers\n- Explanations or commentary\n\nREQUIRED JSON structure (copy this exact format):\n{\n  "characters": [\n    {\n      "name": "Character name",\n      "aliases": ["Other names"],\n      "physicalAge": "Age if mentioned",\n      "mentalAge": "Mental age if different",\n      "physical": "Physical description",\n      "personality": "Personality traits",\n      "sexuality": "Sexual orientation if mentioned",\n      "raceEthnicity": "Race/ethnicity if mentioned",\n      "roleSkills": "Job/role/skills",\n      "lastInteraction": "Recent interaction with user",\n      "relationships": ["Relationships with other characters"],\n      "confidence": 75\n    }\n  ]\n}\n\nRules:\n- Only extract clearly named speaking characters\n- Skip generic references ("the waiter", "a woman")\n- Use most recent information for conflicts\n- Empty array if no clear characters: {"characters":[]}\n- Confidence: 90+ (explicit), 70-89 (clear), 50-69 (mentioned), <50 (vague)\n\nYour response must start with { immediately.'}${n}\\n\\n[DATA TO ANALYZE]`}\\n${c}\\n\\n[RESPOND WITH JSON ONLY - NO STORY CONTINUATION]`;let d,m;try{d=await O([{mes:l}]),w.log()}catch(e){w.log(),d=Math.ceil(l.length/4)}if(d>o&&e.length>1){"  ".repeat(t);w.log();const r=Math.floor(e.length/2),a=e.slice(0,r),o=e.slice(r);w.log();const[i,s]=await Promise.all([z(a,n,t+1),z(o,n,t+1)]),c={characters:[...i.characters||[],...s.characters||[]]};return w.log(),c}try{m="ollama"===a.source?await async function(e){return(0,y.Xc)("callOllama",async()=>{const n=(0,C.eU)();if(!n.ollamaModel)throw new y.S_("No Ollama model selected");w.log();const t=await _(n.ollamaModel),r=Math.floor(.25*t),a=Math.max(4e3,r);w.log();const o=await fetch(`${n.ollamaEndpoint}/api/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:n.ollamaModel,prompt:e,stream:!1,format:"json",options:{temperature:.2,top_p:.85,top_k:25,repeat_penalty:1.1,num_predict:a}})});if(!o.ok)throw new y.S_(`Ollama API error: ${o.statusText}`);const i=await o.json();return w.log(),w.log(),N(i.response)})}(l):await async function(e){return(0,y.Xc)("callSillyTavern",async()=>{w.log();const n=b.r.getContext();if(!n.onlineStatus)throw new y.S_("No API connection available. Please connect to an API first.");let t;try{t=await n.getTokenCountAsync(e),w.log()}catch(n){w.log(),t=Math.ceil(e.length/4),w.log()}const r=n.maxContext||4096,a=Math.floor(.25*r),o=Math.max(4e3,a);w.log();const i=await n.generateRaw({prompt:e,systemPrompt:"",prefill:"",temperature:.2,top_p:.85,top_k:25,rep_pen:1.1,max_tokens:o,stop:[]});if(w.log(),!i)throw new y.S_("Empty response from SillyTavern LLM");return N(i)})}(l)}catch(a){if(r<3&&(a.message.includes("JSON")||a.message.includes("empty")||a.message.includes("truncated"))){w.log();const a=1e3*Math.pow(2,r);return await new Promise(e=>setTimeout(e,a)),await z(e,n,t,r+1)}throw a}if(T.size>50){const e=T.keys().next().value;T.delete(e)}return T.set(s,m),w.log(),m})}var R=t(134);const L=(0,f.Xv)("processing"),P=new k.h("Message Processing");function D(e,n=null){console.log(`[NT-Processing] ${e}`,n||"")}let j=[],U=!1,F=!1,X={totalBatches:0,currentBatch:0,failedCharacters:[],lastError:null,contextTarget:80};async function W(e){return(0,y.Xc)("processAnalysisResults",async()=>{if(e&&Array.isArray(e)){L.log();for(const n of e)try{await Z(n)}catch(e){console.error(`Error processing character ${n.name}:`,e)}}else L.log()})}async function Z(e){return(0,y.Xc)("processCharacterData",async()=>{if(!e.name||""===e.name.trim())return void L.log();const n=e.name.trim();if((0,v.eY)(n))return void L.log();const t=n.toLowerCase().includes("{{char}}")||!0===e.isMainCharacter||"main"===e.role,r=(0,v._$)(n);if(r)await(0,v.t9)(r,e,!1,t),await(0,R.TQ)(r,r.preferredName),L.log();else{const n=await(0,v.rL)(e);if(n)await(0,v.t9)(n,e,!0,t),await(0,R.TQ)(n,n.preferredName),L.log();else{const n=await(0,v.OW)(e,t);await(0,R.TQ)(n,n.preferredName),L.log()}}})}async function Q(e,n=!0){return(0,y.Xc)("harvestMessages",async()=>{if(!(0,C.TJ)("enabled",!0))return void L.log();if("sillytavern"===(0,C.eU)().source){if(!b.r.getContext().onlineStatus)return void P.warning("Please connect to an API (OpenAI, Claude, etc.) before analyzing messages")}const t=b.r.getContext();if(!t.chat||0===t.chat.length)return L.log(),void P.info("No messages in chat to analyze");const r=t.chat.length,a=Math.max(0,r-e),o=t.chat.slice(a,r);D(`[Batching] Message selection: startIdx=${a}, endIdx=${r}, requesting ${e} messages, got ${o.length} messages`);const i=await M(),s=i-1e3;D(`[Batching] Token budget: maxPromptTokens=${i}, reserved=1000, availableTokens=${s}`),D(`[Batching] Context target: ${X.contextTarget}%`);const c=await O(o);if(D(`[Batching] Total tokens for ${o.length} messages: ${c} tokens`),c>s){D(`[Batching] Messages exceed token limit (${c} > ${s}), creating batches`);const e=[];let t=[],r=0;const i=[];for(const n of o){const a=await O([n]),o=r+a>s,c=t.length>=50;if((o||c)&&t.length>0){const s=o?"token limit":"message count limit";D(`[Batching] Batch ${e.length+1} complete: ${t.length} messages, ${r} tokens (split by ${s})`),e.push(t),i.push({size:t.length,tokens:r,reason:s}),t=[n],r=a}else t.push(n),r+=a}t.length>0&&(e.push(t),i.push({size:t.length,tokens:r,reason:"final batch"}),D(`[Batching] Final batch ${e.length}: ${t.length} messages, ${r} tokens`));const l=i.map((e,n)=>`Batch ${n+1}: ${e.size}msg/${e.tokens}tok (${e.reason})`).join(" | ");D(`[Batching] Created ${e.length} total batches: ${l}`),D(`[Batching] Constraints applied: MIN=5, TARGET=30, MAX=50, TokenLimit=${s}`),F=!1;const d=Math.round(o.length/e.length),m=`Analyzing ${o.length} messages in ${e.length} batches (~${d} messages each). This may take a while. Continue?`;if(n){if(!confirm(m))return D("[Batching] User cancelled batch processing"),void(F=!0)}H(0,e.length,"Starting analysis...");let g=0,u=0;const h=new Set;D(`[Batching] Starting batch processing loop: ${e.length} batches`);for(let n=0;n<e.length;n++){if(F)return D(`[BatchProcessing] User aborted at batch ${n+1}/${e.length}`),Y(),void P.warning("Analysis aborted");const t=e[n],r=a+e.slice(0,n).reduce((e,n)=>e+n.length,0),o=r+t.length;D(`[BatchProcessing] Processing batch ${n+1}/${e.length}: messages ${r}-${o-1} (${t.length} messages)`);try{H(n+1,e.length,`Analyzing messages ${r+1}-${o}...`);const a=E(),i=await z(t,a);i.characters&&Array.isArray(i.characters)&&(await W(i.characters),i.characters.forEach(e=>h.add(e.name))),g++,n<e.length-1&&await new Promise(e=>setTimeout(e,500))}catch(a){D(`[BatchProcessing] ERROR in batch ${n+1}: ${a.message}`),D(`[BatchProcessing] Context: messages ${r}-${o-1}, batch size ${t.length}, token count calc error`),console.error(`Error processing batch ${n+1}:`,a),u++;if(!confirm(`Batch ${n+1} failed.\n\nError: ${a.message}\n\nContinue with remaining batches?`)){D(`[BatchProcessing] User chose not to continue after error on batch ${n+1}/${e.length}`);break}D(`[BatchProcessing] User chose to continue despite error on batch ${n+1}/${e.length}`)}}Y();const p=`Analysis complete!\n\nBatches processed: ${g}/${e.length}\nUnique characters found: ${h.size}\nFailed batches: ${u}`;return D(`[BatchProcessing] Batch analysis complete: ${g}/${e.length} successful, ${u} failed, ${h.size} characters found`),void(u>0?P.warning(p,{timeOut:8e3}):P.success(p,{timeOut:8e3}))}n&&P.info(`Analyzing ${o.length} messages for character information...`);try{const e=E(),t=await z(o,e);L.log(),t.characters&&Array.isArray(t.characters)?(await W(t.characters),n&&P.success(`Found ${t.characters.length} character(s) in messages`)):L.log()}catch(e){console.error("Error during harvest:",e),P.error(`Analysis failed: ${e.message}`)}})}async function J(e){return(0,y.Xc)("onMessageReceived",async()=>{if(!(0,C.TJ)("enabled",!0)||!(0,C.TJ)("autoAnalyze",!0))return;const e=b.r.getContext().chat;if(!e||0===e.length)return;const n=e.length-1,t=(0,C.TJ)("lastScannedMessageId",-1);if(n<=t)return void L.log();if(t>=0&&n<t){L.log();const e=await async function(e,n){return new Promise(t=>{const r=$(`\n            <div class="name-tracker-rescan-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--SmartThemeBodyColor); border: 2px solid var(--SmartThemeBorderColor); padding: 20px; border-radius: 10px; z-index: 9999; max-width: 500px;">\n                <h3>Message History Changed</h3>\n                <p>Messages have been deleted or edited. Would you like to rescan the chat?</p>\n                <p>Current last scanned message: ${n}<br>\n                Current message index: ${e}</p>\n                <div style="margin-top: 15px;">\n                    <label>Rescan from message: <input type="number" id="rescan-from" value="0" min="0" max="${e}" style="width: 80px; margin-left: 10px;"></label>\n                </div>\n                <div style="margin-top: 15px; text-align: right;">\n                    <button id="rescan-yes" class="menu_button">Rescan</button>\n                    <button id="rescan-no" class="menu_button">Skip</button>\n                </div>\n            </div>\n        `);$("body").append(r),r.find("#rescan-yes").on("click",()=>{const e=parseInt(r.find("#rescan-from").val())||0;r.remove(),t({rescan:!0,fromMessage:e})}),r.find("#rescan-no").on("click",()=>{r.remove(),t({rescan:!1})})})}(n,t);return e.rescan?((0,C.nT)("lastScannedMessageId",e.fromMessage-1),void q(async()=>{await Q(n-e.fromMessage+1,!0)})):void(0,C.nT)("lastScannedMessageId",n)}const r=(0,C.TJ)("messageFrequency",10);n-t>=r&&(L.log(),q(async()=>{await Q(r,!0),(0,C.nT)("lastScannedMessageId",n)}))})}function H(e,n,t=""){const r="name_tracker_progress",a=$(`.${r}`);if(a.length>0)return t&&a.find(".title").text(t),a.find(".progress").text(e),a.find(".total").text(n),void a.find("progress").val(e).attr("max",n);const o=$(`\n        <div class="${r} name_tracker_progress_bar flex-container justifyspacebetween alignitemscenter" style="\n            padding: 10px;\n            margin: 5px 0;\n            background: var(--SmartThemeBlurTintColor);\n            border: 1px solid var(--SmartThemeBorderColor);\n            border-radius: 5px;\n        ">\n            <div class="title" style="flex: 1; font-weight: bold;">${t||"Name Tracker Scan"}</div>\n            <div style="margin: 0 10px;">(<span class="progress">${e}</span> / <span class="total">${n}</span>)</div>\n            <progress value="${e}" max="${n}" style="flex: 2; margin: 0 10px;"></progress>\n            <button class="menu_button fa-solid fa-stop" title="Abort scan" style="padding: 5px 10px;"></button>\n        </div>\n    `);o.find("button").on("click",function(){F=!0,Y(),P.warning("Scan aborted by user")}),$("#sheld").append(o)}function Y(){const e=$(".name_tracker_progress");e.length>0&&e.fadeOut(300,function(){$(this).remove()})}async function q(e){return(0,y.Xc)("addToQueue",async()=>{j.push(e),U||await async function(){return(0,y.Xc)("processQueue",async()=>{if(!U&&0!==j.length){for(U=!0;j.length>0;){const e=j.shift();try{await e()}catch(e){console.error("Error processing queue task:",e)}}U=!1}})}()})}const G=(0,f.Xv)("ui"),K=new k.h("UI Management");function V(){return(0,y.Xc)("updateCharacterList",()=>{const e=$("#name_tracker_character_list");if(0===e.length)return void G.log();const n=(0,C.bg)();if(0===Object.keys(n).length)return void e.html('\n                <div class="name_tracker_no_characters">\n                    <p style="text-align: center; color: var(--SmartThemeQuoteColor);">\n                        No characters tracked yet. Start a conversation and character information will be extracted automatically!\n                    </p>\n                </div>\n            ');const t=Object.values(n).sort((e,n)=>e.isMainChar&&!n.isMainChar?-1:!e.isMainChar&&n.isMainChar?1:e.preferredName.localeCompare(n.preferredName));let r='<div class="name_tracker_character_list">';for(const e of t){const n=e.isMainChar?'<i class="fa-solid fa-user"></i>':"",t=e.ignored?'<span class="char-ignored-badge">IGNORED</span>':"",a=(0,v.pp)(e)?'<span class="char-review-badge">NEEDS REVIEW</span>':"",o=e.aliases&&e.aliases.length>0?`<div class="char-aliases">Aliases: ${(0,x.ZD)(e.aliases.join(", "))}</div>`:"",i=e.relationships&&e.relationships.length>0?`<div class="char-relationships">Relationships: ${(0,x.ZD)(e.relationships.join("; "))}</div>`:"",s=e.lastUpdated?new Date(e.lastUpdated).toLocaleString():"Never";r+=`\n                <div class="name_tracker_character_item" data-character="${(0,x.ZD)(e.preferredName)}">\n                    <div class="char-header">\n                        <span class="char-name">\n                            ${n}\n                            ${(0,x.ZD)(e.preferredName)}\n                            ${t}\n                            ${a}\n                        </span>\n                        <div class="char-actions">\n                            <button class="char-action-btn char-action-edit" data-name="${(0,x.ZD)(e.preferredName)}" title="Edit lorebook entry">\n                                <i class="fa-solid fa-edit"></i>\n                            </button>\n                            <button class="char-action-btn char-action-view" data-name="${(0,x.ZD)(e.preferredName)}" title="View in lorebook">\n                                <i class="fa-solid fa-book"></i>\n                            </button>\n                            <button class="char-action-btn char-action-merge" data-name="${(0,x.ZD)(e.preferredName)}" title="Merge with another character">\n                                <i class="fa-solid fa-code-merge"></i>\n                            </button>\n                            <button class="char-action-btn char-action-ignore" data-name="${(0,x.ZD)(e.preferredName)}" title="${e.ignored?"Unignore":"Ignore"} character">\n                                <i class="fa-solid ${e.ignored?"fa-eye":"fa-eye-slash"}"></i>\n                            </button>\n                        </div>\n                    </div>\n                    ${o}\n                    ${i}\n                    <div class="char-metadata">\n                        <span>Confidence: ${e.confidence}%</span>\n                        <span>Updated: ${s}</span>\n                    </div>\n                </div>\n            `}r+="</div>",e.html(r)})}function ee(){return(0,y.Xc)("updateStatusDisplay",()=>{const e=$("#name_tracker_status_display");if(0===e.length)return;const n=(0,C.bg)(),t=Object.keys(n).length,r=(0,C.PL)("messageCounter",0),a=(0,C.PL)("lastScannedMessageId",-1),o=(0,C.PL)("messageFrequency",10),i=b.r.getContext(),s=i?.chat?.length||0,c=Math.max(0,s-a),l=r>0?` (${r} analyzed)`:"",d=i.chat?i.chat.length:0,m=`\n            <div class="name_tracker_status">\n                <div class="status-item">\n                    <strong>Characters tracked:</strong> ${t}${l}\n                </div>\n                <div class="status-item">\n                    <strong>Messages in chat:</strong> ${d}\n                </div>\n                <div class="status-item">\n                    <strong>Last scanned message:</strong> ${a>=0?a+1:"None"}\n                </div>\n                <div class="status-item">\n                    <strong>Pending messages:</strong> ${c}\n                </div>\n                <div class="status-item">\n                    <strong>Messages until next scan:</strong> ${Math.max(0,o-(d-a))}\n                </div>\n            </div>\n        `;e.html(m)})}function ne(){return(0,y.Xc)("showCharacterListModal",()=>{const e=Object.values((0,C.bg)()||{});let n="";if(0===e.length)n='<p style="text-align: center; color: var(--SmartThemeQuoteColor);">No characters tracked yet</p>';else{e.sort((e,n)=>e.isMainChar&&!n.isMainChar?-1:!e.isMainChar&&n.isMainChar?1:e.preferredName.localeCompare(n.preferredName)),n='<div style="max-height: 400px; overflow-y: auto;">';for(const t of e){const e=[];t.isMainChar&&e.push('<span style="background: var(--SmartThemeBodyColor); padding: 2px 6px; border-radius: 3px; font-size: 0.85em; margin-left: 5px;">MAIN</span>'),t.ignored&&e.push('<span style="background: var(--black70a); padding: 2px 6px; border-radius: 3px; font-size: 0.85em; margin-left: 5px;">IGNORED</span>'),(0,v.pp)(t)&&e.push('<span style="background: var(--crimsonDark); padding: 2px 6px; border-radius: 3px; font-size: 0.85em; margin-left: 5px;">NEEDS REVIEW</span>');const r=t.aliases&&t.aliases.length>0?`<div style="font-size: 0.9em; color: var(--SmartThemeQuoteColor); margin-top: 3px;">Aliases: ${(0,x.ZD)(t.aliases.join(", "))}</div>`:"";n+=`\n                    <div style="padding: 10px; margin: 5px 0; background: var(--SmartThemeBlurTintColor); border: 1px solid var(--SmartThemeBorderColor); border-radius: 5px;">\n                        <div style="font-weight: bold;">\n                            ${t.isMainChar?'<i class="fa-solid fa-user" style="margin-right: 5px;"></i>':""}\n                            ${(0,x.ZD)(t.preferredName)}\n                            ${e.join("")}\n                        </div>\n                        ${r}\n                    </div>\n                `}n+="</div>"}const t=`\n            <div class="name-tracker-character-modal">\n                <h3 style="margin-top: 0;">Tracked Characters (${e.length})</h3>\n                ${n}\n                <div style="margin-top: 15px; text-align: center;">\n                    <button class="menu_button" onclick="$('#name_tracker_settings').find('.inline-drawer-toggle').click(); $(this).closest('.popup').remove();">\n                        <i class="fa-solid fa-gear"></i> Open Settings\n                    </button>\n                </div>\n            </div>\n        `,r=b.r.getContext();r.callGenericPopup(t,r.POPUP_TYPE.TEXT,"",{wider:!0,okButton:"Close"})})}function te(){return(0,y.Xc)("initializeUIHandlers",()=>{$(document).on("click",".char-action-merge",async function(){const e=$(this).data("name");await async function(e){return(0,y.Xc)("showMergeDialog",async()=>{const n=(0,C.bg)(),t=Object.keys(n).filter(n=>n!==e);if(0===t.length)return void K.warning("No other characters to merge with");const r=prompt(`Merge "${e}" into which character? Available: ${t.join(", ")}`);r&&n[r]?(await(0,v.lF)(e,r),V(),ee()):r&&K.error("Invalid target character name")})}(e)}),$(document).on("click",".char-action-ignore",async function(){const e=$(this).data("name");await(0,v.el)(e),V(),ee()}),$(document).on("click",".char-action-view",async function(){const e=$(this).data("name");await(0,R._Z)(e)}),$(document).on("click",".char-action-edit",async function(){const e=$(this).data("name");await async function(e){return(0,y.Xc)("showEditLorebookModal",async()=>{const n=(0,C.qN)(e);if(!n)return void K.error("Character not found");const t=[e,...n.aliases||[]].join(", "),r=`\n            <div class="lorebook-entry-editor">\n                <h3>Edit Lorebook Entry: ${(0,x.ZD)(e)}</h3>\n                \n                <div class="editor-section">\n                    <label for="entry-keys">Keys (comma-separated):</label>\n                    <input type="text" id="entry-keys" class="text_pole" value="${(0,x.ZD)(t)}" \n                           placeholder="${(0,x.ZD)(e)}, aliases, nicknames">\n                    <small>These words trigger this entry in the chat context</small>\n                </div>\n                \n                <div class="editor-section">\n                    <label for="entry-content">Entry Content:</label>\n                    <textarea id="entry-content" rows="10" class="text_pole" \n                              placeholder="Description, personality, background, relationships...">${(0,x.ZD)(n.notes||"")}</textarea>\n                    <small>This will be injected into context when keys are mentioned</small>\n                </div>\n                \n                <div class="editor-section">\n                    <label for="entry-relationships">Relationships:</label>\n                    <textarea id="entry-relationships" rows="3" class="text_pole" \n                              placeholder="Friend of Alice; Enemy of Bob; Works for XYZ Corp">${(0,x.ZD)((n.relationships||[]).join("; "))}</textarea>\n                    <small>One relationship per line or semicolon-separated</small>\n                </div>\n            </div>\n        `,a=$(`\n            <div class="nametracker-modal" style="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: var(--SmartThemeBlurTintColor);\n                border: 1px solid var(--SmartThemeBorderColor);\n                border-radius: 10px;\n                padding: 20px;\n                max-width: 600px;\n                width: 90%;\n                max-height: 80vh;\n                overflow-y: auto;\n                z-index: 9999;\n                box-shadow: 0 4px 20px rgba(0,0,0,0.5);\n            ">\n                ${r}\n                <div style="margin-top: 20px; text-align: right;">\n                    <button class="menu_button" id="entry-save">Save</button>\n                    <button class="menu_button" id="entry-cancel">Cancel</button>\n                </div>\n            </div>\n        `),o=$('\n            <div class="nametracker-overlay" style="\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.7);\n                z-index: 9998;\n            "></div>\n        ');$("body").append(o).append(a);const i=()=>{a.remove(),o.remove()};a.find("#entry-save").on("click",async()=>{const t=a.find("#entry-keys").val().split(",").map(e=>e.trim()).filter(e=>e),r=a.find("#entry-content").val(),o=a.find("#entry-relationships").val().split(/[;\\n]/).map(e=>e.trim()).filter(e=>e),s=t[0]||e,c=t.slice(1);n.preferredName=s,n.aliases=c,n.notes=r,n.relationships=o,s!==e&&(0,C.sr)(e),(0,C.e7)(s,n),V(),ee(),K.success(`Updated lorebook entry for ${s}`),i()}),a.find("#entry-cancel").on("click",i),o.on("click",i)})}(e)}),G.log()})}function re(e,n,t,r=null,a=""){return(0,y.Xc)("addMenuButton",()=>{const o=$(`\n            <div class="list-group-item flex-container flexGap5 interactable ${a}" title="${r||e}" tabindex="0">\n                <i class="${n}"></i>\n                <span>${e}</span>\n            </div>\n        `),i=$("#extensionsMenu");i.length?(o.appendTo(i),o.on("click",()=>t())):console.error("[Name Tracker] Could not find the extensions menu")})}function ae(){return(0,y.Xc)("toggleAutoHarvest",()=>{const e=(0,C.PL)("autoAnalyze",!0);(0,C.ZC)("autoAnalyze",!e),$("#name_tracker_auto_analyze").prop("checked",!e);const n=$("#extensionsMenu .name-tracker-toggle-harvest");e?n.find("i").removeClass("fa-toggle-on").addClass("fa-toggle-off"):n.find("i").removeClass("fa-toggle-off").addClass("fa-toggle-on"),ee(),K.success("Auto-harvest "+(e?"disabled":"enabled"))})}async function oe(){return(0,y.Xc)("openChatLorebook",async()=>{const e=b.r.getContext(),n=e.chatMetadata?.world_info;n?"function"==typeof e.openWorldInfoEditor?await e.openWorldInfoEditor(n):($("#WorldInfo").click(),K.info(`Please select "${n}" from the World Info panel`)):K.warning("No active chat or lorebook")})}function ie(){return(0,y.Xc)("initializeMenuButtons",()=>{re("Toggle Auto-Harvest",(0,C.PL)("autoAnalyze",!0)?"fa-solid fa-toggle-on":"fa-solid fa-toggle-off",ae,"Toggle automatic character harvesting on/off","name-tracker-toggle-harvest"),re("View Characters","fa-solid fa-users",ne,"View all tracked characters"),re("Open Chat Lorebook","fa-solid fa-book",oe,"Open the Name Tracker chat lorebook in the World Info editor"),G.log()})}function se(){return(0,y.Xc)("bindSettingsHandlers",()=>{$("#name_tracker_enabled").on("input",e=>{(0,C.ZC)("enabled",e.target.checked),ee()}),$("#name_tracker_auto_analyze").on("input",e=>{(0,C.ZC)("autoAnalyze",e.target.checked),ee()}),$("#name_tracker_message_frequency").on("input",e=>{(0,C.ZC)("messageFrequency",parseInt(e.target.value)||10),ee()}),$("#name_tracker_llm_source").on("change",e=>{(0,C.ZC)("llmSource",e.target.value)}),$("#name_tracker_ollama_endpoint").on("input",e=>{(0,C.ZC)("ollamaEndpoint",e.target.value)}),$("#name_tracker_ollama_model").on("change",e=>{(0,C.ZC)("ollamaModel",e.target.value)}),$("#name_tracker_load_models").on("click",async()=>{try{await async function(){return(0,y.Xc)("loadOllamaModels",async()=>{const e=(0,C.TJ)("ollamaEndpoint","http://localhost:11434");I(`[OllamaModels] Loading models from ${e}`);try{const n=await fetch(`${e}/api/tags`);if(!n.ok)throw new Error(`Failed to connect to Ollama: ${n.statusText}`);const t=await n.json();return S=t.models||[],I(`[OllamaModels] Found ${S.length} models: ${S.map(e=>e.name).join(", ")}`),S}catch(e){throw console.error("Error loading Ollama models:",e),B.error("Failed to load Ollama models. Check endpoint and try again."),e}})}(),K.success("Ollama models loaded")}catch(e){G.log(),K.error("Failed to load Ollama models")}}),$("#name_tracker_confidence_threshold").on("input",e=>{(0,C.ZC)("confidenceThreshold",parseInt(e.target.value)||70)}),$("#name_tracker_lorebook_position").on("change",e=>{(0,C.ZC)("lorebookPosition",parseInt(e.target.value)||0)}),$("#name_tracker_lorebook_depth").on("input",e=>{(0,C.ZC)("lorebookDepth",parseInt(e.target.value)||1)}),$("#name_tracker_lorebook_cooldown").on("input",e=>{(0,C.ZC)("lorebookCooldown",parseInt(e.target.value)||5)}),$("#name_tracker_lorebook_probability").on("input",e=>{(0,C.ZC)("lorebookProbability",parseInt(e.target.value)||100)}),$("#name_tracker_lorebook_enabled").on("input",e=>{(0,C.ZC)("lorebookEnabled",e.target.checked)}),$("#name_tracker_debug_mode").on("input",e=>{(0,C.ZC)("debugMode",e.target.checked)}),$("#name_tracker_manual_analyze").on("click",async()=>{const e=(0,C.PL)("messageFrequency",10);await Q(e,!0),V(),ee()}),$("#name_tracker_scan_all").on("click",async()=>{await async function(){return(0,y.Xc)("scanEntireChat",async()=>{const e=b.r.getContext();if(!e.chat||0===e.chat.length)return void P.warning("No chat messages to scan");if("sillytavern"===(0,C.eU)().source&&!e.onlineStatus)return void P.warning("Please connect to an API (OpenAI, Claude, etc.) before analyzing messages");const n=e.chat.length,t=await M()-1e3,r=[];let a=[],o=0;for(let i=0;i<n;i++){const n=e.chat[i],s=await O([n]);o+s>t&&a.length>0?(r.push(a),a=[n],o=s):(a.push(n),o+=s)}a.length>0&&r.push(a);const i=r.length;if(!confirm(`This will analyze all ${n} messages in ${i} batches. This may take a while. Continue?`))return;F=!1,H(0,i,"Starting batch scan...");let s=0,c=0;const l=new Set;for(let e=0;e<i;e++){if(F){L.log();break}const n=r[e],t=r.slice(0,e).reduce((e,n)=>e+n.length,0),a=t+n.length;try{H(e+1,i,`Processing messages ${t+1}-${a}...`);const r=E(),o=await z(n,r);o.characters&&Array.isArray(o.characters)&&(await W(o.characters),o.characters.forEach(e=>l.add(e.name))),s++,e<i-1&&await new Promise(e=>setTimeout(e,1e3))}catch(n){if(console.error(`Error processing batch ${e+1}:`,n),c++,!confirm(`Batch ${e+1} failed.\n\nError: ${n.message}\n\nContinue with remaining batches?`))break}}Y(),(0,C.nT)("lastScannedMessageId",n-1);const d=`Full chat scan complete!\n\nMessages: ${n}\nBatches: ${s}/${i}\nCharacters found: ${l.size}\nFailed: ${c}`;c>0?P.warning(d,{timeOut:1e4}):P.success(d,{timeOut:1e4})})}(),V(),ee()}),$("#name_tracker_create_character").on("click",()=>{!async function(){(0,y.Xc)("showCreateCharacterModal",async()=>{const e=prompt("Enter character name:");if(e&&e.trim())try{await(0,v.g9)(e.trim()),V(),ee()}catch(e){K.error(e.message)}})}()}),$("#name_tracker_clear_cache").on("click",()=>{j=[],U=!1,L.log(),K.info("Cache and processing queue cleared")}),$("#name_tracker_undo_merge").on("click",async()=>{const{undoLastMerge:e}=await Promise.resolve().then(t.bind(t,551));await e()&&(V(),ee())}),$("#name_tracker_purge_entries").on("click",()=>{!async function(){(0,y.Xc)("showPurgeConfirmation",async()=>{const e=(0,C.bg)(),n=Object.keys(e).length;if(0!==n){if(confirm(`This will delete all ${n} tracked characters and their lorebook entries.\\n\\nThis action cannot be undone!\\n\\nContinue?`))try{const e=await(0,v.vu)();V(),ee(),K.success(`Purged ${e} characters`)}catch(e){K.error(`Failed to purge characters: ${e.message}`)}}else K.info("No characters to purge")})}()}),$("#name_tracker_edit_prompt").on("click",()=>{!async function(){(0,y.Xc)("showSystemPromptEditor",async()=>{const e=(0,C.PL)("systemPrompt")||"",n=$(`\n            <div class="nametracker-modal" style="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: var(--SmartThemeBlurTintColor);\n                border: 1px solid var(--SmartThemeBorderColor);\n                border-radius: 10px;\n                padding: 20px;\n                max-width: 700px;\n                width: 90%;\n                max-height: 80vh;\n                overflow-y: auto;\n                z-index: 9999;\n                box-shadow: 0 4px 20px rgba(0,0,0,0.5);\n            ">\n                <h3 style="margin-top: 0;">Edit System Prompt</h3>\n                <p>Customize the system prompt used for character analysis. Leave blank to use default.</p>\n                <textarea id="system_prompt_editor" rows="20" style="width: 100%; margin: 10px 0;" \n                          placeholder="Enter custom system prompt or leave blank for default...">${(0,x.ZD)(e)}</textarea>\n                <div style="margin-top: 20px; text-align: right;">\n                    <button class="menu_button" id="system_prompt_save">Save</button>\n                    <button class="menu_button" id="system_prompt_reset">Reset to Default</button>\n                    <button class="menu_button" id="system_prompt_cancel">Cancel</button>\n                </div>\n            </div>\n        `),t=$('\n            <div class="nametracker-overlay" style="\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.7);\n                z-index: 9998;\n            "></div>\n        ');$("body").append(t).append(n);const r=()=>{n.remove(),t.remove()};n.find("#system_prompt_save").on("click",()=>{const e=n.find("#system_prompt_editor").val().trim();(0,C.ZC)("systemPrompt",e||null),K.success("System prompt updated"),r()}),n.find("#system_prompt_reset").on("click",()=>{n.find("#system_prompt_editor").val(""),(0,C.ZC)("systemPrompt",null),K.success("Reset to default system prompt"),r()}),n.find("#system_prompt_cancel").on("click",r),t.on("click",r)})}()}),$("#name_tracker_debug_status").on("click",()=>{(0,y.Xc)("showDebugStatus",()=>{const e=(0,b.r)(),n=(0,C.TJ)(),t=(0,C.bg)(),r={MIN_MESSAGES_PER_BATCH:5,TARGET_MESSAGES_PER_BATCH:30,MAX_MESSAGES_PER_BATCH:50,CONTEXT_TARGET_PERCENT:80,MIN_CONTEXT_TARGET:50},a={"Extension Status":{Enabled:!1!==n.enabled,"Debug Mode":!1!==n.debugMode,"LLM Source":n.llmSource||"sillytavern","Tracked Characters":Object.keys(t).length,"Chat Loaded":!!e?.chatId},"Batch Configuration":{"Min Messages/Batch":r.MIN_MESSAGES_PER_BATCH,"Target Messages/Batch":r.TARGET_MESSAGES_PER_BATCH,"Max Messages/Batch":r.MAX_MESSAGES_PER_BATCH,"Context Target %":r.CONTEXT_TARGET_PERCENT,"Min Context Target":r.MIN_CONTEXT_TARGET},"Analysis Settings":{"Message Frequency":n.messageFrequency||10,"Auto-Analyze":!1!==n.autoAnalyze,"Confidence Threshold":n.confidenceThreshold||70},"Lorebook Settings":{Position:["After Char","Before Char","Top","Bottom"][n.lorebookPosition||0],Depth:n.lorebookDepth||1,Cooldown:n.lorebookCooldown||5,"Probability %":n.lorebookProbability||100,Enabled:!1!==n.lorebookEnabled},"Current Chat":{"Chat ID":e?.chatId||"None",Character:e?.characters?.[0]?.name||"None","Messages Count":e?.chat?.length||0}};let o='<div style="font-family: monospace; font-size: 12px; max-height: 500px; overflow-y: auto;">';for(const[e,n]of Object.entries(a)){o+='<div style="margin-bottom: 15px; border-bottom: 1px solid var(--SmartThemeBorderColor); padding-bottom: 10px;">',o+=`<strong style="color: var(--SmartThemeQuoteColor);">${e}</strong><br>`;for(const[e,t]of Object.entries(n))o+=`<div style="margin-left: 10px; padding: 2px 0;">\n                    <span style="color: var(--SmartThemeBorderColor);">${e}:</span> \n                    <span style="color: var(--SmartThemeMainColor);">${!0===t?"":!1===t?"":t}</span>\n                </div>`;o+="</div>"}o+="</div>";const i=$(`\n            <div class="nametracker-modal" style="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: var(--SmartThemeBlurTintColor);\n                border: 2px solid var(--SmartThemeMainColor);\n                border-radius: 10px;\n                padding: 20px;\n                max-width: 500px;\n                width: 90%;\n                max-height: 70vh;\n                overflow-y: auto;\n                z-index: 9999;\n                box-shadow: 0 4px 20px rgba(0,0,0,0.5);\n            ">\n                <h3 style="margin-top: 0; color: var(--SmartThemeMainColor);">\n                    <i class="fa-solid fa-bug"></i> Debug Status\n                </h3>\n                ${o}\n                <div style="margin-top: 20px; text-align: right; border-top: 1px solid var(--SmartThemeBorderColor); padding-top: 10px;">\n                    <button class="menu_button" id="debug-close">Close</button>\n                </div>\n            </div>\n        `),s=$('\n            <div class="nametracker-overlay" style="\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.7);\n                z-index: 9998;\n            "></div>\n        ');$("body").append(s).append(i);const c=()=>{i.remove(),s.remove()};i.find("#debug-close").on("click",c),s.on("click",c),console.log("[NT-Debug]",a)})}),G.log()})}function ce(){return(0,y.Xc)("updateUI",()=>{$("#name_tracker_enabled").prop("checked",(0,C.PL)("enabled",!0)),$("#name_tracker_auto_analyze").prop("checked",(0,C.PL)("autoAnalyze",!0)),$("#name_tracker_message_frequency").val((0,C.PL)("messageFrequency",10)),$("#name_tracker_llm_source").val((0,C.PL)("llmSource","sillytavern")),$("#name_tracker_ollama_endpoint").val((0,C.PL)("ollamaEndpoint","http://localhost:11434")),$("#name_tracker_ollama_model").val((0,C.PL)("ollamaModel","")),$("#name_tracker_confidence_threshold").val((0,C.PL)("confidenceThreshold",70)),$("#name_tracker_lorebook_position").val((0,C.PL)("lorebookPosition",0)),$("#name_tracker_lorebook_depth").val((0,C.PL)("lorebookDepth",1)),$("#name_tracker_lorebook_cooldown").val((0,C.PL)("lorebookCooldown",5)),$("#name_tracker_lorebook_probability").val((0,C.PL)("lorebookProbability",100)),$("#name_tracker_lorebook_enabled").prop("checked",(0,C.PL)("lorebookEnabled",!0)),$("#name_tracker_debug_mode").prop("checked",(0,C.PL)("debugMode",!1)),V(),ee(),G.log()})}console.log("[STnametracker] Main index.js: Import validation"),console.log("[STnametracker] Main index.js: initializeLorebook import =",typeof R.WF,R.WF),console.log("[STnametracker] Main index.js: initializeUIHandlers import =",typeof te,te),console.log("[STnametracker] Main index.js: initializeMenuButtons import =",typeof ie,ie),console.log("[STnametracker] Main index.js: bindSettingsHandlers import =",typeof se,se),console.log("[STnametracker] Main index.js: updateUI import =",typeof ce,ce),"function"!=typeof R.WF&&(console.error("[STnametracker] Main index.js: CRITICAL ERROR - initializeLorebook import failed!"),console.error("[STnametracker] Main index.js: Expected function, got:",typeof R.WF,R.WF));const le="STnametracker",de=`scripts/extensions/third-party/${le}`;const me=f.Ay.createModuleLogger("Main");const ge=new class{constructor(){this.initialized=!1,this.modules=new Map}async initialize(){return console.log("[STnametracker] Enter initialize() method"),y.r_.withErrorBoundary("Main",async()=>{console.log("[STnametracker] Inside error boundary"),this.initialized?console.log("[STnametracker] Already initialized, skipping"):(console.log("[STnametracker] Starting initialization sequence"),me.log("Starting Name Tracker Extension v2.1.0"),console.log("[STnametracker] Step 1: Initializing core systems..."),await this.initializeCore(),console.log("[STnametracker] Step 1: Core systems completed"),console.log("[STnametracker] Step 2: Initializing feature modules..."),await this.initializeModules(),console.log("[STnametracker] Step 2: Feature modules completed"),console.log("[STnametracker] Step 3: Initializing UI..."),await this.initializeUI(),console.log("[STnametracker] Step 3: UI completed"),console.log("[STnametracker] Step 4: Registering event listeners..."),this.registerEventListeners(),console.log("[STnametracker] Step 4: Event listeners completed"),this.initialized=!0,console.log("[STnametracker] Marking as initialized"),me.log("Name Tracker Extension initialized successfully"),console.log("[STnametracker] Full initialization sequence completed successfully"))},{retries:2,fallback:async e=>(me.error("Failed to initialize extension:",e),k.A.error("Failed to initialize","Extension Error"),!1)})}async initializeCore(){console.log("[STnametracker] initializeCore: Starting..."),me.debug("Initializing core systems..."),console.log("[STnametracker] initializeCore: Connecting debug system..."),f.Ay.isDebugEnabled=()=>(0,C.PL)("debugMode",!1),console.log("[STnametracker] initializeCore: Debug system connected"),console.log("[STnametracker] initializeCore: Settings ready"),this.setupErrorRecovery(),me.debug("Core systems initialized")}async initializeModules(){if(me.debug("Initializing feature modules..."),console.log("[STnametracker] initializeModules: Starting module initialization"),console.log("[STnametracker] initializeModules: Checking import of initializeLorebook..."),console.log("[STnametracker] initializeModules: initializeLorebook =",typeof R.WF,R.WF),"function"!=typeof R.WF)throw console.error("[STnametracker] initializeModules: CRITICAL - initializeLorebook is not a function!"),console.error("[STnametracker] initializeModules: Type:",typeof R.WF),console.error("[STnametracker] initializeModules: Value:",R.WF),new Error("initializeLorebook is not a function: "+typeof R.WF);try{console.log("[STnametracker] initializeModules: About to call initializeLorebook()..."),await(0,R.WF)(),console.log("[STnametracker] initializeModules: initializeLorebook() completed successfully"),me.debug("Feature modules initialized")}catch(e){throw console.error("[STnametracker] initializeModules: Error in initializeLorebook:",e),me.error("Failed to initialize feature modules:",e),e}}async initializeUI(){console.log("[STnametracker] initializeUI: Starting UI initialization..."),me.debug("Initializing UI...");try{console.log("[STnametracker] initializeUI: Loading settings HTML from:",`${de}/settings.html`);const e=await $.get(`${de}/settings.html`);console.log("[STnametracker] initializeUI: Settings HTML loaded, length:",e.length),console.log("[STnametracker] initializeUI: Finding #extensions_settings element...");const n=$("#extensions_settings");console.log("[STnametracker] initializeUI: Target element found:",n.length>0),n.append(e),console.log("[STnametracker] initializeUI: Settings HTML appended"),console.log("[STnametracker] initializeUI: Initializing UI handlers..."),te(),console.log("[STnametracker] initializeUI: UI handlers initialized"),console.log("[STnametracker] initializeUI: Initializing menu buttons..."),ie(),console.log("[STnametracker] initializeUI: Menu buttons initialized"),console.log("[STnametracker] initializeUI: Binding settings handlers..."),se(),console.log("[STnametracker] initializeUI: Settings handlers bound"),console.log("[STnametracker] initializeUI: Updating UI..."),ce(),console.log("[STnametracker] initializeUI: UI updated"),me.debug("UI initialized")}catch(e){throw me.error("Failed to initialize UI:",e),e}}registerEventListeners(){me.debug("Registering event listeners...");try{const e=b.A.getContext(),n=e.eventSource,t=e.event_types;if(!n||!t)return void me.warn("SillyTavern event system not available");n.on(t.MESSAGE_RECEIVED,async e=>{me.debug("Message received event:",e),await J()}),n.on(t.MESSAGE_SENT,async e=>{me.debug("Message sent event:",e),await J()}),n.on(t.CHAT_CHANGED,async()=>{me.debug("Chat changed event received"),(0,C.nF)({characters:{},lastScannedMessageId:-1})}),me.debug("Event listeners registered")}catch(e){me.error("Failed to register event listeners:",e)}}setupErrorRecovery(){y.r_.registerRecoveryStrategy("NETWORK_ERROR",async e=>(me.warn("Attempting network error recovery"),await y.r_.delay(2e3),k.A.info("Retrying network operation..."),null)),y.r_.registerRecoveryStrategy("DATA_FORMAT_ERROR",async e=>(me.warn("Data format error, clearing cache"),null)),y.r_.onCriticalError(e=>{me.error("Critical error occurred:",e)})}getStatus(){return{initialized:this.initialized,context:b.A.getStatus(),settings:{initialized:!0,moduleCount:Object.keys((0,C.TJ)()).length},debug:f.Ay.getPerformanceSummary(),errors:y.r_.getRecentErrors(5).length}}async shutdown(){return y.r_.withErrorBoundary("Main",async()=>{me.log("Shutting down Name Tracker Extension"),this.initialized=!1,f.Ay.clear(),me.log("Extension shutdown complete")},{silent:!0})}};jQuery(async()=>{console.log("[STnametracker] jQuery ready, starting extension load...");try{console.log("[STnametracker] Logger available, initializing..."),me.log("Name Tracker Extension loading..."),console.log("[STnametracker] Setting up extension_settings..."),window.extension_settings||(console.log("[STnametracker] Creating window.extension_settings"),window.extension_settings={}),console.log("[STnametracker] Current extension_settings keys:",Object.keys(window.extension_settings)),window.extension_settings[le]=window.extension_settings[le]||{},console.log("[STnametracker] Extension settings initialized"),console.log("[STnametracker] Starting main initialization..."),await ge.initialize(),console.log("[STnametracker] Main initialization completed"),window.nameTrackerExtension=ge,window.ntDebug={status:()=>ge.getStatus(),errors:()=>y.r_.getRecentErrors(),settings:()=>(0,C.TJ)(),chatData:()=>(0,C.zB)(),clear:()=>f.Ay.clear()},me.log("Name Tracker Extension loaded successfully"),console.log("[STnametracker] Extension loaded. Use ntDebug.status() for diagnostics.")}catch(e){console.error("[STnametracker] Failed to initialize:",e),k.A.error("Extension failed to load","Critical Error")}})})();
//# sourceMappingURL=index.js.map