(()=>{"use strict";var e={56(e,t,n){e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},72(e){var t=[];function n(e){for(var n=-1,r=0;r<t.length;r++)if(t[r].identifier===e){n=r;break}return n}function r(e,r){for(var a={},s=[],i=0;i<e.length;i++){var l=e[i],c=r.base?l[0]+r.base:l[0],d=a[c]||0,g="".concat(c," ").concat(d);a[c]=d+1;var m=n(g),h={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==m)t[m].references++,t[m].updater(h);else{var p=o(h,r);r.byIndex=i,t.splice(i,0,{identifier:g,updater:p,references:1})}s.push(g)}return s}function o(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,o){var a=r(e=e||[],o=o||{});return function(e){e=e||[];for(var s=0;s<a.length;s++){var i=n(a[s]);t[i].references--}for(var l=r(e,o),c=0;c<a.length;c++){var d=n(a[c]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}a=l}}},83(e,t,n){n.d(t,{A:()=>i});var r=n(354),o=n.n(r),a=n(314),s=n.n(a)()(o());s.push([e.id,"/* Styles for the Name Tracker extension */\n\n.name-tracker-settings {\n    padding: 5px;\n}\n\n.name-tracker_block {\n    margin-bottom: 10px;\n}\n\n.name-tracker_block h4 {\n    margin-top: 10px;\n    margin-bottom: 10px;\n    font-weight: bold;\n}\n\n/* Status Display */\n.name-tracker-status-block {\n    background-color: var(--SmartThemeBlurTintColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    padding: 10px;\n}\n\n.name-tracker-status {\n    font-weight: bold;\n    color: var(--SmartThemeBodyColor);\n    padding: 5px;\n    text-align: center;\n}\n\n/* Character List */\n.name-tracker-character-list {\n    max-height: 400px;\n    overflow-y: auto;\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    padding: 5px;\n    margin-top: 5px;\n}\n\n.name-tracker-character {\n    padding: 10px;\n    margin-bottom: 10px;\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    background-color: var(--SmartThemeBlurTintColor);\n}\n\n.name-tracker-character:last-child {\n    margin-bottom: 0;\n}\n\n/* Active/loaded character styling (characters that are loaded in SillyTavern) */\n.name-tracker-character.main-character {\n    border-left: 3px solid #4CAF50;\n    background-color: rgba(76, 175, 80, 0.05);\n}\n\n.character-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 5px;\n}\n\n.character-name {\n    font-weight: bold;\n    font-size: 1.1em;\n    color: var(--SmartThemeBodyColor);\n}\n\n.character-name .fa-user {\n    color: #4CAF50;\n    margin-right: 5px;\n}\n\n.character-name.ignored {\n    color: var(--SmartThemeQuoteColor);\n    text-decoration: line-through;\n}\n\n.character-badge {\n    display: inline-block;\n    padding: 2px 8px;\n    border-radius: 3px;\n    font-size: 0.75em;\n    font-weight: bold;\n    margin-left: 5px;\n}\n\n.character-badge.main-char {\n    background-color: #4CAF50;\n    color: #fff;\n}\n\n.character-badge.ignored {\n    background-color: #666;\n    color: #fff;\n}\n\n.character-badge.unresolved {\n    background-color: #ff9800;\n    color: #000;\n}\n\n/* Lorebook entry editor modal */\n.lorebook-entry-editor h3 {\n    margin-top: 0;\n    margin-bottom: 20px;\n    color: var(--SmartThemeBodyColor);\n}\n\n.editor-section {\n    margin-bottom: 15px;\n}\n\n.editor-section label {\n    display: block;\n    font-weight: bold;\n    margin-bottom: 5px;\n    color: var(--SmartThemeBodyColor);\n}\n\n.editor-section small {\n    display: block;\n    margin-top: 3px;\n    color: var(--SmartThemeQuoteColor);\n    font-size: 0.85em;\n}\n\n.editor-section input,\n.editor-section textarea {\n    width: 100%;\n    box-sizing: border-box;\n}\n\n.character-aliases {\n    font-size: 0.9em;\n    color: var(--SmartThemeQuoteColor);\n    margin-bottom: 8px;\n    font-style: italic;\n}\n\n.lorebook-entry-id {\n    display: inline-block;\n    margin-left: 10px;\n    padding: 2px 6px;\n    background: var(--SmartThemeBlurTintColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 3px;\n    font-family: monospace;\n    font-size: 0.85em;\n    font-style: normal;\n    color: var(--SmartThemeQuoteColor);\n}\n\n.character-details {\n    font-size: 0.85em;\n    color: var(--SmartThemeBodyColor);\n    margin: 8px 0;\n    padding: 8px;\n    background: var(--SmartThemeBlurTintColor);\n    border-left: 2px solid var(--SmartThemeBorderColor);\n    border-radius: 3px;\n    line-height: 1.4;\n}\n\n.character-actions {\n    display: flex;\n    gap: 5px;\n    flex-wrap: wrap;\n    margin-top: 8px;\n}\n\n.character-actions .menu_button {\n    flex: 1;\n    min-width: 100px;\n    padding: 5px 10px;\n    font-size: 0.9em;\n}\n\n.menu_button.compact {\n    padding: 5px 10px;\n    font-size: 0.9em;\n}\n\n.name-tracker-empty {\n    color: var(--SmartThemeQuoteColor);\n    font-style: italic;\n    text-align: center;\n    padding: 20px;\n}\n\n/* Ollama Settings */\n.ollama-settings {\n    background-color: var(--SmartThemeBlurTintColor);\n    border-left: 3px solid var(--SmartThemeBorderColor);\n    padding: 10px;\n    margin-top: 5px;\n    border-radius: 5px;\n}\n\n/* Merge Dialog */\n.merge-dialog {\n    padding: 15px;\n}\n\n.merge-dialog p {\n    margin-bottom: 10px;\n}\n\n.merge-dialog strong {\n    color: var(--SmartThemeBodyColor);\n    font-weight: bold;\n}\n\n.merge-warning {\n    color: #ff9800;\n    font-size: 0.9em;\n    margin-top: 10px;\n    padding: 10px;\n    background-color: rgba(255, 152, 0, 0.1);\n    border-left: 3px solid #ff9800;\n    border-radius: 3px;\n}\n\n/* Button states */\nbutton:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n}\n\n/* Flex utilities */\n.flexGap5 {\n    gap: 5px;\n}\n\n.flex1 {\n    flex: 1;\n}\n\n/* Progress indicator */\n.name-tracker-progress {\n    margin: 10px 0;\n    padding: 10px;\n    background-color: var(--SmartThemeBlurTintColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    text-align: center;\n}\n\n.name-tracker-progress .progress-text {\n    margin-bottom: 5px;\n    font-weight: bold;\n}\n\n.name-tracker-progress .progress-bar {\n    width: 100%;\n    height: 20px;\n    background-color: var(--black50a);\n    border-radius: 10px;\n    overflow: hidden;\n}\n\n.name-tracker-progress .progress-fill {\n    height: 100%;\n    background-color: var(--SmartThemeQuoteColor);\n    transition: width 0.3s ease;\n}\n\n/* Character details preview (for potential future use) */\n.character-details {\n    display: none;\n    margin-top: 10px;\n    padding: 10px;\n    background-color: var(--black30a);\n    border-radius: 5px;\n    font-size: 0.9em;\n}\n\n.character-details.expanded {\n    display: block;\n}\n\n.character-details-section {\n    margin-bottom: 8px;\n}\n\n.character-details-section:last-child {\n    margin-bottom: 0;\n}\n\n.character-details-label {\n    font-weight: bold;\n    color: var(--SmartThemeQuoteColor);\n    margin-right: 5px;\n}\n\n/* Responsive adjustments */\n@media (max-width: 768px) {\n    .character-actions {\n        flex-direction: column;\n    }\n    \n    .character-actions .menu_button {\n        width: 100%;\n    }\n}\n\n/* Animation for new characters */\n@keyframes fadeIn {\n    from {\n        opacity: 0;\n        transform: translateY(-10px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.name-tracker-character.new {\n    animation: fadeIn 0.3s ease;\n}\n\n/* System Prompt Editor */\n.system-prompt-editor h3 {\n    margin-top: 0;\n    margin-bottom: 10px;\n    color: var(--SmartThemeBodyColor);\n}\n\n.system-prompt-editor p {\n    margin-bottom: 10px;\n    color: var(--SmartThemeQuoteColor);\n    font-size: 0.9em;\n}\n\n#system_prompt_editor {\n    background-color: var(--SmartThemeBlurTintColor);\n    color: var(--SmartThemeBodyColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 3px;\n    padding: 10px;\n    resize: vertical;\n}\n\n#system_prompt_editor:focus {\n    outline: none;\n    border-color: var(--SmartThemeEmColor);\n}\n\n.system-prompt-actions button {\n    min-width: 100px;\n}\n\n#system_prompt_reset {\n    margin-right: auto;\n}\n\n\n","",{version:3,sources:["webpack://./style.css"],names:[],mappings:"AAAA,0CAA0C;;AAE1C;IACI,YAAY;AAChB;;AAEA;IACI,mBAAmB;AACvB;;AAEA;IACI,gBAAgB;IAChB,mBAAmB;IACnB,iBAAiB;AACrB;;AAEA,mBAAmB;AACnB;IACI,gDAAgD;IAChD,8CAA8C;IAC9C,kBAAkB;IAClB,aAAa;AACjB;;AAEA;IACI,iBAAiB;IACjB,iCAAiC;IACjC,YAAY;IACZ,kBAAkB;AACtB;;AAEA,mBAAmB;AACnB;IACI,iBAAiB;IACjB,gBAAgB;IAChB,8CAA8C;IAC9C,kBAAkB;IAClB,YAAY;IACZ,eAAe;AACnB;;AAEA;IACI,aAAa;IACb,mBAAmB;IACnB,8CAA8C;IAC9C,kBAAkB;IAClB,gDAAgD;AACpD;;AAEA;IACI,gBAAgB;AACpB;;AAEA,gFAAgF;AAChF;IACI,8BAA8B;IAC9B,yCAAyC;AAC7C;;AAEA;IACI,aAAa;IACb,8BAA8B;IAC9B,mBAAmB;IACnB,kBAAkB;AACtB;;AAEA;IACI,iBAAiB;IACjB,gBAAgB;IAChB,iCAAiC;AACrC;;AAEA;IACI,cAAc;IACd,iBAAiB;AACrB;;AAEA;IACI,kCAAkC;IAClC,6BAA6B;AACjC;;AAEA;IACI,qBAAqB;IACrB,gBAAgB;IAChB,kBAAkB;IAClB,iBAAiB;IACjB,iBAAiB;IACjB,gBAAgB;AACpB;;AAEA;IACI,yBAAyB;IACzB,WAAW;AACf;;AAEA;IACI,sBAAsB;IACtB,WAAW;AACf;;AAEA;IACI,yBAAyB;IACzB,WAAW;AACf;;AAEA,gCAAgC;AAChC;IACI,aAAa;IACb,mBAAmB;IACnB,iCAAiC;AACrC;;AAEA;IACI,mBAAmB;AACvB;;AAEA;IACI,cAAc;IACd,iBAAiB;IACjB,kBAAkB;IAClB,iCAAiC;AACrC;;AAEA;IACI,cAAc;IACd,eAAe;IACf,kCAAkC;IAClC,iBAAiB;AACrB;;AAEA;;IAEI,WAAW;IACX,sBAAsB;AAC1B;;AAEA;IACI,gBAAgB;IAChB,kCAAkC;IAClC,kBAAkB;IAClB,kBAAkB;AACtB;;AAEA;IACI,qBAAqB;IACrB,iBAAiB;IACjB,gBAAgB;IAChB,0CAA0C;IAC1C,8CAA8C;IAC9C,kBAAkB;IAClB,sBAAsB;IACtB,iBAAiB;IACjB,kBAAkB;IAClB,kCAAkC;AACtC;;AAEA;IACI,iBAAiB;IACjB,iCAAiC;IACjC,aAAa;IACb,YAAY;IACZ,0CAA0C;IAC1C,mDAAmD;IACnD,kBAAkB;IAClB,gBAAgB;AACpB;;AAEA;IACI,aAAa;IACb,QAAQ;IACR,eAAe;IACf,eAAe;AACnB;;AAEA;IACI,OAAO;IACP,gBAAgB;IAChB,iBAAiB;IACjB,gBAAgB;AACpB;;AAEA;IACI,iBAAiB;IACjB,gBAAgB;AACpB;;AAEA;IACI,kCAAkC;IAClC,kBAAkB;IAClB,kBAAkB;IAClB,aAAa;AACjB;;AAEA,oBAAoB;AACpB;IACI,gDAAgD;IAChD,mDAAmD;IACnD,aAAa;IACb,eAAe;IACf,kBAAkB;AACtB;;AAEA,iBAAiB;AACjB;IACI,aAAa;AACjB;;AAEA;IACI,mBAAmB;AACvB;;AAEA;IACI,iCAAiC;IACjC,iBAAiB;AACrB;;AAEA;IACI,cAAc;IACd,gBAAgB;IAChB,gBAAgB;IAChB,aAAa;IACb,wCAAwC;IACxC,8BAA8B;IAC9B,kBAAkB;AACtB;;AAEA,kBAAkB;AAClB;IACI,YAAY;IACZ,mBAAmB;AACvB;;AAEA,mBAAmB;AACnB;IACI,QAAQ;AACZ;;AAEA;IACI,OAAO;AACX;;AAEA,uBAAuB;AACvB;IACI,cAAc;IACd,aAAa;IACb,gDAAgD;IAChD,8CAA8C;IAC9C,kBAAkB;IAClB,kBAAkB;AACtB;;AAEA;IACI,kBAAkB;IAClB,iBAAiB;AACrB;;AAEA;IACI,WAAW;IACX,YAAY;IACZ,iCAAiC;IACjC,mBAAmB;IACnB,gBAAgB;AACpB;;AAEA;IACI,YAAY;IACZ,6CAA6C;IAC7C,2BAA2B;AAC/B;;AAEA,yDAAyD;AACzD;IACI,aAAa;IACb,gBAAgB;IAChB,aAAa;IACb,iCAAiC;IACjC,kBAAkB;IAClB,gBAAgB;AACpB;;AAEA;IACI,cAAc;AAClB;;AAEA;IACI,kBAAkB;AACtB;;AAEA;IACI,gBAAgB;AACpB;;AAEA;IACI,iBAAiB;IACjB,kCAAkC;IAClC,iBAAiB;AACrB;;AAEA,2BAA2B;AAC3B;IACI;QACI,sBAAsB;IAC1B;;IAEA;QACI,WAAW;IACf;AACJ;;AAEA,iCAAiC;AACjC;IACI;QACI,UAAU;QACV,4BAA4B;IAChC;IACA;QACI,UAAU;QACV,wBAAwB;IAC5B;AACJ;;AAEA;IACI,2BAA2B;AAC/B;;AAEA,yBAAyB;AACzB;IACI,aAAa;IACb,mBAAmB;IACnB,iCAAiC;AACrC;;AAEA;IACI,mBAAmB;IACnB,kCAAkC;IAClC,gBAAgB;AACpB;;AAEA;IACI,gDAAgD;IAChD,iCAAiC;IACjC,8CAA8C;IAC9C,kBAAkB;IAClB,aAAa;IACb,gBAAgB;AACpB;;AAEA;IACI,aAAa;IACb,sCAAsC;AAC1C;;AAEA;IACI,gBAAgB;AACpB;;AAEA;IACI,kBAAkB;AACtB",sourcesContent:["/* Styles for the Name Tracker extension */\r\n\r\n.name-tracker-settings {\r\n    padding: 5px;\r\n}\r\n\r\n.name-tracker_block {\r\n    margin-bottom: 10px;\r\n}\r\n\r\n.name-tracker_block h4 {\r\n    margin-top: 10px;\r\n    margin-bottom: 10px;\r\n    font-weight: bold;\r\n}\r\n\r\n/* Status Display */\r\n.name-tracker-status-block {\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    padding: 10px;\r\n}\r\n\r\n.name-tracker-status {\r\n    font-weight: bold;\r\n    color: var(--SmartThemeBodyColor);\r\n    padding: 5px;\r\n    text-align: center;\r\n}\r\n\r\n/* Character List */\r\n.name-tracker-character-list {\r\n    max-height: 400px;\r\n    overflow-y: auto;\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    padding: 5px;\r\n    margin-top: 5px;\r\n}\r\n\r\n.name-tracker-character {\r\n    padding: 10px;\r\n    margin-bottom: 10px;\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n}\r\n\r\n.name-tracker-character:last-child {\r\n    margin-bottom: 0;\r\n}\r\n\r\n/* Active/loaded character styling (characters that are loaded in SillyTavern) */\r\n.name-tracker-character.main-character {\r\n    border-left: 3px solid #4CAF50;\r\n    background-color: rgba(76, 175, 80, 0.05);\r\n}\r\n\r\n.character-header {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    margin-bottom: 5px;\r\n}\r\n\r\n.character-name {\r\n    font-weight: bold;\r\n    font-size: 1.1em;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.character-name .fa-user {\r\n    color: #4CAF50;\r\n    margin-right: 5px;\r\n}\r\n\r\n.character-name.ignored {\r\n    color: var(--SmartThemeQuoteColor);\r\n    text-decoration: line-through;\r\n}\r\n\r\n.character-badge {\r\n    display: inline-block;\r\n    padding: 2px 8px;\r\n    border-radius: 3px;\r\n    font-size: 0.75em;\r\n    font-weight: bold;\r\n    margin-left: 5px;\r\n}\r\n\r\n.character-badge.main-char {\r\n    background-color: #4CAF50;\r\n    color: #fff;\r\n}\r\n\r\n.character-badge.ignored {\r\n    background-color: #666;\r\n    color: #fff;\r\n}\r\n\r\n.character-badge.unresolved {\r\n    background-color: #ff9800;\r\n    color: #000;\r\n}\r\n\r\n/* Lorebook entry editor modal */\r\n.lorebook-entry-editor h3 {\r\n    margin-top: 0;\r\n    margin-bottom: 20px;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.editor-section {\r\n    margin-bottom: 15px;\r\n}\r\n\r\n.editor-section label {\r\n    display: block;\r\n    font-weight: bold;\r\n    margin-bottom: 5px;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.editor-section small {\r\n    display: block;\r\n    margin-top: 3px;\r\n    color: var(--SmartThemeQuoteColor);\r\n    font-size: 0.85em;\r\n}\r\n\r\n.editor-section input,\r\n.editor-section textarea {\r\n    width: 100%;\r\n    box-sizing: border-box;\r\n}\r\n\r\n.character-aliases {\r\n    font-size: 0.9em;\r\n    color: var(--SmartThemeQuoteColor);\r\n    margin-bottom: 8px;\r\n    font-style: italic;\r\n}\r\n\r\n.lorebook-entry-id {\r\n    display: inline-block;\r\n    margin-left: 10px;\r\n    padding: 2px 6px;\r\n    background: var(--SmartThemeBlurTintColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 3px;\r\n    font-family: monospace;\r\n    font-size: 0.85em;\r\n    font-style: normal;\r\n    color: var(--SmartThemeQuoteColor);\r\n}\r\n\r\n.character-details {\r\n    font-size: 0.85em;\r\n    color: var(--SmartThemeBodyColor);\r\n    margin: 8px 0;\r\n    padding: 8px;\r\n    background: var(--SmartThemeBlurTintColor);\r\n    border-left: 2px solid var(--SmartThemeBorderColor);\r\n    border-radius: 3px;\r\n    line-height: 1.4;\r\n}\r\n\r\n.character-actions {\r\n    display: flex;\r\n    gap: 5px;\r\n    flex-wrap: wrap;\r\n    margin-top: 8px;\r\n}\r\n\r\n.character-actions .menu_button {\r\n    flex: 1;\r\n    min-width: 100px;\r\n    padding: 5px 10px;\r\n    font-size: 0.9em;\r\n}\r\n\r\n.menu_button.compact {\r\n    padding: 5px 10px;\r\n    font-size: 0.9em;\r\n}\r\n\r\n.name-tracker-empty {\r\n    color: var(--SmartThemeQuoteColor);\r\n    font-style: italic;\r\n    text-align: center;\r\n    padding: 20px;\r\n}\r\n\r\n/* Ollama Settings */\r\n.ollama-settings {\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    border-left: 3px solid var(--SmartThemeBorderColor);\r\n    padding: 10px;\r\n    margin-top: 5px;\r\n    border-radius: 5px;\r\n}\r\n\r\n/* Merge Dialog */\r\n.merge-dialog {\r\n    padding: 15px;\r\n}\r\n\r\n.merge-dialog p {\r\n    margin-bottom: 10px;\r\n}\r\n\r\n.merge-dialog strong {\r\n    color: var(--SmartThemeBodyColor);\r\n    font-weight: bold;\r\n}\r\n\r\n.merge-warning {\r\n    color: #ff9800;\r\n    font-size: 0.9em;\r\n    margin-top: 10px;\r\n    padding: 10px;\r\n    background-color: rgba(255, 152, 0, 0.1);\r\n    border-left: 3px solid #ff9800;\r\n    border-radius: 3px;\r\n}\r\n\r\n/* Button states */\r\nbutton:disabled {\r\n    opacity: 0.5;\r\n    cursor: not-allowed;\r\n}\r\n\r\n/* Flex utilities */\r\n.flexGap5 {\r\n    gap: 5px;\r\n}\r\n\r\n.flex1 {\r\n    flex: 1;\r\n}\r\n\r\n/* Progress indicator */\r\n.name-tracker-progress {\r\n    margin: 10px 0;\r\n    padding: 10px;\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    text-align: center;\r\n}\r\n\r\n.name-tracker-progress .progress-text {\r\n    margin-bottom: 5px;\r\n    font-weight: bold;\r\n}\r\n\r\n.name-tracker-progress .progress-bar {\r\n    width: 100%;\r\n    height: 20px;\r\n    background-color: var(--black50a);\r\n    border-radius: 10px;\r\n    overflow: hidden;\r\n}\r\n\r\n.name-tracker-progress .progress-fill {\r\n    height: 100%;\r\n    background-color: var(--SmartThemeQuoteColor);\r\n    transition: width 0.3s ease;\r\n}\r\n\r\n/* Character details preview (for potential future use) */\r\n.character-details {\r\n    display: none;\r\n    margin-top: 10px;\r\n    padding: 10px;\r\n    background-color: var(--black30a);\r\n    border-radius: 5px;\r\n    font-size: 0.9em;\r\n}\r\n\r\n.character-details.expanded {\r\n    display: block;\r\n}\r\n\r\n.character-details-section {\r\n    margin-bottom: 8px;\r\n}\r\n\r\n.character-details-section:last-child {\r\n    margin-bottom: 0;\r\n}\r\n\r\n.character-details-label {\r\n    font-weight: bold;\r\n    color: var(--SmartThemeQuoteColor);\r\n    margin-right: 5px;\r\n}\r\n\r\n/* Responsive adjustments */\r\n@media (max-width: 768px) {\r\n    .character-actions {\r\n        flex-direction: column;\r\n    }\r\n    \r\n    .character-actions .menu_button {\r\n        width: 100%;\r\n    }\r\n}\r\n\r\n/* Animation for new characters */\r\n@keyframes fadeIn {\r\n    from {\r\n        opacity: 0;\r\n        transform: translateY(-10px);\r\n    }\r\n    to {\r\n        opacity: 1;\r\n        transform: translateY(0);\r\n    }\r\n}\r\n\r\n.name-tracker-character.new {\r\n    animation: fadeIn 0.3s ease;\r\n}\r\n\r\n/* System Prompt Editor */\r\n.system-prompt-editor h3 {\r\n    margin-top: 0;\r\n    margin-bottom: 10px;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.system-prompt-editor p {\r\n    margin-bottom: 10px;\r\n    color: var(--SmartThemeQuoteColor);\r\n    font-size: 0.9em;\r\n}\r\n\r\n#system_prompt_editor {\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    color: var(--SmartThemeBodyColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 3px;\r\n    padding: 10px;\r\n    resize: vertical;\r\n}\r\n\r\n#system_prompt_editor:focus {\r\n    outline: none;\r\n    border-color: var(--SmartThemeEmColor);\r\n}\r\n\r\n.system-prompt-actions button {\r\n    min-width: 100px;\r\n}\r\n\r\n#system_prompt_reset {\r\n    margin-right: auto;\r\n}\r\n\r\n\r\n"],sourceRoot:""}]);const i=s},102(e,t,n){n.d(t,{A:()=>i,stContext:()=>s});var r=n(806),o=n(462);const a=r.Ay.createModuleLogger("Context");const s=new class{constructor(){this._context=null,this._lastUpdate=0,this._updateInterval=1e3}getContext(){const e=Date.now();if(!this._context||e-this._lastUpdate>this._updateInterval)try{this._context=SillyTavern.getContext(),this._lastUpdate=e}catch(e){throw a.error("Failed to get SillyTavern context:",e),new Error("SillyTavern context not available")}return this._context}getChat(){return this.getContext().chat||[]}getChatMetadata(){return this.getContext().chatMetadata||{}}getChatId(){return this.getContext().chatId||null}getCharacterId(){return this.getContext().characterId}getCharacters(){return this.getContext().characters||[]}getUserName(){return this.getContext().name1||"User"}getExtensionSettings(){return this.getContext().extensionSettings||{}}async saveExtensionSettings(){return o.r_.withErrorBoundary("Context",async()=>{const e=this.getContext();e.saveSettingsDebounced?e.saveSettingsDebounced():a.warn("saveSettingsDebounced not available")},{silent:!0})}async saveChatMetadata(){return o.r_.withErrorBoundary("Context",async()=>{const e=this.getContext();e.saveMetadata?await e.saveMetadata():a.warn("saveMetadata not available")},{silent:!0})}async generateQuietPrompt(e){return o.r_.withErrorBoundary("Context",async()=>{const t=this.getContext();if(!t.generateQuietPrompt)throw new Error("generateQuietPrompt not available");return await t.generateQuietPrompt(e)},{retries:1})}async loadWorldInfo(e){return o.r_.withErrorBoundary("Context",async()=>{const t=this.getContext();if(!t.loadWorldInfo)throw new Error("loadWorldInfo not available");return await t.loadWorldInfo(e)})}async saveWorldInfo(e,t,n=!1){return o.r_.withErrorBoundary("Context",async()=>{const r=this.getContext();if(!r.saveWorldInfo)throw new Error("saveWorldInfo not available");return await r.saveWorldInfo(e,t,n)})}async saveWorldInfoEntry(e,t){return o.r_.withErrorBoundary("Context",async()=>{const n=this.getContext();if(!n.saveWorldInfoEntry)throw new Error("saveWorldInfoEntry not available");return await n.saveWorldInfoEntry(e,t)})}getEventSource(){return this.getContext().eventSource}getEventTypes(){return this.getContext().event_types}async callGenericPopup(e,t,n="",r={}){return o.r_.withErrorBoundary("Context",async()=>{const o=this.getContext();if(!o.callGenericPopup)throw new Error("callGenericPopup not available");return await o.callGenericPopup(e,t,n,r)})}isContextAvailable(){try{return!!this.getContext()}catch{return!1}}clearCache(){this._context=null,this._lastUpdate=0,a.debug("Cleared context cache")}getStatus(){return{available:this.isContextAvailable(),cached:!!this._context,lastUpdate:this._lastUpdate,chatId:this.getChatId(),characterId:this.getCharacterId()}}dumpContextToConsole(){try{const e=this.getContext(),t={timestamp:(new Date).toISOString(),availableProperties:Object.keys(e),fullContext:e,detailedBreakdown:{}},n=["maxContext","maxTokens","amount_gen","token_limit","extensionSettings","settings","chat","chatMetadata","characters","world_info","botId","characterId","chatId","impersonate","groups"];for(const r of n)r in e&&(t.detailedBreakdown[r]={type:typeof e[r],value:e[r],isNull:null===e[r],isUndefined:void 0===e[r]});return console.group("%c[Name Tracker] COMPLETE CONTEXT DUMP","color: #00ff00; font-weight: bold; font-size: 14px;"),console.log("%cTimestamp:","color: #ffaa00; font-weight: bold;",t.timestamp),console.log("%cTotal Properties:","color: #ffaa00; font-weight: bold;",t.availableProperties.length),console.log("%cAll Property Names:","color: #00aaff; font-weight: bold;",t.availableProperties.join(", ")),console.log("%cDetailed Property Breakdown:","color: #ff00ff; font-weight: bold;",t.detailedBreakdown),console.log("%cFull Context Object:","color: #00ff00; font-weight: bold;",e),console.log("%cJSON Dump (for copying):","color: #ffff00; font-weight: bold;",JSON.stringify(t,null,2)),console.groupEnd(),t}catch(e){throw console.error("[Name Tracker] ERROR dumping context:",e),e}}},i=s},113(e){e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},134(e,t,n){n.d(t,{TQ:()=>h,WF:()=>m,_Z:()=>p});var r=n(806),o=n(462),a=n(548),s=n(102),i=n(854),l=n(695);let c;console.log("[LOREBOOK] Starting module load..."),console.log("[LOREBOOK] Imports completed. Types:"),console.log("[LOREBOOK] createModuleLogger:",typeof r.Xv),console.log("[LOREBOOK] withErrorBoundary:",typeof o.Xc),console.log("[LOREBOOK] NameTrackerError:",typeof o.S_);try{console.log("[LOREBOOK] About to call createModuleLogger..."),c=(0,r.Xv)("lorebook"),console.log("[LOREBOOK] Debug logger created successfully:",c)}catch(e){console.error("[LOREBOOK] Failed to create debug logger:",e),console.error("[LOREBOOK] Error stack:",e.stack),c={log:console.log.bind(console,"[LOREBOOK]"),error:console.error.bind(console,"[LOREBOOK]"),warn:console.warn.bind(console,"[LOREBOOK]"),debug:console.debug.bind(console,"[LOREBOOK]")}}const d=new l.h("Lorebook Management");let g=null;async function m(){return(0,o.Xc)("initializeLorebook",async()=>{const e=s.stContext.getContext();if(!e.chatId)return c.log("No active chat, skipping lorebook initialization"),g=null,null;const t="world_info",n=e.chatMetadata;if(!n)return c.log("No chat metadata available, skipping lorebook initialization"),g=null,null;if(n[t])return g=n[t],c.log(`Using existing chat lorebook: ${g}`),g;const r=`NameTracker_${e.chatId}`.replace(/[^a-z0-9 -]/gi,"_").replace(/_{2,}/g,"_").substring(0,64);console.log(`[NT-Lorebook] ðŸ†• Creating new chat lorebook: ${r}`),console.log(`[NT-Lorebook]    Chat ID: ${e.chatId}`),c.log(`Creating new chat lorebook: ${r}`),g=r,n[t]=g;try{await e.saveMetadata(),console.log(`[NT-Lorebook] âœ… Bound lorebook to chat metadata: ${g}`),c.log(`Bound lorebook to chat: ${g}`);const t=await e.loadWorldInfo(g);t?console.log(`[NT-Lorebook] â„¹ï¸  Lorebook file already exists with ${Object.keys(t.entries||{}).length} entries`):(console.log(`[NT-Lorebook] ðŸ“ Creating empty lorebook file: ${g}`),c.log(),await e.saveWorldInfo(g,{entries:{}},!0),console.log("[NT-Lorebook] âœ… Lorebook file created successfully")),d.info(`Chat lorebook "${g}" created and bound to this chat`,{timeOut:5e3}),console.log("[NT-Lorebook] ðŸŽ‰ Chat lorebook initialization complete")}catch(e){throw console.error("Failed to initialize lorebook:",e),g=null,new o.S_(`Failed to initialize lorebook: ${e.message}`)}return g})}async function h(e,t){return(0,o.Xc)("updateLorebookEntry",async()=>{if(c.log(`updateLorebookEntry called for: ${t}`),c.log("  Character data:",e),!g)return void c.log("No lorebook initialized, skipping entry update");const n=s.stContext.getContext(),r=(0,a.gf)(),o=[];if(e.physicalAge||e.mentalAge){const t=[];e.physicalAge&&t.push(`Physical: ${e.physicalAge}`),e.mentalAge&&t.push(`Mental: ${e.mentalAge}`),o.push(`**Age:** ${t.join(", ")}`)}e.physical&&o.push(`\n**Physical Description:**\n${e.physical}`),e.personality&&o.push(`\n**Personality:**\n${e.personality}`),e.sexuality&&o.push(`\n**Sexuality:**\n${e.sexuality}`),e.raceEthnicity&&o.push(`**Race/Ethnicity:** ${e.raceEthnicity}`),e.roleSkills&&o.push(`\n**Role & Skills:**\n${e.roleSkills}`),e.lastInteraction&&o.push(`\n**Last Interaction with {{user}}:**\n${e.lastInteraction}`),e.relationships&&e.relationships.length>0&&(o.push("\n**Relationships:**"),e.relationships.forEach(e=>{o.push(`- ${e}`)}));const l=o.join("\n"),d=[e.preferredName];e.aliases&&d.push(...e.aliases);let m=await n.loadWorldInfo(g);m||(c.log(),m={entries:{}});const h=(0,a.TJ)("messageFrequency",10),p=Math.max(1,Math.floor(.75*h));let u=null;if(e.lorebookEntryId&&m.entries&&m.entries[e.lorebookEntryId]){u=e.lorebookEntryId;const n=m.entries[u];console.log(`[NT-Lorebook] ðŸ”„ Updating existing entry for: ${t}`),console.log(`[NT-Lorebook]    Entry UID: ${u}`),console.log(`[NT-Lorebook]    Keys: ${d.join(", ")}`),console.log(`[NT-Lorebook]    Content length: ${l.length} chars`),n.key=d,n.content=l,n.enabled=r.enabled,n.position=r.position,n.probability=r.probability,n.depth=r.depth,n.scanDepth=r.scanDepth,n.cooldown=p,c.log()}else{const n=(0,i.cv)(),o={uid:n,key:d,keysecondary:[],comment:`Auto-generated entry for ${e.preferredName}`,content:l,constant:!1,selective:!0,contextConfig:{prefix:"",suffix:"",tokenBudget:0,reservedTokens:0,budgetPriority:400,trimDirection:"doNotTrim",insertionOrder:0,maximumTrimType:"sentence",insertionPosition:"before"},enabled:r.enabled,position:r.position,excludeRecursion:!1,preventRecursion:!1,delayUntilRecursion:!1,probability:r.probability,useProbability:!0,depth:r.depth,selectiveLogic:0,group:"",scanDepth:r.scanDepth,caseSensitive:null,matchWholeWords:null,useGroupScoring:null,automationId:"",role:0,vectorized:!1,sticky:0,cooldown:p,delay:0};m.entries[n]=o,e.lorebookEntryId=n,console.log(`[NT-Lorebook] ðŸ†• Creating new entry for: ${t}`),console.log(`[NT-Lorebook]    Entry UID: ${n}`),console.log(`[NT-Lorebook]    Keys: ${d.join(", ")}`),console.log(`[NT-Lorebook]    Content length: ${l.length} chars`),console.log(`[NT-Lorebook]    Enabled: ${r.enabled}`),console.log(`[NT-Lorebook]    Position: ${r.position}`),c.log()}try{console.log(`[NT-Lorebook] ðŸ’¾ Saving lorebook: ${g}`),console.log(`[NT-Lorebook]    Total entries: ${Object.keys(m.entries).length}`),await n.saveWorldInfo(g,m,!0),console.log("[NT-Lorebook] âœ… Lorebook saved successfully");const t=await n.loadWorldInfo(g),r=u||e.lorebookEntryId;t&&t.entries&&t.entries[r]?(console.log(`[NT-Lorebook] âœ… Verification successful - entry ${r} confirmed in lorebook`),c.log()):(console.error("[NT-Lorebook] âŒ WARNING: Lorebook verification failed - entries may not have been saved!"),console.error("[NT-Lorebook]    Target UID:",r),console.error("[NT-Lorebook]    Available entries:",Object.keys(t?.entries||{})),console.error("[Name Tracker] WARNING: Lorebook verification failed - entries may not have been saved!")),c.log()}catch(e){throw console.error("[NT-Lorebook] âŒ Error saving lorebook:",e),console.error("[NT-Lorebook]    Lorebook name:",g),console.error("[NT-Lorebook]    Error details:",e.message),console.error("[Name Tracker] Error saving lorebook:",e),c.log(),e}})}async function p(e){return(0,o.Xc)("viewInLorebook",async()=>{if(!(0,a.qN)(e))throw new o.S_("Character not found");if(!g)return void d.warning("No active chat or lorebook");const t=s.stContext.getContext();"function"==typeof t.openWorldInfoEditor?(await t.openWorldInfoEditor(g),d.success(`Opened lorebook for ${e}`)):($("#WorldInfo").click(),d.info(`Please select "${g}" from the World Info panel`))})}},314(e){e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n="",r=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),r&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),r&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n}).join("")},t.i=function(e,n,r,o,a){"string"==typeof e&&(e=[[null,e,void 0]]);var s={};if(r)for(var i=0;i<this.length;i++){var l=this[i][0];null!=l&&(s[l]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);r&&s[d[0]]||(void 0!==a&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=a),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),o&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=o):d[4]="".concat(o)),t.push(d))}},t}},354(e){e.exports=function(e){var t=e[1],n=e[3];if(!n)return t;if("function"==typeof btoa){var r=btoa(unescape(encodeURIComponent(JSON.stringify(n)))),o="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(r),a="/*# ".concat(o," */");return[t].concat([a]).join("\n")}return[t].join("\n")}},462(e,t,n){n.d(t,{S_:()=>o,Xc:()=>s,r_:()=>a});const r=n(806).Ay.createModuleLogger("ErrorHandler");class o extends Error{constructor(e,t,n,r=!0){super(e),this.name="NameTrackerError",this.code=t,this.module=n,this.recoverable=r,this.timestamp=Date.now()}}const a=new class{constructor(){this.errorHistory=[],this.transactionStack=[],this.recoveryStrategies=new Map,this.criticalErrorCallbacks=[]}async withErrorBoundary(e,t,n={}){const{fallback:o=null,retries:a=0,silent:s=!1,operationId:i=null}=n;let l=null;const c=Date.now();i&&r.trace(i,`Starting operation in ${e}`);for(let n=0;n<=a;n++)try{const n=await t();return i&&r.trace(i,`Operation completed successfully in ${e}`),n}catch(t){if(console.log(`[STnametracker] Error caught in ${e}:`,t),l=t,n<a){console.log(`[STnametracker] Retrying operation in ${e}, attempt ${n+1}/${a+1}:`,t.message),r.warn(`Retrying operation in ${e}, attempt ${n+1}/${a+1}:`,t.message),await this.delay(100*Math.pow(2,n));continue}}console.log(`[STnametracker] All retries failed in ${e}, tracking error:`,l);const d=this.trackError(l,e,{operation:t.name||"anonymous",duration:Date.now()-c,retries:a,operationId:i});if(s||(console.log(`[STnametracker] Notifying user of error in ${e}`),this.notifyUser(d)),o)try{return r.debug(`Attempting fallback for ${e}:`,d.code),await o(d)}catch(t){r.error(`Fallback failed for ${e}:`,t)}const g=this.recoveryStrategies.get(d.code);if(g)try{return await g(d)}catch(e){r.error(`Recovery strategy failed for ${d.code}:`,e)}throw d}trackError(e,t,n={}){let a;if(e instanceof o)a=e;else{const n=this.categorizeError(e,t);a=new o(e.message,n,t,this.isRecoverable(e,n))}return a.context=n,this.errorHistory.push(a),this.errorHistory.length>100&&this.errorHistory.shift(),r.error(`Error in ${t}:`,{code:a.code,message:a.message,context:n}),a}categorizeError(e,t){return e.message.includes("fetch")||e.message.includes("network")?"NETWORK_ERROR":e.message.includes("JSON")||e.message.includes("parse")?"DATA_FORMAT_ERROR":e.message.includes("context")||e.message.includes("SillyTavern")?"CONTEXT_ERROR":"TypeError"===e.name?"TYPE_ERROR":"LLM"===t&&(e.message.includes("quota")||e.message.includes("rate"))?"API_LIMIT_ERROR":"UNKNOWN_ERROR"}isRecoverable(e,t){return!["CONTEXT_ERROR","TYPE_ERROR"].includes(t)}startTransaction(e,t){this.transactionStack.push({id:e,state:JSON.stringify(t),timestamp:Date.now()}),r.debug(`Started transaction: ${e}`)}commitTransaction(e){const t=this.transactionStack.findIndex(t=>t.id===e);-1!==t&&(this.transactionStack.splice(t,1),r.debug(`Committed transaction: ${e}`))}rollbackTransaction(e){const t=this.transactionStack.findIndex(t=>t.id===e);if(-1!==t){const n=this.transactionStack.splice(t,1)[0];return r.debug(`Rolled back transaction: ${e}`),JSON.parse(n.state)}return null}registerRecoveryStrategy(e,t){this.recoveryStrategies.set(e,t),r.debug(`Registered recovery strategy for: ${e}`)}onCriticalError(e){this.criticalErrorCallbacks.push(e)}notifyUser(e){const t=`Name Tracker: ${e.message}`;e.recoverable?toastr.warning(t,"Warning",{timeOut:5e3}):(toastr.error(t,"Error",{timeOut:8e3}),this.criticalErrorCallbacks.forEach(t=>{try{t(e)}catch(e){r.error("Critical error callback failed:",e)}}))}getRecentErrors(e=10){return this.errorHistory.slice(-e)}clearHistory(){this.errorHistory=[],r.debug("Cleared error history")}delay(e){return new Promise(t=>setTimeout(t,e))}},s=a.withErrorBoundary.bind(a)},540(e){e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},548(e,t,n){n.d(t,{PL:()=>A,TJ:()=>d,ZC:()=>y,bg:()=>m,e7:()=>b,getLLMConfig:()=>x,gf:()=>k,nF:()=>u,nT:()=>g,qN:()=>C,sr:()=>f,yb:()=>T,zB:()=>p});var r=n(462),o=n(806),a=n(102);const s="STnametracker",i=(0,o.Xv)("Settings"),l=Object.freeze({enabled:!0,autoAnalyze:!0,messageFrequency:10,llmSource:"sillytavern",ollamaEndpoint:"http://localhost:11434",ollamaModel:"",confidenceThreshold:70,lorebookPosition:0,lorebookDepth:1,lorebookCooldown:5,lorebookScanDepth:1,lorebookProbability:100,lorebookEnabled:!0,debugMode:!1,systemPrompt:null,lastScannedMessageId:-1,totalCharactersDetected:0,lastAnalysisTime:null,analysisCache:new Map}),c=Object.freeze({characters:{},lastScannedMessageId:-1,analysisHistory:[],lorebookEntries:{},processingStats:{totalProcessed:0,charactersFound:0,lastProcessedTime:null}});function d(){return r.r_.withErrorBoundary("Settings",()=>{if("undefined"==typeof extension_settings)return console.warn("[STnametracker] extension_settings not available"),{...l};extension_settings[s]||(extension_settings[s]={...l});return{...l,...extension_settings[s]}},{...l})}function g(e){return r.r_.withErrorBoundary("Settings",()=>{"undefined"!=typeof extension_settings?(extension_settings[s]||(extension_settings[s]={...l}),Object.assign(extension_settings[s],e),"undefined"!=typeof saveSettingsDebounced&&saveSettingsDebounced()):console.warn("[STnametracker] extension_settings not available for saving")})}function m(){return r.r_.withErrorBoundary("Settings",()=>{try{const e=a.stContext.getChatMetadata();return e[s]||(e[s]={...c}),e[s].characters||{}}catch(e){return i.warn("Failed to get characters:",e.message),{}}},{})}function h(e){return r.r_.withErrorBoundary("Settings",()=>{try{const t=a.stContext.getChatMetadata();t[s]||(t[s]={...c}),t[s].characters=e,a.stContext.saveChatMetadata().catch(e=>{i.warn("Failed to save chat metadata:",e.message)})}catch(e){i.warn("Failed to set characters:",e.message)}})}function p(){return r.r_.withErrorBoundary("Settings",()=>{try{const e=a.stContext.getChatMetadata();return e[s]||(e[s]={...c}),e[s]}catch(e){return i.warn("Failed to get chat data:",e.message),{...c}}},{...c})}function u(e){return r.r_.withErrorBoundary("Settings",()=>{try{const t=a.stContext.getChatMetadata();t[s]||(t[s]={...c}),Object.assign(t[s],e),a.stContext.saveChatMetadata().catch(e=>{i.warn("Failed to save chat metadata:",e.message)})}catch(e){i.warn("Failed to set chat data:",e.message)}})}function f(e){return r.r_.withErrorBoundary("Settings",()=>{const t=m();delete t[e],h(t)})}function A(e,t){const n=d();return void 0!==n[e]?n[e]:t}function y(e,t){const n={};n[e]=t,g(n)}function C(e){return r.r_.withErrorBoundary("Settings",()=>{if(!e||"string"!=typeof e)return console.warn("[STnametracker] Invalid character name:",e),null;return m()[e]||null},null)}function b(e,t){return r.r_.withErrorBoundary("Settings",()=>{if(!e||"string"!=typeof e)throw new Error("Character name must be a non-empty string");if(!t||"object"!=typeof t)throw new Error("Character data must be an object");const n={...m()};n[e]=t,h(n),i.log(`Set character: ${e}`)})}function x(){return r.r_.withErrorBoundary("Settings",()=>{const e=A("llmSource");return console.log("[NT-LLMConfig] llmSource setting:",e),console.log("[NT-LLMConfig] All extension_settings keys:",Object.keys(extension_settings.sillytavern_nametracker||{})),{source:e,ollamaEndpoint:A("ollamaEndpoint"),ollamaModel:A("ollamaModel"),systemPrompt:A("systemPrompt")}},{source:"sillytavern",ollamaEndpoint:"http://localhost:11434",ollamaModel:"",systemPrompt:null})}function k(){return r.r_.withErrorBoundary("Settings",()=>({position:A("lorebookPosition"),depth:A("lorebookDepth"),cooldown:A("lorebookCooldown"),scanDepth:A("lorebookScanDepth"),probability:A("lorebookProbability"),enabled:A("lorebookEnabled")}),{position:0,depth:1,cooldown:5,scanDepth:1,probability:100,enabled:!0})}function T(e,t){return r.r_.withErrorBoundary("Settings",()=>{try{const n=a.stContext.getChatMetadata();n[s]||(n[s]={...c}),n[s][e]=t,i.log(`Updated chat data ${e}`),a.stContext.saveChatMetadata().catch(e=>{i.warn("Failed to save chat metadata:",e.message)})}catch(e){i.warn("Failed to set chat metadata:",e.message)}})}},551(e,t,n){n.d(t,{OW:()=>A,_$:()=>h,eY:()=>m,el:()=>x,g9:()=>k,lF:()=>C,pp:()=>v,rL:()=>p,t9:()=>y,undoLastMerge:()=>b,vu:()=>T});var r=n(134),o=n(806),a=n(462),s=n(548),i=n(695);const l=(0,o.Xv)("characters"),c=new i.h("Character Management");function d(e,t=null){console.log(`[NT-Characters] ${e}`,t||"")}let g=[];function m(e){return(0,a.Xc)("isIgnoredCharacter",()=>{const t=(0,s.bg)();return Object.values(t).some(t=>t.ignored&&(t.preferredName===e||t.aliases.includes(e)))})}function h(e){return(0,a.Xc)("findExistingCharacter",()=>{const t=(0,s.bg)(),n=Object.values(t).find(t=>t.preferredName===e||t.aliases.includes(e))||null;return d(`[FindChar] Searching for '${e}': ${n?"FOUND as "+n.preferredName:"NOT FOUND"}`),n})}async function p(e){return(0,a.Xc)("findPotentialMatch",async()=>{const t=(0,s.bg)(),n=(0,s.TJ)("confidenceThreshold",70);l.log();for(const r of Object.values(t)){if(u(e.name,r.preferredName)>=n)return l.log(),r;for(const t of r.aliases){if(u(e.name,t)>=n)return l.log(),r}}return null})}function u(e,t){return(0,a.Xc)("calculateNameSimilarity",()=>{if(e=e.toLowerCase(),t=t.toLowerCase(),e===t)return 100;if(e.includes(t)||t.includes(e))return 85;const n=e.split(/\s+/),r=t.split(/\s+/);return n.filter(e=>r.includes(e)).length>0?70:0})}function f(e,t){return(0,a.Xc)("cleanAliases",()=>{if(!e||!Array.isArray(e))return[];const n=["son","daughter","mother","father","mom","dad","parent","brother","sister","sibling","cousin","uncle","aunt","friend","boyfriend","girlfriend","husband","wife","spouse","boss","employee","coworker","colleague","partner","neighbor","roommate","child","kid","baby","man","woman","person","guy","girl","boy","user","{{user}}","char","{{char}}"],r=t.toLowerCase();return e.filter(e=>{if(!e||"string"!=typeof e)return!1;const t=e.trim().toLowerCase();return t!==r&&(!n.includes(t)&&!(t.length<2))}).map(e=>e.trim()).filter((e,t,n)=>n.indexOf(e)===t)})}async function A(e,t=!1){return(0,a.Xc)("createCharacter",async()=>{l.log();const n=f(e.aliases||[],e.name),o={preferredName:e.name,aliases:n,physicalAge:e.physicalAge||"",mentalAge:e.mentalAge||"",physical:e.physical||"",personality:e.personality||"",sexuality:e.sexuality||"",raceEthnicity:e.raceEthnicity||"",roleSkills:e.roleSkills||"",lastInteraction:e.lastInteraction||"",relationships:e.relationships||[],ignored:!1,confidence:e.confidence||50,lorebookEntryId:null,lastUpdated:Date.now(),isMainChar:t||!1,lastMessageProcessed:-1};return l.log(),(0,s.e7)(o.preferredName,o),await(0,r.TQ)(o,o.preferredName),l.log(),o})}async function y(e,t,n=!1,r=!1){return(0,a.Xc)("updateCharacter",async()=>{if(l.log(),r&&(e.isMainChar=!0),n&&t.name!==e.preferredName&&(e.aliases||(e.aliases=[]),e.aliases.includes(t.name)||t.name.toLowerCase()===e.preferredName.toLowerCase()||e.aliases.push(t.name)),e.aliases=f(e.aliases||[],e.preferredName),t.physicalAge&&(e.physicalAge=t.physicalAge),t.mentalAge&&(e.mentalAge=t.mentalAge),t.physical&&(e.physical=t.physical),t.personality&&(e.personality=t.personality),t.sexuality&&(e.sexuality=t.sexuality),t.raceEthnicity&&(e.raceEthnicity=t.raceEthnicity),t.roleSkills&&(e.roleSkills=t.roleSkills),t.lastInteraction&&(e.lastInteraction=t.lastInteraction),t.relationships&&Array.isArray(t.relationships)){e.relationships||(e.relationships=[]);for(const n of t.relationships)e.relationships.includes(n)||e.relationships.push(n)}return t.confidence&&(e.confidence=Math.round((e.confidence+t.confidence)/2)),e.lastUpdated=Date.now(),(0,s.e7)(e.preferredName,e),l.log(),e})}async function C(e,t){return(0,a.Xc)("mergeCharacters",async()=>{const n=(0,s.bg)(),r=n[e],o=n[t];if(!r||!o)throw new a.S_("One or both characters not found");const i={operation:"merge",timestamp:Date.now(),sourceName:e,targetName:t,sourceData:JSON.parse(JSON.stringify(r)),targetDataBefore:JSON.parse(JSON.stringify(o))};g.push(i),g.length>3&&g.shift();for(const e of r.aliases)o.aliases.includes(e)||o.aliases.push(e);r.preferredName===o.preferredName||o.aliases.includes(r.preferredName)||o.aliases.push(r.preferredName),r.physicalAge&&!o.physicalAge&&(o.physicalAge=r.physicalAge),r.mentalAge&&!o.mentalAge&&(o.mentalAge=r.mentalAge),r.physical&&!o.physical&&(o.physical=r.physical),r.personality&&!o.personality&&(o.personality=r.personality),r.sexuality&&!o.sexuality&&(o.sexuality=r.sexuality),r.raceEthnicity&&!o.raceEthnicity&&(o.raceEthnicity=r.raceEthnicity),r.roleSkills&&!o.roleSkills&&(o.roleSkills=r.roleSkills),r.lastInteraction&&!o.lastInteraction&&(o.lastInteraction=r.lastInteraction);for(const e of r.relationships)o.relationships.includes(e)||o.relationships.push(e);return o.lastUpdated=Date.now(),(0,s.e7)(o.preferredName,o),(0,s.sr)(e),l.log(),c.success(`Merged ${e} into ${t}`),i})}async function b(){return(0,a.Xc)("undoLastMerge",async()=>{if(0===g.length)return c.warning("No merge operations to undo"),!1;const e=g.pop();return"merge"!==e.operation?(c.error("Last operation was not a merge"),!1):((0,s.e7)(e.sourceName,e.sourceData),(0,s.e7)(e.targetName,e.targetDataBefore),l.log(),c.success("Merge undone successfully"),!0)})}async function x(e){return(0,a.Xc)("toggleIgnoreCharacter",async()=>{const t=(0,s.qN)(e);if(!t)throw new a.S_("Character not found");t.ignored=!t.ignored,(0,s.e7)(e,t);const n=t.ignored?"ignored":"unignored";return c.info(`${e} ${n}`),l.log(),t.ignored})}async function k(e){return(0,a.Xc)("createNewCharacter",async()=>{if(!e||!e.trim())throw new a.S_("Character name is required");const t=e.trim();if((0,s.qN)(t))throw new a.S_(`Character "${t}" already exists`);const n={name:t,aliases:[],physicalAge:"",mentalAge:"",physical:"",personality:"",sexuality:"",raceEthnicity:"",roleSkills:"",lastInteraction:"",relationships:[],confidence:100},r=await A(n,!1);return l.log(),c.success(`Created character: ${t}`),r})}async function T(){return(0,a.Xc)("purgeAllCharacters",async()=>{const e=(0,s.bg)(),t=Object.keys(e).length;return 0===t?(c.info("No characters to purge"),0):((0,s.yb)("characters",{}),g=[],l.log(),c.success(`Purged ${t} characters`),t)})}function v(e){return(0,a.Xc)("hasUnresolvedRelationships",()=>{if(!e.relationships||0===e.relationships.length)return!1;const t=(0,s.bg)(),n=Object.values(t).reduce((e,t)=>(e.add(t.preferredName.toLowerCase()),t.aliases.forEach(t=>e.add(t.toLowerCase())),e),new Set);return e.relationships.some(e=>e.toLowerCase().split(/\s+/).some(e=>e.length>2&&!n.has(e)))})}},659(e){var t={};e.exports=function(e,n){var r=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(n)}},695(e,t,n){n.d(t,{A:()=>s,h:()=>o});const r=n(806).Ay.createModuleLogger("Notifications");class o{constructor(){this.defaultOptions={timeOut:5e3,extendedTimeOut:2e3,closeButton:!0,progressBar:!0,preventDuplicates:!0},this.prefix="Name Tracker: "}success(e,t="Success",n={}){const o={...this.defaultOptions,...n};toastr.success(this.prefix+e,t,o),r.debug("Success notification:",e)}info(e,t="Info",n={}){const o={...this.defaultOptions,...n};toastr.info(this.prefix+e,t,o),r.debug("Info notification:",e)}warning(e,t="Warning",n={}){const o={...this.defaultOptions,timeOut:8e3,...n};toastr.warning(this.prefix+e,t,o),r.debug("Warning notification:",e)}error(e,t="Error",n={}){const o={...this.defaultOptions,timeOut:1e4,extendedTimeOut:5e3,...n};toastr.error(this.prefix+e,t,o),r.error("Error notification:",e)}persistent(e,t="Notice",n="info"){const o={...this.defaultOptions,timeOut:0,extendedTimeOut:0};switch(n){case"success":toastr.success(this.prefix+e,t,o);break;case"warning":toastr.warning(this.prefix+e,t,o);break;case"error":toastr.error(this.prefix+e,t,o);break;default:toastr.info(this.prefix+e,t,o)}r.debug("Persistent notification:",e)}progress(e,t=0,n=null){const o=n||`progress_${Date.now()}`,a=`\n            <div style="margin-bottom: 8px;">${this.prefix}${e}</div>\n            <div style="background: #333; border-radius: 3px; overflow: hidden;">\n                <div style="background: #007acc; height: 6px; width: ${t}%; transition: width 0.3s ease;"></div>\n            </div>\n            <div style="text-align: center; font-size: 11px; margin-top: 4px;">${t}%</div>\n        `,s={timeOut:0,extendedTimeOut:0,closeButton:!1,progressBar:!1,preventDuplicates:!1,toastId:o};return toastr.remove(),toastr.info(a,"",s),r.debug("Progress notification:",e,`${t}%`),o}clear(){toastr.clear(),r.debug("Cleared all notifications")}confirm(e,t,n=null,o="Confirm"){const a=`confirm_${Date.now()}`,s=`\n            <div style="margin-bottom: 12px;">${e}</div>\n            <div style="text-align: right;">\n                <button class="btn btn-sm btn-secondary me-2" onclick="nameTrackerNotifications.handleConfirmCancel('${a}')">Cancel</button>\n                <button class="btn btn-sm btn-primary" onclick="nameTrackerNotifications.handleConfirmOk('${a}')">Confirm</button>\n            </div>\n        `;window.nameTrackerNotifications=window.nameTrackerNotifications||{},window.nameTrackerNotifications.confirmCallbacks=window.nameTrackerNotifications.confirmCallbacks||{},window.nameTrackerNotifications.confirmCallbacks[a]={onConfirm:t,onCancel:n},window.nameTrackerNotifications.handleConfirmOk=e=>{const t=window.nameTrackerNotifications.confirmCallbacks[e];t&&t.onConfirm&&t.onConfirm(),delete window.nameTrackerNotifications.confirmCallbacks[e],toastr.clear()},window.nameTrackerNotifications.handleConfirmCancel=e=>{const t=window.nameTrackerNotifications.confirmCallbacks[e];t&&t.onCancel&&t.onCancel(),delete window.nameTrackerNotifications.confirmCallbacks[e],toastr.clear()};const i={timeOut:0,extendedTimeOut:0,closeButton:!1,progressBar:!1,preventDuplicates:!1,toastId:a};return toastr.info(s,this.prefix+o,i),r.debug("Confirmation notification:",e),a}getStatus(){return{defaultOptions:this.defaultOptions,prefix:this.prefix,activeConfirms:Object.keys(window.nameTrackerNotifications?.confirmCallbacks||{}).length}}}const a=new o;r.debug("Notifications module loaded");const s=a},744(e,t,n){n.d(t,{Bw:()=>f,Kr:()=>k,au:()=>b,fR:()=>y,getMaxPromptLength:()=>C});var r=n(806),o=n(462),a=n(548),s=n(102),i=n(854),l=n(695);const c=(0,r.Xv)("llm"),d=new l.h("LLM Integration");function g(e,t=null){console.log(`[NT-LLM] ${e}`,t||"")}const m=.85,h=new Map;let p=[];const u='Extract character information from messages and return ONLY a JSON object.\n\nCRITICAL: Your entire response must be a single JSON object starting with { and ending with }\n\nDO NOT include:\n- Any text before the JSON\n- Any text after the JSON  \n- Code block markers\n- Explanations or commentary\n\nREQUIRED JSON structure (copy this exact format):\n{\n  "characters": [\n    {\n      "name": "Character name",\n      "aliases": ["Other names"],\n      "physicalAge": "Age if mentioned",\n      "mentalAge": "Mental age if different",\n      "physical": "Physical description",\n      "personality": "Personality traits",\n      "sexuality": "Sexual orientation if mentioned",\n      "raceEthnicity": "Race/ethnicity if mentioned",\n      "roleSkills": "Job/role/skills",\n      "lastInteraction": "Recent interaction with user",\n      "relationships": ["Relationships with other characters"],\n      "confidence": 75\n    }\n  ]\n}\n\nRules:\n- Only extract clearly named speaking characters\n- Skip generic references ("the waiter", "a woman")\n- Use most recent information for conflicts\n- Empty array if no clear characters: {"characters":[]}\n- Confidence: 90+ (explicit), 70-89 (clear), 50-69 (mentioned), <50 (vague)\n\nYour response must start with { immediately.';async function f(){return(0,o.Xc)("loadOllamaModels",async()=>{const e=(0,a.TJ)("ollamaEndpoint","http://localhost:11434");g(`[OllamaModels] Loading models from ${e}`);try{const t=await fetch(`${e}/api/tags`);if(!t.ok)throw new Error(`Failed to connect to Ollama: ${t.statusText}`);const n=await t.json();return p=n.models||[],g(`[OllamaModels] Found ${p.length} models: ${p.map(e=>e.name).join(", ")}`),p}catch(e){throw console.error("Error loading Ollama models:",e),d.error("Failed to load Ollama models. Check endpoint and try again."),e}})}async function A(e){return(0,o.Xc)("getOllamaModelContext",async()=>{const t=(0,a.TJ)("ollamaEndpoint","http://localhost:11434");if(!e)return c.log(),4096;try{const n=await fetch(`${t}/api/show`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!n.ok)throw new Error(`Failed to fetch model info: ${n.statusText}`);const r=await n.json();if(r.parameters&&Array.isArray(r.parameters))for(const e of r.parameters){const t=e.match(/num_ctx\\s+(\\d+)/);if(t){const e=parseInt(t[1]);return c.log(),e}}if(r.model_info&&r.model_info.num_ctx){const e=parseInt(r.model_info.num_ctx);return c.log(),e}return c.log(),4096}catch(e){return console.error("Error fetching Ollama model context:",e),c.log(),4096}})}function y(){return(0,o.Xc)("buildCharacterRoster",()=>{const e=(0,a.bg)(),t=Object.keys(e);if(0===t.length)return"";return`\\n\\n[KNOWN CHARACTERS]\\nThe following characters have already been identified. If you encounter them again, use the same name and add any new details:\\n${t.map(t=>{const n=e[t];return`  - ${t}${n.aliases&&n.aliases.length>0?` (also known as: ${n.aliases.join(", ")})`:""}${n.relationships&&n.relationships.length>0?`\\n    Relationships: ${n.relationships.join("; ")}`:""}`}).join("\\n")}\\n`})}async function C(){return(0,o.Xc)("getMaxPromptLength",async()=>{const e=[],t=t=>{e.push(t),console.log(`[NT-MaxContext] ${t}`)};try{const n=(0,a.getLLMConfig)();let r=4096,o=2048,i="fallback";if(t(`Starting context detection for LLM source: ${n.source}`),"ollama"===n.source&&n.ollamaModel)t(`Using Ollama model: ${n.ollamaModel}`),r=await A(n.ollamaModel),i="ollama";else{t("Using SillyTavern context");let e=null;try{e=s.stContext.getContext(),t("Successfully retrieved SillyTavern context")}catch(n){t(`ERROR: Failed to get context: ${n.message}`),e=null}if(e)try{const n=Object.keys(e);t(`Available context properties: ${n.filter(e=>e.toLowerCase().includes("max")||e.toLowerCase().includes("context")||e.toLowerCase().includes("token")||e.toLowerCase().includes("prompt")).join(", ")}`)}catch(e){t(`Error analyzing context keys: ${e.message}`)}let n=null;if(t("Method 1: Checking context.maxContext..."),e&&"number"==typeof e.maxContext&&e.maxContext>0)n=e.maxContext,t(`âœ“ Method 1 SUCCESS: context.maxContext = ${n}`),i="context.maxContext";else{t(`âœ— Method 1 FAILED: ${e?"number"!=typeof e.maxContext?"type is "+typeof e.maxContext:e.maxContext<=0?`value is ${e.maxContext}`:"unknown":"context is null"}`)}if(n||(t("Method 2: Checking context.extensionSettings.common.maxContext..."),e?.extensionSettings?.common?"number"==typeof e.extensionSettings.common.maxContext&&e.extensionSettings.common.maxContext>0?(n=e.extensionSettings.common.maxContext,t(`âœ“ Method 2 SUCCESS: extensionSettings.common.maxContext = ${n}`),i="extensionSettings.common.maxContext"):t("âœ— Method 2 FAILED: extensionSettings.common exists but maxContext is invalid"):t("âœ— Method 2 FAILED: extensionSettings.common path does not exist")),n||(t("Method 3: Checking context.chat.maxContextSize..."),e?.chat&&"object"==typeof e.chat&&!Array.isArray(e.chat)?"number"==typeof e.chat.maxContextSize&&e.chat.maxContextSize>0?(n=e.chat.maxContextSize,t(`âœ“ Method 3 SUCCESS: chat.maxContextSize = ${n}`),i="chat.maxContextSize"):t("âœ— Method 3 FAILED: chat exists but maxContextSize is invalid"):t("âœ— Method 3 FAILED: chat path does not exist or is an array")),n||(t("Method 4: Checking context.token_limit..."),e&&"number"==typeof e.token_limit&&e.token_limit>0?(n=e.token_limit,t(`âœ“ Method 4 SUCCESS: token_limit = ${n}`),i="token_limit"):t("âœ— Method 4 FAILED: token_limit is not valid")),n||(t("Method 5: Checking context.amount_gen (fallback)..."),e&&"number"==typeof e.amount_gen&&e.amount_gen>0?(n=4*e.amount_gen,t(`âœ“ Method 5 FALLBACK: amount_gen = ${e.amount_gen}, estimated context = ${n}`),i="amount_gen_estimate"):t("âœ— Method 5 FAILED: amount_gen is not valid")),n||(t("Method 6: Checking context.settings.max_context..."),e&&"object"==typeof e.settings?"number"==typeof e.settings.max_context&&e.settings.max_context>0?(n=e.settings.max_context,t(`âœ“ Method 6 SUCCESS: settings.max_context = ${n}`),i="settings.max_context"):t("âœ— Method 6 FAILED: settings exists but max_context is invalid"):t("âœ— Method 6 FAILED: settings path does not exist")),n&&("number"!=typeof n||n<100)&&(t(`WARNING: Detected maxContext is not valid: ${n}, type: ${typeof n}`),n=null),e&&n)r=Math.floor(n),t(`Detected maxContext: ${r} (type: ${typeof r})`),o=Math.min(4096,Math.floor(.15*r)),t(`Extension will request max ${o} tokens for analysis responses (15% of context, capped at 4096)`);else{if(t("WARNING: Could not detect maxContext from any path, using fallback (4096)"),t(`Context exists: ${!!e}, detectedMaxContext: ${n}`),e)try{const n=Object.keys(e).sort();t(`Full context object keys (first 20): ${n.slice(0,20).join(", ")}${n.length>20?`... (${n.length-20} more)`:""}`)}catch(e){t(`Could not enumerate context keys: ${e.message}`)}r=4096,o=1024,i="fallback"}}const l=500+o+500,c=Math.max(1e3,r-l);t(`Token allocation: maxContext=${r}, reserved=${l}, available=${c}`),t(`Final detection method: ${i}`);const d=Math.max(1e3,Math.min(c,5e4));return t(`Returning maxPromptLength: ${d}`),{maxPrompt:d,detectionMethod:i,maxContext:r,debugLog:e.join("\n")}}catch(n){return t(`ERROR in getMaxPromptLength: ${n.message}`),console.error("[NT-MaxContext] Stack:",n.stack),{maxPrompt:3276,detectionMethod:"error",maxContext:4096,debugLog:e.join("\n")+"\nFATAL ERROR: "+n.message}}})}async function b(e){return(0,o.Xc)("calculateMessageTokens",async()=>{const t=s.stContext.getContext();let n=0;for(const r of e)if(r&&"object"==typeof r&&r.extra&&"number"==typeof r.extra.token_count)n+=r.extra.token_count;else{const e=r?.mes||r?.message||String(r);if(e&&t.getTokenCountAsync)try{n+=await t.getTokenCountAsync(e)}catch(t){c.log(),n+=Math.ceil(e.length/4)}else n+=Math.ceil(e.length/4)}return n})}function x(e){return(0,o.Xc)("parseJSONResponse",()=>{if(console.log("[NT-Parse] ========== PARSE START =========="),console.log("[NT-Parse] Input type:",typeof e),console.log("[NT-Parse] Input is null?:",null===e),console.log("[NT-Parse] Input is undefined?:",void 0===e),"object"==typeof e&&null!==e&&(console.log("[NT-Parse] Input is an OBJECT (not string). Keys:",Object.keys(e)),console.log("[NT-Parse] Full object:",JSON.stringify(e).substring(0,500)),e.characters&&Array.isArray(e.characters)))return console.log("[NT-Parse] Object already has characters array, returning as-is"),e;if(console.log("[NT-Parse] Input length:",e?e.length:"null"),e&&"string"==typeof e&&(console.log("[NT-Parse] First 300 chars:",e.substring(0,300)),console.log("[NT-Parse] Last 100 chars:",e.substring(Math.max(0,e.length-100)))),!e||"string"!=typeof e)throw console.error("[NT-Parse] âŒ INVALID: Response is not a string:",typeof e),console.error("[NT-Parse] âŒ Response value:",e),new o.S_("LLM returned empty or invalid response");if(e=e.trim(),console.log("[NT-Parse] After trim, length:",e.length),0===e.length)throw console.error("[NT-Parse] âŒ Text is empty after trim"),new o.S_("LLM returned empty response");const t=e.match(/```(?:json)?\s*([\s\S]*?)```/);t&&(console.log("[NT-Parse] Found markdown code block, extracting JSON"),e=t[1].trim(),console.log("[NT-Parse] After markdown extraction, length:",e.length));const n=e.indexOf("{"),r=e.lastIndexOf("}");if(console.log("[NT-Parse] Brace search: first={"+n+", last="+r+"}"),-1!==n&&-1!==r&&r>n){const t=e.substring(0,n),o=e.substring(n,r+1),a=e.substring(r+1);console.log("[NT-Parse] Text before JSON:",t.substring(0,100)),console.log("[NT-Parse] Extracted JSON length:",o.length),console.log("[NT-Parse] Text after JSON:",a.substring(0,100)),e=o}e=(e=e.replace(/^(?:Here's the analysis:|Here is the JSON:|Result:|Output:)\s*/i,"")).trim(),console.log("[NT-Parse] Before JSON.parse, length:",e.length),console.log("[NT-Parse] First 200 chars:",e.substring(0,200)),console.log("[NT-Parse] Last 100 chars:",e.substring(Math.max(0,e.length-100)));try{console.log("[NT-Parse] Attempting JSON.parse...");const t=JSON.parse(e);return console.log("[NT-Parse] âœ… Successfully parsed JSON"),console.log("[NT-Parse] Parsed type:",typeof t),console.log("[NT-Parse] Parsed keys:",Object.keys(t)),console.log("[NT-Parse] Full parsed object:",JSON.stringify(t).substring(0,500)),t.characters?Array.isArray(t.characters)||(console.warn("[NT-Parse] âš ï¸  parsed.characters exists but is NOT an array. Type:",typeof t.characters),console.warn("[NT-Parse] Value:",t.characters)):(console.warn("[NT-Parse] âš ï¸  parsed.characters is undefined or null"),console.warn("[NT-Parse] Available keys in object:",Object.keys(t))),t.characters&&Array.isArray(t.characters)?(console.log("[NT-Parse] âœ… Valid response with",t.characters.length,"characters"),console.log("[NT-Parse] ========== PARSE END (SUCCESS) =========="),t):(console.warn("[NT-Parse] âŒ Response missing characters array, returning empty"),console.warn("[NT-Parse] Full parsed object:",t),{characters:[]})}catch(t){if(console.error("[NT-Parse] âŒ JSON.parse failed:",t.message),console.error("[NT-Parse] âŒ Error at position:",t.name),console.log("[NT-Parse] Text being parsed (first 500 chars):",e.substring(0,500)),console.log("[NT-Parse] Text being parsed (last 200 chars):",e.substring(Math.max(0,e.length-200))),e.includes('"characters"')&&!e.trim().endsWith("}")){console.log("[NT-Parse] Detected truncated response, attempting recovery...");let t=e;const n=(e.match(/\{/g)||[]).length,r=(e.match(/\}/g)||[]).length,o=(e.match(/\[/g)||[]).length,a=(e.match(/\]/g)||[]).length;console.log("[NT-Parse] Recovery attempt - braces: open="+n+" close="+r+", brackets: open="+o+" close="+a),t.match(/"[^"]*$/)&&(console.log("[NT-Parse] Adding closing quote"),t+='"');for(let e=0;e<o-a;e++)t+="]";for(let e=0;e<n-r;e++)t+="}";console.log("[NT-Parse] Salvaged text length:",t.length),console.log("[NT-Parse] Attempting to parse salvaged content...");try{const e=JSON.parse(t);return console.log("[NT-Parse] âœ… Successfully recovered JSON with",e.characters?.length||0,"characters"),console.log("[NT-Parse] ========== PARSE END (RECOVERED) =========="),e}catch(e){console.error("[NT-Parse] âŒ Recovery failed:",e.message),console.error("[NT-Parse] Salvaged text (first 500):",t.substring(0,500))}}throw console.log("[NT-Parse] ========== PARSE END (FAILED) =========="),new o.S_("Failed to parse LLM response as JSON. The response may be too long or truncated. Try analyzing fewer messages at once.")}})}async function k(e,t="",n=0,r=0){return(0,o.Xc)("callLLMAnalysis",async()=>{const l=(0,a.getLLMConfig)(),d=(await C()).maxPrompt;c.log();const g=e.map(e=>"string"==typeof e?e:e.mes?e.mes:e.message?e.message:JSON.stringify(e)),p=(0,i.tx)(g.join("\\n")+l.source+l.ollamaModel);if(h.has(p))return c.log(),h.get(p);const f=g.map((e,t)=>`Message ${t+1}:\\n${e}`).join("\\n\\n");let y=function(){const e=(0,a.TJ)(),t=e?.systemPrompt||u;return"string"==typeof t?t:u}();console.log("[NT-Prompt] getSystemPrompt() returned type:",typeof y),y&&"object"==typeof y&&"function"==typeof y.then&&(console.warn("[NT-Prompt] getSystemPrompt returned Promise, awaiting..."),y=await y,console.log("[NT-Prompt] After await, type:",typeof y)),"string"!=typeof y&&(console.warn("[NT-Prompt] systemPrompt is not a string, using default. Type:",typeof y,"Value:",y),y=u);let T=t||"";console.log("[NT-Prompt] knownCharacters type:",typeof T),T&&"object"==typeof T&&"function"==typeof T.then&&(console.warn("[NT-Prompt] knownCharacters is Promise, awaiting..."),T=await T,console.log("[NT-Prompt] After await, type:",typeof T)),T=String(T||""),console.log("[NT-Prompt] Final systemPrompt length:",y.length),console.log("[NT-Prompt] Final rosterStr length:",T.length),console.log("[NT-Prompt] systemPrompt preview:",y.substring(0,100));const v=y+(T?"\n\n"+T:""),w="[DATA TO ANALYZE]\n"+f;let S;const B=v+"\n\n"+w;try{S=await b([{mes:B}]),c.log()}catch(e){c.log(),S=Math.ceil(B.length/4)}if(S>d&&e.length>1){"  ".repeat(n);c.log();const r=Math.floor(e.length/2),o=e.slice(0,r),a=e.slice(r);c.log();const[s,i]=await Promise.all([k(o,t,n+1),k(a,t,n+1)]),l={characters:[...s.characters||[],...i.characters||[]]};return c.log(),l}let I;c.log(`Calling LLM with prompt (${S} tokens)...`),console.log("[NT-Prompt] Prompt composition:"),console.log("SYSTEM ("+v.length+" chars):"),console.log("=".repeat(80)),console.log(v),console.log("=".repeat(80)),console.log("USER ("+w.length+" chars):"),console.log("=".repeat(80)),console.log(w),console.log("=".repeat(80)),console.log("PREFILL:",""),console.log("=".repeat(80));try{if("ollama"===l.source){const e=v+"\n\n"+w+"\n";I=await async function(e){return(0,o.Xc)("callOllama",async()=>{const t=(0,a.getLLMConfig)();if(!t.ollamaModel)throw new o.S_("No Ollama model selected");c.log();const n=await A(t.ollamaModel),r=Math.floor(.25*n),s=Math.max(4e3,r);c.log();const i=await fetch(`${t.ollamaEndpoint}/api/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t.ollamaModel,prompt:e,stream:!1,format:"json",options:{temperature:.2,top_p:m,top_k:25,repeat_penalty:1.1,num_predict:s}})});if(!i.ok)throw new o.S_(`Ollama API error: ${i.statusText}`);const l=await i.json();return c.log(),c.log(),x(l.response)})}(e)}else I=await async function(e,t,n=""){return(0,o.Xc)("callSillyTavern",async()=>{c.log();const r=s.stContext.getContext();if(!r.onlineStatus)throw new o.S_("No API connection available. Please connect to an API first.");console.log("[NT-ST-Call] Starting SillyTavern LLM call"),console.log("[NT-ST-Call] System prompt length:",e.length,"characters"),console.log("[NT-ST-Call] User prompt length:",t.length,"characters"),n&&console.log("[NT-ST-Call] Prefill:",n),console.log("[NT-ST-Call] ========== PROMPT STRUCTURE START =========="),console.log("SYSTEM:",e),console.log("USER:",t),n&&console.log("PREFILL:",n),console.log("[NT-ST-Call] ========== PROMPT STRUCTURE END ==========");const a=e+"\n\n"+t+(n?"\n"+n:"");let i;try{i=await r.getTokenCountAsync(a),console.log("[NT-ST-Call] Token count:",i),c.log()}catch(e){console.log("[NT-ST-Call] Token count failed, estimating:",e.message),c.log(),i=Math.ceil(a.length/4),console.log("[NT-ST-Call] Estimated tokens:",i),c.log()}const l=r.maxContext||4096,d=Math.floor(.25*l),g=Math.max(4e3,d);console.log("[NT-ST-Call] Max context:",l,"Calculated maxTokens:",g),c.log();let h=null;for(let a=1;a<=3;a++)try{console.log(`[NT-ST-Call] Attempt ${a}/3`),console.log("[NT-ST-Call] Calling generateRaw with params:",{temperature:.2,top_p:m,top_k:25,rep_pen:1.1,responseLength:g});const s=await r.generateRaw({systemPrompt:e,prompt:t,prefill:n,temperature:.2,top_p:m,top_k:25,rep_pen:1.1,responseLength:g});console.log("[NT-ST-Call] ========== RAW API RESPONSE START =========="),console.log("[NT-ST-Call] Response type:",typeof s),console.log(JSON.stringify(s,null,2)),console.log("[NT-ST-Call] ========== RAW API RESPONSE END =========="),console.log("[NT-ST-Call] Raw result type:",typeof s),console.log("[NT-ST-Call] Raw result object:",JSON.stringify(s).substring(0,500));let i=s;if("object"==typeof s&&s.choices&&Array.isArray(s.choices)&&(s.choices[0]?.message?.content?(console.log("[NT-ST-Call] Detected chat completion format, extracting from choices[0].message.content"),i=s.choices[0].message.content):s.choices[0]?.text&&(console.log("[NT-ST-Call] Detected text completion format, extracting from choices[0].text"),i=s.choices[0].text)),console.log("[NT-ST-Call] Extracted text type:",typeof i),console.log("[NT-ST-Call] Extracted text length:",i?i.length:"null"),i&&"string"==typeof i&&console.log("[NT-ST-Call] Extracted text preview:",i.substring(0,300)),console.log("[NT-ST-Call] ========== EXTRACTED TEXT START =========="),console.log(i),console.log("[NT-ST-Call] ========== EXTRACTED TEXT END =========="),c.log(),!i||"string"!=typeof i)throw new o.S_("Empty or invalid response from SillyTavern LLM");if(n){console.log("[NT-ST-Call] Prepending prefill to complete JSON:",n),i=n+i;const e=(i.match(/{/g)||[]).length,t=(i.match(/}/g)||[]).length;if(e>t){const n=e-t;console.log(`[NT-ST-Call] Adding ${n} closing brace(s) to complete JSON`),i+="}".repeat(n)}console.log("[NT-ST-Call] Combined text preview:",i.substring(0,300))}const l=await x(i);console.log("[NT-ST-Call] parseJSONResponse returned type:",typeof l),console.log("[NT-ST-Call] parseJSONResponse returned value:",l),console.log("[NT-ST-Call] parsed.characters exists?:",l&&"characters"in l),console.log("[NT-ST-Call] parsed.characters type:",typeof l?.characters),console.log("[NT-ST-Call] parsed.characters is Array?:",Array.isArray(l?.characters));const d=Array.isArray(l?.characters)?l.characters.length:0;return console.log("[NT-ST-Call] âœ… Successfully parsed on attempt",a,"characters:",d),console.log("[NT-ST-Call] Parsed result:",JSON.stringify(l).substring(0,300)),l}catch(e){h=e,console.error(`[NT-ST-Call] âŒ Attempt ${a}/3 failed:`,e.message),console.error("[NT-ST-Call] Error details:",e),a<3&&(console.log("[NT-ST-Call] Waiting 2000ms before retry..."),await new Promise(e=>setTimeout(e,2e3)))}if(!confirm(`Failed to parse LLM response after 3 attempts.\n\nLast error: ${h.message}\n\nCheck console for detailed logs. Continue processing remaining batches?`))throw new o.S_("User aborted after parse failures");return{characters:[]}})}(v,w,"")}catch(o){if(r<3&&(o.message.includes("JSON")||o.message.includes("empty")||o.message.includes("truncated"))){c.log();const o=1e3*Math.pow(2,r);return await new Promise(e=>setTimeout(e,o)),await k(e,t,n,r+1)}throw o}if(I&&Array.isArray(I.characters)&&I.characters.length>0){if(h.size>50){const e=h.keys().next().value;h.delete(e)}h.set(p,I)}else console.warn("[NT-Cache] Skipping cache because result is empty or has no characters");return c.log(),I})}},806(e,t,n){n.d(t,{Ay:()=>a,Xv:()=>o});const r=new class{constructor(){this.modules=new Map,this.performanceMarks=new Map,this.operationTraces=new Map}createModuleLogger(e){if(this.modules.has(e))return this.modules.get(e);const t={log:(...t)=>this.log(e,"log",...t),warn:(...t)=>this.log(e,"warn",...t),error:(...t)=>this.log(e,"error",...t),debug:(...t)=>this.log(e,"debug",...t),trace:(t,n)=>this.addTrace(e,t,n),startTimer:t=>this.startTimer(e,t),endTimer:t=>this.endTimer(e,t)};return this.modules.set(e,t),t}log(e,t,...n){if(!this.isDebugEnabled())return;const r=`[STnametracker:${e}] ${(new Date).toLocaleTimeString()}`;switch(t){case"error":console.error(r,...n);break;case"warn":console.warn(r,...n);break;case"debug":console.debug(r,...n);break;default:console.log(r,...n)}}addTrace(e,t,n){this.isDebugEnabled()&&(this.operationTraces.has(t)||this.operationTraces.set(t,[]),this.operationTraces.get(t).push({module:e,timestamp:Date.now(),message:n}))}getTrace(e){return this.operationTraces.get(e)||[]}startTimer(e,t){const n=`${e}:${t}`;this.performanceMarks.set(n,performance.now())}endTimer(e,t){const n=`${e}:${t}`,r=this.performanceMarks.get(n);if(void 0===r)return this.log(e,"warn",`Timer '${t}' was not started`),0;const o=performance.now()-r;return this.performanceMarks.delete(n),this.log(e,"debug",`Timer '${t}': ${o.toFixed(2)}ms`),o}isDebugEnabled(){return!0}clear(){this.operationTraces.clear(),this.performanceMarks.clear()}getPerformanceSummary(){return{activeTimers:this.performanceMarks.size,activeTraces:this.operationTraces.size,modules:Array.from(this.modules.keys())}}};function o(e){return r.createModuleLogger(e)}const a=r},825(e){e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var r="";n.supports&&(r+="@supports (".concat(n.supports,") {")),n.media&&(r+="@media ".concat(n.media," {"));var o=void 0!==n.layer;o&&(r+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),r+=n.css,o&&(r+="}"),n.media&&(r+="}"),n.supports&&(r+="}");var a=n.sourceMap;a&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),t.styleTagTransform(r,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},854(e,t,n){n.d(t,{ZD:()=>o,cv:()=>a,tx:()=>r});function r(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return t.toString(36)}function o(e){if("string"!=typeof e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function a(){return Date.now().toString(36)+Math.random().toString(36).substr(2,9)}n(806).Ay.createModuleLogger("Utils").debug("Utils module loaded")}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var a=t[r]={id:r,exports:{}};return e[r](a,a.exports,n),a.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0;var r=n(72),o=n.n(r),a=n(825),s=n.n(a),i=n(659),l=n.n(i),c=n(56),d=n.n(c),g=n(540),m=n.n(g),h=n(113),p=n.n(h),u=n(83),f={};f.styleTagTransform=p(),f.setAttributes=d(),f.insert=l().bind(null,"head"),f.domAPI=s(),f.insertStyleElement=m();o()(u.A,f);u.A&&u.A.locals&&u.A.locals;var A=n(806),y=n(462),C=n(102),b=n(548),x=n(695),k=n(854),T=n(551),v=n(744),w=n(134);const S=(0,A.Xv)("processing"),B=new x.h("Message Processing");function I(e,t=null){console.log(`[NT-Processing] ${e}`,t||"")}function E(e){return Math.floor(.35*e)}async function N(e,t,n=!0){const r=[];let o=[],a=0;for(const s of e){const e=await(0,v.au)([s]),i=a+e>t,l=n&&o.length>=50;(i||l)&&o.length>0?(r.push(o),o=[s],a=e):(o.push(s),a+=e)}return o.length>0&&r.push(o),r}let _=[],M=!1,P=!1;const O={totalBatches:0,currentBatch:0,failedCharacters:[],lastError:null,contextTarget:80};async function L(e){return(0,y.Xc)("processAnalysisResults",async()=>{if(console.log("[NT-Processing] ðŸ”„ processAnalysisResults called"),console.log("[NT-Processing]    Input type:",typeof e),console.log("[NT-Processing]    Is array?:",Array.isArray(e)),console.log("[NT-Processing]    Length:",e?.length),!e||!Array.isArray(e))return console.warn("[NT-Processing] âš ï¸  Invalid input - not an array:",e),void S.log();console.log("[NT-Processing] âœ… Processing",e.length,"characters"),S.log();for(const t of e)try{console.log("[NT-Processing] ðŸ“ Processing character:",t.name),await R(t),console.log("[NT-Processing] âœ… Character processed:",t.name)}catch(e){console.error(`[NT-Processing] âŒ Error processing character ${t.name}:`,e),console.error("[NT-Processing] Error stack:",e.stack)}console.log("[NT-Processing] ðŸŽ‰ All characters processed")})}async function R(e){return(0,y.Xc)("processCharacterData",async()=>{if(console.log("[NT-CharData] ðŸ” Processing character data for:",e.name),!e.name||""===e.name.trim())return console.warn("[NT-CharData] âš ï¸  Character has no name, skipping"),void S.log();const t=e.name.trim();if(console.log("[NT-CharData]    Character name:",t),(0,T.eY)(t))return console.log("[NT-CharData] â­ï¸  Character is ignored, skipping:",t),void S.log();const n=t.toLowerCase().includes("{{char}}")||!0===e.isMainCharacter||"main"===e.role;console.log("[NT-CharData]    Is main char?:",n);const r=(0,T._$)(t);if(console.log("[NT-CharData]    Existing character found?:",!!r),r)console.log("[NT-CharData] ðŸ”„ Updating existing character:",r.preferredName),await(0,T.t9)(r,e,!1,n),console.log("[NT-CharData] ðŸ“š Updating lorebook entry..."),await(0,w.TQ)(r,r.preferredName),console.log("[NT-CharData] âœ… Existing character updated"),S.log();else{console.log("[NT-CharData] ðŸ” Checking for potential matches...");const r=await(0,T.rL)(e);if(console.log("[NT-CharData]    Potential match found?:",!!r),r)console.log("[NT-CharData] ðŸ”„ Updating potential match:",r.preferredName),await(0,T.t9)(r,e,!0,n),console.log("[NT-CharData] ðŸ“š Updating lorebook entry..."),await(0,w.TQ)(r,r.preferredName),console.log("[NT-CharData] âœ… Potential match updated"),S.log();else{console.log("[NT-CharData] ðŸ†• Creating new character:",t);const r=await(0,T.OW)(e,n);console.log("[NT-CharData] âœ… Character created:",r.preferredName),console.log("[NT-CharData] ðŸ“š Creating lorebook entry..."),await(0,w.TQ)(r,r.preferredName),console.log("[NT-CharData] âœ… New character complete"),S.log()}}})}async function z(e,t=!0){return(0,y.Xc)("harvestMessages",async()=>{if(!(0,b.TJ)("enabled",!0))return void S.log();if("sillytavern"===(0,b.getLLMConfig)().source){if(!C.stContext.getContext().onlineStatus)return void B.warning("Please connect to an API (OpenAI, Claude, etc.) before analyzing messages")}const n=C.stContext.getContext();if(!n.chat||0===n.chat.length)return S.log(),void B.info("No messages in chat to analyze");const r=n.chat.length,o=Math.max(0,r-e),a=n.chat.slice(o,r);I(`[Batching] Message selection: startIdx=${o}, endIdx=${r}, requesting ${e} messages, got ${a.length} messages`);const s=(await(0,v.getMaxPromptLength)()).maxPrompt,i=E(s);I(`[Batching] Token budget: maxPromptTokens=${s}, targetPercent=35%, availableTokens=${i}`),I(`[Batching] Context target: ${O.contextTarget}%`),I(`[Batching] Estimated reserves: systemPrompt=~1000tok, response=~4000tok, messages=${i}tok`);const l=await(0,v.au)(a);if(I(`[Batching] Total tokens for ${a.length} messages: ${l} tokens`),l>i){I(`[Batching] Messages exceed token limit (${l} > ${i}), creating batches`);const e=await N(a,i,!0),n=await Promise.all(e.map(async(e,t)=>{const n=await(0,v.au)(e);return`Batch ${t+1}: ${e.length}msg/${n}tok`}));I(`[Batching] Created ${e.length} total batches: ${n.join(" | ")}`),I(`[Batching] Constraints applied: MIN=5, TARGET=30, MAX=50, TokenLimit=${i}`),P=!1;const r=Math.round(a.length/e.length),s=`Analyzing ${a.length} messages in ${e.length} batches (~${r} messages each). This may take a while. Continue?`;if(t){if(!confirm(s))return I("[Batching] User cancelled batch processing"),void(P=!0)}j(0,e.length,"Starting analysis...");let c=0,d=0;const g=new Set;I(`[Batching] Starting batch processing loop: ${e.length} batches`);for(let t=0;t<e.length;t++){if(P)return I(`[BatchProcessing] User aborted at batch ${t+1}/${e.length}`),F(),void B.warning("Analysis aborted");const n=e[t],r=o+e.slice(0,t).reduce((e,t)=>e+t.length,0),a=r+n.length;I(`[BatchProcessing] Processing batch ${t+1}/${e.length}: messages ${r}-${a-1} (${n.length} messages)`);try{j(t+1,e.length,`Analyzing messages ${r+1}-${a}...`);const o=(0,v.fR)(),s=await(0,v.Kr)(n,o);console.log("[NT-Batch] ðŸ“Š LLM analysis returned"),console.log("[NT-Batch]    Type:",typeof s),console.log("[NT-Batch]    Value:",s),console.log("[NT-Batch]    Has characters?:",s&&"characters"in s),console.log("[NT-Batch]    Characters type:",typeof s?.characters),console.log("[NT-Batch]    Characters is Array?:",Array.isArray(s?.characters)),console.log("[NT-Batch]    Characters length:",s?.characters?.length),s.characters&&Array.isArray(s.characters)?(console.log("[NT-Batch] âœ… Calling processAnalysisResults with",s.characters.length,"characters"),await L(s.characters),s.characters.forEach(e=>g.add(e.name))):(console.warn("[NT-Batch] âš ï¸  Condition failed - not processing results"),console.warn("[NT-Batch]    analysis:",s),console.warn("[NT-Batch]    analysis.characters:",s?.characters)),c++,t<e.length-1&&await new Promise(e=>setTimeout(e,500))}catch(o){I(`[BatchProcessing] ERROR in batch ${t+1}: ${o.message}`),I(`[BatchProcessing] Context: messages ${r}-${a-1}, batch size ${n.length}, token count calc error`),console.error(`Error processing batch ${t+1}:`,o),d++;if(!confirm(`Batch ${t+1} failed.\n\nError: ${o.message}\n\nContinue with remaining batches?`)){I(`[BatchProcessing] User chose not to continue after error on batch ${t+1}/${e.length}`);break}I(`[BatchProcessing] User chose to continue despite error on batch ${t+1}/${e.length}`)}}F();const m=`Analysis complete!\n\nBatches processed: ${c}/${e.length}\nUnique characters found: ${g.size}\nFailed batches: ${d}`;return I(`[BatchProcessing] Batch analysis complete: ${c}/${e.length} successful, ${d} failed, ${g.size} characters found`),void(d>0?B.warning(m,"Batch Analysis",{timeOut:8e3}):B.success(m,"Batch Analysis",{timeOut:8e3}))}t&&B.info(`Analyzing ${a.length} messages for character information...`);try{const e=(0,v.fR)(),n=await(0,v.Kr)(a,e);S.log(),n.characters&&Array.isArray(n.characters)?(await L(n.characters),t&&B.success(`Found ${n.characters.length} character(s) in messages`)):S.log()}catch(e){console.error("Error during harvest:",e),B.error(`Analysis failed: ${e.message}`)}})}async function D(e){return(0,y.Xc)("onMessageReceived",async()=>{if(!(0,b.TJ)("enabled",!0)||!(0,b.TJ)("autoAnalyze",!0))return;const e=C.stContext.getContext().chat;if(!e||0===e.length)return;const t=e.length-1,n=(0,b.TJ)("lastScannedMessageId",-1);if(t<=n)return void S.log();if(n>=0&&t<n){S.log();const e=await async function(e,t){return new Promise(n=>{const r=$(`\n            <div class="name-tracker-rescan-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--SmartThemeBodyColor); border: 2px solid var(--SmartThemeBorderColor); padding: 20px; border-radius: 10px; z-index: 9999; max-width: 500px;">\n                <h3>Message History Changed</h3>\n                <p>Messages have been deleted or edited. Would you like to rescan the chat?</p>\n                <p>Current last scanned message: ${t}<br>\n                Current message index: ${e}</p>\n                <div style="margin-top: 15px;">\n                    <label>Rescan from message: <input type="number" id="rescan-from" value="0" min="0" max="${e}" style="width: 80px; margin-left: 10px;"></label>\n                </div>\n                <div style="margin-top: 15px; text-align: right;">\n                    <button id="rescan-yes" class="menu_button">Rescan</button>\n                    <button id="rescan-no" class="menu_button">Skip</button>\n                </div>\n            </div>\n        `);$("body").append(r),r.find("#rescan-yes").on("click",()=>{const e=parseInt(r.find("#rescan-from").val())||0;r.remove(),n({rescan:!0,fromMessage:e})}),r.find("#rescan-no").on("click",()=>{r.remove(),n({rescan:!1})})})}(t,n);return e.rescan?((0,b.nT)("lastScannedMessageId",e.fromMessage-1),void U(async()=>{await z(t-e.fromMessage+1,!0)})):void(0,b.nT)("lastScannedMessageId",t)}const r=(0,b.TJ)("messageFrequency",10);t-n>=r&&(S.log(),U(async()=>{await z(r,!0),(0,b.nT)("lastScannedMessageId",t)}))})}function j(e,t,n=""){const r="name_tracker_progress",o=$(`.${r}`);if(o.length>0)return n&&o.find(".title").text(n),o.find(".progress").text(e),o.find(".total").text(t),void o.find("progress").val(e).attr("max",t);const a=$(`\n        <div class="${r} name_tracker_progress_bar flex-container justifyspacebetween alignitemscenter" style="\n            padding: 10px;\n            margin: 5px 0;\n            background: var(--SmartThemeBlurTintColor);\n            border: 1px solid var(--SmartThemeBorderColor);\n            border-radius: 5px;\n        ">\n            <div class="title" style="flex: 1; font-weight: bold;">${n||"Name Tracker Scan"}</div>\n            <div style="margin: 0 10px;">(<span class="progress">${e}</span> / <span class="total">${t}</span>)</div>\n            <progress value="${e}" max="${t}" style="flex: 2; margin: 0 10px;"></progress>\n            <button class="menu_button fa-solid fa-stop" title="Abort scan" style="padding: 5px 10px;"></button>\n        </div>\n    `);a.find("button").on("click",function(){P=!0,F(),B.warning("Scan aborted by user")}),$("#sheld").append(a)}function F(){const e=$(".name_tracker_progress");e.length>0&&e.fadeOut(300,function(){$(this).remove()})}async function U(e){return(0,y.Xc)("addToQueue",async()=>{_.push(e),M||await async function(){return(0,y.Xc)("processQueue",async()=>{if(!M&&0!==_.length){for(M=!0;_.length>0;){const e=_.shift();try{await e()}catch(e){console.error("Error processing queue task:",e)}}M=!1}})}()})}const X=(0,A.Xv)("ui"),W=new x.h("UI Management");function J(){return(0,y.Xc)("updateCharacterList",()=>{const e=$("#name_tracker_character_list");if(0===e.length)return void X.log();const t=(0,b.bg)();if(0===Object.keys(t).length)return void e.html('\n                <div class="name_tracker_no_characters">\n                    <p style="text-align: center; color: var(--SmartThemeQuoteColor);">\n                        No characters tracked yet. Start a conversation and character information will be extracted automatically!\n                    </p>\n                </div>\n            ');const n=Object.values(t).sort((e,t)=>e.isMainChar&&!t.isMainChar?-1:!e.isMainChar&&t.isMainChar?1:e.preferredName.localeCompare(t.preferredName));let r='<div class="name_tracker_character_list">';for(const e of n){const t=e.isMainChar?'<i class="fa-solid fa-user"></i>':"",n=e.ignored?'<span class="char-ignored-badge">IGNORED</span>':"",o=(0,T.pp)(e)?'<span class="char-review-badge">NEEDS REVIEW</span>':"",a=e.aliases&&e.aliases.length>0?`<div class="char-aliases">Aliases: ${(0,k.ZD)(e.aliases.join(", "))}</div>`:"",s=e.relationships&&e.relationships.length>0?`<div class="char-relationships">Relationships: ${(0,k.ZD)(e.relationships.join("; "))}</div>`:"",i=e.lastUpdated?new Date(e.lastUpdated).toLocaleString():"Never";r+=`\n                <div class="name_tracker_character_item" data-character="${(0,k.ZD)(e.preferredName)}">\n                    <div class="char-header">\n                        <span class="char-name">\n                            ${t}\n                            ${(0,k.ZD)(e.preferredName)}\n                            ${n}\n                            ${o}\n                        </span>\n                        <div class="char-actions">\n                            <button class="char-action-btn char-action-edit" data-name="${(0,k.ZD)(e.preferredName)}" title="Edit lorebook entry">\n                                <i class="fa-solid fa-edit"></i>\n                            </button>\n                            <button class="char-action-btn char-action-view" data-name="${(0,k.ZD)(e.preferredName)}" title="View in lorebook">\n                                <i class="fa-solid fa-book"></i>\n                            </button>\n                            <button class="char-action-btn char-action-merge" data-name="${(0,k.ZD)(e.preferredName)}" title="Merge with another character">\n                                <i class="fa-solid fa-code-merge"></i>\n                            </button>\n                            <button class="char-action-btn char-action-ignore" data-name="${(0,k.ZD)(e.preferredName)}" title="${e.ignored?"Unignore":"Ignore"} character">\n                                <i class="fa-solid ${e.ignored?"fa-eye":"fa-eye-slash"}"></i>\n                            </button>\n                        </div>\n                    </div>\n                    ${a}\n                    ${s}\n                    <div class="char-metadata">\n                        <span>Confidence: ${e.confidence}%</span>\n                        <span>Updated: ${i}</span>\n                    </div>\n                </div>\n            `}r+="</div>",e.html(r)})}function Z(){return(0,y.Xc)("updateStatusDisplay",()=>{const e=$("#name_tracker_status_display");if(0===e.length)return;const t=(0,b.bg)(),n=Object.keys(t).length,r=(0,b.PL)("messageCounter",0),o=(0,b.PL)("lastScannedMessageId",-1),a=(0,b.PL)("messageFrequency",10),s=C.stContext.getContext(),i=s?.chat?.length||0,l=Math.max(0,i-o),c=r>0?` (${r} analyzed)`:"",d=s.chat?s.chat.length:0,g=`\n            <div class="name_tracker_status">\n                <div class="status-item">\n                    <strong>Characters tracked:</strong> ${n}${c}\n                </div>\n                <div class="status-item">\n                    <strong>Messages in chat:</strong> ${d}\n                </div>\n                <div class="status-item">\n                    <strong>Last scanned message:</strong> ${o>=0?o+1:"None"}\n                </div>\n                <div class="status-item">\n                    <strong>Pending messages:</strong> ${l}\n                </div>\n                <div class="status-item">\n                    <strong>Messages until next scan:</strong> ${Math.max(0,a-(d-o))}\n                </div>\n            </div>\n        `;e.html(g)})}function Q(){return(0,y.Xc)("showCharacterListModal",()=>{const e=Object.values((0,b.bg)()||{});let t="";if(0===e.length)t='<p style="text-align: center; color: var(--SmartThemeQuoteColor);">No characters tracked yet</p>';else{e.sort((e,t)=>e.isMainChar&&!t.isMainChar?-1:!e.isMainChar&&t.isMainChar?1:e.preferredName.localeCompare(t.preferredName)),t='<div style="max-height: 400px; overflow-y: auto;">';for(const n of e){const e=[];n.isMainChar&&e.push('<span style="background: var(--SmartThemeBodyColor); padding: 2px 6px; border-radius: 3px; font-size: 0.85em; margin-left: 5px;">MAIN</span>'),n.ignored&&e.push('<span style="background: var(--black70a); padding: 2px 6px; border-radius: 3px; font-size: 0.85em; margin-left: 5px;">IGNORED</span>'),(0,T.pp)(n)&&e.push('<span style="background: var(--crimsonDark); padding: 2px 6px; border-radius: 3px; font-size: 0.85em; margin-left: 5px;">NEEDS REVIEW</span>');const r=n.aliases&&n.aliases.length>0?`<div style="font-size: 0.9em; color: var(--SmartThemeQuoteColor); margin-top: 3px;">Aliases: ${(0,k.ZD)(n.aliases.join(", "))}</div>`:"";t+=`\n                    <div style="padding: 10px; margin: 5px 0; background: var(--SmartThemeBlurTintColor); border: 1px solid var(--SmartThemeBorderColor); border-radius: 5px;">\n                        <div style="font-weight: bold;">\n                            ${n.isMainChar?'<i class="fa-solid fa-user" style="margin-right: 5px;"></i>':""}\n                            ${(0,k.ZD)(n.preferredName)}\n                            ${e.join("")}\n                        </div>\n                        ${r}\n                    </div>\n                `}t+="</div>"}const n=`\n            <div class="name-tracker-character-modal">\n                <h3 style="margin-top: 0;">Tracked Characters (${e.length})</h3>\n                ${t}\n                <div style="margin-top: 15px; text-align: center;">\n                    <button class="menu_button" onclick="$('#name_tracker_settings').find('.inline-drawer-toggle').click(); $(this).closest('.popup').remove();">\n                        <i class="fa-solid fa-gear"></i> Open Settings\n                    </button>\n                </div>\n            </div>\n        `,r=C.stContext.getContext();r.callGenericPopup(n,r.POPUP_TYPE.TEXT,"",{wider:!0,okButton:"Close"})})}function G(){return(0,y.Xc)("initializeUIHandlers",()=>{$(document).on("click",".char-action-merge",async function(){const e=$(this).data("name");await async function(e){return(0,y.Xc)("showMergeDialog",async()=>{const t=(0,b.bg)(),n=Object.keys(t).filter(t=>t!==e);if(0===n.length)return void W.warning("No other characters to merge with");const r=prompt(`Merge "${e}" into which character? Available: ${n.join(", ")}`);r&&t[r]?(await(0,T.lF)(e,r),J(),Z()):r&&W.error("Invalid target character name")})}(e)}),$(document).on("click",".char-action-ignore",async function(){const e=$(this).data("name");await(0,T.el)(e),J(),Z()}),$(document).on("click",".char-action-view",async function(){const e=$(this).data("name");await(0,w._Z)(e)}),$(document).on("click",".char-action-edit",async function(){const e=$(this).data("name");await async function(e){return(0,y.Xc)("showEditLorebookModal",async()=>{const t=(0,b.qN)(e);if(!t)return void W.error("Character not found");const n=[e,...t.aliases||[]].join(", "),r=`\n            <div class="lorebook-entry-editor">\n                <h3>Edit Lorebook Entry: ${(0,k.ZD)(e)}</h3>\n                \n                <div class="editor-section">\n                    <label for="entry-keys">Keys (comma-separated):</label>\n                    <input type="text" id="entry-keys" class="text_pole" value="${(0,k.ZD)(n)}" \n                           placeholder="${(0,k.ZD)(e)}, aliases, nicknames">\n                    <small>These words trigger this entry in the chat context</small>\n                </div>\n                \n                <div class="editor-section">\n                    <label for="entry-content">Entry Content:</label>\n                    <textarea id="entry-content" rows="10" class="text_pole" \n                              placeholder="Description, personality, background, relationships...">${(0,k.ZD)(t.notes||"")}</textarea>\n                    <small>This will be injected into context when keys are mentioned</small>\n                </div>\n                \n                <div class="editor-section">\n                    <label for="entry-relationships">Relationships:</label>\n                    <textarea id="entry-relationships" rows="3" class="text_pole" \n                              placeholder="Friend of Alice; Enemy of Bob; Works for XYZ Corp">${(0,k.ZD)((t.relationships||[]).join("; "))}</textarea>\n                    <small>One relationship per line or semicolon-separated</small>\n                </div>\n            </div>\n        `,o=$(`\n            <div class="nametracker-modal" style="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: var(--SmartThemeBlurTintColor);\n                border: 1px solid var(--SmartThemeBorderColor);\n                border-radius: 10px;\n                padding: 20px;\n                max-width: 600px;\n                width: 90%;\n                max-height: 80vh;\n                overflow-y: auto;\n                z-index: 9999;\n                box-shadow: 0 4px 20px rgba(0,0,0,0.5);\n            ">\n                ${r}\n                <div style="margin-top: 20px; text-align: right;">\n                    <button class="menu_button" id="entry-save">Save</button>\n                    <button class="menu_button" id="entry-cancel">Cancel</button>\n                </div>\n            </div>\n        `),a=$('\n            <div class="nametracker-overlay" style="\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.7);\n                z-index: 9998;\n            "></div>\n        ');$("body").append(a).append(o);const s=()=>{o.remove(),a.remove()};o.find("#entry-save").on("click",async()=>{const n=o.find("#entry-keys").val().split(",").map(e=>e.trim()).filter(e=>e),r=o.find("#entry-content").val(),a=o.find("#entry-relationships").val().split(/[;\\n]/).map(e=>e.trim()).filter(e=>e),i=n[0]||e,l=n.slice(1);t.preferredName=i,t.aliases=l,t.notes=r,t.relationships=a,i!==e&&(0,b.sr)(e),(0,b.e7)(i,t),J(),Z(),W.success(`Updated lorebook entry for ${i}`),s()}),o.find("#entry-cancel").on("click",s),a.on("click",s)})}(e)}),X.log()})}function H(e,t,n,r=null,o=""){return(0,y.Xc)("addMenuButton",()=>{const a=$(`\n            <div class="list-group-item flex-container flexGap5 interactable ${o}" title="${r||e}" tabindex="0">\n                <i class="${t}"></i>\n                <span>${e}</span>\n            </div>\n        `),s=$("#extensionsMenu");s.length?(a.appendTo(s),a.on("click",()=>n())):console.error("[Name Tracker] Could not find the extensions menu")})}function q(){return(0,y.Xc)("toggleAutoHarvest",()=>{const e=(0,b.PL)("autoAnalyze",!0);(0,b.ZC)("autoAnalyze",!e),$("#name_tracker_auto_analyze").prop("checked",!e);const t=$("#extensionsMenu .name-tracker-toggle-harvest");e?t.find("i").removeClass("fa-toggle-on").addClass("fa-toggle-off"):t.find("i").removeClass("fa-toggle-off").addClass("fa-toggle-on"),Z(),W.success("Auto-harvest "+(e?"disabled":"enabled"))})}async function Y(){return(0,y.Xc)("openChatLorebook",async()=>{const e=C.stContext.getContext(),t=e.chatMetadata?.world_info;t?"function"==typeof e.openWorldInfoEditor?await e.openWorldInfoEditor(t):($("#WorldInfo").click(),W.info(`Please select "${t}" from the World Info panel`)):W.warning("No active chat or lorebook")})}function K(){return(0,y.Xc)("initializeMenuButtons",()=>{H("Toggle Auto-Harvest",(0,b.PL)("autoAnalyze",!0)?"fa-solid fa-toggle-on":"fa-solid fa-toggle-off",q,"Toggle automatic character harvesting on/off","name-tracker-toggle-harvest"),H("View Characters","fa-solid fa-users",Q,"View all tracked characters"),H("Open Chat Lorebook","fa-solid fa-book",Y,"Open the Name Tracker chat lorebook in the World Info editor"),X.log()})}function V(){return(0,y.Xc)("bindSettingsHandlers",()=>{$("#name_tracker_enabled").on("input",e=>{(0,b.ZC)("enabled",e.target.checked),Z()}),$("#name_tracker_auto_analyze").on("input",e=>{(0,b.ZC)("autoAnalyze",e.target.checked),Z()}),$("#name_tracker_message_frequency").on("input",e=>{(0,b.ZC)("messageFrequency",parseInt(e.target.value)||10),Z()}),$("#name_tracker_llm_source").on("change",e=>{(0,b.ZC)("llmSource",e.target.value)}),$("#name_tracker_ollama_endpoint").on("input",e=>{(0,b.ZC)("ollamaEndpoint",e.target.value)}),$("#name_tracker_ollama_model").on("change",e=>{(0,b.ZC)("ollamaModel",e.target.value)}),$("#name_tracker_load_models").on("click",async()=>{try{await(0,v.Bw)(),W.success("Ollama models loaded")}catch(e){X.log(),W.error("Failed to load Ollama models")}}),$("#name_tracker_confidence_threshold").on("input",e=>{(0,b.ZC)("confidenceThreshold",parseInt(e.target.value)||70)}),$("#name_tracker_lorebook_position").on("change",e=>{(0,b.ZC)("lorebookPosition",parseInt(e.target.value)||0)}),$("#name_tracker_lorebook_depth").on("input",e=>{(0,b.ZC)("lorebookDepth",parseInt(e.target.value)||1)}),$("#name_tracker_lorebook_cooldown").on("input",e=>{(0,b.ZC)("lorebookCooldown",parseInt(e.target.value)||5)}),$("#name_tracker_lorebook_probability").on("input",e=>{(0,b.ZC)("lorebookProbability",parseInt(e.target.value)||100)}),$("#name_tracker_lorebook_enabled").on("input",e=>{(0,b.ZC)("lorebookEnabled",e.target.checked)}),$("#name_tracker_debug_mode").on("input",e=>{(0,b.ZC)("debugMode",e.target.checked)}),$("#name_tracker_manual_analyze").on("click",async()=>{const e=(0,b.PL)("messageFrequency",10);await z(e,!0),J(),Z()}),$("#name_tracker_scan_all").on("click",async()=>{await async function(){return(0,y.Xc)("scanEntireChat",async()=>{const e=C.stContext.getContext();if(!e.chat||0===e.chat.length)return void B.warning("No chat messages to scan");if("sillytavern"===(0,b.getLLMConfig)().source&&!e.onlineStatus)return void B.warning("Please connect to an API (OpenAI, Claude, etc.) before analyzing messages");const t=e.chat.length,n=E((await(0,v.getMaxPromptLength)()).maxPrompt),r=await N(e.chat,n,!1),o=r.length;if(!confirm(`This will analyze all ${t} messages in ${o} batches. This may take a while. Continue?`))return;P=!1,j(0,o,"Starting batch scan...");let a=0,s=0;const i=new Set;for(let e=0;e<o;e++){if(P){S.log();break}const t=r[e],n=r.slice(0,e).reduce((e,t)=>e+t.length,0),l=n+t.length;try{j(e+1,o,`Processing messages ${n+1}-${l}...`);const r=(0,v.fR)(),s=await(0,v.Kr)(t,r);s.characters&&Array.isArray(s.characters)&&(await L(s.characters),s.characters.forEach(e=>i.add(e.name))),a++,e<o-1&&await new Promise(e=>setTimeout(e,1e3))}catch(t){if(console.error(`Error processing batch ${e+1}:`,t),s++,!confirm(`Batch ${e+1} failed.\n\nError: ${t.message}\n\nContinue with remaining batches?`))break}}F(),(0,b.nT)("lastScannedMessageId",t-1);const l=`Full chat scan complete!\n\nMessages: ${t}\nBatches: ${a}/${o}\nCharacters found: ${i.size}\nFailed: ${s}`,c=String(l||"Scan completed");s>0?B.warning(c,"Scan Complete",{timeOut:1e4}):B.success(c,"Scan Complete",{timeOut:1e4})})}(),J(),Z()}),$("#name_tracker_create_character").on("click",()=>{!async function(){(0,y.Xc)("showCreateCharacterModal",async()=>{const e=prompt("Enter character name:");if(e&&e.trim())try{await(0,T.g9)(e.trim()),J(),Z()}catch(e){W.error(e.message)}})}()}),$("#name_tracker_clear_cache").on("click",()=>{_=[],M=!1,S.log(),W.info("Cache and processing queue cleared")}),$("#name_tracker_undo_merge").on("click",async()=>{const{undoLastMerge:e}=await Promise.resolve().then(n.bind(n,551));await e()&&(J(),Z())}),$("#name_tracker_purge_entries").on("click",()=>{!async function(){(0,y.Xc)("showPurgeConfirmation",async()=>{const e=(0,b.bg)(),t=Object.keys(e).length;if(0!==t){if(confirm(`This will delete all ${t} tracked characters and their lorebook entries.\\n\\nThis action cannot be undone!\\n\\nContinue?`))try{const e=await(0,T.vu)();J(),Z(),W.success(`Purged ${e} characters`)}catch(e){W.error(`Failed to purge characters: ${e.message}`)}}else W.info("No characters to purge")})}()}),$("#name_tracker_edit_prompt").on("click",()=>{!async function(){(0,y.Xc)("showSystemPromptEditor",async()=>{const e=(0,b.PL)("systemPrompt")||"",t=$(`\n            <div class="nametracker-modal" style="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: var(--SmartThemeBlurTintColor);\n                border: 1px solid var(--SmartThemeBorderColor);\n                border-radius: 10px;\n                padding: 20px;\n                max-width: 700px;\n                width: 90%;\n                max-height: 80vh;\n                overflow-y: auto;\n                z-index: 9999;\n                box-shadow: 0 4px 20px rgba(0,0,0,0.5);\n            ">\n                <h3 style="margin-top: 0;">Edit System Prompt</h3>\n                <p>Customize the system prompt used for character analysis. Leave blank to use default.</p>\n                <textarea id="system_prompt_editor" rows="20" style="width: 100%; margin: 10px 0;" \n                          placeholder="Enter custom system prompt or leave blank for default...">${(0,k.ZD)(e)}</textarea>\n                <div style="margin-top: 20px; text-align: right;">\n                    <button class="menu_button" id="system_prompt_save">Save</button>\n                    <button class="menu_button" id="system_prompt_reset">Reset to Default</button>\n                    <button class="menu_button" id="system_prompt_cancel">Cancel</button>\n                </div>\n            </div>\n        `),n=$('\n            <div class="nametracker-overlay" style="\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.7);\n                z-index: 9998;\n            "></div>\n        ');$("body").append(n).append(t);const r=()=>{t.remove(),n.remove()};t.find("#system_prompt_save").on("click",()=>{const e=t.find("#system_prompt_editor").val().trim();(0,b.ZC)("systemPrompt",e||null),W.success("System prompt updated"),r()}),t.find("#system_prompt_reset").on("click",()=>{t.find("#system_prompt_editor").val(""),(0,b.ZC)("systemPrompt",null),W.success("Reset to default system prompt"),r()}),t.find("#system_prompt_cancel").on("click",r),n.on("click",r)})}()}),$("#name_tracker_debug_status").on("click",()=>{(0,y.Xc)("showDebugStatus",async()=>{const e=(0,b.TJ)(),t=(0,b.bg)(),r=async()=>{let r={},o=4096,a={},s="unknown",i="";try{const{getMaxPromptLength:e}=await Promise.resolve().then(n.bind(n,744)),{getLLMConfig:t}=await Promise.resolve().then(n.bind(n,548)),{stContext:l}=await Promise.resolve().then(n.bind(n,102));r=t();const c=await e();o=c.maxPrompt,s=c.detectionMethod,i=c.debugLog||"";let d=l.getContext();if(!d||void 0===d.maxContext)for(let e=0;e<3&&(await new Promise(e=>setTimeout(e,200)),d=l.getContext(),!d||void 0===d.maxContext);e++);if(d&&void 0!==d.maxContext){const e=d.maxContext;a={totalContext:e,maxGeneration:Math.min(4096,Math.floor(.15*e)),maxGenerationNote:"Extension-controlled (15% of context, max 4096)",modelName:d.main_api||"unknown"}}else a={totalContext:"Not loaded yet (no chat active)",maxGeneration:"N/A",maxGenerationNote:"Context will be available after chat loads",modelName:d?.main_api||"unknown"}}catch(e){console.error("[NT-Debug] Error in buildDebugContent:",e),X.log("Could not load LLM config:",e),a={totalContext:"Error loading",maxGeneration:"Error",maxGenerationNote:"Check console for details",modelName:"unknown"},s="error"}const l={MIN_MESSAGES_PER_BATCH:5,TARGET_MESSAGES_PER_BATCH:30,MAX_MESSAGES_PER_BATCH:50,CONTEXT_TARGET_PERCENT:80,MIN_CONTEXT_TARGET:50},c=500,d=500,g=c+("number"==typeof a.maxGeneration?a.maxGeneration:2048)+d,m=o,h={"Extension Status":{Enabled:!1!==e.enabled,"Debug Mode":!1!==e.debugMode,"LLM Source":e.llmSource||"sillytavern","Model API":a.modelName,"Tracked Characters":Object.keys(t).length},"SillyTavern Context":{"Total Context Window":a.totalContext,"Extension Max Tokens":`${a.maxGeneration} (${a.maxGenerationNote})`,"System Prompt Reserve":c,"Safety Margin":d,"Total Reserved":g},"Max Context Detection":{"Detection Method":s||"unknown","Detected Max Context":a.totalContext,"Final Max Prompt":o},"Usable Token Budget":{"Max Prompt Tokens":o,"Context Target %":l.CONTEXT_TARGET_PERCENT,"Tokens to Use":Math.floor(m*(l.CONTEXT_TARGET_PERCENT/100))},"Batch Configuration":{"Min Messages/Batch":l.MIN_MESSAGES_PER_BATCH,"Target Messages/Batch":l.TARGET_MESSAGES_PER_BATCH,"Max Messages/Batch":l.MAX_MESSAGES_PER_BATCH,"Min Context Target":l.MIN_CONTEXT_TARGET},"Analysis Settings":{"Message Frequency":e.messageFrequency||10,"Auto-Analyze":!1!==e.autoAnalyze,"Confidence Threshold":e.confidenceThreshold||70},"Lorebook Settings":{Position:["After Char","Before Char","Top","Bottom"][e.lorebookPosition||0],Depth:e.lorebookDepth||1,Cooldown:e.lorebookCooldown||5,"Probability %":e.lorebookProbability||100,Enabled:!1!==e.lorebookEnabled}};let p='<div style="font-family: monospace; font-size: 12px; max-height: 500px; overflow-y: auto;">';for(const[e,t]of Object.entries(h)){p+='<div style="margin-bottom: 15px; border-bottom: 1px solid #666; padding-bottom: 10px;">',p+=`<strong style="color: #90EE90; font-size: 13px;">${e}</strong><br>`;for(const[e,n]of Object.entries(t))p+=`<div style="margin-left: 10px; padding: 2px 0;">\n                        <span style="color: #87CEEB;">${e}:</span> \n                        <span style="color: #FFFF99;">${!0===n?"âœ“":!1===n?"âœ—":n}</span>\n                    </div>`;p+="</div>"}return p+="</div>",{debugInfo:h,htmlContent:p}},o=await r(),a=$(`\n            <div class="nametracker-modal" style="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: #1a1a1a;\n                border: 2px solid #90EE90;\n                border-radius: 10px;\n                padding: 20px;\n                max-width: 550px;\n                width: 90%;\n                max-height: 75vh;\n                overflow-y: auto;\n                z-index: 9999;\n                box-shadow: 0 4px 20px rgba(0,0,0,0.8);\n            ">\n                <h3 style="margin-top: 0; color: #90EE90; border-bottom: 2px solid #90EE90; padding-bottom: 10px;">\n                    <i class="fa-solid fa-bug"></i> Debug Status\n                </h3>\n                <div id="nt-debug-content">${o.htmlContent}</div>\n                <div style="margin-top: 20px; display: flex; gap: 8px; justify-content: flex-end; border-top: 1px solid #666; padding-top: 10px;">\n                    <button class="menu_button" id="debug-refresh" style="background: #2a2a2a; color: #FFFF99; border: 1px solid #90EE90;">Refresh</button>\n                    <button class="menu_button" id="debug-close" style="background: #2a2a2a; color: #90EE90; border: 1px solid #90EE90;">Close</button>\n                </div>\n            </div>\n        `),s=$('\n            <div class="nametracker-overlay" style="\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.7);\n                z-index: 9998;\n            "></div>\n        ');$("body").append(s).append(a);const i=()=>{a.remove(),s.remove()};a.find("#debug-close").on("click",i),s.on("click",i),console.log("[NT-Debug]",o.debugInfo),a.find("#debug-refresh").on("click",async()=>{try{const e=await r();a.find("#nt-debug-content").html(e.htmlContent),console.log("[NT-Debug]",e.debugInfo)}catch(e){console.error("[NT-Debug] Refresh failed:",e)}})})}),$("#name_tracker_dump_context").on("click",()=>{(0,y.Xc)("dumpContextToConsole",()=>{try{const e=C.stContext.dumpContextToConsole();W.success("Context dumped to console - Press F12 to view","Context Dump");const t={"Total Properties":e.availableProperties.length,"Key Properties Found":Object.keys(e.detailedBreakdown).filter(t=>t in e.detailedBreakdown).length,Timestamp:e.timestamp};console.log("%c[Name Tracker] QUICK SUMMARY:","color: #ffaa00; font-weight: bold; font-size: 12px;"),console.table(t)}catch(e){X.log(`Failed to dump context: ${e.message}`),W.error(`Failed to dump context: ${e.message}`,"Context Dump")}})}),X.log()})}function ee(){return(0,y.Xc)("updateUI",()=>{$("#name_tracker_enabled").prop("checked",(0,b.PL)("enabled",!0)),$("#name_tracker_auto_analyze").prop("checked",(0,b.PL)("autoAnalyze",!0)),$("#name_tracker_message_frequency").val((0,b.PL)("messageFrequency",10)),$("#name_tracker_llm_source").val((0,b.PL)("llmSource","sillytavern")),$("#name_tracker_ollama_endpoint").val((0,b.PL)("ollamaEndpoint","http://localhost:11434")),$("#name_tracker_ollama_model").val((0,b.PL)("ollamaModel","")),$("#name_tracker_confidence_threshold").val((0,b.PL)("confidenceThreshold",70)),$("#name_tracker_lorebook_position").val((0,b.PL)("lorebookPosition",0)),$("#name_tracker_lorebook_depth").val((0,b.PL)("lorebookDepth",1)),$("#name_tracker_lorebook_cooldown").val((0,b.PL)("lorebookCooldown",5)),$("#name_tracker_lorebook_probability").val((0,b.PL)("lorebookProbability",100)),$("#name_tracker_lorebook_enabled").prop("checked",(0,b.PL)("lorebookEnabled",!0)),$("#name_tracker_debug_mode").prop("checked",(0,b.PL)("debugMode",!1)),J(),Z(),X.log()})}console.log("[STnametracker] Main index.js: Import validation"),console.log("[STnametracker] Main index.js: initializeLorebook import =",typeof w.WF,w.WF),console.log("[STnametracker] Main index.js: initializeUIHandlers import =",typeof G,G),console.log("[STnametracker] Main index.js: initializeMenuButtons import =",typeof K,K),console.log("[STnametracker] Main index.js: bindSettingsHandlers import =",typeof V,V),console.log("[STnametracker] Main index.js: updateUI import =",typeof ee,ee),"function"!=typeof w.WF&&(console.error("[STnametracker] Main index.js: CRITICAL ERROR - initializeLorebook import failed!"),console.error("[STnametracker] Main index.js: Expected function, got:",typeof w.WF,w.WF));const te="STnametracker",ne=`scripts/extensions/third-party/${te}`;const re=A.Ay.createModuleLogger("Main");const oe=new class{constructor(){this.initialized=!1,this.modules=new Map}async initialize(){return console.log("[STnametracker] Enter initialize() method"),y.r_.withErrorBoundary("Main",async()=>{console.log("[STnametracker] Inside error boundary"),this.initialized?console.log("[STnametracker] Already initialized, skipping"):(console.log("[STnametracker] Starting initialization sequence"),re.log("Starting Name Tracker Extension v2.1.0"),console.log("[STnametracker] Step 1: Initializing core systems..."),await this.initializeCore(),console.log("[STnametracker] Step 1: Core systems completed"),console.log("[STnametracker] Step 2: Initializing feature modules..."),await this.initializeModules(),console.log("[STnametracker] Step 2: Feature modules completed"),console.log("[STnametracker] Step 3: Initializing UI..."),await this.initializeUI(),console.log("[STnametracker] Step 3: UI completed"),console.log("[STnametracker] Step 4: Registering event listeners..."),this.registerEventListeners(),console.log("[STnametracker] Step 4: Event listeners completed"),this.initialized=!0,console.log("[STnametracker] Marking as initialized"),re.log("Name Tracker Extension initialized successfully"),console.log("[STnametracker] Full initialization sequence completed successfully"))},{retries:2,fallback:async e=>(re.error("Failed to initialize extension:",e),x.A.error("Failed to initialize","Extension Error"),!1)})}async initializeCore(){console.log("[STnametracker] initializeCore: Starting..."),re.debug("Initializing core systems..."),console.log("[STnametracker] initializeCore: Connecting debug system..."),A.Ay.isDebugEnabled=()=>(0,b.PL)("debugMode",!1),console.log("[STnametracker] initializeCore: Debug system connected"),console.log("[STnametracker] initializeCore: Settings ready"),this.setupErrorRecovery(),re.debug("Core systems initialized")}async initializeModules(){if(re.debug("Initializing feature modules..."),console.log("[STnametracker] initializeModules: Starting module initialization"),console.log("[STnametracker] initializeModules: Checking import of initializeLorebook..."),console.log("[STnametracker] initializeModules: initializeLorebook =",typeof w.WF,w.WF),"function"!=typeof w.WF)throw console.error("[STnametracker] initializeModules: CRITICAL - initializeLorebook is not a function!"),console.error("[STnametracker] initializeModules: Type:",typeof w.WF),console.error("[STnametracker] initializeModules: Value:",w.WF),new Error("initializeLorebook is not a function: "+typeof w.WF);try{console.log("[STnametracker] initializeModules: About to call initializeLorebook()..."),await(0,w.WF)(),console.log("[STnametracker] initializeModules: initializeLorebook() completed successfully"),re.debug("Feature modules initialized")}catch(e){throw console.error("[STnametracker] initializeModules: Error in initializeLorebook:",e),re.error("Failed to initialize feature modules:",e),e}}async initializeUI(){console.log("[STnametracker] initializeUI: Starting UI initialization..."),re.debug("Initializing UI...");try{console.log("[STnametracker] initializeUI: Loading settings HTML from:",`${ne}/settings.html`);const e=await $.get(`${ne}/settings.html`);console.log("[STnametracker] initializeUI: Settings HTML loaded, length:",e.length),console.log("[STnametracker] initializeUI: Finding #extensions_settings element...");const t=$("#extensions_settings");console.log("[STnametracker] initializeUI: Target element found:",t.length>0),t.append(e),console.log("[STnametracker] initializeUI: Settings HTML appended"),console.log("[STnametracker] initializeUI: Initializing UI handlers..."),G(),console.log("[STnametracker] initializeUI: UI handlers initialized"),console.log("[STnametracker] initializeUI: Initializing menu buttons..."),K(),console.log("[STnametracker] initializeUI: Menu buttons initialized"),console.log("[STnametracker] initializeUI: Binding settings handlers..."),V(),console.log("[STnametracker] initializeUI: Settings handlers bound"),console.log("[STnametracker] initializeUI: Updating UI..."),ee(),console.log("[STnametracker] initializeUI: UI updated"),re.debug("UI initialized")}catch(e){throw re.error("Failed to initialize UI:",e),e}}registerEventListeners(){re.debug("Registering event listeners...");try{const e=C.A.getContext(),t=e.eventSource,n=e.event_types;if(!t||!n)return void re.warn("SillyTavern event system not available");t.on(n.MESSAGE_RECEIVED,async e=>{re.debug("Message received event:",e),await D()}),t.on(n.MESSAGE_SENT,async e=>{re.debug("Message sent event:",e),await D()}),t.on(n.CHAT_CHANGED,async()=>{re.debug("Chat changed event received"),(0,b.nF)({characters:{},lastScannedMessageId:-1})}),re.debug("Event listeners registered")}catch(e){re.error("Failed to register event listeners:",e)}}setupErrorRecovery(){y.r_.registerRecoveryStrategy("NETWORK_ERROR",async e=>(re.warn("Attempting network error recovery"),await y.r_.delay(2e3),x.A.info("Retrying network operation..."),null)),y.r_.registerRecoveryStrategy("DATA_FORMAT_ERROR",async e=>(re.warn("Data format error, clearing cache"),null)),y.r_.onCriticalError(e=>{re.error("Critical error occurred:",e)})}getStatus(){return{initialized:this.initialized,context:C.A.getStatus(),settings:{initialized:!0,moduleCount:Object.keys((0,b.TJ)()).length},debug:A.Ay.getPerformanceSummary(),errors:y.r_.getRecentErrors(5).length}}async shutdown(){return y.r_.withErrorBoundary("Main",async()=>{re.log("Shutting down Name Tracker Extension"),this.initialized=!1,A.Ay.clear(),re.log("Extension shutdown complete")},{silent:!0})}};jQuery(async()=>{console.log("[STnametracker] jQuery ready, starting extension load...");try{console.log("[STnametracker] Logger available, initializing..."),re.log("Name Tracker Extension loading..."),console.log("[STnametracker] Setting up extension_settings..."),window.extension_settings||(console.log("[STnametracker] Creating window.extension_settings"),window.extension_settings={}),console.log("[STnametracker] Current extension_settings keys:",Object.keys(window.extension_settings)),window.extension_settings[te]=window.extension_settings[te]||{},console.log("[STnametracker] Initializing defaults...");const e=(0,b.TJ)();console.log("[STnametracker] Settings initialized with defaults. llmSource:",e.llmSource),console.log("[STnametracker] Extension settings keys after init:",Object.keys(window.extension_settings[te])),console.log("[STnametracker] Starting main initialization..."),await oe.initialize(),console.log("[STnametracker] Main initialization completed"),window.nameTrackerExtension=oe,window.ntDebug={status:()=>oe.getStatus(),errors:()=>y.r_.getRecentErrors(),settings:()=>(0,b.TJ)(),chatData:()=>(0,b.zB)(),clear:()=>A.Ay.clear()},re.log("Name Tracker Extension loaded successfully"),console.log("[STnametracker] Extension loaded. Use ntDebug.status() for diagnostics.")}catch(e){console.error("[STnametracker] Failed to initialize:",e),x.A.error("Extension failed to load","Critical Error")}})})();
//# sourceMappingURL=index.js.map