(()=>{"use strict";var e={56(e,n,r){e.exports=function(e){var n=r.nc;n&&e.setAttribute("nonce",n)}},72(e){var n=[];function r(e){for(var r=-1,t=0;t<n.length;t++)if(n[t].identifier===e){r=t;break}return r}function t(e,t){for(var o={},i=[],s=0;s<e.length;s++){var c=e[s],l=t.base?c[0]+t.base:c[0],d=o[l]||0,m="".concat(l," ").concat(d);o[l]=d+1;var g=r(m),u={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==g)n[g].references++,n[g].updater(u);else{var p=a(u,t);t.byIndex=s,n.splice(s,0,{identifier:m,updater:p,references:1})}i.push(m)}return i}function a(e,n){var r=n.domAPI(n);r.update(e);return function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap&&n.supports===e.supports&&n.layer===e.layer)return;r.update(e=n)}else r.remove()}}e.exports=function(e,a){var o=t(e=e||[],a=a||{});return function(e){e=e||[];for(var i=0;i<o.length;i++){var s=r(o[i]);n[s].references--}for(var c=t(e,a),l=0;l<o.length;l++){var d=r(o[l]);0===n[d].references&&(n[d].updater(),n.splice(d,1))}o=c}}},83(e,n,r){r.d(n,{A:()=>s});var t=r(354),a=r.n(t),o=r(314),i=r.n(o)()(a());i.push([e.id,"/* Styles for the Name Tracker extension */\n\n.name-tracker-settings {\n    padding: 5px;\n}\n\n.name-tracker_block {\n    margin-bottom: 10px;\n}\n\n.name-tracker_block h4 {\n    margin-top: 10px;\n    margin-bottom: 10px;\n    font-weight: bold;\n}\n\n/* Status Display */\n.name-tracker-status-block {\n    background-color: var(--SmartThemeBlurTintColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    padding: 10px;\n}\n\n.name-tracker-status {\n    font-weight: bold;\n    color: var(--SmartThemeBodyColor);\n    padding: 5px;\n    text-align: center;\n}\n\n/* Character List */\n.name-tracker-character-list {\n    max-height: 400px;\n    overflow-y: auto;\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    padding: 5px;\n    margin-top: 5px;\n}\n\n.name-tracker-character {\n    padding: 10px;\n    margin-bottom: 10px;\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    background-color: var(--SmartThemeBlurTintColor);\n}\n\n.name-tracker-character:last-child {\n    margin-bottom: 0;\n}\n\n/* Active/loaded character styling (characters that are loaded in SillyTavern) */\n.name-tracker-character.main-character {\n    border-left: 3px solid #4CAF50;\n    background-color: rgba(76, 175, 80, 0.05);\n}\n\n.character-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 5px;\n}\n\n.character-name {\n    font-weight: bold;\n    font-size: 1.1em;\n    color: var(--SmartThemeBodyColor);\n}\n\n.character-name .fa-user {\n    color: #4CAF50;\n    margin-right: 5px;\n}\n\n.character-name.ignored {\n    color: var(--SmartThemeQuoteColor);\n    text-decoration: line-through;\n}\n\n.character-badge {\n    display: inline-block;\n    padding: 2px 8px;\n    border-radius: 3px;\n    font-size: 0.75em;\n    font-weight: bold;\n    margin-left: 5px;\n}\n\n.character-badge.main-char {\n    background-color: #4CAF50;\n    color: #fff;\n}\n\n.character-badge.ignored {\n    background-color: #666;\n    color: #fff;\n}\n\n.character-badge.unresolved {\n    background-color: #ff9800;\n    color: #000;\n}\n\n/* Lorebook entry editor modal */\n.lorebook-entry-editor h3 {\n    margin-top: 0;\n    margin-bottom: 20px;\n    color: var(--SmartThemeBodyColor);\n}\n\n.editor-section {\n    margin-bottom: 15px;\n}\n\n.editor-section label {\n    display: block;\n    font-weight: bold;\n    margin-bottom: 5px;\n    color: var(--SmartThemeBodyColor);\n}\n\n.editor-section small {\n    display: block;\n    margin-top: 3px;\n    color: var(--SmartThemeQuoteColor);\n    font-size: 0.85em;\n}\n\n.editor-section input,\n.editor-section textarea {\n    width: 100%;\n    box-sizing: border-box;\n}\n\n.character-aliases {\n    font-size: 0.9em;\n    color: var(--SmartThemeQuoteColor);\n    margin-bottom: 8px;\n    font-style: italic;\n}\n\n.lorebook-entry-id {\n    display: inline-block;\n    margin-left: 10px;\n    padding: 2px 6px;\n    background: var(--SmartThemeBlurTintColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 3px;\n    font-family: monospace;\n    font-size: 0.85em;\n    font-style: normal;\n    color: var(--SmartThemeQuoteColor);\n}\n\n.character-details {\n    font-size: 0.85em;\n    color: var(--SmartThemeBodyColor);\n    margin: 8px 0;\n    padding: 8px;\n    background: var(--SmartThemeBlurTintColor);\n    border-left: 2px solid var(--SmartThemeBorderColor);\n    border-radius: 3px;\n    line-height: 1.4;\n}\n\n.character-actions {\n    display: flex;\n    gap: 5px;\n    flex-wrap: wrap;\n    margin-top: 8px;\n}\n\n.character-actions .menu_button {\n    flex: 1;\n    min-width: 100px;\n    padding: 5px 10px;\n    font-size: 0.9em;\n}\n\n.menu_button.compact {\n    padding: 5px 10px;\n    font-size: 0.9em;\n}\n\n.name-tracker-empty {\n    color: var(--SmartThemeQuoteColor);\n    font-style: italic;\n    text-align: center;\n    padding: 20px;\n}\n\n/* Ollama Settings */\n.ollama-settings {\n    background-color: var(--SmartThemeBlurTintColor);\n    border-left: 3px solid var(--SmartThemeBorderColor);\n    padding: 10px;\n    margin-top: 5px;\n    border-radius: 5px;\n}\n\n/* Merge Dialog */\n.merge-dialog {\n    padding: 15px;\n}\n\n.merge-dialog p {\n    margin-bottom: 10px;\n}\n\n.merge-dialog strong {\n    color: var(--SmartThemeBodyColor);\n    font-weight: bold;\n}\n\n.merge-warning {\n    color: #ff9800;\n    font-size: 0.9em;\n    margin-top: 10px;\n    padding: 10px;\n    background-color: rgba(255, 152, 0, 0.1);\n    border-left: 3px solid #ff9800;\n    border-radius: 3px;\n}\n\n/* Button states */\nbutton:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n}\n\n/* Flex utilities */\n.flexGap5 {\n    gap: 5px;\n}\n\n.flex1 {\n    flex: 1;\n}\n\n/* Progress indicator */\n.name-tracker-progress {\n    margin: 10px 0;\n    padding: 10px;\n    background-color: var(--SmartThemeBlurTintColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    text-align: center;\n}\n\n.name-tracker-progress .progress-text {\n    margin-bottom: 5px;\n    font-weight: bold;\n}\n\n.name-tracker-progress .progress-bar {\n    width: 100%;\n    height: 20px;\n    background-color: var(--black50a);\n    border-radius: 10px;\n    overflow: hidden;\n}\n\n.name-tracker-progress .progress-fill {\n    height: 100%;\n    background-color: var(--SmartThemeQuoteColor);\n    transition: width 0.3s ease;\n}\n\n/* Character details preview (for potential future use) */\n.character-details {\n    display: none;\n    margin-top: 10px;\n    padding: 10px;\n    background-color: var(--black30a);\n    border-radius: 5px;\n    font-size: 0.9em;\n}\n\n.character-details.expanded {\n    display: block;\n}\n\n.character-details-section {\n    margin-bottom: 8px;\n}\n\n.character-details-section:last-child {\n    margin-bottom: 0;\n}\n\n.character-details-label {\n    font-weight: bold;\n    color: var(--SmartThemeQuoteColor);\n    margin-right: 5px;\n}\n\n/* Responsive adjustments */\n@media (max-width: 768px) {\n    .character-actions {\n        flex-direction: column;\n    }\n    \n    .character-actions .menu_button {\n        width: 100%;\n    }\n}\n\n/* Animation for new characters */\n@keyframes fadeIn {\n    from {\n        opacity: 0;\n        transform: translateY(-10px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.name-tracker-character.new {\n    animation: fadeIn 0.3s ease;\n}\n\n/* System Prompt Editor */\n.system-prompt-editor h3 {\n    margin-top: 0;\n    margin-bottom: 10px;\n    color: var(--SmartThemeBodyColor);\n}\n\n.system-prompt-editor p {\n    margin-bottom: 10px;\n    color: var(--SmartThemeQuoteColor);\n    font-size: 0.9em;\n}\n\n#system_prompt_editor {\n    background-color: var(--SmartThemeBlurTintColor);\n    color: var(--SmartThemeBodyColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 3px;\n    padding: 10px;\n    resize: vertical;\n}\n\n#system_prompt_editor:focus {\n    outline: none;\n    border-color: var(--SmartThemeEmColor);\n}\n\n.system-prompt-actions button {\n    min-width: 100px;\n}\n\n#system_prompt_reset {\n    margin-right: auto;\n}\n\n\n","",{version:3,sources:["webpack://./style.css"],names:[],mappings:"AAAA,0CAA0C;;AAE1C;IACI,YAAY;AAChB;;AAEA;IACI,mBAAmB;AACvB;;AAEA;IACI,gBAAgB;IAChB,mBAAmB;IACnB,iBAAiB;AACrB;;AAEA,mBAAmB;AACnB;IACI,gDAAgD;IAChD,8CAA8C;IAC9C,kBAAkB;IAClB,aAAa;AACjB;;AAEA;IACI,iBAAiB;IACjB,iCAAiC;IACjC,YAAY;IACZ,kBAAkB;AACtB;;AAEA,mBAAmB;AACnB;IACI,iBAAiB;IACjB,gBAAgB;IAChB,8CAA8C;IAC9C,kBAAkB;IAClB,YAAY;IACZ,eAAe;AACnB;;AAEA;IACI,aAAa;IACb,mBAAmB;IACnB,8CAA8C;IAC9C,kBAAkB;IAClB,gDAAgD;AACpD;;AAEA;IACI,gBAAgB;AACpB;;AAEA,gFAAgF;AAChF;IACI,8BAA8B;IAC9B,yCAAyC;AAC7C;;AAEA;IACI,aAAa;IACb,8BAA8B;IAC9B,mBAAmB;IACnB,kBAAkB;AACtB;;AAEA;IACI,iBAAiB;IACjB,gBAAgB;IAChB,iCAAiC;AACrC;;AAEA;IACI,cAAc;IACd,iBAAiB;AACrB;;AAEA;IACI,kCAAkC;IAClC,6BAA6B;AACjC;;AAEA;IACI,qBAAqB;IACrB,gBAAgB;IAChB,kBAAkB;IAClB,iBAAiB;IACjB,iBAAiB;IACjB,gBAAgB;AACpB;;AAEA;IACI,yBAAyB;IACzB,WAAW;AACf;;AAEA;IACI,sBAAsB;IACtB,WAAW;AACf;;AAEA;IACI,yBAAyB;IACzB,WAAW;AACf;;AAEA,gCAAgC;AAChC;IACI,aAAa;IACb,mBAAmB;IACnB,iCAAiC;AACrC;;AAEA;IACI,mBAAmB;AACvB;;AAEA;IACI,cAAc;IACd,iBAAiB;IACjB,kBAAkB;IAClB,iCAAiC;AACrC;;AAEA;IACI,cAAc;IACd,eAAe;IACf,kCAAkC;IAClC,iBAAiB;AACrB;;AAEA;;IAEI,WAAW;IACX,sBAAsB;AAC1B;;AAEA;IACI,gBAAgB;IAChB,kCAAkC;IAClC,kBAAkB;IAClB,kBAAkB;AACtB;;AAEA;IACI,qBAAqB;IACrB,iBAAiB;IACjB,gBAAgB;IAChB,0CAA0C;IAC1C,8CAA8C;IAC9C,kBAAkB;IAClB,sBAAsB;IACtB,iBAAiB;IACjB,kBAAkB;IAClB,kCAAkC;AACtC;;AAEA;IACI,iBAAiB;IACjB,iCAAiC;IACjC,aAAa;IACb,YAAY;IACZ,0CAA0C;IAC1C,mDAAmD;IACnD,kBAAkB;IAClB,gBAAgB;AACpB;;AAEA;IACI,aAAa;IACb,QAAQ;IACR,eAAe;IACf,eAAe;AACnB;;AAEA;IACI,OAAO;IACP,gBAAgB;IAChB,iBAAiB;IACjB,gBAAgB;AACpB;;AAEA;IACI,iBAAiB;IACjB,gBAAgB;AACpB;;AAEA;IACI,kCAAkC;IAClC,kBAAkB;IAClB,kBAAkB;IAClB,aAAa;AACjB;;AAEA,oBAAoB;AACpB;IACI,gDAAgD;IAChD,mDAAmD;IACnD,aAAa;IACb,eAAe;IACf,kBAAkB;AACtB;;AAEA,iBAAiB;AACjB;IACI,aAAa;AACjB;;AAEA;IACI,mBAAmB;AACvB;;AAEA;IACI,iCAAiC;IACjC,iBAAiB;AACrB;;AAEA;IACI,cAAc;IACd,gBAAgB;IAChB,gBAAgB;IAChB,aAAa;IACb,wCAAwC;IACxC,8BAA8B;IAC9B,kBAAkB;AACtB;;AAEA,kBAAkB;AAClB;IACI,YAAY;IACZ,mBAAmB;AACvB;;AAEA,mBAAmB;AACnB;IACI,QAAQ;AACZ;;AAEA;IACI,OAAO;AACX;;AAEA,uBAAuB;AACvB;IACI,cAAc;IACd,aAAa;IACb,gDAAgD;IAChD,8CAA8C;IAC9C,kBAAkB;IAClB,kBAAkB;AACtB;;AAEA;IACI,kBAAkB;IAClB,iBAAiB;AACrB;;AAEA;IACI,WAAW;IACX,YAAY;IACZ,iCAAiC;IACjC,mBAAmB;IACnB,gBAAgB;AACpB;;AAEA;IACI,YAAY;IACZ,6CAA6C;IAC7C,2BAA2B;AAC/B;;AAEA,yDAAyD;AACzD;IACI,aAAa;IACb,gBAAgB;IAChB,aAAa;IACb,iCAAiC;IACjC,kBAAkB;IAClB,gBAAgB;AACpB;;AAEA;IACI,cAAc;AAClB;;AAEA;IACI,kBAAkB;AACtB;;AAEA;IACI,gBAAgB;AACpB;;AAEA;IACI,iBAAiB;IACjB,kCAAkC;IAClC,iBAAiB;AACrB;;AAEA,2BAA2B;AAC3B;IACI;QACI,sBAAsB;IAC1B;;IAEA;QACI,WAAW;IACf;AACJ;;AAEA,iCAAiC;AACjC;IACI;QACI,UAAU;QACV,4BAA4B;IAChC;IACA;QACI,UAAU;QACV,wBAAwB;IAC5B;AACJ;;AAEA;IACI,2BAA2B;AAC/B;;AAEA,yBAAyB;AACzB;IACI,aAAa;IACb,mBAAmB;IACnB,iCAAiC;AACrC;;AAEA;IACI,mBAAmB;IACnB,kCAAkC;IAClC,gBAAgB;AACpB;;AAEA;IACI,gDAAgD;IAChD,iCAAiC;IACjC,8CAA8C;IAC9C,kBAAkB;IAClB,aAAa;IACb,gBAAgB;AACpB;;AAEA;IACI,aAAa;IACb,sCAAsC;AAC1C;;AAEA;IACI,gBAAgB;AACpB;;AAEA;IACI,kBAAkB;AACtB",sourcesContent:["/* Styles for the Name Tracker extension */\r\n\r\n.name-tracker-settings {\r\n    padding: 5px;\r\n}\r\n\r\n.name-tracker_block {\r\n    margin-bottom: 10px;\r\n}\r\n\r\n.name-tracker_block h4 {\r\n    margin-top: 10px;\r\n    margin-bottom: 10px;\r\n    font-weight: bold;\r\n}\r\n\r\n/* Status Display */\r\n.name-tracker-status-block {\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    padding: 10px;\r\n}\r\n\r\n.name-tracker-status {\r\n    font-weight: bold;\r\n    color: var(--SmartThemeBodyColor);\r\n    padding: 5px;\r\n    text-align: center;\r\n}\r\n\r\n/* Character List */\r\n.name-tracker-character-list {\r\n    max-height: 400px;\r\n    overflow-y: auto;\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    padding: 5px;\r\n    margin-top: 5px;\r\n}\r\n\r\n.name-tracker-character {\r\n    padding: 10px;\r\n    margin-bottom: 10px;\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n}\r\n\r\n.name-tracker-character:last-child {\r\n    margin-bottom: 0;\r\n}\r\n\r\n/* Active/loaded character styling (characters that are loaded in SillyTavern) */\r\n.name-tracker-character.main-character {\r\n    border-left: 3px solid #4CAF50;\r\n    background-color: rgba(76, 175, 80, 0.05);\r\n}\r\n\r\n.character-header {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    margin-bottom: 5px;\r\n}\r\n\r\n.character-name {\r\n    font-weight: bold;\r\n    font-size: 1.1em;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.character-name .fa-user {\r\n    color: #4CAF50;\r\n    margin-right: 5px;\r\n}\r\n\r\n.character-name.ignored {\r\n    color: var(--SmartThemeQuoteColor);\r\n    text-decoration: line-through;\r\n}\r\n\r\n.character-badge {\r\n    display: inline-block;\r\n    padding: 2px 8px;\r\n    border-radius: 3px;\r\n    font-size: 0.75em;\r\n    font-weight: bold;\r\n    margin-left: 5px;\r\n}\r\n\r\n.character-badge.main-char {\r\n    background-color: #4CAF50;\r\n    color: #fff;\r\n}\r\n\r\n.character-badge.ignored {\r\n    background-color: #666;\r\n    color: #fff;\r\n}\r\n\r\n.character-badge.unresolved {\r\n    background-color: #ff9800;\r\n    color: #000;\r\n}\r\n\r\n/* Lorebook entry editor modal */\r\n.lorebook-entry-editor h3 {\r\n    margin-top: 0;\r\n    margin-bottom: 20px;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.editor-section {\r\n    margin-bottom: 15px;\r\n}\r\n\r\n.editor-section label {\r\n    display: block;\r\n    font-weight: bold;\r\n    margin-bottom: 5px;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.editor-section small {\r\n    display: block;\r\n    margin-top: 3px;\r\n    color: var(--SmartThemeQuoteColor);\r\n    font-size: 0.85em;\r\n}\r\n\r\n.editor-section input,\r\n.editor-section textarea {\r\n    width: 100%;\r\n    box-sizing: border-box;\r\n}\r\n\r\n.character-aliases {\r\n    font-size: 0.9em;\r\n    color: var(--SmartThemeQuoteColor);\r\n    margin-bottom: 8px;\r\n    font-style: italic;\r\n}\r\n\r\n.lorebook-entry-id {\r\n    display: inline-block;\r\n    margin-left: 10px;\r\n    padding: 2px 6px;\r\n    background: var(--SmartThemeBlurTintColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 3px;\r\n    font-family: monospace;\r\n    font-size: 0.85em;\r\n    font-style: normal;\r\n    color: var(--SmartThemeQuoteColor);\r\n}\r\n\r\n.character-details {\r\n    font-size: 0.85em;\r\n    color: var(--SmartThemeBodyColor);\r\n    margin: 8px 0;\r\n    padding: 8px;\r\n    background: var(--SmartThemeBlurTintColor);\r\n    border-left: 2px solid var(--SmartThemeBorderColor);\r\n    border-radius: 3px;\r\n    line-height: 1.4;\r\n}\r\n\r\n.character-actions {\r\n    display: flex;\r\n    gap: 5px;\r\n    flex-wrap: wrap;\r\n    margin-top: 8px;\r\n}\r\n\r\n.character-actions .menu_button {\r\n    flex: 1;\r\n    min-width: 100px;\r\n    padding: 5px 10px;\r\n    font-size: 0.9em;\r\n}\r\n\r\n.menu_button.compact {\r\n    padding: 5px 10px;\r\n    font-size: 0.9em;\r\n}\r\n\r\n.name-tracker-empty {\r\n    color: var(--SmartThemeQuoteColor);\r\n    font-style: italic;\r\n    text-align: center;\r\n    padding: 20px;\r\n}\r\n\r\n/* Ollama Settings */\r\n.ollama-settings {\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    border-left: 3px solid var(--SmartThemeBorderColor);\r\n    padding: 10px;\r\n    margin-top: 5px;\r\n    border-radius: 5px;\r\n}\r\n\r\n/* Merge Dialog */\r\n.merge-dialog {\r\n    padding: 15px;\r\n}\r\n\r\n.merge-dialog p {\r\n    margin-bottom: 10px;\r\n}\r\n\r\n.merge-dialog strong {\r\n    color: var(--SmartThemeBodyColor);\r\n    font-weight: bold;\r\n}\r\n\r\n.merge-warning {\r\n    color: #ff9800;\r\n    font-size: 0.9em;\r\n    margin-top: 10px;\r\n    padding: 10px;\r\n    background-color: rgba(255, 152, 0, 0.1);\r\n    border-left: 3px solid #ff9800;\r\n    border-radius: 3px;\r\n}\r\n\r\n/* Button states */\r\nbutton:disabled {\r\n    opacity: 0.5;\r\n    cursor: not-allowed;\r\n}\r\n\r\n/* Flex utilities */\r\n.flexGap5 {\r\n    gap: 5px;\r\n}\r\n\r\n.flex1 {\r\n    flex: 1;\r\n}\r\n\r\n/* Progress indicator */\r\n.name-tracker-progress {\r\n    margin: 10px 0;\r\n    padding: 10px;\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    text-align: center;\r\n}\r\n\r\n.name-tracker-progress .progress-text {\r\n    margin-bottom: 5px;\r\n    font-weight: bold;\r\n}\r\n\r\n.name-tracker-progress .progress-bar {\r\n    width: 100%;\r\n    height: 20px;\r\n    background-color: var(--black50a);\r\n    border-radius: 10px;\r\n    overflow: hidden;\r\n}\r\n\r\n.name-tracker-progress .progress-fill {\r\n    height: 100%;\r\n    background-color: var(--SmartThemeQuoteColor);\r\n    transition: width 0.3s ease;\r\n}\r\n\r\n/* Character details preview (for potential future use) */\r\n.character-details {\r\n    display: none;\r\n    margin-top: 10px;\r\n    padding: 10px;\r\n    background-color: var(--black30a);\r\n    border-radius: 5px;\r\n    font-size: 0.9em;\r\n}\r\n\r\n.character-details.expanded {\r\n    display: block;\r\n}\r\n\r\n.character-details-section {\r\n    margin-bottom: 8px;\r\n}\r\n\r\n.character-details-section:last-child {\r\n    margin-bottom: 0;\r\n}\r\n\r\n.character-details-label {\r\n    font-weight: bold;\r\n    color: var(--SmartThemeQuoteColor);\r\n    margin-right: 5px;\r\n}\r\n\r\n/* Responsive adjustments */\r\n@media (max-width: 768px) {\r\n    .character-actions {\r\n        flex-direction: column;\r\n    }\r\n    \r\n    .character-actions .menu_button {\r\n        width: 100%;\r\n    }\r\n}\r\n\r\n/* Animation for new characters */\r\n@keyframes fadeIn {\r\n    from {\r\n        opacity: 0;\r\n        transform: translateY(-10px);\r\n    }\r\n    to {\r\n        opacity: 1;\r\n        transform: translateY(0);\r\n    }\r\n}\r\n\r\n.name-tracker-character.new {\r\n    animation: fadeIn 0.3s ease;\r\n}\r\n\r\n/* System Prompt Editor */\r\n.system-prompt-editor h3 {\r\n    margin-top: 0;\r\n    margin-bottom: 10px;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.system-prompt-editor p {\r\n    margin-bottom: 10px;\r\n    color: var(--SmartThemeQuoteColor);\r\n    font-size: 0.9em;\r\n}\r\n\r\n#system_prompt_editor {\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    color: var(--SmartThemeBodyColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 3px;\r\n    padding: 10px;\r\n    resize: vertical;\r\n}\r\n\r\n#system_prompt_editor:focus {\r\n    outline: none;\r\n    border-color: var(--SmartThemeEmColor);\r\n}\r\n\r\n.system-prompt-actions button {\r\n    min-width: 100px;\r\n}\r\n\r\n#system_prompt_reset {\r\n    margin-right: auto;\r\n}\r\n\r\n\r\n"],sourceRoot:""}]);const s=i},102(e,n,r){r.d(n,{A:()=>s,r:()=>i});var t=r(806),a=r(462);const o=t.Ay.createModuleLogger("Context");const i=new class{constructor(){this._context=null,this._lastUpdate=0,this._updateInterval=1e3}getContext(){const e=Date.now();if(!this._context||e-this._lastUpdate>this._updateInterval)try{this._context=SillyTavern.getContext(),this._lastUpdate=e}catch(e){throw o.error("Failed to get SillyTavern context:",e),new Error("SillyTavern context not available")}return this._context}getChat(){return this.getContext().chat||[]}getChatMetadata(){return this.getContext().chatMetadata||{}}getChatId(){return this.getContext().chatId||null}getCharacterId(){return this.getContext().characterId}getCharacters(){return this.getContext().characters||[]}getUserName(){return this.getContext().name1||"User"}getExtensionSettings(){return this.getContext().extensionSettings||{}}async saveExtensionSettings(){return a.r_.withErrorBoundary("Context",async()=>{const e=this.getContext();e.saveSettingsDebounced?e.saveSettingsDebounced():o.warn("saveSettingsDebounced not available")},{silent:!0})}async saveChatMetadata(){return a.r_.withErrorBoundary("Context",async()=>{const e=this.getContext();e.saveMetadata?await e.saveMetadata():o.warn("saveMetadata not available")},{silent:!0})}async generateQuietPrompt(e){return a.r_.withErrorBoundary("Context",async()=>{const n=this.getContext();if(!n.generateQuietPrompt)throw new Error("generateQuietPrompt not available");return await n.generateQuietPrompt(e)},{retries:1})}async loadWorldInfo(e){return a.r_.withErrorBoundary("Context",async()=>{const n=this.getContext();if(!n.loadWorldInfo)throw new Error("loadWorldInfo not available");return await n.loadWorldInfo(e)})}async saveWorldInfo(e,n,r=!1){return a.r_.withErrorBoundary("Context",async()=>{const t=this.getContext();if(!t.saveWorldInfo)throw new Error("saveWorldInfo not available");return await t.saveWorldInfo(e,n,r)})}async saveWorldInfoEntry(e,n){return a.r_.withErrorBoundary("Context",async()=>{const r=this.getContext();if(!r.saveWorldInfoEntry)throw new Error("saveWorldInfoEntry not available");return await r.saveWorldInfoEntry(e,n)})}getEventSource(){return this.getContext().eventSource}getEventTypes(){return this.getContext().event_types}async callGenericPopup(e,n,r="",t={}){return a.r_.withErrorBoundary("Context",async()=>{const a=this.getContext();if(!a.callGenericPopup)throw new Error("callGenericPopup not available");return await a.callGenericPopup(e,n,r,t)})}isContextAvailable(){try{return!!this.getContext()}catch{return!1}}clearCache(){this._context=null,this._lastUpdate=0,o.debug("Cleared context cache")}getStatus(){return{available:this.isContextAvailable(),cached:!!this._context,lastUpdate:this._lastUpdate,chatId:this.getChatId(),characterId:this.getCharacterId()}}},s=i},113(e){e.exports=function(e,n){if(n.styleSheet)n.styleSheet.cssText=e;else{for(;n.firstChild;)n.removeChild(n.firstChild);n.appendChild(document.createTextNode(e))}}},134(e,n,r){r.d(n,{TQ:()=>u,WF:()=>g,_Z:()=>p});var t=r(806),a=r(462),o=r(418),i=r(102),s=r(854),c=r(695);let l;console.log("[LOREBOOK] Starting module load..."),console.log("[LOREBOOK] Imports completed. Types:"),console.log("[LOREBOOK] createModuleLogger:",typeof t.Xv),console.log("[LOREBOOK] withErrorBoundary:",typeof a.Xc),console.log("[LOREBOOK] NameTrackerError:",typeof a.S_);try{console.log("[LOREBOOK] About to call createModuleLogger..."),l=(0,t.Xv)("lorebook"),console.log("[LOREBOOK] Debug logger created successfully:",l)}catch(e){console.error("[LOREBOOK] Failed to create debug logger:",e),console.error("[LOREBOOK] Error stack:",e.stack),l={log:console.log.bind(console,"[LOREBOOK]"),error:console.error.bind(console,"[LOREBOOK]"),warn:console.warn.bind(console,"[LOREBOOK]"),debug:console.debug.bind(console,"[LOREBOOK]")}}const d=new c.h("Lorebook Management");let m=null;async function g(){return(0,a.Xc)("initializeLorebook",async()=>{const e=i.r.getContext();if(!e.chatId)return l.log("No active chat, skipping lorebook initialization"),m=null,null;const n="world_info",r=e.chatMetadata;if(!r)return l.log("No chat metadata available, skipping lorebook initialization"),m=null,null;if(r[n])return m=r[n],l.log(`Using existing chat lorebook: ${m}`),m;const t=`NameTracker_${e.chatId}`.replace(/[^a-z0-9 -]/gi,"_").replace(/_{2,}/g,"_").substring(0,64);l.log(`Creating new chat lorebook: ${t}`),m=t,r[n]=m;try{await e.saveMetadata(),l.log(`Bound lorebook to chat: ${m}`);await e.loadWorldInfo(m)||(l.log(),await e.saveWorldInfo(m,{entries:{}},!0)),d.info(`Chat lorebook "${m}" created and bound to this chat`,{timeOut:5e3})}catch(e){throw console.error("Failed to initialize lorebook:",e),m=null,new a.S_(`Failed to initialize lorebook: ${e.message}`)}return m})}async function u(e,n){return(0,a.Xc)("updateLorebookEntry",async()=>{if(l.log(`updateLorebookEntry called for: ${n}`),l.log("  Character data:",e),!m)return void l.log("No lorebook initialized, skipping entry update");const r=i.r.getContext(),t=(0,o.gf)(),a=[];if(e.physicalAge||e.mentalAge){const n=[];e.physicalAge&&n.push(`Physical: ${e.physicalAge}`),e.mentalAge&&n.push(`Mental: ${e.mentalAge}`),a.push(`**Age:** ${n.join(", ")}`)}e.physical&&a.push(`\n**Physical Description:**\n${e.physical}`),e.personality&&a.push(`\n**Personality:**\n${e.personality}`),e.sexuality&&a.push(`\n**Sexuality:**\n${e.sexuality}`),e.raceEthnicity&&a.push(`**Race/Ethnicity:** ${e.raceEthnicity}`),e.roleSkills&&a.push(`\n**Role & Skills:**\n${e.roleSkills}`),e.lastInteraction&&a.push(`\n**Last Interaction with {{user}}:**\n${e.lastInteraction}`),e.relationships&&e.relationships.length>0&&(a.push("\n**Relationships:**"),e.relationships.forEach(e=>{a.push(`- ${e}`)}));const c=a.join("\n"),d=[e.preferredName];e.aliases&&d.push(...e.aliases);let g=await r.loadWorldInfo(m);g||(l.log(),g={entries:{}});const u=(0,o.TJ)("messageFrequency",10),p=Math.max(1,Math.floor(.75*u));let h=null;if(e.lorebookEntryId&&g.entries&&g.entries[e.lorebookEntryId]){h=e.lorebookEntryId;const n=g.entries[h];n.key=d,n.content=c,n.enabled=t.enabled,n.position=t.position,n.probability=t.probability,n.depth=t.depth,n.scanDepth=t.scanDepth,n.cooldown=p,l.log()}else{const n=(0,s.cv)(),r={uid:n,key:d,keysecondary:[],comment:`Auto-generated entry for ${e.preferredName}`,content:c,constant:!1,selective:!0,contextConfig:{prefix:"",suffix:"",tokenBudget:0,reservedTokens:0,budgetPriority:400,trimDirection:"doNotTrim",insertionOrder:0,maximumTrimType:"sentence",insertionPosition:"before"},enabled:t.enabled,position:t.position,excludeRecursion:!1,preventRecursion:!1,delayUntilRecursion:!1,probability:t.probability,useProbability:!0,depth:t.depth,selectiveLogic:0,group:"",scanDepth:t.scanDepth,caseSensitive:null,matchWholeWords:null,useGroupScoring:null,automationId:"",role:0,vectorized:!1,sticky:0,cooldown:p,delay:0};g.entries[n]=r,e.lorebookEntryId=n,l.log()}try{await r.saveWorldInfo(m,g,!0);const n=await r.loadWorldInfo(m),t=h||e.lorebookEntryId;n&&n.entries&&n.entries[t]?l.log():console.error("[Name Tracker] WARNING: Lorebook verification failed - entries may not have been saved!"),l.log()}catch(e){throw console.error("[Name Tracker] Error saving lorebook:",e),l.log(),e}})}async function p(e){return(0,a.Xc)("viewInLorebook",async()=>{if(!(0,o.qN)(e))throw new a.S_("Character not found");if(!m)return void d.warning("No active chat or lorebook");const n=i.r.getContext();"function"==typeof n.openWorldInfoEditor?(await n.openWorldInfoEditor(m),d.success(`Opened lorebook for ${e}`)):($("#WorldInfo").click(),d.info(`Please select "${m}" from the World Info panel`))})}},314(e){e.exports=function(e){var n=[];return n.toString=function(){return this.map(function(n){var r="",t=void 0!==n[5];return n[4]&&(r+="@supports (".concat(n[4],") {")),n[2]&&(r+="@media ".concat(n[2]," {")),t&&(r+="@layer".concat(n[5].length>0?" ".concat(n[5]):""," {")),r+=e(n),t&&(r+="}"),n[2]&&(r+="}"),n[4]&&(r+="}"),r}).join("")},n.i=function(e,r,t,a,o){"string"==typeof e&&(e=[[null,e,void 0]]);var i={};if(t)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(i[c]=!0)}for(var l=0;l<e.length;l++){var d=[].concat(e[l]);t&&i[d[0]]||(void 0!==o&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=o),r&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=r):d[2]=r),a&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=a):d[4]="".concat(a)),n.push(d))}},n}},354(e){e.exports=function(e){var n=e[1],r=e[3];if(!r)return n;if("function"==typeof btoa){var t=btoa(unescape(encodeURIComponent(JSON.stringify(r)))),a="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(t),o="/*# ".concat(a," */");return[n].concat([o]).join("\n")}return[n].join("\n")}},418(e,n,r){r.d(n,{PL:()=>_,TJ:()=>y,Yq:()=>h,ZC:()=>E,bg:()=>x,e7:()=>w,eU:()=>S,gf:()=>T,kO:()=>b,mt:()=>f,nT:()=>C,oS:()=>B,qN:()=>v,sr:()=>I,yb:()=>k});var t=r(806),a=r(462),o=r(695);const{extension_settings:i,saveSettingsDebounced:s,saveMetadataDebounced:c}=window,l=t.Ay.createModuleLogger("Settings"),d="STnametracker",m=Object.freeze({enabled:!0,autoAnalyze:!0,messageFrequency:10,llmSource:"sillytavern",ollamaEndpoint:"http://localhost:11434",ollamaModel:"",confidenceThreshold:70,lorebookPosition:0,lorebookDepth:1,lorebookCooldown:5,lorebookScanDepth:1,lorebookProbability:100,lorebookEnabled:!0,debugMode:!1,systemPrompt:null}),g=Object.freeze({characters:{},messageCounter:0,lastHarvestMessage:0,lastScannedMessageId:-1});let u=!1;function p(){const e=SillyTavern?.getContext?.();if(!e)throw new Error("SillyTavern context not available");return e}async function h(){return a.r_.withErrorBoundary("Settings",async()=>{if(u)return void l.log("Settings already initialized");if(l.log("Initializing settings manager"),i[d]){const e=i[d];i[d]={...m,...e}}else i[d]={...m};const e=p().chatMetadata;if(e[d]){const n=e[d];e[d]={...g,...n}}else e[d]={...g};u=!0,l.log("Settings initialized")})}function A(){if(!u)throw new Error("Settings manager not initialized")}function f(){return A(),i[d]||{}}function y(e){return a.r_.withErrorBoundary("Settings",()=>{if(!(e in m))throw new Error(`Unknown setting key: ${e}`);return i[d]?.[e]??m[e]})}function C(e,n){return a.r_.withErrorBoundary("Settings",()=>{if(!(e in m))throw new Error(`Unknown setting key: ${e}`);i[d]||(i[d]={...m});const r=i[d][e];i[d][e]=n,l.log(`Updated setting ${e}: ${r} â†’ ${n}`),s()})}function b(e){return a.r_.withErrorBoundary("Settings",()=>{A();const n=p();return n.chatMetadata[d]?.[e]})}function k(e,n){return a.r_.withErrorBoundary("Settings",()=>{if(!(e in g))throw new Error(`Unknown chat data key: ${e}`);const r=p();r.chatMetadata[d]||(r.chatMetadata[d]={...g});r.chatMetadata[d][e];r.chatMetadata[d][e]=n,l.log(`Updated chat data ${e}`),c()})}function x(){return b("characters")||{}}function v(e){return a.r_.withErrorBoundary("Settings",()=>{if(!e||"string"!=typeof e)return l.warn("Invalid character name:",e),null;return x()[e]||null})}function w(e,n){return a.r_.withErrorBoundary("Settings",()=>{if(!e||"string"!=typeof e)throw new Error("Character name must be a non-empty string");if(!n||"object"!=typeof n)throw new Error("Character data must be an object");const r={...x()};r[e]=n,k("characters",r),l.log(`Set character: ${e}`)})}function I(e){return a.r_.withErrorBoundary("Settings",()=>{if(!e||"string"!=typeof e)return void l.warn("Invalid character name for removal:",e);const n={...x()};n[e]&&(delete n[e],k("characters",n),l.log(`Removed character: ${e}`))})}async function B(){return a.r_.withErrorBoundary("Settings",async()=>{l.log("Chat changed, reinitializing chat data");const e=p().chatMetadata;if(e[d]){const n=e[d];e[d]={...g,...n},l.log("Loaded existing chat data")}else e[d]={...g},l.log("Initialized new chat data")})}function S(){return{source:y("llmSource"),ollamaEndpoint:y("ollamaEndpoint"),ollamaModel:y("ollamaModel"),systemPrompt:y("systemPrompt")}}function T(){return{position:y("lorebookPosition"),depth:y("lorebookDepth"),cooldown:y("lorebookCooldown"),scanDepth:y("lorebookScanDepth"),probability:y("lorebookProbability"),enabled:y("lorebookEnabled")}}function _(e,n){try{const r=y(e);return void 0!==r?r:n}catch(r){return l.warn(`getSetting error for key ${e}:`,r),n}}function E(e,n){try{C(e,n)}catch(n){l.error(`setSetting error for key ${e}:`,n),o.A.error(`Failed to update setting: ${n.message}`)}}},462(e,n,r){r.d(n,{S_:()=>a,Xc:()=>i,r_:()=>o});const t=r(806).Ay.createModuleLogger("ErrorHandler");class a extends Error{constructor(e,n,r,t=!0){super(e),this.name="NameTrackerError",this.code=n,this.module=r,this.recoverable=t,this.timestamp=Date.now()}}const o=new class{constructor(){this.errorHistory=[],this.transactionStack=[],this.recoveryStrategies=new Map,this.criticalErrorCallbacks=[]}async withErrorBoundary(e,n,r={}){const{fallback:a=null,retries:o=0,silent:i=!1,operationId:s=null}=r;let c=null;const l=Date.now();s&&t.trace(s,`Starting operation in ${e}`);for(let r=0;r<=o;r++)try{const r=await n();return s&&t.trace(s,`Operation completed successfully in ${e}`),r}catch(n){if(console.log(`[STnametracker] Error caught in ${e}:`,n),c=n,r<o){console.log(`[STnametracker] Retrying operation in ${e}, attempt ${r+1}/${o+1}:`,n.message),t.warn(`Retrying operation in ${e}, attempt ${r+1}/${o+1}:`,n.message),await this.delay(100*Math.pow(2,r));continue}}console.log(`[STnametracker] All retries failed in ${e}, tracking error:`,c);const d=this.trackError(c,e,{operation:n.name||"anonymous",duration:Date.now()-l,retries:o,operationId:s});if(i||(console.log(`[STnametracker] Notifying user of error in ${e}`),this.notifyUser(d)),a)try{return t.debug(`Attempting fallback for ${e}:`,d.code),await a(d)}catch(n){t.error(`Fallback failed for ${e}:`,n)}const m=this.recoveryStrategies.get(d.code);if(m)try{return await m(d)}catch(e){t.error(`Recovery strategy failed for ${d.code}:`,e)}throw d}trackError(e,n,r={}){let o;if(e instanceof a)o=e;else{const r=this.categorizeError(e,n);o=new a(e.message,r,n,this.isRecoverable(e,r))}return o.context=r,this.errorHistory.push(o),this.errorHistory.length>100&&this.errorHistory.shift(),t.error(`Error in ${n}:`,{code:o.code,message:o.message,context:r}),o}categorizeError(e,n){return e.message.includes("fetch")||e.message.includes("network")?"NETWORK_ERROR":e.message.includes("JSON")||e.message.includes("parse")?"DATA_FORMAT_ERROR":e.message.includes("context")||e.message.includes("SillyTavern")?"CONTEXT_ERROR":"TypeError"===e.name?"TYPE_ERROR":"LLM"===n&&(e.message.includes("quota")||e.message.includes("rate"))?"API_LIMIT_ERROR":"UNKNOWN_ERROR"}isRecoverable(e,n){return!["CONTEXT_ERROR","TYPE_ERROR"].includes(n)}startTransaction(e,n){this.transactionStack.push({id:e,state:JSON.stringify(n),timestamp:Date.now()}),t.debug(`Started transaction: ${e}`)}commitTransaction(e){const n=this.transactionStack.findIndex(n=>n.id===e);-1!==n&&(this.transactionStack.splice(n,1),t.debug(`Committed transaction: ${e}`))}rollbackTransaction(e){const n=this.transactionStack.findIndex(n=>n.id===e);if(-1!==n){const r=this.transactionStack.splice(n,1)[0];return t.debug(`Rolled back transaction: ${e}`),JSON.parse(r.state)}return null}registerRecoveryStrategy(e,n){this.recoveryStrategies.set(e,n),t.debug(`Registered recovery strategy for: ${e}`)}onCriticalError(e){this.criticalErrorCallbacks.push(e)}notifyUser(e){const n=`Name Tracker: ${e.message}`;e.recoverable?toastr.warning(n,"Warning",{timeOut:5e3}):(toastr.error(n,"Error",{timeOut:8e3}),this.criticalErrorCallbacks.forEach(n=>{try{n(e)}catch(e){t.error("Critical error callback failed:",e)}}))}getRecentErrors(e=10){return this.errorHistory.slice(-e)}clearHistory(){this.errorHistory=[],t.debug("Cleared error history")}delay(e){return new Promise(n=>setTimeout(n,e))}},i=o.withErrorBoundary.bind(o)},540(e){e.exports=function(e){var n=document.createElement("style");return e.setAttributes(n,e.attributes),e.insert(n,e.options),n}},551(e,n,r){r.d(n,{OW:()=>A,_$:()=>g,eY:()=>m,el:()=>b,g9:()=>k,lF:()=>y,pp:()=>v,rL:()=>u,t9:()=>f,undoLastMerge:()=>C,vu:()=>x});var t=r(134),a=r(806),o=r(462),i=r(418),s=(r(854),r(695));const c=(0,a.Xv)("characters"),l=new s.h("Character Management");let d=[];function m(e){return(0,o.Xc)("isIgnoredCharacter",()=>{const n=(0,i.bg)();return Object.values(n).some(n=>n.ignored&&(n.preferredName===e||n.aliases.includes(e)))})}function g(e){return(0,o.Xc)("findExistingCharacter",()=>{const n=(0,i.bg)();return Object.values(n).find(n=>n.preferredName===e||n.aliases.includes(e))||null})}async function u(e){return(0,o.Xc)("findPotentialMatch",async()=>{const n=(0,i.bg)(),r=(0,i.TJ)("confidenceThreshold",70);c.log();for(const t of Object.values(n)){if(p(e.name,t.preferredName)>=r)return c.log(),t;for(const n of t.aliases){if(p(e.name,n)>=r)return c.log(),t}}return null})}function p(e,n){return(0,o.Xc)("calculateNameSimilarity",()=>{if(e=e.toLowerCase(),n=n.toLowerCase(),e===n)return 100;if(e.includes(n)||n.includes(e))return 85;const r=e.split(/\s+/),t=n.split(/\s+/);return r.filter(e=>t.includes(e)).length>0?70:0})}function h(e,n){return(0,o.Xc)("cleanAliases",()=>{if(!e||!Array.isArray(e))return[];const r=["son","daughter","mother","father","mom","dad","parent","brother","sister","sibling","cousin","uncle","aunt","friend","boyfriend","girlfriend","husband","wife","spouse","boss","employee","coworker","colleague","partner","neighbor","roommate","child","kid","baby","man","woman","person","guy","girl","boy","user","{{user}}","char","{{char}}"],t=n.toLowerCase();return e.filter(e=>{if(!e||"string"!=typeof e)return!1;const n=e.trim().toLowerCase();return n!==t&&(!r.includes(n)&&!(n.length<2))}).map(e=>e.trim()).filter((e,n,r)=>r.indexOf(e)===n)})}async function A(e,n=!1){return(0,o.Xc)("createCharacter",async()=>{c.log();const r=h(e.aliases||[],e.name),a={preferredName:e.name,aliases:r,physicalAge:e.physicalAge||"",mentalAge:e.mentalAge||"",physical:e.physical||"",personality:e.personality||"",sexuality:e.sexuality||"",raceEthnicity:e.raceEthnicity||"",roleSkills:e.roleSkills||"",lastInteraction:e.lastInteraction||"",relationships:e.relationships||[],ignored:!1,confidence:e.confidence||50,lorebookEntryId:null,lastUpdated:Date.now(),isMainChar:n||!1};return c.log(),(0,i.e7)(a.preferredName,a),await(0,t.TQ)(a,a.preferredName),c.log(),a})}async function f(e,n,r=!1,t=!1){return(0,o.Xc)("updateCharacter",async()=>{if(c.log(),t&&(e.isMainChar=!0),r&&n.name!==e.preferredName&&(e.aliases||(e.aliases=[]),e.aliases.includes(n.name)||n.name.toLowerCase()===e.preferredName.toLowerCase()||e.aliases.push(n.name)),e.aliases=h(e.aliases||[],e.preferredName),n.physicalAge&&(e.physicalAge=n.physicalAge),n.mentalAge&&(e.mentalAge=n.mentalAge),n.physical&&(e.physical=n.physical),n.personality&&(e.personality=n.personality),n.sexuality&&(e.sexuality=n.sexuality),n.raceEthnicity&&(e.raceEthnicity=n.raceEthnicity),n.roleSkills&&(e.roleSkills=n.roleSkills),n.lastInteraction&&(e.lastInteraction=n.lastInteraction),n.relationships&&Array.isArray(n.relationships)){e.relationships||(e.relationships=[]);for(const r of n.relationships)e.relationships.includes(r)||e.relationships.push(r)}return n.confidence&&(e.confidence=Math.round((e.confidence+n.confidence)/2)),e.lastUpdated=Date.now(),(0,i.e7)(e.preferredName,e),c.log(),e})}async function y(e,n){return(0,o.Xc)("mergeCharacters",async()=>{const r=(0,i.bg)(),t=r[e],a=r[n];if(!t||!a)throw new o.S_("One or both characters not found");const s={operation:"merge",timestamp:Date.now(),sourceName:e,targetName:n,sourceData:JSON.parse(JSON.stringify(t)),targetDataBefore:JSON.parse(JSON.stringify(a))};d.push(s),d.length>3&&d.shift();for(const e of t.aliases)a.aliases.includes(e)||a.aliases.push(e);t.preferredName===a.preferredName||a.aliases.includes(t.preferredName)||a.aliases.push(t.preferredName),t.physicalAge&&!a.physicalAge&&(a.physicalAge=t.physicalAge),t.mentalAge&&!a.mentalAge&&(a.mentalAge=t.mentalAge),t.physical&&!a.physical&&(a.physical=t.physical),t.personality&&!a.personality&&(a.personality=t.personality),t.sexuality&&!a.sexuality&&(a.sexuality=t.sexuality),t.raceEthnicity&&!a.raceEthnicity&&(a.raceEthnicity=t.raceEthnicity),t.roleSkills&&!a.roleSkills&&(a.roleSkills=t.roleSkills),t.lastInteraction&&!a.lastInteraction&&(a.lastInteraction=t.lastInteraction);for(const e of t.relationships)a.relationships.includes(e)||a.relationships.push(e);return a.lastUpdated=Date.now(),(0,i.e7)(a.preferredName,a),(0,i.sr)(e),c.log(),l.success(`Merged ${e} into ${n}`),s})}async function C(){return(0,o.Xc)("undoLastMerge",async()=>{if(0===d.length)return l.warning("No merge operations to undo"),!1;const e=d.pop();return"merge"!==e.operation?(l.error("Last operation was not a merge"),!1):((0,i.e7)(e.sourceName,e.sourceData),(0,i.e7)(e.targetName,e.targetDataBefore),c.log(),l.success("Merge undone successfully"),!0)})}async function b(e){return(0,o.Xc)("toggleIgnoreCharacter",async()=>{const n=(0,i.qN)(e);if(!n)throw new o.S_("Character not found");n.ignored=!n.ignored,(0,i.e7)(e,n);const r=n.ignored?"ignored":"unignored";return l.info(`${e} ${r}`),c.log(),n.ignored})}async function k(e){return(0,o.Xc)("createNewCharacter",async()=>{if(!e||!e.trim())throw new o.S_("Character name is required");const n=e.trim();if((0,i.qN)(n))throw new o.S_(`Character "${n}" already exists`);const r={name:n,aliases:[],physicalAge:"",mentalAge:"",physical:"",personality:"",sexuality:"",raceEthnicity:"",roleSkills:"",lastInteraction:"",relationships:[],confidence:100},t=await A(r,!1);return c.log(),l.success(`Created character: ${n}`),t})}async function x(){return(0,o.Xc)("purgeAllCharacters",async()=>{const e=(0,i.bg)(),n=Object.keys(e).length;return 0===n?(l.info("No characters to purge"),0):((0,i.yb)("characters",{}),d=[],c.log(),l.success(`Purged ${n} characters`),n)})}function v(e){return(0,o.Xc)("hasUnresolvedRelationships",()=>{if(!e.relationships||0===e.relationships.length)return!1;const n=(0,i.bg)(),r=Object.values(n).reduce((e,n)=>(e.add(n.preferredName.toLowerCase()),n.aliases.forEach(n=>e.add(n.toLowerCase())),e),new Set);return e.relationships.some(e=>e.toLowerCase().split(/\s+/).some(e=>e.length>2&&!r.has(e)))})}},659(e){var n={};e.exports=function(e,r){var t=function(e){if(void 0===n[e]){var r=document.querySelector(e);if(window.HTMLIFrameElement&&r instanceof window.HTMLIFrameElement)try{r=r.contentDocument.head}catch(e){r=null}n[e]=r}return n[e]}(e);if(!t)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");t.appendChild(r)}},695(e,n,r){r.d(n,{A:()=>i,h:()=>a});const t=r(806).Ay.createModuleLogger("Notifications");class a{constructor(){this.defaultOptions={timeOut:5e3,extendedTimeOut:2e3,closeButton:!0,progressBar:!0,preventDuplicates:!0},this.prefix="Name Tracker: "}success(e,n="Success",r={}){const a={...this.defaultOptions,...r};toastr.success(this.prefix+e,n,a),t.debug("Success notification:",e)}info(e,n="Info",r={}){const a={...this.defaultOptions,...r};toastr.info(this.prefix+e,n,a),t.debug("Info notification:",e)}warning(e,n="Warning",r={}){const a={...this.defaultOptions,timeOut:8e3,...r};toastr.warning(this.prefix+e,n,a),t.debug("Warning notification:",e)}error(e,n="Error",r={}){const a={...this.defaultOptions,timeOut:1e4,extendedTimeOut:5e3,...r};toastr.error(this.prefix+e,n,a),t.error("Error notification:",e)}persistent(e,n="Notice",r="info"){const a={...this.defaultOptions,timeOut:0,extendedTimeOut:0};switch(r){case"success":toastr.success(this.prefix+e,n,a);break;case"warning":toastr.warning(this.prefix+e,n,a);break;case"error":toastr.error(this.prefix+e,n,a);break;default:toastr.info(this.prefix+e,n,a)}t.debug("Persistent notification:",e)}progress(e,n=0,r=null){const a=r||`progress_${Date.now()}`,o=`\n            <div style="margin-bottom: 8px;">${this.prefix}${e}</div>\n            <div style="background: #333; border-radius: 3px; overflow: hidden;">\n                <div style="background: #007acc; height: 6px; width: ${n}%; transition: width 0.3s ease;"></div>\n            </div>\n            <div style="text-align: center; font-size: 11px; margin-top: 4px;">${n}%</div>\n        `,i={timeOut:0,extendedTimeOut:0,closeButton:!1,progressBar:!1,preventDuplicates:!1,toastId:a};return toastr.remove(),toastr.info(o,"",i),t.debug("Progress notification:",e,`${n}%`),a}clear(){toastr.clear(),t.debug("Cleared all notifications")}confirm(e,n,r=null,a="Confirm"){const o=`confirm_${Date.now()}`,i=`\n            <div style="margin-bottom: 12px;">${e}</div>\n            <div style="text-align: right;">\n                <button class="btn btn-sm btn-secondary me-2" onclick="nameTrackerNotifications.handleConfirmCancel('${o}')">Cancel</button>\n                <button class="btn btn-sm btn-primary" onclick="nameTrackerNotifications.handleConfirmOk('${o}')">Confirm</button>\n            </div>\n        `;window.nameTrackerNotifications=window.nameTrackerNotifications||{},window.nameTrackerNotifications.confirmCallbacks=window.nameTrackerNotifications.confirmCallbacks||{},window.nameTrackerNotifications.confirmCallbacks[o]={onConfirm:n,onCancel:r},window.nameTrackerNotifications.handleConfirmOk=e=>{const n=window.nameTrackerNotifications.confirmCallbacks[e];n&&n.onConfirm&&n.onConfirm(),delete window.nameTrackerNotifications.confirmCallbacks[e],toastr.clear()},window.nameTrackerNotifications.handleConfirmCancel=e=>{const n=window.nameTrackerNotifications.confirmCallbacks[e];n&&n.onCancel&&n.onCancel(),delete window.nameTrackerNotifications.confirmCallbacks[e],toastr.clear()};const s={timeOut:0,extendedTimeOut:0,closeButton:!1,progressBar:!1,preventDuplicates:!1,toastId:o};return toastr.info(i,this.prefix+a,s),t.debug("Confirmation notification:",e),o}getStatus(){return{defaultOptions:this.defaultOptions,prefix:this.prefix,activeConfirms:Object.keys(window.nameTrackerNotifications?.confirmCallbacks||{}).length}}}const o=new a;t.debug("Notifications module loaded");const i=o},806(e,n,r){r.d(n,{Ay:()=>o,Xv:()=>a});const t=new class{constructor(){this.modules=new Map,this.performanceMarks=new Map,this.operationTraces=new Map}createModuleLogger(e){if(this.modules.has(e))return this.modules.get(e);const n={log:(...n)=>this.log(e,"log",...n),warn:(...n)=>this.log(e,"warn",...n),error:(...n)=>this.log(e,"error",...n),debug:(...n)=>this.log(e,"debug",...n),trace:(n,r)=>this.addTrace(e,n,r),startTimer:n=>this.startTimer(e,n),endTimer:n=>this.endTimer(e,n)};return this.modules.set(e,n),n}log(e,n,...r){if(!this.isDebugEnabled())return;const t=`[STnametracker:${e}] ${(new Date).toLocaleTimeString()}`;switch(n){case"error":console.error(t,...r);break;case"warn":console.warn(t,...r);break;case"debug":console.debug(t,...r);break;default:console.log(t,...r)}}addTrace(e,n,r){this.isDebugEnabled()&&(this.operationTraces.has(n)||this.operationTraces.set(n,[]),this.operationTraces.get(n).push({module:e,timestamp:Date.now(),message:r}))}getTrace(e){return this.operationTraces.get(e)||[]}startTimer(e,n){const r=`${e}:${n}`;this.performanceMarks.set(r,performance.now())}endTimer(e,n){const r=`${e}:${n}`,t=this.performanceMarks.get(r);if(void 0===t)return this.log(e,"warn",`Timer '${n}' was not started`),0;const a=performance.now()-t;return this.performanceMarks.delete(r),this.log(e,"debug",`Timer '${n}': ${a.toFixed(2)}ms`),a}isDebugEnabled(){return!0}clear(){this.operationTraces.clear(),this.performanceMarks.clear()}getPerformanceSummary(){return{activeTimers:this.performanceMarks.size,activeTraces:this.operationTraces.size,modules:Array.from(this.modules.keys())}}};function a(e){return t.createModuleLogger(e)}const o=t},825(e){e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var n=e.insertStyleElement(e);return{update:function(r){!function(e,n,r){var t="";r.supports&&(t+="@supports (".concat(r.supports,") {")),r.media&&(t+="@media ".concat(r.media," {"));var a=void 0!==r.layer;a&&(t+="@layer".concat(r.layer.length>0?" ".concat(r.layer):""," {")),t+=r.css,a&&(t+="}"),r.media&&(t+="}"),r.supports&&(t+="}");var o=r.sourceMap;o&&"undefined"!=typeof btoa&&(t+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),n.styleTagTransform(t,e,n.options)}(n,e,r)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(n)}}}},854(e,n,r){r.d(n,{ZD:()=>a,cv:()=>o,tx:()=>t});function t(e){let n=0;for(let r=0;r<e.length;r++){n=(n<<5)-n+e.charCodeAt(r),n&=n}return n.toString(36)}function a(e){if("string"!=typeof e)return"";const n=document.createElement("div");return n.textContent=e,n.innerHTML}function o(){return Date.now().toString(36)+Math.random().toString(36).substr(2,9)}r(806).Ay.createModuleLogger("Utils").debug("Utils module loaded")}},n={};function r(t){var a=n[t];if(void 0!==a)return a.exports;var o=n[t]={id:t,exports:{}};return e[t](o,o.exports,r),o.exports}r.n=e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return r.d(n,{a:n}),n},r.d=(e,n)=>{for(var t in n)r.o(n,t)&&!r.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:n[t]})},r.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n),r.nc=void 0;var t=r(72),a=r.n(t),o=r(825),i=r.n(o),s=r(659),c=r.n(s),l=r(56),d=r.n(l),m=r(540),g=r.n(m),u=r(113),p=r.n(u),h=r(83),A={};A.styleTagTransform=p(),A.setAttributes=d(),A.insert=c().bind(null,"head"),A.domAPI=i(),A.insertStyleElement=g();a()(h.A,A);h.A&&h.A.locals&&h.A.locals;var f=r(806),y=r(462),C=r(102),b=r(418),k=r(695),x=r(854),v=r(551);const w=(0,f.Xv)("llm"),I=new k.h("LLM Integration"),B=new Map;let S=[];async function T(e){return(0,y.Xc)("getOllamaModelContext",async()=>{const n=(0,b.TJ)("ollamaEndpoint","http://localhost:11434");if(!e)return w.log(),4096;try{const r=await fetch(`${n}/api/show`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!r.ok)throw new Error(`Failed to fetch model info: ${r.statusText}`);const t=await r.json();if(t.parameters&&Array.isArray(t.parameters))for(const e of t.parameters){const n=e.match(/num_ctx\\s+(\\d+)/);if(n){const e=parseInt(n[1]);return w.log(),e}}if(t.model_info&&t.model_info.num_ctx){const e=parseInt(t.model_info.num_ctx);return w.log(),e}return w.log(),4096}catch(e){return console.error("Error fetching Ollama model context:",e),w.log(),4096}})}function _(){return(0,y.Xc)("buildCharacterRoster",()=>{const e=(0,b.bg)(),n=Object.keys(e);if(0===n.length)return"";return`\\n\\n[KNOWN CHARACTERS]\\nThe following characters have already been identified. If you encounter them again, use the same name and add any new details:\\n${n.map(n=>{const r=e[n];return`  - ${n}${r.aliases&&r.aliases.length>0?` (also known as: ${r.aliases.join(", ")})`:""}${r.relationships&&r.relationships.length>0?`\\n    Relationships: ${r.relationships.join("; ")}`:""}`}).join("\\n")}\\n`})}async function E(){return(0,y.Xc)("getMaxPromptLength",async()=>{const e=(0,b.eU)();let n=4096;if("ollama"===e.source&&e.ollamaModel)n=await T(e.ollamaModel);else{n=C.r.getContext().maxContext||4096}const r=Math.floor(.5*n);return w.log(),Math.max(1e3,Math.min(r,25e3))})}async function M(e){return(0,y.Xc)("calculateMessageTokens",async()=>{const n=C.r.getContext();let r=0;for(const t of e)if(t&&"object"==typeof t&&t.extra&&"number"==typeof t.extra.token_count)r+=t.extra.token_count;else{const e=t?.mes||t?.message||String(t);if(e&&n.getTokenCountAsync)try{r+=await n.getTokenCountAsync(e)}catch(n){w.log(),r+=Math.ceil(e.length/4)}else r+=Math.ceil(e.length/4)}return r})}function O(e){return(0,y.Xc)("parseJSONResponse",()=>{if(!e||"string"!=typeof e)throw console.error("Invalid response text:",e),new y.S_("LLM returned empty or invalid response");const n=(e=e.trim()).match(/```(?:json)?\\s*([\\s\\S]*?)```/);n&&(e=n[1].trim());const r=e.indexOf("{"),t=e.lastIndexOf("}");-1!==r&&-1!==t&&t>r&&(e=e.substring(r,t+1)),e=(e=e.replace(/^(?:Here's the analysis:|Here is the JSON:|Result:|Output:)\\s*/i,"")).trim();try{const n=JSON.parse(e);return n.characters&&Array.isArray(n.characters)?n:(console.warn("Response missing characters array, returning empty:",n),{characters:[]})}catch(n){if(console.error("Failed to parse JSON response. Original text:",e),console.error("Parse error:",n.message),e.includes('"characters"')&&!e.trim().endsWith("}")){w.log(),w.log();let n=e;const r=(e.match(/\{/g)||[]).length,t=(e.match(/\}/g)||[]).length,a=(e.match(/\[/g)||[]).length,o=(e.match(/\]/g)||[]).length;n.match(/"[^"]*$/)&&(n+='"');for(let e=0;e<a-o;e++)n+="]";for(let e=0;e<r-t;e++)n+="}";try{const e=JSON.parse(n);return w.log(),e}catch(e){w.log()}}const r=e.match(/\\{[\\s\\S]*"characters"[\\s\\S]*\\}/);if(r)try{return JSON.parse(r[0])}catch(e){w.log()}throw new y.S_("Failed to parse LLM response as JSON. The response may be too long or truncated. Try analyzing fewer messages at once.")}})}async function z(e,n="",r=0,t=0){return(0,y.Xc)("callLLMAnalysis",async()=>{const a=(0,b.eU)(),o=await E();w.log();const i=e.map(e=>"string"==typeof e?e:e.mes?e.mes:e.message?e.message:JSON.stringify(e)),s=(0,x.tx)(i.join("\\n")+a.source+a.ollamaModel);if(B.has(s))return w.log(),B.get(s);const c=i.map((e,n)=>`Message ${n+1}:\\n${e}`).join("\\n\\n"),l=`${`[SYSTEM INSTRUCTION - DO NOT ROLEPLAY]\\n${(0,b.TJ)("systemPrompt")||'You are a character analysis assistant. Your task is to extract character information from chat messages and return it in a structured JSON format.\n\nCRITICAL: You MUST respond with ONLY valid JSON. Do not include any explanatory text, markdown formatting, or commentary. Just the raw JSON object.\n\nIMPORTANT PROCESSING RULES:\n1. Process messages in CHRONOLOGICAL ORDER (oldest to newest)\n2. When there is conflicting information about a character, ALWAYS use the MOST RECENT information\n3. Be smart about name variations - "Alex" and "Alexandra" may be the same person\n4. Track physical attributes, personality traits, relationships, and interactions with {{user}}\n5. Don\'t create entries for generic references like "the bartender" unless given specific names\n\nRequired JSON structure:\n{\n  "characters": [\n    {\n      "name": "Character\'s primary/preferred name",\n      "aliases": ["Alternative names", "Nicknames"],\n      "physicalAge": "Age or age range",\n      "mentalAge": "Mental/emotional age if different",\n      "physical": "Physical description and appearance",\n      "personality": "Personality traits and behavior", \n      "sexuality": "Sexual orientation or preferences",\n      "raceEthnicity": "Race/ethnicity information",\n      "roleSkills": "Job, role, skills, abilities",\n      "lastInteraction": "Most recent interaction or scene with {{user}}",\n      "relationships": ["Relationship with other characters"],\n      "confidence": 85\n    }\n  ]\n}\n\nConfidence scores (0-100):\n- 90-100: Character explicitly named with detailed info\n- 70-89: Character clearly identified with some details\n- 50-69: Character mentioned but limited info\n- Below 50: Uncertain or vague reference\n\nFocus on major speaking characters and those with significant interactions. Avoid analyzing every minor mention.'}${n}\\n\\n[DATA TO ANALYZE]`}\\n${c}\\n\\n[RESPOND WITH JSON ONLY - NO STORY CONTINUATION]`;let d,m;try{d=await M([{mes:l}]),w.log()}catch(e){w.log(),d=Math.ceil(l.length/4)}if(d>o&&e.length>1){"  ".repeat(r);w.log();const t=Math.floor(e.length/2),a=e.slice(0,t),o=e.slice(t);w.log();const[i,s]=await Promise.all([z(a,n,r+1),z(o,n,r+1)]),c={characters:[...i.characters||[],...s.characters||[]]};return w.log(),c}try{m="ollama"===a.source?await async function(e){return(0,y.Xc)("callOllama",async()=>{const n=(0,b.eU)();if(!n.ollamaModel)throw new y.S_("No Ollama model selected");w.log();const r=await T(n.ollamaModel),t=Math.floor(.25*r),a=Math.max(4e3,t);w.log();const o=await fetch(`${n.ollamaEndpoint}/api/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:n.ollamaModel,prompt:e,stream:!1,format:"json",options:{temperature:.3,top_p:.9,top_k:40,repeat_penalty:1.1,num_predict:a}})});if(!o.ok)throw new y.S_(`Ollama API error: ${o.statusText}`);const i=await o.json();return w.log(),w.log(),O(i.response)})}(l):await async function(e){return(0,y.Xc)("callSillyTavern",async()=>{w.log();const n=C.r.getContext();if(!n.onlineStatus)throw new y.S_("No API connection available. Please connect to an API first.");let r;try{r=await n.getTokenCountAsync(e),w.log()}catch(n){w.log(),r=Math.ceil(e.length/4),w.log()}const t=n.maxContext||4096,a=Math.floor(.25*t),o=Math.max(4e3,a);w.log();const i=await n.generateRaw({prompt:e,systemPrompt:"",prefill:"",temperature:.3,top_p:.9,top_k:40,min_p:.05,rep_pen:1.1,max_tokens:o,stop:[]});if(w.log(),!i)throw new y.S_("Empty response from SillyTavern LLM");return O(i)})}(l)}catch(a){if(t<3&&(a.message.includes("JSON")||a.message.includes("empty")||a.message.includes("truncated"))){w.log();const a=1e3*Math.pow(2,t);return await new Promise(e=>setTimeout(e,a)),await z(e,n,r,t+1)}throw a}if(B.size>50){const e=B.keys().next().value;B.delete(e)}return B.set(s,m),w.log(),m})}var N=r(134);const L=(0,f.Xv)("processing"),R=new k.h("Message Processing");let D=[],P=!1,j=!1;async function U(e){return(0,y.Xc)("processAnalysisResults",async()=>{if(e&&Array.isArray(e)){L.log();for(const n of e)try{await W(n)}catch(e){console.error(`Error processing character ${n.name}:`,e)}}else L.log()})}async function W(e){return(0,y.Xc)("processCharacterData",async()=>{if(!e.name||""===e.name.trim())return void L.log();const n=e.name.trim();if((0,v.eY)(n))return void L.log();const r=n.toLowerCase().includes("{{char}}")||!0===e.isMainCharacter||"main"===e.role,t=(0,v._$)(n);if(t)await(0,v.t9)(t,e,!1,r),await(0,N.TQ)(t,t.preferredName),L.log();else{const n=await(0,v.rL)(e);if(n)await(0,v.t9)(n,e,!0,r),await(0,N.TQ)(n,n.preferredName),L.log();else{const n=await(0,v.OW)(e,r);await(0,N.TQ)(n,n.preferredName),L.log()}}})}async function F(e,n=!0){return(0,y.Xc)("harvestMessages",async()=>{if(!(0,b.TJ)("enabled",!0))return void L.log();if("sillytavern"===(0,b.eU)().source){if(!C.r.getContext().onlineStatus)return void R.warning("Please connect to an API (OpenAI, Claude, etc.) before analyzing messages")}const r=C.r.getContext();if(!r.chat||0===r.chat.length)return L.log(),void R.info("No messages in chat to analyze");const t=r.chat.length,a=Math.max(0,t-e),o=r.chat.slice(a,t),i=await E()-1e3;if(await M(o)>i){L.log();const e=[];let r=[],t=0;for(const n of o){const a=await M([n]);t+a>i&&r.length>0?(e.push(r),r=[n],t=a):(r.push(n),t+=a)}r.length>0&&e.push(r),n&&R.info(`Splitting into ${e.length} batches to fit context window`),j=!1,Z(0,e.length,"Starting analysis...");let s=0,c=0;const l=new Set;for(let n=0;n<e.length;n++){if(j)return L.log(),Q(),void R.warning("Analysis aborted");const r=e[n],t=a+e.slice(0,n).reduce((e,n)=>e+n.length,0),o=t+r.length;try{Z(n+1,e.length,`Analyzing messages ${t+1}-${o}...`);const a=_(),i=await z(r,a);i.characters&&Array.isArray(i.characters)&&(await U(i.characters),i.characters.forEach(e=>l.add(e.name))),s++,n<e.length-1&&await new Promise(e=>setTimeout(e,500))}catch(e){console.error(`Error processing batch ${n+1}:`,e),c++;if(!confirm(`Batch ${n+1} failed.\\n\\nError: ${e.message}\\n\\nContinue with remaining batches?`))break}}Q();const d=`Analysis complete!\\n\\nBatches processed: ${s}/${e.length}\\nUnique characters found: ${l.size}\\nFailed batches: ${c}`;return void(c>0?R.warning(d,{timeOut:8e3}):R.success(d,{timeOut:8e3}))}n&&R.info(`Analyzing ${o.length} messages for character information...`);try{const e=_(),r=await z(o,e);L.log(),r.characters&&Array.isArray(r.characters)?(await U(r.characters),n&&R.success(`Found ${r.characters.length} character(s) in messages`)):L.log()}catch(e){console.error("Error during harvest:",e),R.error(`Analysis failed: ${e.message}`)}})}async function X(e){return(0,y.Xc)("onMessageReceived",async()=>{if(!(0,b.TJ)("enabled",!0)||!(0,b.TJ)("autoAnalyze",!0))return;const e=C.r.getContext().chat;if(!e||0===e.length)return;const n=e.length-1,r=(0,b.TJ)("lastScannedMessageId",-1);if(n<=r)return void L.log();if(r>=0&&n<r){L.log();const e=await async function(e,n){return new Promise(r=>{const t=$(`\n            <div class="name-tracker-rescan-modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--SmartThemeBodyColor); border: 2px solid var(--SmartThemeBorderColor); padding: 20px; border-radius: 10px; z-index: 9999; max-width: 500px;">\n                <h3>Message History Changed</h3>\n                <p>Messages have been deleted or edited. Would you like to rescan the chat?</p>\n                <p>Current last scanned message: ${n}<br>\n                Current message index: ${e}</p>\n                <div style="margin-top: 15px;">\n                    <label>Rescan from message: <input type="number" id="rescan-from" value="0" min="0" max="${e}" style="width: 80px; margin-left: 10px;"></label>\n                </div>\n                <div style="margin-top: 15px; text-align: right;">\n                    <button id="rescan-yes" class="menu_button">Rescan</button>\n                    <button id="rescan-no" class="menu_button">Skip</button>\n                </div>\n            </div>\n        `);$("body").append(t),t.find("#rescan-yes").on("click",()=>{const e=parseInt(t.find("#rescan-from").val())||0;t.remove(),r({rescan:!0,fromMessage:e})}),t.find("#rescan-no").on("click",()=>{t.remove(),r({rescan:!1})})})}(n,r);return e.rescan?((0,b.nT)("lastScannedMessageId",e.fromMessage-1),void J(async()=>{await F(n-e.fromMessage+1,!0)})):void(0,b.nT)("lastScannedMessageId",n)}const t=(0,b.TJ)("messageFrequency",10);n-r>=t&&(L.log(),J(async()=>{await F(t,!0),(0,b.nT)("lastScannedMessageId",n)}))})}function Z(e,n,r=""){const t="name_tracker_progress",a=$(`.${t}`);if(a.length>0)return r&&a.find(".title").text(r),a.find(".progress").text(e),a.find(".total").text(n),void a.find("progress").val(e).attr("max",n);const o=$(`\n        <div class="${t} name_tracker_progress_bar flex-container justifyspacebetween alignitemscenter" style="\n            padding: 10px;\n            margin: 5px 0;\n            background: var(--SmartThemeBlurTintColor);\n            border: 1px solid var(--SmartThemeBorderColor);\n            border-radius: 5px;\n        ">\n            <div class="title" style="flex: 1; font-weight: bold;">${r||"Name Tracker Scan"}</div>\n            <div style="margin: 0 10px;">(<span class="progress">${e}</span> / <span class="total">${n}</span>)</div>\n            <progress value="${e}" max="${n}" style="flex: 2; margin: 0 10px;"></progress>\n            <button class="menu_button fa-solid fa-stop" title="Abort scan" style="padding: 5px 10px;"></button>\n        </div>\n    `);o.find("button").on("click",function(){j=!0,Q(),R.warning("Scan aborted by user")}),$("#sheld").append(o)}function Q(){const e=$(".name_tracker_progress");e.length>0&&e.fadeOut(300,function(){$(this).remove()})}async function J(e){return(0,y.Xc)("addToQueue",async()=>{D.push(e),P||await async function(){return(0,y.Xc)("processQueue",async()=>{if(!P&&0!==D.length){for(P=!0;D.length>0;){const e=D.shift();try{await e()}catch(e){console.error("Error processing queue task:",e)}}P=!1}})}()})}const Y=(0,f.Xv)("ui"),q=new k.h("UI Management");function H(){return(0,y.Xc)("updateCharacterList",()=>{const e=$("#name_tracker_character_list");if(0===e.length)return void Y.log();const n=(0,b.bg)();if(0===Object.keys(n).length)return void e.html('\n                <div class="name_tracker_no_characters">\n                    <p style="text-align: center; color: var(--SmartThemeQuoteColor);">\n                        No characters tracked yet. Start a conversation and character information will be extracted automatically!\n                    </p>\n                </div>\n            ');const r=Object.values(n).sort((e,n)=>e.isMainChar&&!n.isMainChar?-1:!e.isMainChar&&n.isMainChar?1:e.preferredName.localeCompare(n.preferredName));let t='<div class="name_tracker_character_list">';for(const e of r){const n=e.isMainChar?'<i class="fa-solid fa-user"></i>':"",r=e.ignored?'<span class="char-ignored-badge">IGNORED</span>':"",a=(0,v.pp)(e)?'<span class="char-review-badge">NEEDS REVIEW</span>':"",o=e.aliases&&e.aliases.length>0?`<div class="char-aliases">Aliases: ${(0,x.ZD)(e.aliases.join(", "))}</div>`:"",i=e.relationships&&e.relationships.length>0?`<div class="char-relationships">Relationships: ${(0,x.ZD)(e.relationships.join("; "))}</div>`:"",s=e.lastUpdated?new Date(e.lastUpdated).toLocaleString():"Never";t+=`\n                <div class="name_tracker_character_item" data-character="${(0,x.ZD)(e.preferredName)}">\n                    <div class="char-header">\n                        <span class="char-name">\n                            ${n}\n                            ${(0,x.ZD)(e.preferredName)}\n                            ${r}\n                            ${a}\n                        </span>\n                        <div class="char-actions">\n                            <button class="char-action-btn char-action-edit" data-name="${(0,x.ZD)(e.preferredName)}" title="Edit lorebook entry">\n                                <i class="fa-solid fa-edit"></i>\n                            </button>\n                            <button class="char-action-btn char-action-view" data-name="${(0,x.ZD)(e.preferredName)}" title="View in lorebook">\n                                <i class="fa-solid fa-book"></i>\n                            </button>\n                            <button class="char-action-btn char-action-merge" data-name="${(0,x.ZD)(e.preferredName)}" title="Merge with another character">\n                                <i class="fa-solid fa-code-merge"></i>\n                            </button>\n                            <button class="char-action-btn char-action-ignore" data-name="${(0,x.ZD)(e.preferredName)}" title="${e.ignored?"Unignore":"Ignore"} character">\n                                <i class="fa-solid ${e.ignored?"fa-eye":"fa-eye-slash"}"></i>\n                            </button>\n                        </div>\n                    </div>\n                    ${o}\n                    ${i}\n                    <div class="char-metadata">\n                        <span>Confidence: ${e.confidence}%</span>\n                        <span>Updated: ${s}</span>\n                    </div>\n                </div>\n            `}t+="</div>",e.html(t)})}function K(){return(0,y.Xc)("updateStatusDisplay",()=>{const e=$("#name_tracker_status_display");if(0===e.length)return;const n=(0,b.bg)(),r=Object.keys(n).length,t=(0,b.PL)("messageCounter",0),a=(0,b.PL)("lastScannedMessageId",-1),o=(0,b.PL)("messageFrequency",10),i=C.r.getContext(),s=i?.chat?.length||0,c=Math.max(0,s-a),l=t>0?` (${t} analyzed)`:"",d=i.chat?i.chat.length:0,m=`\n            <div class="name_tracker_status">\n                <div class="status-item">\n                    <strong>Characters tracked:</strong> ${r}${l}\n                </div>\n                <div class="status-item">\n                    <strong>Messages in chat:</strong> ${d}\n                </div>\n                <div class="status-item">\n                    <strong>Last scanned message:</strong> ${a>=0?a+1:"None"}\n                </div>\n                <div class="status-item">\n                    <strong>Pending messages:</strong> ${c}\n                </div>\n                <div class="status-item">\n                    <strong>Messages until next scan:</strong> ${Math.max(0,o-(d-a))}\n                </div>\n            </div>\n        `;e.html(m)})}function G(){return(0,y.Xc)("showCharacterListModal",()=>{const e=Object.values((0,b.bg)()||{});let n="";if(0===e.length)n='<p style="text-align: center; color: var(--SmartThemeQuoteColor);">No characters tracked yet</p>';else{e.sort((e,n)=>e.isMainChar&&!n.isMainChar?-1:!e.isMainChar&&n.isMainChar?1:e.preferredName.localeCompare(n.preferredName)),n='<div style="max-height: 400px; overflow-y: auto;">';for(const r of e){const e=[];r.isMainChar&&e.push('<span style="background: var(--SmartThemeBodyColor); padding: 2px 6px; border-radius: 3px; font-size: 0.85em; margin-left: 5px;">MAIN</span>'),r.ignored&&e.push('<span style="background: var(--black70a); padding: 2px 6px; border-radius: 3px; font-size: 0.85em; margin-left: 5px;">IGNORED</span>'),(0,v.pp)(r)&&e.push('<span style="background: var(--crimsonDark); padding: 2px 6px; border-radius: 3px; font-size: 0.85em; margin-left: 5px;">NEEDS REVIEW</span>');const t=r.aliases&&r.aliases.length>0?`<div style="font-size: 0.9em; color: var(--SmartThemeQuoteColor); margin-top: 3px;">Aliases: ${(0,x.ZD)(r.aliases.join(", "))}</div>`:"";n+=`\n                    <div style="padding: 10px; margin: 5px 0; background: var(--SmartThemeBlurTintColor); border: 1px solid var(--SmartThemeBorderColor); border-radius: 5px;">\n                        <div style="font-weight: bold;">\n                            ${r.isMainChar?'<i class="fa-solid fa-user" style="margin-right: 5px;"></i>':""}\n                            ${(0,x.ZD)(r.preferredName)}\n                            ${e.join("")}\n                        </div>\n                        ${t}\n                    </div>\n                `}n+="</div>"}const r=`\n            <div class="name-tracker-character-modal">\n                <h3 style="margin-top: 0;">Tracked Characters (${e.length})</h3>\n                ${n}\n                <div style="margin-top: 15px; text-align: center;">\n                    <button class="menu_button" onclick="$('#name_tracker_settings').find('.inline-drawer-toggle').click(); $(this).closest('.popup').remove();">\n                        <i class="fa-solid fa-gear"></i> Open Settings\n                    </button>\n                </div>\n            </div>\n        `,t=C.r.getContext();t.callGenericPopup(r,t.POPUP_TYPE.TEXT,"",{wider:!0,okButton:"Close"})})}function V(){return(0,y.Xc)("initializeUIHandlers",()=>{$(document).on("click",".char-action-merge",async function(){const e=$(this).data("name");await async function(e){return(0,y.Xc)("showMergeDialog",async()=>{const n=(0,b.bg)(),r=Object.keys(n).filter(n=>n!==e);if(0===r.length)return void q.warning("No other characters to merge with");const t=prompt(`Merge "${e}" into which character? Available: ${r.join(", ")}`);t&&n[t]?(await(0,v.lF)(e,t),H(),K()):t&&q.error("Invalid target character name")})}(e)}),$(document).on("click",".char-action-ignore",async function(){const e=$(this).data("name");await(0,v.el)(e),H(),K()}),$(document).on("click",".char-action-view",async function(){const e=$(this).data("name");await(0,N._Z)(e)}),$(document).on("click",".char-action-edit",async function(){const e=$(this).data("name");await async function(e){return(0,y.Xc)("showEditLorebookModal",async()=>{const n=(0,b.qN)(e);if(!n)return void q.error("Character not found");const r=[e,...n.aliases||[]].join(", "),t=`\n            <div class="lorebook-entry-editor">\n                <h3>Edit Lorebook Entry: ${(0,x.ZD)(e)}</h3>\n                \n                <div class="editor-section">\n                    <label for="entry-keys">Keys (comma-separated):</label>\n                    <input type="text" id="entry-keys" class="text_pole" value="${(0,x.ZD)(r)}" \n                           placeholder="${(0,x.ZD)(e)}, aliases, nicknames">\n                    <small>These words trigger this entry in the chat context</small>\n                </div>\n                \n                <div class="editor-section">\n                    <label for="entry-content">Entry Content:</label>\n                    <textarea id="entry-content" rows="10" class="text_pole" \n                              placeholder="Description, personality, background, relationships...">${(0,x.ZD)(n.notes||"")}</textarea>\n                    <small>This will be injected into context when keys are mentioned</small>\n                </div>\n                \n                <div class="editor-section">\n                    <label for="entry-relationships">Relationships:</label>\n                    <textarea id="entry-relationships" rows="3" class="text_pole" \n                              placeholder="Friend of Alice; Enemy of Bob; Works for XYZ Corp">${(0,x.ZD)((n.relationships||[]).join("; "))}</textarea>\n                    <small>One relationship per line or semicolon-separated</small>\n                </div>\n            </div>\n        `,a=$(`\n            <div class="nametracker-modal" style="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: var(--SmartThemeBlurTintColor);\n                border: 1px solid var(--SmartThemeBorderColor);\n                border-radius: 10px;\n                padding: 20px;\n                max-width: 600px;\n                width: 90%;\n                max-height: 80vh;\n                overflow-y: auto;\n                z-index: 9999;\n                box-shadow: 0 4px 20px rgba(0,0,0,0.5);\n            ">\n                ${t}\n                <div style="margin-top: 20px; text-align: right;">\n                    <button class="menu_button" id="entry-save">Save</button>\n                    <button class="menu_button" id="entry-cancel">Cancel</button>\n                </div>\n            </div>\n        `),o=$('\n            <div class="nametracker-overlay" style="\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.7);\n                z-index: 9998;\n            "></div>\n        ');$("body").append(o).append(a);const i=()=>{a.remove(),o.remove()};a.find("#entry-save").on("click",async()=>{const r=a.find("#entry-keys").val().split(",").map(e=>e.trim()).filter(e=>e),t=a.find("#entry-content").val(),o=a.find("#entry-relationships").val().split(/[;\\n]/).map(e=>e.trim()).filter(e=>e),s=r[0]||e,c=r.slice(1);n.preferredName=s,n.aliases=c,n.notes=t,n.relationships=o,s!==e&&(0,b.sr)(e),(0,b.e7)(s,n),H(),K(),q.success(`Updated lorebook entry for ${s}`),i()}),a.find("#entry-cancel").on("click",i),o.on("click",i)})}(e)}),Y.log()})}function ee(e,n,r,t=null,a=""){return(0,y.Xc)("addMenuButton",()=>{const o=$(`\n            <div class="list-group-item flex-container flexGap5 interactable ${a}" title="${t||e}" tabindex="0">\n                <i class="${n}"></i>\n                <span>${e}</span>\n            </div>\n        `),i=$("#extensionsMenu");i.length?(o.appendTo(i),o.on("click",()=>r())):console.error("[Name Tracker] Could not find the extensions menu")})}function ne(){return(0,y.Xc)("toggleAutoHarvest",()=>{const e=(0,b.PL)("autoAnalyze",!0);(0,b.ZC)("autoAnalyze",!e),$("#name_tracker_auto_analyze").prop("checked",!e);const n=$("#extensionsMenu .name-tracker-toggle-harvest");e?n.find("i").removeClass("fa-toggle-on").addClass("fa-toggle-off"):n.find("i").removeClass("fa-toggle-off").addClass("fa-toggle-on"),K(),q.success("Auto-harvest "+(e?"disabled":"enabled"))})}async function re(){return(0,y.Xc)("openChatLorebook",async()=>{const e=C.r.getContext(),n=e.chatMetadata?.world_info;n?"function"==typeof e.openWorldInfoEditor?await e.openWorldInfoEditor(n):($("#WorldInfo").click(),q.info(`Please select "${n}" from the World Info panel`)):q.warning("No active chat or lorebook")})}function te(){return(0,y.Xc)("initializeMenuButtons",()=>{ee("Toggle Auto-Harvest",(0,b.PL)("autoAnalyze",!0)?"fa-solid fa-toggle-on":"fa-solid fa-toggle-off",ne,"Toggle automatic character harvesting on/off","name-tracker-toggle-harvest"),ee("View Characters","fa-solid fa-users",G,"View all tracked characters"),ee("Open Chat Lorebook","fa-solid fa-book",re,"Open the Name Tracker chat lorebook in the World Info editor"),Y.log()})}function ae(){return(0,y.Xc)("bindSettingsHandlers",()=>{$("#name_tracker_enabled").on("input",e=>{(0,b.ZC)("enabled",e.target.checked),K()}),$("#name_tracker_auto_analyze").on("input",e=>{(0,b.ZC)("autoAnalyze",e.target.checked),K()}),$("#name_tracker_message_frequency").on("input",e=>{(0,b.ZC)("messageFrequency",parseInt(e.target.value)||10),K()}),$("#name_tracker_llm_source").on("change",e=>{(0,b.ZC)("llmSource",e.target.value)}),$("#name_tracker_ollama_endpoint").on("input",e=>{(0,b.ZC)("ollamaEndpoint",e.target.value)}),$("#name_tracker_ollama_model").on("change",e=>{(0,b.ZC)("ollamaModel",e.target.value)}),$("#name_tracker_load_models").on("click",async()=>{try{await async function(){return(0,y.Xc)("loadOllamaModels",async()=>{const e=(0,b.TJ)("ollamaEndpoint","http://localhost:11434");w.log();try{const n=await fetch(`${e}/api/tags`);if(!n.ok)throw new Error(`Failed to connect to Ollama: ${n.statusText}`);const r=await n.json();return S=r.models||[],w.log(),S}catch(e){throw console.error("Error loading Ollama models:",e),I.error("Failed to load Ollama models. Check endpoint and try again."),e}})}(),q.success("Ollama models loaded")}catch(e){Y.log(),q.error("Failed to load Ollama models")}}),$("#name_tracker_confidence_threshold").on("input",e=>{(0,b.ZC)("confidenceThreshold",parseInt(e.target.value)||70)}),$("#name_tracker_lorebook_position").on("change",e=>{(0,b.ZC)("lorebookPosition",parseInt(e.target.value)||0)}),$("#name_tracker_lorebook_depth").on("input",e=>{(0,b.ZC)("lorebookDepth",parseInt(e.target.value)||1)}),$("#name_tracker_lorebook_cooldown").on("input",e=>{(0,b.ZC)("lorebookCooldown",parseInt(e.target.value)||5)}),$("#name_tracker_lorebook_probability").on("input",e=>{(0,b.ZC)("lorebookProbability",parseInt(e.target.value)||100)}),$("#name_tracker_lorebook_enabled").on("input",e=>{(0,b.ZC)("lorebookEnabled",e.target.checked)}),$("#name_tracker_debug_mode").on("input",e=>{(0,b.ZC)("debugMode",e.target.checked)}),$("#name_tracker_manual_analyze").on("click",async()=>{const e=(0,b.PL)("messageFrequency",10);await F(e,!0),H(),K()}),$("#name_tracker_scan_all").on("click",async()=>{await async function(){return(0,y.Xc)("scanEntireChat",async()=>{const e=C.r.getContext();if(!e.chat||0===e.chat.length)return void R.warning("No chat messages to scan");if("sillytavern"===(0,b.eU)().source&&!e.onlineStatus)return void R.warning("Please connect to an API (OpenAI, Claude, etc.) before analyzing messages");const n=e.chat.length,r=await E()-1e3,t=[];let a=[],o=0;for(let i=0;i<n;i++){const n=e.chat[i],s=await M([n]);o+s>r&&a.length>0?(t.push(a),a=[n],o=s):(a.push(n),o+=s)}a.length>0&&t.push(a);const i=t.length;if(!confirm(`This will analyze all ${n} messages in ${i} batches. This may take a while. Continue?`))return;j=!1,Z(0,i,"Starting batch scan...");let s=0,c=0;const l=new Set;for(let e=0;e<i;e++){if(j){L.log();break}const n=t[e],r=t.slice(0,e).reduce((e,n)=>e+n.length,0),a=r+n.length;try{Z(e+1,i,`Processing messages ${r+1}-${a}...`);const t=_(),o=await z(n,t);o.characters&&Array.isArray(o.characters)&&(await U(o.characters),o.characters.forEach(e=>l.add(e.name))),s++,e<i-1&&await new Promise(e=>setTimeout(e,1e3))}catch(n){if(console.error(`Error processing batch ${e+1}:`,n),c++,!confirm(`Batch ${e+1} failed.\\n\\nError: ${n.message}\\n\\nContinue with remaining batches?`))break}}Q(),(0,b.nT)("lastScannedMessageId",n-1);const d=`Full chat scan complete!\\n\\nMessages: ${n}\\nBatches: ${s}/${i}\\nCharacters found: ${l.size}\\nFailed: ${c}`;c>0?R.warning(d,{timeOut:1e4}):R.success(d,{timeOut:1e4})})}(),H(),K()}),$("#name_tracker_create_character").on("click",()=>{!async function(){(0,y.Xc)("showCreateCharacterModal",async()=>{const e=prompt("Enter character name:");if(e&&e.trim())try{await(0,v.g9)(e.trim()),H(),K()}catch(e){q.error(e.message)}})}()}),$("#name_tracker_clear_cache").on("click",()=>{D=[],P=!1,L.log(),q.info("Cache and processing queue cleared")}),$("#name_tracker_undo_merge").on("click",async()=>{const{undoLastMerge:e}=await Promise.resolve().then(r.bind(r,551));await e()&&(H(),K())}),$("#name_tracker_purge_entries").on("click",()=>{!async function(){(0,y.Xc)("showPurgeConfirmation",async()=>{const e=(0,b.bg)(),n=Object.keys(e).length;if(0!==n){if(confirm(`This will delete all ${n} tracked characters and their lorebook entries.\\n\\nThis action cannot be undone!\\n\\nContinue?`))try{const e=await(0,v.vu)();H(),K(),q.success(`Purged ${e} characters`)}catch(e){q.error(`Failed to purge characters: ${e.message}`)}}else q.info("No characters to purge")})}()}),$("#name_tracker_edit_prompt").on("click",()=>{!async function(){(0,y.Xc)("showSystemPromptEditor",async()=>{const e=(0,b.PL)("systemPrompt")||"",n=$(`\n            <div class="nametracker-modal" style="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: var(--SmartThemeBlurTintColor);\n                border: 1px solid var(--SmartThemeBorderColor);\n                border-radius: 10px;\n                padding: 20px;\n                max-width: 700px;\n                width: 90%;\n                max-height: 80vh;\n                overflow-y: auto;\n                z-index: 9999;\n                box-shadow: 0 4px 20px rgba(0,0,0,0.5);\n            ">\n                <h3 style="margin-top: 0;">Edit System Prompt</h3>\n                <p>Customize the system prompt used for character analysis. Leave blank to use default.</p>\n                <textarea id="system_prompt_editor" rows="20" style="width: 100%; margin: 10px 0;" \n                          placeholder="Enter custom system prompt or leave blank for default...">${(0,x.ZD)(e)}</textarea>\n                <div style="margin-top: 20px; text-align: right;">\n                    <button class="menu_button" id="system_prompt_save">Save</button>\n                    <button class="menu_button" id="system_prompt_reset">Reset to Default</button>\n                    <button class="menu_button" id="system_prompt_cancel">Cancel</button>\n                </div>\n            </div>\n        `),r=$('\n            <div class="nametracker-overlay" style="\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.7);\n                z-index: 9998;\n            "></div>\n        ');$("body").append(r).append(n);const t=()=>{n.remove(),r.remove()};n.find("#system_prompt_save").on("click",()=>{const e=n.find("#system_prompt_editor").val().trim();(0,b.ZC)("systemPrompt",e||null),q.success("System prompt updated"),t()}),n.find("#system_prompt_reset").on("click",()=>{n.find("#system_prompt_editor").val(""),(0,b.ZC)("systemPrompt",null),q.success("Reset to default system prompt"),t()}),n.find("#system_prompt_cancel").on("click",t),r.on("click",t)})}()}),Y.log()})}function oe(){return(0,y.Xc)("updateUI",()=>{$("#name_tracker_enabled").prop("checked",(0,b.PL)("enabled",!0)),$("#name_tracker_auto_analyze").prop("checked",(0,b.PL)("autoAnalyze",!0)),$("#name_tracker_message_frequency").val((0,b.PL)("messageFrequency",10)),$("#name_tracker_llm_source").val((0,b.PL)("llmSource","sillytavern")),$("#name_tracker_ollama_endpoint").val((0,b.PL)("ollamaEndpoint","http://localhost:11434")),$("#name_tracker_ollama_model").val((0,b.PL)("ollamaModel","")),$("#name_tracker_confidence_threshold").val((0,b.PL)("confidenceThreshold",70)),$("#name_tracker_lorebook_position").val((0,b.PL)("lorebookPosition",0)),$("#name_tracker_lorebook_depth").val((0,b.PL)("lorebookDepth",1)),$("#name_tracker_lorebook_cooldown").val((0,b.PL)("lorebookCooldown",5)),$("#name_tracker_lorebook_probability").val((0,b.PL)("lorebookProbability",100)),$("#name_tracker_lorebook_enabled").prop("checked",(0,b.PL)("lorebookEnabled",!0)),$("#name_tracker_debug_mode").prop("checked",(0,b.PL)("debugMode",!1)),H(),K(),Y.log()})}console.log("[STnametracker] Main index.js: Import validation"),console.log("[STnametracker] Main index.js: initializeLorebook import =",typeof N.WF,N.WF),console.log("[STnametracker] Main index.js: initializeUIHandlers import =",typeof V,V),console.log("[STnametracker] Main index.js: initializeMenuButtons import =",typeof te,te),console.log("[STnametracker] Main index.js: bindSettingsHandlers import =",typeof ae,ae),console.log("[STnametracker] Main index.js: updateUI import =",typeof oe,oe),"function"!=typeof N.WF&&(console.error("[STnametracker] Main index.js: CRITICAL ERROR - initializeLorebook import failed!"),console.error("[STnametracker] Main index.js: Expected function, got:",typeof N.WF,N.WF));const ie="STnametracker",se=`scripts/extensions/third-party/${ie}`;const ce=f.Ay.createModuleLogger("Main");const le=new class{constructor(){this.initialized=!1,this.modules=new Map}async initialize(){return console.log("[STnametracker] Enter initialize() method"),y.r_.withErrorBoundary("Main",async()=>{console.log("[STnametracker] Inside error boundary"),this.initialized?console.log("[STnametracker] Already initialized, skipping"):(console.log("[STnametracker] Starting initialization sequence"),ce.log("Starting Name Tracker Extension v2.1.0"),console.log("[STnametracker] Step 1: Initializing core systems..."),await this.initializeCore(),console.log("[STnametracker] Step 1: Core systems completed"),console.log("[STnametracker] Step 2: Initializing feature modules..."),await this.initializeModules(),console.log("[STnametracker] Step 2: Feature modules completed"),console.log("[STnametracker] Step 3: Initializing UI..."),await this.initializeUI(),console.log("[STnametracker] Step 3: UI completed"),console.log("[STnametracker] Step 4: Registering event listeners..."),this.registerEventListeners(),console.log("[STnametracker] Step 4: Event listeners completed"),this.initialized=!0,console.log("[STnametracker] Marking as initialized"),ce.log("Name Tracker Extension initialized successfully"),console.log("[STnametracker] Full initialization sequence completed successfully"))},{retries:2,fallback:async e=>(ce.error("Failed to initialize extension:",e),k.A.error("Failed to initialize","Extension Error"),!1)})}async initializeCore(){console.log("[STnametracker] initializeCore: Starting..."),ce.debug("Initializing core systems..."),console.log("[STnametracker] initializeCore: Connecting debug system..."),f.Ay.isDebugEnabled=()=>(0,b.TJ)("debugMode"),console.log("[STnametracker] initializeCore: Debug system connected"),console.log("[STnametracker] initializeCore: Initializing settings..."),await(0,b.Yq)(),console.log("[STnametracker] initializeCore: Settings initialized"),this.setupErrorRecovery(),ce.debug("Core systems initialized")}async initializeModules(){if(ce.debug("Initializing feature modules..."),console.log("[STnametracker] initializeModules: Starting module initialization"),console.log("[STnametracker] initializeModules: Checking import of initializeLorebook..."),console.log("[STnametracker] initializeModules: initializeLorebook =",typeof N.WF,N.WF),"function"!=typeof N.WF)throw console.error("[STnametracker] initializeModules: CRITICAL - initializeLorebook is not a function!"),console.error("[STnametracker] initializeModules: Type:",typeof N.WF),console.error("[STnametracker] initializeModules: Value:",N.WF),new Error("initializeLorebook is not a function: "+typeof N.WF);try{console.log("[STnametracker] initializeModules: About to call initializeLorebook()..."),await(0,N.WF)(),console.log("[STnametracker] initializeModules: initializeLorebook() completed successfully"),ce.debug("Feature modules initialized")}catch(e){throw console.error("[STnametracker] initializeModules: Error in initializeLorebook:",e),ce.error("Failed to initialize feature modules:",e),e}}async initializeUI(){console.log("[STnametracker] initializeUI: Starting UI initialization..."),ce.debug("Initializing UI...");try{console.log("[STnametracker] initializeUI: Loading settings HTML from:",`${se}/settings.html`);const e=await $.get(`${se}/settings.html`);console.log("[STnametracker] initializeUI: Settings HTML loaded, length:",e.length),console.log("[STnametracker] initializeUI: Finding #extensions_settings element...");const n=$("#extensions_settings");console.log("[STnametracker] initializeUI: Target element found:",n.length>0),n.append(e),console.log("[STnametracker] initializeUI: Settings HTML appended"),console.log("[STnametracker] initializeUI: Initializing UI handlers..."),V(),console.log("[STnametracker] initializeUI: UI handlers initialized"),console.log("[STnametracker] initializeUI: Initializing menu buttons..."),te(),console.log("[STnametracker] initializeUI: Menu buttons initialized"),console.log("[STnametracker] initializeUI: Binding settings handlers..."),ae(),console.log("[STnametracker] initializeUI: Settings handlers bound"),console.log("[STnametracker] initializeUI: Updating UI..."),oe(),console.log("[STnametracker] initializeUI: UI updated"),ce.debug("UI initialized")}catch(e){throw ce.error("Failed to initialize UI:",e),e}}registerEventListeners(){ce.debug("Registering event listeners...");try{const e=C.A.getContext(),n=e.eventSource,r=e.event_types;if(!n||!r)return void ce.warn("SillyTavern event system not available");n.on(r.MESSAGE_RECEIVED,async e=>{ce.debug("Message received event:",e),await X()}),n.on(r.MESSAGE_SENT,async e=>{ce.debug("Message sent event:",e),await X()}),n.on(r.CHAT_CHANGED,async()=>{ce.debug("Chat changed event received"),await(0,b.oS)()}),ce.debug("Event listeners registered")}catch(e){ce.error("Failed to register event listeners:",e)}}setupErrorRecovery(){y.r_.registerRecoveryStrategy("NETWORK_ERROR",async e=>(ce.warn("Attempting network error recovery"),await y.r_.delay(2e3),k.A.info("Retrying network operation..."),null)),y.r_.registerRecoveryStrategy("DATA_FORMAT_ERROR",async e=>(ce.warn("Data format error, clearing cache"),null)),y.r_.onCriticalError(e=>{ce.error("Critical error occurred:",e)})}getStatus(){return{initialized:this.initialized,context:C.A.getStatus(),settings:{initialized:!0,moduleCount:Object.keys((0,b.mt)()).length},debug:f.Ay.getPerformanceSummary(),errors:y.r_.getRecentErrors(5).length}}async shutdown(){return y.r_.withErrorBoundary("Main",async()=>{ce.log("Shutting down Name Tracker Extension"),this.initialized=!1,f.Ay.clear(),ce.log("Extension shutdown complete")},{silent:!0})}};jQuery(async()=>{console.log("[STnametracker] jQuery ready, starting extension load...");try{console.log("[STnametracker] Logger available, initializing..."),ce.log("Name Tracker Extension loading..."),console.log("[STnametracker] Setting up extension_settings..."),window.extension_settings||(console.log("[STnametracker] Creating window.extension_settings"),window.extension_settings={}),console.log("[STnametracker] Current extension_settings keys:",Object.keys(window.extension_settings)),window.extension_settings[ie]=window.extension_settings[ie]||{},console.log("[STnametracker] Extension settings initialized"),console.log("[STnametracker] Starting main initialization..."),await le.initialize(),console.log("[STnametracker] Main initialization completed"),window.nameTrackerExtension=le,window.ntDebug={status:()=>le.getStatus(),errors:()=>y.r_.getRecentErrors(),settings:()=>window.extension_settings?.[ie]||{},chatData:()=>({characters:(0,b.kO)("characters")||{},messageCounter:(0,b.kO)("messageCounter")||0,lastScannedMessageId:(0,b.kO)("lastScannedMessageId")||-1}),clear:()=>f.Ay.clear()},ce.log("Name Tracker Extension loaded successfully"),console.log("[STnametracker] Extension loaded. Use ntDebug.status() for diagnostics.")}catch(e){console.error("[STnametracker] Failed to initialize:",e),k.A.error("Extension failed to load","Critical Error")}})})();
//# sourceMappingURL=index.js.map