(()=>{"use strict";var e={56(e,t,n){e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},72(e){var t=[];function n(e){for(var n=-1,r=0;r<t.length;r++)if(t[r].identifier===e){n=r;break}return n}function r(e,r){for(var o={},i=[],s=0;s<e.length;s++){var c=e[s],l=r.base?c[0]+r.base:c[0],d=o[l]||0,g="".concat(l," ").concat(d);o[l]=d+1;var h=n(g),m={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==h)t[h].references++,t[h].updater(m);else{var u=a(m,r);r.byIndex=s,t.splice(s,0,{identifier:g,updater:u,references:1})}i.push(g)}return i}function a(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,a){var o=r(e=e||[],a=a||{});return function(e){e=e||[];for(var i=0;i<o.length;i++){var s=n(o[i]);t[s].references--}for(var c=r(e,a),l=0;l<o.length;l++){var d=n(o[l]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}o=c}}},83(e,t,n){n.d(t,{A:()=>s});var r=n(354),a=n.n(r),o=n(314),i=n.n(o)()(a());i.push([e.id,"/* Styles for the Name Tracker extension */\n\n.name-tracker-settings {\n    padding: 5px;\n}\n\n.name-tracker_block {\n    margin-bottom: 10px;\n}\n\n.name-tracker_block h4 {\n    margin-top: 10px;\n    margin-bottom: 10px;\n    font-weight: bold;\n}\n\n/* Status Display */\n.name-tracker-status-block {\n    background-color: var(--SmartThemeBlurTintColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    padding: 10px;\n}\n\n.name-tracker-status {\n    font-weight: bold;\n    color: var(--SmartThemeBodyColor);\n    padding: 5px;\n    text-align: center;\n}\n\n/* Character List */\n.name-tracker-character-list {\n    max-height: 400px;\n    overflow-y: auto;\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    padding: 5px;\n    margin-top: 5px;\n}\n\n.name-tracker-character {\n    padding: 10px;\n    margin-bottom: 10px;\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    background-color: var(--SmartThemeBlurTintColor);\n}\n\n.name-tracker-character:last-child {\n    margin-bottom: 0;\n}\n\n/* Active/loaded character styling (characters that are loaded in SillyTavern) */\n.name-tracker-character.main-character {\n    border-left: 3px solid #4CAF50;\n    background-color: rgba(76, 175, 80, 0.05);\n}\n\n.character-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 5px;\n}\n\n.character-name {\n    font-weight: bold;\n    font-size: 1.1em;\n    color: var(--SmartThemeBodyColor);\n}\n\n.character-name .fa-user {\n    color: #4CAF50;\n    margin-right: 5px;\n}\n\n.character-name.ignored {\n    color: var(--SmartThemeQuoteColor);\n    text-decoration: line-through;\n}\n\n.character-badge {\n    display: inline-block;\n    padding: 2px 8px;\n    border-radius: 3px;\n    font-size: 0.75em;\n    font-weight: bold;\n    margin-left: 5px;\n}\n\n.character-badge.main-char {\n    background-color: #4CAF50;\n    color: #fff;\n}\n\n.character-badge.ignored {\n    background-color: #666;\n    color: #fff;\n}\n\n.character-badge.unresolved {\n    background-color: #ff9800;\n    color: #000;\n}\n\n/* Lorebook entry editor modal */\n.lorebook-entry-editor h3 {\n    margin-top: 0;\n    margin-bottom: 20px;\n    color: var(--SmartThemeBodyColor);\n}\n\n.editor-section {\n    margin-bottom: 15px;\n}\n\n.editor-section label {\n    display: block;\n    font-weight: bold;\n    margin-bottom: 5px;\n    color: var(--SmartThemeBodyColor);\n}\n\n.editor-section small {\n    display: block;\n    margin-top: 3px;\n    color: var(--SmartThemeQuoteColor);\n    font-size: 0.85em;\n}\n\n.editor-section input,\n.editor-section textarea {\n    width: 100%;\n    box-sizing: border-box;\n}\n\n.character-aliases {\n    font-size: 0.9em;\n    color: var(--SmartThemeQuoteColor);\n    margin-bottom: 8px;\n    font-style: italic;\n}\n\n.lorebook-entry-id {\n    display: inline-block;\n    margin-left: 10px;\n    padding: 2px 6px;\n    background: var(--SmartThemeBlurTintColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 3px;\n    font-family: monospace;\n    font-size: 0.85em;\n    font-style: normal;\n    color: var(--SmartThemeQuoteColor);\n}\n\n.character-details {\n    font-size: 0.85em;\n    color: var(--SmartThemeBodyColor);\n    margin: 8px 0;\n    padding: 8px;\n    background: var(--SmartThemeBlurTintColor);\n    border-left: 2px solid var(--SmartThemeBorderColor);\n    border-radius: 3px;\n    line-height: 1.4;\n}\n\n.character-actions {\n    display: flex;\n    gap: 5px;\n    flex-wrap: wrap;\n    margin-top: 8px;\n}\n\n.character-actions .menu_button {\n    flex: 1;\n    min-width: 100px;\n    padding: 5px 10px;\n    font-size: 0.9em;\n}\n\n.menu_button.compact {\n    padding: 5px 10px;\n    font-size: 0.9em;\n}\n\n.name-tracker-empty {\n    color: var(--SmartThemeQuoteColor);\n    font-style: italic;\n    text-align: center;\n    padding: 20px;\n}\n\n/* Ollama Settings */\n.ollama-settings {\n    background-color: var(--SmartThemeBlurTintColor);\n    border-left: 3px solid var(--SmartThemeBorderColor);\n    padding: 10px;\n    margin-top: 5px;\n    border-radius: 5px;\n}\n\n/* Merge Dialog */\n.merge-dialog {\n    padding: 15px;\n}\n\n.merge-dialog p {\n    margin-bottom: 10px;\n}\n\n.merge-dialog strong {\n    color: var(--SmartThemeBodyColor);\n    font-weight: bold;\n}\n\n.merge-warning {\n    color: #ff9800;\n    font-size: 0.9em;\n    margin-top: 10px;\n    padding: 10px;\n    background-color: rgba(255, 152, 0, 0.1);\n    border-left: 3px solid #ff9800;\n    border-radius: 3px;\n}\n\n/* Button states */\nbutton:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n}\n\n/* Flex utilities */\n.flexGap5 {\n    gap: 5px;\n}\n\n.flex1 {\n    flex: 1;\n}\n\n/* Progress indicator */\n.name-tracker-progress {\n    margin: 10px 0;\n    padding: 10px;\n    background-color: var(--SmartThemeBlurTintColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 5px;\n    text-align: center;\n}\n\n.name-tracker-progress .progress-text {\n    margin-bottom: 5px;\n    font-weight: bold;\n}\n\n.name-tracker-progress .progress-bar {\n    width: 100%;\n    height: 20px;\n    background-color: var(--black50a);\n    border-radius: 10px;\n    overflow: hidden;\n}\n\n.name-tracker-progress .progress-fill {\n    height: 100%;\n    background-color: var(--SmartThemeQuoteColor);\n    transition: width 0.3s ease;\n}\n\n/* Character details preview (for potential future use) */\n.character-details {\n    display: none;\n    margin-top: 10px;\n    padding: 10px;\n    background-color: var(--black30a);\n    border-radius: 5px;\n    font-size: 0.9em;\n}\n\n.character-details.expanded {\n    display: block;\n}\n\n.character-details-section {\n    margin-bottom: 8px;\n}\n\n.character-details-section:last-child {\n    margin-bottom: 0;\n}\n\n.character-details-label {\n    font-weight: bold;\n    color: var(--SmartThemeQuoteColor);\n    margin-right: 5px;\n}\n\n/* Responsive adjustments */\n@media (max-width: 768px) {\n    .character-actions {\n        flex-direction: column;\n    }\n    \n    .character-actions .menu_button {\n        width: 100%;\n    }\n}\n\n/* Animation for new characters */\n@keyframes fadeIn {\n    from {\n        opacity: 0;\n        transform: translateY(-10px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.name-tracker-character.new {\n    animation: fadeIn 0.3s ease;\n}\n\n/* System Prompt Editor */\n.system-prompt-editor h3 {\n    margin-top: 0;\n    margin-bottom: 10px;\n    color: var(--SmartThemeBodyColor);\n}\n\n.system-prompt-editor p {\n    margin-bottom: 10px;\n    color: var(--SmartThemeQuoteColor);\n    font-size: 0.9em;\n}\n\n#system_prompt_editor {\n    background-color: var(--SmartThemeBlurTintColor);\n    color: var(--SmartThemeBodyColor);\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 3px;\n    padding: 10px;\n    resize: vertical;\n}\n\n#system_prompt_editor:focus {\n    outline: none;\n    border-color: var(--SmartThemeEmColor);\n}\n\n.system-prompt-actions button {\n    min-width: 100px;\n}\n\n#system_prompt_reset {\n    margin-right: auto;\n}\n\n\n","",{version:3,sources:["webpack://./style.css"],names:[],mappings:"AAAA,0CAA0C;;AAE1C;IACI,YAAY;AAChB;;AAEA;IACI,mBAAmB;AACvB;;AAEA;IACI,gBAAgB;IAChB,mBAAmB;IACnB,iBAAiB;AACrB;;AAEA,mBAAmB;AACnB;IACI,gDAAgD;IAChD,8CAA8C;IAC9C,kBAAkB;IAClB,aAAa;AACjB;;AAEA;IACI,iBAAiB;IACjB,iCAAiC;IACjC,YAAY;IACZ,kBAAkB;AACtB;;AAEA,mBAAmB;AACnB;IACI,iBAAiB;IACjB,gBAAgB;IAChB,8CAA8C;IAC9C,kBAAkB;IAClB,YAAY;IACZ,eAAe;AACnB;;AAEA;IACI,aAAa;IACb,mBAAmB;IACnB,8CAA8C;IAC9C,kBAAkB;IAClB,gDAAgD;AACpD;;AAEA;IACI,gBAAgB;AACpB;;AAEA,gFAAgF;AAChF;IACI,8BAA8B;IAC9B,yCAAyC;AAC7C;;AAEA;IACI,aAAa;IACb,8BAA8B;IAC9B,mBAAmB;IACnB,kBAAkB;AACtB;;AAEA;IACI,iBAAiB;IACjB,gBAAgB;IAChB,iCAAiC;AACrC;;AAEA;IACI,cAAc;IACd,iBAAiB;AACrB;;AAEA;IACI,kCAAkC;IAClC,6BAA6B;AACjC;;AAEA;IACI,qBAAqB;IACrB,gBAAgB;IAChB,kBAAkB;IAClB,iBAAiB;IACjB,iBAAiB;IACjB,gBAAgB;AACpB;;AAEA;IACI,yBAAyB;IACzB,WAAW;AACf;;AAEA;IACI,sBAAsB;IACtB,WAAW;AACf;;AAEA;IACI,yBAAyB;IACzB,WAAW;AACf;;AAEA,gCAAgC;AAChC;IACI,aAAa;IACb,mBAAmB;IACnB,iCAAiC;AACrC;;AAEA;IACI,mBAAmB;AACvB;;AAEA;IACI,cAAc;IACd,iBAAiB;IACjB,kBAAkB;IAClB,iCAAiC;AACrC;;AAEA;IACI,cAAc;IACd,eAAe;IACf,kCAAkC;IAClC,iBAAiB;AACrB;;AAEA;;IAEI,WAAW;IACX,sBAAsB;AAC1B;;AAEA;IACI,gBAAgB;IAChB,kCAAkC;IAClC,kBAAkB;IAClB,kBAAkB;AACtB;;AAEA;IACI,qBAAqB;IACrB,iBAAiB;IACjB,gBAAgB;IAChB,0CAA0C;IAC1C,8CAA8C;IAC9C,kBAAkB;IAClB,sBAAsB;IACtB,iBAAiB;IACjB,kBAAkB;IAClB,kCAAkC;AACtC;;AAEA;IACI,iBAAiB;IACjB,iCAAiC;IACjC,aAAa;IACb,YAAY;IACZ,0CAA0C;IAC1C,mDAAmD;IACnD,kBAAkB;IAClB,gBAAgB;AACpB;;AAEA;IACI,aAAa;IACb,QAAQ;IACR,eAAe;IACf,eAAe;AACnB;;AAEA;IACI,OAAO;IACP,gBAAgB;IAChB,iBAAiB;IACjB,gBAAgB;AACpB;;AAEA;IACI,iBAAiB;IACjB,gBAAgB;AACpB;;AAEA;IACI,kCAAkC;IAClC,kBAAkB;IAClB,kBAAkB;IAClB,aAAa;AACjB;;AAEA,oBAAoB;AACpB;IACI,gDAAgD;IAChD,mDAAmD;IACnD,aAAa;IACb,eAAe;IACf,kBAAkB;AACtB;;AAEA,iBAAiB;AACjB;IACI,aAAa;AACjB;;AAEA;IACI,mBAAmB;AACvB;;AAEA;IACI,iCAAiC;IACjC,iBAAiB;AACrB;;AAEA;IACI,cAAc;IACd,gBAAgB;IAChB,gBAAgB;IAChB,aAAa;IACb,wCAAwC;IACxC,8BAA8B;IAC9B,kBAAkB;AACtB;;AAEA,kBAAkB;AAClB;IACI,YAAY;IACZ,mBAAmB;AACvB;;AAEA,mBAAmB;AACnB;IACI,QAAQ;AACZ;;AAEA;IACI,OAAO;AACX;;AAEA,uBAAuB;AACvB;IACI,cAAc;IACd,aAAa;IACb,gDAAgD;IAChD,8CAA8C;IAC9C,kBAAkB;IAClB,kBAAkB;AACtB;;AAEA;IACI,kBAAkB;IAClB,iBAAiB;AACrB;;AAEA;IACI,WAAW;IACX,YAAY;IACZ,iCAAiC;IACjC,mBAAmB;IACnB,gBAAgB;AACpB;;AAEA;IACI,YAAY;IACZ,6CAA6C;IAC7C,2BAA2B;AAC/B;;AAEA,yDAAyD;AACzD;IACI,aAAa;IACb,gBAAgB;IAChB,aAAa;IACb,iCAAiC;IACjC,kBAAkB;IAClB,gBAAgB;AACpB;;AAEA;IACI,cAAc;AAClB;;AAEA;IACI,kBAAkB;AACtB;;AAEA;IACI,gBAAgB;AACpB;;AAEA;IACI,iBAAiB;IACjB,kCAAkC;IAClC,iBAAiB;AACrB;;AAEA,2BAA2B;AAC3B;IACI;QACI,sBAAsB;IAC1B;;IAEA;QACI,WAAW;IACf;AACJ;;AAEA,iCAAiC;AACjC;IACI;QACI,UAAU;QACV,4BAA4B;IAChC;IACA;QACI,UAAU;QACV,wBAAwB;IAC5B;AACJ;;AAEA;IACI,2BAA2B;AAC/B;;AAEA,yBAAyB;AACzB;IACI,aAAa;IACb,mBAAmB;IACnB,iCAAiC;AACrC;;AAEA;IACI,mBAAmB;IACnB,kCAAkC;IAClC,gBAAgB;AACpB;;AAEA;IACI,gDAAgD;IAChD,iCAAiC;IACjC,8CAA8C;IAC9C,kBAAkB;IAClB,aAAa;IACb,gBAAgB;AACpB;;AAEA;IACI,aAAa;IACb,sCAAsC;AAC1C;;AAEA;IACI,gBAAgB;AACpB;;AAEA;IACI,kBAAkB;AACtB",sourcesContent:["/* Styles for the Name Tracker extension */\r\n\r\n.name-tracker-settings {\r\n    padding: 5px;\r\n}\r\n\r\n.name-tracker_block {\r\n    margin-bottom: 10px;\r\n}\r\n\r\n.name-tracker_block h4 {\r\n    margin-top: 10px;\r\n    margin-bottom: 10px;\r\n    font-weight: bold;\r\n}\r\n\r\n/* Status Display */\r\n.name-tracker-status-block {\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    padding: 10px;\r\n}\r\n\r\n.name-tracker-status {\r\n    font-weight: bold;\r\n    color: var(--SmartThemeBodyColor);\r\n    padding: 5px;\r\n    text-align: center;\r\n}\r\n\r\n/* Character List */\r\n.name-tracker-character-list {\r\n    max-height: 400px;\r\n    overflow-y: auto;\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    padding: 5px;\r\n    margin-top: 5px;\r\n}\r\n\r\n.name-tracker-character {\r\n    padding: 10px;\r\n    margin-bottom: 10px;\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n}\r\n\r\n.name-tracker-character:last-child {\r\n    margin-bottom: 0;\r\n}\r\n\r\n/* Active/loaded character styling (characters that are loaded in SillyTavern) */\r\n.name-tracker-character.main-character {\r\n    border-left: 3px solid #4CAF50;\r\n    background-color: rgba(76, 175, 80, 0.05);\r\n}\r\n\r\n.character-header {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    margin-bottom: 5px;\r\n}\r\n\r\n.character-name {\r\n    font-weight: bold;\r\n    font-size: 1.1em;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.character-name .fa-user {\r\n    color: #4CAF50;\r\n    margin-right: 5px;\r\n}\r\n\r\n.character-name.ignored {\r\n    color: var(--SmartThemeQuoteColor);\r\n    text-decoration: line-through;\r\n}\r\n\r\n.character-badge {\r\n    display: inline-block;\r\n    padding: 2px 8px;\r\n    border-radius: 3px;\r\n    font-size: 0.75em;\r\n    font-weight: bold;\r\n    margin-left: 5px;\r\n}\r\n\r\n.character-badge.main-char {\r\n    background-color: #4CAF50;\r\n    color: #fff;\r\n}\r\n\r\n.character-badge.ignored {\r\n    background-color: #666;\r\n    color: #fff;\r\n}\r\n\r\n.character-badge.unresolved {\r\n    background-color: #ff9800;\r\n    color: #000;\r\n}\r\n\r\n/* Lorebook entry editor modal */\r\n.lorebook-entry-editor h3 {\r\n    margin-top: 0;\r\n    margin-bottom: 20px;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.editor-section {\r\n    margin-bottom: 15px;\r\n}\r\n\r\n.editor-section label {\r\n    display: block;\r\n    font-weight: bold;\r\n    margin-bottom: 5px;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.editor-section small {\r\n    display: block;\r\n    margin-top: 3px;\r\n    color: var(--SmartThemeQuoteColor);\r\n    font-size: 0.85em;\r\n}\r\n\r\n.editor-section input,\r\n.editor-section textarea {\r\n    width: 100%;\r\n    box-sizing: border-box;\r\n}\r\n\r\n.character-aliases {\r\n    font-size: 0.9em;\r\n    color: var(--SmartThemeQuoteColor);\r\n    margin-bottom: 8px;\r\n    font-style: italic;\r\n}\r\n\r\n.lorebook-entry-id {\r\n    display: inline-block;\r\n    margin-left: 10px;\r\n    padding: 2px 6px;\r\n    background: var(--SmartThemeBlurTintColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 3px;\r\n    font-family: monospace;\r\n    font-size: 0.85em;\r\n    font-style: normal;\r\n    color: var(--SmartThemeQuoteColor);\r\n}\r\n\r\n.character-details {\r\n    font-size: 0.85em;\r\n    color: var(--SmartThemeBodyColor);\r\n    margin: 8px 0;\r\n    padding: 8px;\r\n    background: var(--SmartThemeBlurTintColor);\r\n    border-left: 2px solid var(--SmartThemeBorderColor);\r\n    border-radius: 3px;\r\n    line-height: 1.4;\r\n}\r\n\r\n.character-actions {\r\n    display: flex;\r\n    gap: 5px;\r\n    flex-wrap: wrap;\r\n    margin-top: 8px;\r\n}\r\n\r\n.character-actions .menu_button {\r\n    flex: 1;\r\n    min-width: 100px;\r\n    padding: 5px 10px;\r\n    font-size: 0.9em;\r\n}\r\n\r\n.menu_button.compact {\r\n    padding: 5px 10px;\r\n    font-size: 0.9em;\r\n}\r\n\r\n.name-tracker-empty {\r\n    color: var(--SmartThemeQuoteColor);\r\n    font-style: italic;\r\n    text-align: center;\r\n    padding: 20px;\r\n}\r\n\r\n/* Ollama Settings */\r\n.ollama-settings {\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    border-left: 3px solid var(--SmartThemeBorderColor);\r\n    padding: 10px;\r\n    margin-top: 5px;\r\n    border-radius: 5px;\r\n}\r\n\r\n/* Merge Dialog */\r\n.merge-dialog {\r\n    padding: 15px;\r\n}\r\n\r\n.merge-dialog p {\r\n    margin-bottom: 10px;\r\n}\r\n\r\n.merge-dialog strong {\r\n    color: var(--SmartThemeBodyColor);\r\n    font-weight: bold;\r\n}\r\n\r\n.merge-warning {\r\n    color: #ff9800;\r\n    font-size: 0.9em;\r\n    margin-top: 10px;\r\n    padding: 10px;\r\n    background-color: rgba(255, 152, 0, 0.1);\r\n    border-left: 3px solid #ff9800;\r\n    border-radius: 3px;\r\n}\r\n\r\n/* Button states */\r\nbutton:disabled {\r\n    opacity: 0.5;\r\n    cursor: not-allowed;\r\n}\r\n\r\n/* Flex utilities */\r\n.flexGap5 {\r\n    gap: 5px;\r\n}\r\n\r\n.flex1 {\r\n    flex: 1;\r\n}\r\n\r\n/* Progress indicator */\r\n.name-tracker-progress {\r\n    margin: 10px 0;\r\n    padding: 10px;\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 5px;\r\n    text-align: center;\r\n}\r\n\r\n.name-tracker-progress .progress-text {\r\n    margin-bottom: 5px;\r\n    font-weight: bold;\r\n}\r\n\r\n.name-tracker-progress .progress-bar {\r\n    width: 100%;\r\n    height: 20px;\r\n    background-color: var(--black50a);\r\n    border-radius: 10px;\r\n    overflow: hidden;\r\n}\r\n\r\n.name-tracker-progress .progress-fill {\r\n    height: 100%;\r\n    background-color: var(--SmartThemeQuoteColor);\r\n    transition: width 0.3s ease;\r\n}\r\n\r\n/* Character details preview (for potential future use) */\r\n.character-details {\r\n    display: none;\r\n    margin-top: 10px;\r\n    padding: 10px;\r\n    background-color: var(--black30a);\r\n    border-radius: 5px;\r\n    font-size: 0.9em;\r\n}\r\n\r\n.character-details.expanded {\r\n    display: block;\r\n}\r\n\r\n.character-details-section {\r\n    margin-bottom: 8px;\r\n}\r\n\r\n.character-details-section:last-child {\r\n    margin-bottom: 0;\r\n}\r\n\r\n.character-details-label {\r\n    font-weight: bold;\r\n    color: var(--SmartThemeQuoteColor);\r\n    margin-right: 5px;\r\n}\r\n\r\n/* Responsive adjustments */\r\n@media (max-width: 768px) {\r\n    .character-actions {\r\n        flex-direction: column;\r\n    }\r\n    \r\n    .character-actions .menu_button {\r\n        width: 100%;\r\n    }\r\n}\r\n\r\n/* Animation for new characters */\r\n@keyframes fadeIn {\r\n    from {\r\n        opacity: 0;\r\n        transform: translateY(-10px);\r\n    }\r\n    to {\r\n        opacity: 1;\r\n        transform: translateY(0);\r\n    }\r\n}\r\n\r\n.name-tracker-character.new {\r\n    animation: fadeIn 0.3s ease;\r\n}\r\n\r\n/* System Prompt Editor */\r\n.system-prompt-editor h3 {\r\n    margin-top: 0;\r\n    margin-bottom: 10px;\r\n    color: var(--SmartThemeBodyColor);\r\n}\r\n\r\n.system-prompt-editor p {\r\n    margin-bottom: 10px;\r\n    color: var(--SmartThemeQuoteColor);\r\n    font-size: 0.9em;\r\n}\r\n\r\n#system_prompt_editor {\r\n    background-color: var(--SmartThemeBlurTintColor);\r\n    color: var(--SmartThemeBodyColor);\r\n    border: 1px solid var(--SmartThemeBorderColor);\r\n    border-radius: 3px;\r\n    padding: 10px;\r\n    resize: vertical;\r\n}\r\n\r\n#system_prompt_editor:focus {\r\n    outline: none;\r\n    border-color: var(--SmartThemeEmColor);\r\n}\r\n\r\n.system-prompt-actions button {\r\n    min-width: 100px;\r\n}\r\n\r\n#system_prompt_reset {\r\n    margin-right: auto;\r\n}\r\n\r\n\r\n"],sourceRoot:""}]);const s=i},102(e,t,n){n.d(t,{A:()=>s,r:()=>i});var r=n(806),a=n(462);const o=r.Ay.createModuleLogger("Context");const i=new class{constructor(){this._context=null,this._lastUpdate=0,this._updateInterval=1e3}getContext(){const e=Date.now();if(!this._context||e-this._lastUpdate>this._updateInterval)try{this._context=SillyTavern.getContext(),this._lastUpdate=e}catch(e){throw o.error("Failed to get SillyTavern context:",e),new Error("SillyTavern context not available")}return this._context}getChat(){return this.getContext().chat||[]}getChatMetadata(){return this.getContext().chatMetadata||{}}getChatId(){return this.getContext().chatId||null}getCharacterId(){return this.getContext().characterId}getCharacters(){return this.getContext().characters||[]}getUserName(){return this.getContext().name1||"User"}getExtensionSettings(){return this.getContext().extensionSettings||{}}async saveExtensionSettings(){return a.r_.withErrorBoundary("Context",async()=>{const e=this.getContext();e.saveSettingsDebounced?e.saveSettingsDebounced():o.warn("saveSettingsDebounced not available")},{silent:!0})}async saveChatMetadata(){return a.r_.withErrorBoundary("Context",async()=>{const e=this.getContext();e.saveMetadata?await e.saveMetadata():o.warn("saveMetadata not available")},{silent:!0})}async generateQuietPrompt(e){return a.r_.withErrorBoundary("Context",async()=>{const t=this.getContext();if(!t.generateQuietPrompt)throw new Error("generateQuietPrompt not available");return await t.generateQuietPrompt(e)},{retries:1})}async loadWorldInfo(e){return a.r_.withErrorBoundary("Context",async()=>{const t=this.getContext();if(!t.loadWorldInfo)throw new Error("loadWorldInfo not available");return await t.loadWorldInfo(e)})}async saveWorldInfo(e,t,n=!1){return a.r_.withErrorBoundary("Context",async()=>{const r=this.getContext();if(!r.saveWorldInfo)throw new Error("saveWorldInfo not available");return await r.saveWorldInfo(e,t,n)})}async saveWorldInfoEntry(e,t){return a.r_.withErrorBoundary("Context",async()=>{const n=this.getContext();if(!n.saveWorldInfoEntry)throw new Error("saveWorldInfoEntry not available");return await n.saveWorldInfoEntry(e,t)})}getEventSource(){return this.getContext().eventSource}getEventTypes(){return this.getContext().event_types}async callGenericPopup(e,t,n="",r={}){return a.r_.withErrorBoundary("Context",async()=>{const a=this.getContext();if(!a.callGenericPopup)throw new Error("callGenericPopup not available");return await a.callGenericPopup(e,t,n,r)})}isContextAvailable(){try{return!!this.getContext()}catch{return!1}}clearCache(){this._context=null,this._lastUpdate=0,o.debug("Cleared context cache")}getStatus(){return{available:this.isContextAvailable(),cached:!!this._context,lastUpdate:this._lastUpdate,chatId:this.getChatId(),characterId:this.getCharacterId()}}},s=i},113(e){e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},314(e){e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n="",r=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),r&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),r&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n}).join("")},t.i=function(e,n,r,a,o){"string"==typeof e&&(e=[[null,e,void 0]]);var i={};if(r)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(i[c]=!0)}for(var l=0;l<e.length;l++){var d=[].concat(e[l]);r&&i[d[0]]||(void 0!==o&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=o),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),a&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=a):d[4]="".concat(a)),t.push(d))}},t}},354(e){e.exports=function(e){var t=e[1],n=e[3];if(!n)return t;if("function"==typeof btoa){var r=btoa(unescape(encodeURIComponent(JSON.stringify(n)))),a="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(r),o="/*# ".concat(a," */");return[t].concat([o]).join("\n")}return[t].join("\n")}},462(e,t,n){n.d(t,{S_:()=>a,Xc:()=>i,r_:()=>o});const r=n(806).Ay.createModuleLogger("ErrorHandler");class a extends Error{constructor(e,t,n,r=!0){super(e),this.name="NameTrackerError",this.code=t,this.module=n,this.recoverable=r,this.timestamp=Date.now()}}const o=new class{constructor(){this.errorHistory=[],this.transactionStack=[],this.recoveryStrategies=new Map,this.criticalErrorCallbacks=[]}async withErrorBoundary(e,t,n={}){const{fallback:a=null,retries:o=0,silent:i=!1,operationId:s=null}=n;let c=null;const l=Date.now();s&&r.trace(s,`Starting operation in ${e}`);for(let n=0;n<=o;n++)try{const n=await t();return s&&r.trace(s,`Operation completed successfully in ${e}`),n}catch(t){if(console.log(`[STnametracker] Error caught in ${e}:`,t),c=t,n<o){console.log(`[STnametracker] Retrying operation in ${e}, attempt ${n+1}/${o+1}:`,t.message),r.warn(`Retrying operation in ${e}, attempt ${n+1}/${o+1}:`,t.message),await this.delay(100*Math.pow(2,n));continue}}console.log(`[STnametracker] All retries failed in ${e}, tracking error:`,c);const d=this.trackError(c,e,{operation:t.name||"anonymous",duration:Date.now()-l,retries:o,operationId:s});if(i||(console.log(`[STnametracker] Notifying user of error in ${e}`),this.notifyUser(d)),a)try{return r.debug(`Attempting fallback for ${e}:`,d.code),await a(d)}catch(t){r.error(`Fallback failed for ${e}:`,t)}const g=this.recoveryStrategies.get(d.code);if(g)try{return await g(d)}catch(e){r.error(`Recovery strategy failed for ${d.code}:`,e)}throw d}trackError(e,t,n={}){let o;if(e instanceof a)o=e;else{const n=this.categorizeError(e,t);o=new a(e.message,n,t,this.isRecoverable(e,n))}return o.context=n,this.errorHistory.push(o),this.errorHistory.length>100&&this.errorHistory.shift(),r.error(`Error in ${t}:`,{code:o.code,message:o.message,context:n}),o}categorizeError(e,t){return e.message.includes("fetch")||e.message.includes("network")?"NETWORK_ERROR":e.message.includes("JSON")||e.message.includes("parse")?"DATA_FORMAT_ERROR":e.message.includes("context")||e.message.includes("SillyTavern")?"CONTEXT_ERROR":"TypeError"===e.name?"TYPE_ERROR":"LLM"===t&&(e.message.includes("quota")||e.message.includes("rate"))?"API_LIMIT_ERROR":"UNKNOWN_ERROR"}isRecoverable(e,t){return!["CONTEXT_ERROR","TYPE_ERROR"].includes(t)}startTransaction(e,t){this.transactionStack.push({id:e,state:JSON.stringify(t),timestamp:Date.now()}),r.debug(`Started transaction: ${e}`)}commitTransaction(e){const t=this.transactionStack.findIndex(t=>t.id===e);-1!==t&&(this.transactionStack.splice(t,1),r.debug(`Committed transaction: ${e}`))}rollbackTransaction(e){const t=this.transactionStack.findIndex(t=>t.id===e);if(-1!==t){const n=this.transactionStack.splice(t,1)[0];return r.debug(`Rolled back transaction: ${e}`),JSON.parse(n.state)}return null}registerRecoveryStrategy(e,t){this.recoveryStrategies.set(e,t),r.debug(`Registered recovery strategy for: ${e}`)}onCriticalError(e){this.criticalErrorCallbacks.push(e)}notifyUser(e){const t=`Name Tracker: ${e.message}`;e.recoverable?toastr.warning(t,"Warning",{timeOut:5e3}):(toastr.error(t,"Error",{timeOut:8e3}),this.criticalErrorCallbacks.forEach(t=>{try{t(e)}catch(e){r.error("Critical error callback failed:",e)}}))}getRecentErrors(e=10){return this.errorHistory.slice(-e)}clearHistory(){this.errorHistory=[],r.debug("Cleared error history")}delay(e){return new Promise(t=>setTimeout(t,e))}},i=o.withErrorBoundary.bind(o)},540(e){e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},548(e,t,n){n.d(t,{A:()=>g,W:()=>d});var r=n(806),a=n(462),o=n(102);const i=r.Ay.createModuleLogger("Settings"),s="STnametracker",c=Object.freeze({enabled:!0,autoAnalyze:!0,messageFrequency:10,llmSource:"sillytavern",ollamaEndpoint:"http://localhost:11434",ollamaModel:"",confidenceThreshold:70,lorebookPosition:0,lorebookDepth:1,lorebookCooldown:5,lorebookScanDepth:1,lorebookProbability:100,lorebookEnabled:!0,debugMode:!1,systemPrompt:null}),l=Object.freeze({characters:{},messageCounter:0,lastHarvestMessage:0,lastScannedMessageId:-1});const d=new class{constructor(){this._settings=null,this._chatData=null,this._settingsCallbacks=[],this._chatCallbacks=[],this._saveTimeout=null,this._initialized=!1}async initialize(){return console.log("[STnametracker] SettingsManager.initialize: Starting..."),a.r_.withErrorBoundary("Settings",async()=>{console.log("[STnametracker] SettingsManager.initialize: Inside error boundary"),this._initialized?console.log("[STnametracker] SettingsManager.initialize: Already initialized"):(console.log("[STnametracker] SettingsManager.initialize: Initializing settings manager"),i.debug("Initializing settings manager"),console.log("[STnametracker] SettingsManager.initialize: Loading global settings..."),await this.loadSettings(),console.log("[STnametracker] SettingsManager.initialize: Global settings loaded"),console.log("[STnametracker] SettingsManager.initialize: Loading chat data..."),await this.loadChatData(),console.log("[STnametracker] SettingsManager.initialize: Chat data loaded"),this._initialized=!0,console.log("[STnametracker] SettingsManager.initialize: Marked as initialized"),i.debug("Settings manager initialized"))})}async loadSettings(){return a.r_.withErrorBoundary("Settings",async()=>{const e=o.A.getExtensionSettings();e[s]||(e[s]={}),this._settings={...c},Object.assign(this._settings,e[s]),e[s]=this._settings,i.debug("Loaded global settings:",Object.keys(this._settings)),this._settingsCallbacks.forEach(e=>{try{e(this._settings)}catch(e){i.error("Settings callback error:",e)}})})}async loadChatData(){return a.r_.withErrorBoundary("Settings",async()=>{const e=o.A.getChatMetadata();e[s]?(this._chatData={...l},Object.assign(this._chatData,e[s]),e[s]=this._chatData,i.debug("Loaded existing chat data:",Object.keys(this._chatData.characters))):(this._chatData={...l},e[s]=this._chatData,i.debug("Initialized new chat data")),this._chatCallbacks.forEach(e=>{try{e(this._chatData)}catch(e){i.error("Chat data callback error:",e)}})})}getSettings(){if(!this._initialized)throw new Error("Settings manager not initialized");return this._settings}getChatData(){if(!this._initialized)throw new Error("Settings manager not initialized");return this._chatData}async updateSetting(e,t){return a.r_.withErrorBoundary("Settings",async()=>{if(!this._initialized)throw new Error("Settings manager not initialized");if(!(e in c))throw new Error(`Unknown setting key: ${e}`);const n=this._settings[e];this._settings[e]=t,i.debug(`Updated setting ${e}: ${n} â†’ ${t}`),this._settingsCallbacks.forEach(r=>{try{r(this._settings,e,t,n)}catch(e){i.error("Settings callback error:",e)}}),await this.saveSettings()})}async updateChatData(e,t){return a.r_.withErrorBoundary("Settings",async()=>{if(!this._initialized)throw new Error("Settings manager not initialized");if(!(e in l))throw new Error(`Unknown chat data key: ${e}`);const n=this._chatData[e];this._chatData[e]=t,i.debug(`Updated chat data ${e}`),this._chatCallbacks.forEach(r=>{try{r(this._chatData,e,t,n)}catch(e){i.error("Chat data callback error:",e)}}),await this.saveChatData()})}getSetting(e,t=void 0){return this._initialized?this._settings[e]??t:t}async setSetting(e,t){return this.updateSetting(e,t)}async saveSettings(){this._saveTimeout&&clearTimeout(this._saveTimeout),this._saveTimeout=setTimeout(async()=>{await a.r_.withErrorBoundary("Settings",async()=>{await o.A.saveExtensionSettings(),i.debug("Saved global settings")},{silent:!0})},500)}async saveChatData(){return a.r_.withErrorBoundary("Settings",async()=>{await o.A.saveChatMetadata(),i.debug("Saved chat metadata")},{silent:!0})}onSettingsChange(e){this._settingsCallbacks.push(e)}onChatDataChange(e){this._chatCallbacks.push(e)}async onChatChanged(){return a.r_.withErrorBoundary("Settings",async()=>{i.debug("Chat changed, reloading chat data"),await this.loadChatData()})}isEnabled(){return this.getSetting("enabled",!1)}isDebugMode(){return this.getSetting("debugMode",!1)}getAutoAnalysisConfig(){return{enabled:this.getSetting("autoAnalyze",!1),frequency:this.getSetting("messageFrequency",10),lastScanned:this._chatData?.lastScannedMessageId??-1}}getLLMConfig(){return{source:this.getSetting("llmSource","sillytavern"),ollamaEndpoint:this.getSetting("ollamaEndpoint","http://localhost:11434"),ollamaModel:this.getSetting("ollamaModel",""),systemPrompt:this.getSetting("systemPrompt")}}getLorebookConfig(){return{position:this.getSetting("lorebookPosition",0),depth:this.getSetting("lorebookDepth",1),cooldown:this.getSetting("lorebookCooldown",5),scanDepth:this.getSetting("lorebookScanDepth",1),probability:this.getSetting("lorebookProbability",100),enabled:this.getSetting("lorebookEnabled",!0)}}async reset(){return a.r_.withErrorBoundary("Settings",async()=>{i.warn("Resetting settings to defaults"),Object.assign(this._settings,c),Object.assign(this._chatData,l),await this.saveSettings(),await this.saveChatData(),this._settingsCallbacks.forEach(e=>{try{e(this._settings)}catch(e){i.error("Settings callback error:",e)}}),this._chatCallbacks.forEach(e=>{try{e(this._chatData)}catch(e){i.error("Chat data callback error:",e)}})})}getCharacters(){return this._initialized&&this._chatData.characters||{}}getCharacter(e){return this._initialized&&this._chatData.characters[e]||null}async setCharacter(e,t){return a.r_.withErrorBoundary("Settings",async()=>{if(!this._initialized)throw new Error("Settings manager not initialized");this._chatData.characters[e]=t,i.debug(`Updated character: ${e}`),this._chatCallbacks.forEach(n=>{try{n(this._chatData,"character_updated",e,t)}catch(e){i.error("Chat data callback error:",e)}}),await this.saveChatData()})}async removeCharacter(e){return a.r_.withErrorBoundary("Settings",async()=>{if(!this._initialized)throw new Error("Settings manager not initialized");this._chatData.characters[e]&&(delete this._chatData.characters[e],i.debug(`Removed character: ${e}`),this._chatCallbacks.forEach(t=>{try{t(this._chatData,"character_removed",e)}catch(e){i.error("Chat data callback error:",e)}}),await this.saveChatData())})}async clearAllCharacters(){return a.r_.withErrorBoundary("Settings",async()=>{if(!this._initialized)throw new Error("Settings manager not initialized");const e=Object.keys(this._chatData.characters).length;this._chatData.characters={},i.debug(`Cleared all characters (${e} removed)`),this._chatCallbacks.forEach(e=>{try{e(this._chatData,"characters_cleared")}catch(e){i.error("Chat data callback error:",e)}}),await this.saveChatData()})}getStatus(){return{initialized:this._initialized,settingsLoaded:!!this._settings,chatDataLoaded:!!this._chatData,charactersCount:Object.keys(this._chatData?.characters||{}).length,callbacks:{settings:this._settingsCallbacks.length,chatData:this._chatCallbacks.length}}}},g=d},551(e,t,n){n.d(t,{OW:()=>p,_$:()=>g,eY:()=>d,el:()=>y,g9:()=>b,lF:()=>f,pp:()=>x,rL:()=>h,t9:()=>A,undoLastMerge:()=>C,vu:()=>k});var r=n(806),a=n(462),o=n(548),i=n(695);const s=(0,r.Xv)("characters"),c=new i.h("Character Management");let l=[];function d(e){return(0,a.Xc)("isIgnoredCharacter",()=>{const t=o.W.getCharacters();return Object.values(t).some(t=>t.ignored&&(t.preferredName===e||t.aliases.includes(e)))})}function g(e){return(0,a.Xc)("findExistingCharacter",()=>{const t=o.W.getCharacters();return Object.values(t).find(t=>t.preferredName===e||t.aliases.includes(e))||null})}async function h(e){return(0,a.Xc)("findPotentialMatch",async()=>{const t=o.W.getCharacters(),n=o.W.getSetting("confidenceThreshold",70);s.log();for(const r of Object.values(t)){if(m(e.name,r.preferredName)>=n)return s.log(),r;for(const t of r.aliases){if(m(e.name,t)>=n)return s.log(),r}}return null})}function m(e,t){return(0,a.Xc)("calculateNameSimilarity",()=>{if(e=e.toLowerCase(),t=t.toLowerCase(),e===t)return 100;if(e.includes(t)||t.includes(e))return 85;const n=e.split(/\s+/),r=t.split(/\s+/);return n.filter(e=>r.includes(e)).length>0?70:0})}function u(e,t){return(0,a.Xc)("cleanAliases",()=>{if(!e||!Array.isArray(e))return[];const n=["son","daughter","mother","father","mom","dad","parent","brother","sister","sibling","cousin","uncle","aunt","friend","boyfriend","girlfriend","husband","wife","spouse","boss","employee","coworker","colleague","partner","neighbor","roommate","child","kid","baby","man","woman","person","guy","girl","boy","user","{{user}}","char","{{char}}"],r=t.toLowerCase();return e.filter(e=>{if(!e||"string"!=typeof e)return!1;const t=e.trim().toLowerCase();return t!==r&&(!n.includes(t)&&!(t.length<2))}).map(e=>e.trim()).filter((e,t,n)=>n.indexOf(e)===t)})}async function p(e,t=!1){return(0,a.Xc)("createCharacter",async()=>{s.log();const n=u(e.aliases||[],e.name),r={preferredName:e.name,aliases:n,physicalAge:e.physicalAge||"",mentalAge:e.mentalAge||"",physical:e.physical||"",personality:e.personality||"",sexuality:e.sexuality||"",raceEthnicity:e.raceEthnicity||"",roleSkills:e.roleSkills||"",lastInteraction:e.lastInteraction||"",relationships:e.relationships||[],ignored:!1,confidence:e.confidence||50,lorebookEntryId:null,lastUpdated:Date.now(),isMainChar:t||!1};return s.log(),o.W.setCharacter(r.preferredName,r),s.log(),r})}async function A(e,t,n=!1,r=!1){return(0,a.Xc)("updateCharacter",async()=>{if(s.log(),r&&(e.isMainChar=!0),n&&t.name!==e.preferredName&&(e.aliases||(e.aliases=[]),e.aliases.includes(t.name)||t.name.toLowerCase()===e.preferredName.toLowerCase()||e.aliases.push(t.name)),e.aliases=u(e.aliases||[],e.preferredName),t.physicalAge&&(e.physicalAge=t.physicalAge),t.mentalAge&&(e.mentalAge=t.mentalAge),t.physical&&(e.physical=t.physical),t.personality&&(e.personality=t.personality),t.sexuality&&(e.sexuality=t.sexuality),t.raceEthnicity&&(e.raceEthnicity=t.raceEthnicity),t.roleSkills&&(e.roleSkills=t.roleSkills),t.lastInteraction&&(e.lastInteraction=t.lastInteraction),t.relationships&&Array.isArray(t.relationships)){e.relationships||(e.relationships=[]);for(const n of t.relationships)e.relationships.includes(n)||e.relationships.push(n)}return t.confidence&&(e.confidence=Math.round((e.confidence+t.confidence)/2)),e.lastUpdated=Date.now(),o.W.setCharacter(e.preferredName,e),s.log(),e})}async function f(e,t){return(0,a.Xc)("mergeCharacters",async()=>{const n=o.W.getCharacters(),r=n[e],i=n[t];if(!r||!i)throw new a.S_("One or both characters not found");const d={operation:"merge",timestamp:Date.now(),sourceName:e,targetName:t,sourceData:JSON.parse(JSON.stringify(r)),targetDataBefore:JSON.parse(JSON.stringify(i))};l.push(d),l.length>3&&l.shift();for(const e of r.aliases)i.aliases.includes(e)||i.aliases.push(e);r.preferredName===i.preferredName||i.aliases.includes(r.preferredName)||i.aliases.push(r.preferredName),r.physicalAge&&!i.physicalAge&&(i.physicalAge=r.physicalAge),r.mentalAge&&!i.mentalAge&&(i.mentalAge=r.mentalAge),r.physical&&!i.physical&&(i.physical=r.physical),r.personality&&!i.personality&&(i.personality=r.personality),r.sexuality&&!i.sexuality&&(i.sexuality=r.sexuality),r.raceEthnicity&&!i.raceEthnicity&&(i.raceEthnicity=r.raceEthnicity),r.roleSkills&&!i.roleSkills&&(i.roleSkills=r.roleSkills),r.lastInteraction&&!i.lastInteraction&&(i.lastInteraction=r.lastInteraction);for(const e of r.relationships)i.relationships.includes(e)||i.relationships.push(e);return i.lastUpdated=Date.now(),o.W.setCharacter(i.preferredName,i),o.W.removeCharacter(e),s.log(),c.success(`Merged ${e} into ${t}`),d})}async function C(){return(0,a.Xc)("undoLastMerge",async()=>{if(0===l.length)return c.warning("No merge operations to undo"),!1;const e=l.pop();return"merge"!==e.operation?(c.error("Last operation was not a merge"),!1):(o.W.setCharacter(e.sourceName,e.sourceData),o.W.setCharacter(e.targetName,e.targetDataBefore),s.log(),c.success("Merge undone successfully"),!0)})}function y(e){return(0,a.Xc)("toggleIgnoreCharacter",()=>{const t=o.W.getCharacter(e);if(!t)throw new a.S_("Character not found");t.ignored=!t.ignored,o.W.setCharacter(e,t);const n=t.ignored?"ignored":"unignored";return c.info(`${e} ${n}`),s.log(),t.ignored})}async function b(e){return(0,a.Xc)("createNewCharacter",async()=>{if(!e||!e.trim())throw new a.S_("Character name is required");const t=e.trim();if(o.W.getCharacter(t))throw new a.S_(`Character "${t}" already exists`);const n={name:t,aliases:[],physicalAge:"",mentalAge:"",physical:"",personality:"",sexuality:"",raceEthnicity:"",roleSkills:"",lastInteraction:"",relationships:[],confidence:100},r=await p(n,!1);return s.log(),c.success(`Created character: ${t}`),r})}async function k(){return(0,a.Xc)("purgeAllCharacters",async()=>{const e=o.W.getCharacters(),t=Object.keys(e).length;return 0===t?(c.info("No characters to purge"),0):(o.W.clearAllCharacters(),l=[],s.log(),c.success(`Purged ${t} characters`),t)})}function x(e){return(0,a.Xc)("hasUnresolvedRelationships",()=>{if(!e.relationships||0===e.relationships.length)return!1;const t=o.W.getCharacters(),n=Object.values(t).reduce((e,t)=>(e.add(t.preferredName.toLowerCase()),t.aliases.forEach(t=>e.add(t.toLowerCase())),e),new Set);return e.relationships.some(e=>e.toLowerCase().split(/\s+/).some(e=>e.length>2&&!n.has(e)))})}},659(e){var t={};e.exports=function(e,n){var r=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(n)}},695(e,t,n){n.d(t,{A:()=>i,h:()=>a});const r=n(806).Ay.createModuleLogger("Notifications");class a{constructor(){this.defaultOptions={timeOut:5e3,extendedTimeOut:2e3,closeButton:!0,progressBar:!0,preventDuplicates:!0},this.prefix="Name Tracker: "}success(e,t="Success",n={}){const a={...this.defaultOptions,...n};toastr.success(this.prefix+e,t,a),r.debug("Success notification:",e)}info(e,t="Info",n={}){const a={...this.defaultOptions,...n};toastr.info(this.prefix+e,t,a),r.debug("Info notification:",e)}warning(e,t="Warning",n={}){const a={...this.defaultOptions,timeOut:8e3,...n};toastr.warning(this.prefix+e,t,a),r.debug("Warning notification:",e)}error(e,t="Error",n={}){const a={...this.defaultOptions,timeOut:1e4,extendedTimeOut:5e3,...n};toastr.error(this.prefix+e,t,a),r.error("Error notification:",e)}persistent(e,t="Notice",n="info"){const a={...this.defaultOptions,timeOut:0,extendedTimeOut:0};switch(n){case"success":toastr.success(this.prefix+e,t,a);break;case"warning":toastr.warning(this.prefix+e,t,a);break;case"error":toastr.error(this.prefix+e,t,a);break;default:toastr.info(this.prefix+e,t,a)}r.debug("Persistent notification:",e)}progress(e,t=0,n=null){const a=n||`progress_${Date.now()}`,o=`\n            <div style="margin-bottom: 8px;">${this.prefix}${e}</div>\n            <div style="background: #333; border-radius: 3px; overflow: hidden;">\n                <div style="background: #007acc; height: 6px; width: ${t}%; transition: width 0.3s ease;"></div>\n            </div>\n            <div style="text-align: center; font-size: 11px; margin-top: 4px;">${t}%</div>\n        `,i={timeOut:0,extendedTimeOut:0,closeButton:!1,progressBar:!1,preventDuplicates:!1,toastId:a};return toastr.remove(),toastr.info(o,"",i),r.debug("Progress notification:",e,`${t}%`),a}clear(){toastr.clear(),r.debug("Cleared all notifications")}confirm(e,t,n=null,a="Confirm"){const o=`confirm_${Date.now()}`,i=`\n            <div style="margin-bottom: 12px;">${e}</div>\n            <div style="text-align: right;">\n                <button class="btn btn-sm btn-secondary me-2" onclick="nameTrackerNotifications.handleConfirmCancel('${o}')">Cancel</button>\n                <button class="btn btn-sm btn-primary" onclick="nameTrackerNotifications.handleConfirmOk('${o}')">Confirm</button>\n            </div>\n        `;window.nameTrackerNotifications=window.nameTrackerNotifications||{},window.nameTrackerNotifications.confirmCallbacks=window.nameTrackerNotifications.confirmCallbacks||{},window.nameTrackerNotifications.confirmCallbacks[o]={onConfirm:t,onCancel:n},window.nameTrackerNotifications.handleConfirmOk=e=>{const t=window.nameTrackerNotifications.confirmCallbacks[e];t&&t.onConfirm&&t.onConfirm(),delete window.nameTrackerNotifications.confirmCallbacks[e],toastr.clear()},window.nameTrackerNotifications.handleConfirmCancel=e=>{const t=window.nameTrackerNotifications.confirmCallbacks[e];t&&t.onCancel&&t.onCancel(),delete window.nameTrackerNotifications.confirmCallbacks[e],toastr.clear()};const s={timeOut:0,extendedTimeOut:0,closeButton:!1,progressBar:!1,preventDuplicates:!1,toastId:o};return toastr.info(i,this.prefix+a,s),r.debug("Confirmation notification:",e),o}getStatus(){return{defaultOptions:this.defaultOptions,prefix:this.prefix,activeConfirms:Object.keys(window.nameTrackerNotifications?.confirmCallbacks||{}).length}}}const o=new a;r.debug("Notifications module loaded");const i=o},806(e,t,n){n.d(t,{Ay:()=>o,Xv:()=>a});const r=new class{constructor(){this.modules=new Map,this.performanceMarks=new Map,this.operationTraces=new Map}createModuleLogger(e){if(this.modules.has(e))return this.modules.get(e);const t={log:(...t)=>this.log(e,"log",...t),warn:(...t)=>this.log(e,"warn",...t),error:(...t)=>this.log(e,"error",...t),debug:(...t)=>this.log(e,"debug",...t),trace:(t,n)=>this.addTrace(e,t,n),startTimer:t=>this.startTimer(e,t),endTimer:t=>this.endTimer(e,t)};return this.modules.set(e,t),t}log(e,t,...n){if(!this.isDebugEnabled())return;const r=`[STnametracker:${e}] ${(new Date).toLocaleTimeString()}`;switch(t){case"error":console.error(r,...n);break;case"warn":console.warn(r,...n);break;case"debug":console.debug(r,...n);break;default:console.log(r,...n)}}addTrace(e,t,n){this.isDebugEnabled()&&(this.operationTraces.has(t)||this.operationTraces.set(t,[]),this.operationTraces.get(t).push({module:e,timestamp:Date.now(),message:n}))}getTrace(e){return this.operationTraces.get(e)||[]}startTimer(e,t){const n=`${e}:${t}`;this.performanceMarks.set(n,performance.now())}endTimer(e,t){const n=`${e}:${t}`,r=this.performanceMarks.get(n);if(void 0===r)return this.log(e,"warn",`Timer '${t}' was not started`),0;const a=performance.now()-r;return this.performanceMarks.delete(n),this.log(e,"debug",`Timer '${t}': ${a.toFixed(2)}ms`),a}isDebugEnabled(){return!0}clear(){this.operationTraces.clear(),this.performanceMarks.clear()}getPerformanceSummary(){return{activeTimers:this.performanceMarks.size,activeTraces:this.operationTraces.size,modules:Array.from(this.modules.keys())}}};function a(e){return r.createModuleLogger(e)}const o=r},825(e){e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var r="";n.supports&&(r+="@supports (".concat(n.supports,") {")),n.media&&(r+="@media ".concat(n.media," {"));var a=void 0!==n.layer;a&&(r+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),r+=n.css,a&&(r+="}"),n.media&&(r+="}"),n.supports&&(r+="}");var o=n.sourceMap;o&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),t.styleTagTransform(r,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}},t={};function n(r){var a=t[r];if(void 0!==a)return a.exports;var o=t[r]={id:r,exports:{}};return e[r](o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0;var r=n(72),a=n.n(r),o=n(825),i=n.n(o),s=n(659),c=n.n(s),l=n(56),d=n.n(l),g=n(540),h=n.n(g),m=n(113),u=n.n(m),p=n(83),A={};A.styleTagTransform=u(),A.setAttributes=d(),A.insert=c().bind(null,"head"),A.domAPI=i(),A.insertStyleElement=h();a()(p.A,A);p.A&&p.A.locals&&p.A.locals;var f=n(806),C=n(462),y=n(102),b=n(548),k=n(695);function x(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return t.toString(36)}function v(e){if("string"!=typeof e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function w(){return Date.now().toString(36)+Math.random().toString(36).substr(2,9)}f.Ay.createModuleLogger("Utils").debug("Utils module loaded");var S=n(551);const B=(0,f.Xv)("llm"),I=new k.h("LLM Integration"),_=new Map;let T=[];async function E(e){return(0,C.Xc)("getOllamaModelContext",async()=>{const t=b.W.getSetting("ollamaEndpoint","http://localhost:11434");if(!e)return B.log(),4096;try{const n=await fetch(`${t}/api/show`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!n.ok)throw new Error(`Failed to fetch model info: ${n.statusText}`);const r=await n.json();if(r.parameters&&Array.isArray(r.parameters))for(const e of r.parameters){const t=e.match(/num_ctx\\s+(\\d+)/);if(t){const e=parseInt(t[1]);return B.log(),e}}if(r.model_info&&r.model_info.num_ctx){const e=parseInt(r.model_info.num_ctx);return B.log(),e}return B.log(),4096}catch(e){return console.error("Error fetching Ollama model context:",e),B.log(),4096}})}function z(){return(0,C.Xc)("buildCharacterRoster",()=>{const e=b.W.getCharacters(),t=Object.keys(e);if(0===t.length)return"";return`\\n\\n[KNOWN CHARACTERS]\\nThe following characters have already been identified. If you encounter them again, use the same name and add any new details:\\n${t.map(t=>{const n=e[t];return`  - ${t}${n.aliases&&n.aliases.length>0?` (also known as: ${n.aliases.join(", ")})`:""}${n.relationships&&n.relationships.length>0?`\\n    Relationships: ${n.relationships.join("; ")}`:""}`}).join("\\n")}\\n`})}async function O(){return(0,C.Xc)("getMaxPromptLength",async()=>{const e=b.W.getLLMConfig();let t=4096;if("ollama"===e.source&&e.ollamaModel)t=await E(e.ollamaModel);else{t=y.r.getContext().maxContext||4096}const n=Math.floor(.5*t);return B.log(),Math.max(1e3,Math.min(n,25e3))})}async function M(e){return(0,C.Xc)("calculateMessageTokens",async()=>{const t=y.r.getContext();let n=0;for(const r of e)if(r&&"object"==typeof r&&r.extra&&"number"==typeof r.extra.token_count)n+=r.extra.token_count;else{const e=r?.mes||r?.message||String(r);if(e&&t.getTokenCountAsync)try{n+=await t.getTokenCountAsync(e)}catch(t){B.log(),n+=Math.ceil(e.length/4)}else n+=Math.ceil(e.length/4)}return n})}function N(e){return(0,C.Xc)("parseJSONResponse",()=>{if(!e||"string"!=typeof e)throw console.error("Invalid response text:",e),new C.S_("LLM returned empty or invalid response");const t=(e=e.trim()).match(/```(?:json)?\\s*([\\s\\S]*?)```/);t&&(e=t[1].trim());const n=e.indexOf("{"),r=e.lastIndexOf("}");-1!==n&&-1!==r&&r>n&&(e=e.substring(n,r+1)),e=(e=e.replace(/^(?:Here's the analysis:|Here is the JSON:|Result:|Output:)\\s*/i,"")).trim();try{const t=JSON.parse(e);return t.characters&&Array.isArray(t.characters)?t:(console.warn("Response missing characters array, returning empty:",t),{characters:[]})}catch(t){if(console.error("Failed to parse JSON response. Original text:",e),console.error("Parse error:",t.message),e.includes('"characters"')&&!e.trim().endsWith("}")){B.log(),B.log();let t=e;const n=(e.match(/\{/g)||[]).length,r=(e.match(/\}/g)||[]).length,a=(e.match(/\[/g)||[]).length,o=(e.match(/\]/g)||[]).length;t.match(/"[^"]*$/)&&(t+='"');for(let e=0;e<a-o;e++)t+="]";for(let e=0;e<n-r;e++)t+="}";try{const e=JSON.parse(t);return B.log(),e}catch(e){B.log()}}const n=e.match(/\\{[\\s\\S]*"characters"[\\s\\S]*\\}/);if(n)try{return JSON.parse(n[0])}catch(e){B.log()}throw new C.S_("Failed to parse LLM response as JSON. The response may be too long or truncated. Try analyzing fewer messages at once.")}})}async function D(e,t="",n=0,r=0){return(0,C.Xc)("callLLMAnalysis",async()=>{const a=b.W.getLLMConfig(),o=await O();B.log();const i=e.map(e=>"string"==typeof e?e:e.mes?e.mes:e.message?e.message:JSON.stringify(e)),s=x(i.join("\\n")+a.source+a.ollamaModel);if(_.has(s))return B.log(),_.get(s);const c=i.map((e,t)=>`Message ${t+1}:\\n${e}`).join("\\n\\n"),l=`${`[SYSTEM INSTRUCTION - DO NOT ROLEPLAY]\\n${b.W.getSetting("systemPrompt")||'You are a character analysis assistant. Your task is to extract character information from chat messages and return it in a structured JSON format.\n\nCRITICAL: You MUST respond with ONLY valid JSON. Do not include any explanatory text, markdown formatting, or commentary. Just the raw JSON object.\n\nIMPORTANT PROCESSING RULES:\n1. Process messages in CHRONOLOGICAL ORDER (oldest to newest)\n2. When there is conflicting information about a character, ALWAYS use the MOST RECENT information\n3. Be smart about name variations - "Alex" and "Alexandra" may be the same person\n4. Track physical attributes, personality traits, relationships, and interactions with {{user}}\n5. Don\'t create entries for generic references like "the bartender" unless given specific names\n\nRequired JSON structure:\n{\n  "characters": [\n    {\n      "name": "Character\'s primary/preferred name",\n      "aliases": ["Alternative names", "Nicknames"],\n      "physicalAge": "Age or age range",\n      "mentalAge": "Mental/emotional age if different",\n      "physical": "Physical description and appearance",\n      "personality": "Personality traits and behavior", \n      "sexuality": "Sexual orientation or preferences",\n      "raceEthnicity": "Race/ethnicity information",\n      "roleSkills": "Job, role, skills, abilities",\n      "lastInteraction": "Most recent interaction or scene with {{user}}",\n      "relationships": ["Relationship with other characters"],\n      "confidence": 85\n    }\n  ]\n}\n\nConfidence scores (0-100):\n- 90-100: Character explicitly named with detailed info\n- 70-89: Character clearly identified with some details\n- 50-69: Character mentioned but limited info\n- Below 50: Uncertain or vague reference\n\nFocus on major speaking characters and those with significant interactions. Avoid analyzing every minor mention.'}${t}\\n\\n[DATA TO ANALYZE]`}\\n${c}\\n\\n[RESPOND WITH JSON ONLY - NO STORY CONTINUATION]`;let d,g;try{d=await M([{mes:l}]),B.log()}catch(e){B.log(),d=Math.ceil(l.length/4)}if(d>o&&e.length>1){"  ".repeat(n);B.log();const r=Math.floor(e.length/2),a=e.slice(0,r),o=e.slice(r);B.log();const[i,s]=await Promise.all([D(a,t,n+1),D(o,t,n+1)]),c={characters:[...i.characters||[],...s.characters||[]]};return B.log(),c}try{g="ollama"===a.source?await async function(e){return(0,C.Xc)("callOllama",async()=>{const t=b.W.getLLMConfig();if(!t.ollamaModel)throw new C.S_("No Ollama model selected");B.log();const n=await E(t.ollamaModel),r=Math.floor(.25*n),a=Math.max(4e3,r);B.log();const o=await fetch(`${t.ollamaEndpoint}/api/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t.ollamaModel,prompt:e,stream:!1,format:"json",options:{temperature:.3,top_p:.9,top_k:40,repeat_penalty:1.1,num_predict:a}})});if(!o.ok)throw new C.S_(`Ollama API error: ${o.statusText}`);const i=await o.json();return B.log(),B.log(),N(i.response)})}(l):await async function(e){return(0,C.Xc)("callSillyTavern",async()=>{B.log();const t=y.r.getContext();if(!t.onlineStatus)throw new C.S_("No API connection available. Please connect to an API first.");let n;try{n=await t.getTokenCountAsync(e),B.log()}catch(t){B.log(),n=Math.ceil(e.length/4),B.log()}const r=t.maxContext||4096,a=Math.floor(.25*r),o=Math.max(4e3,a);B.log();const i=await t.generateRaw({prompt:e,systemPrompt:"",prefill:"",temperature:.3,top_p:.9,top_k:40,min_p:.05,rep_pen:1.1,max_tokens:o,stop:[]});if(B.log(),!i)throw new C.S_("Empty response from SillyTavern LLM");return N(i)})}(l)}catch(a){if(r<3&&(a.message.includes("JSON")||a.message.includes("empty")||a.message.includes("truncated"))){B.log();const a=1e3*Math.pow(2,r);return await new Promise(e=>setTimeout(e,a)),await D(e,t,n,r+1)}throw a}if(_.size>50){const e=_.keys().next().value;_.delete(e)}return _.set(s,g),B.log(),g})}let W;console.log("[LOREBOOK] Starting module load..."),console.log("[LOREBOOK] Imports completed. Types:"),console.log("[LOREBOOK] createModuleLogger:",typeof f.Xv),console.log("[LOREBOOK] withErrorBoundary:",typeof C.Xc),console.log("[LOREBOOK] NameTrackerError:",typeof C.S_);try{console.log("[LOREBOOK] About to call createModuleLogger..."),W=(0,f.Xv)("lorebook"),console.log("[LOREBOOK] Debug logger created successfully:",W)}catch(e){console.error("[LOREBOOK] Failed to create debug logger:",e),console.error("[LOREBOOK] Error stack:",e.stack),W={log:console.log.bind(console,"[LOREBOOK]"),error:console.error.bind(console,"[LOREBOOK]"),warn:console.warn.bind(console,"[LOREBOOK]"),debug:console.debug.bind(console,"[LOREBOOK]")}}const L=new k.h("Lorebook Management");let R=null;async function j(){return(0,C.Xc)("initializeLorebook",async()=>{const e=y.r.getContext();if(!e.chatId)return W.log("No active chat, skipping lorebook initialization"),R=null,null;const t="world_info",n=e.chatMetadata;if(!n)return W.log("No chat metadata available, skipping lorebook initialization"),R=null,null;if(n[t])return R=n[t],W.log(`Using existing chat lorebook: ${R}`),R;const r=`NameTracker_${e.chatId}`.replace(/[^a-z0-9 -]/gi,"_").replace(/_{2,}/g,"_").substring(0,64);W.log(`Creating new chat lorebook: ${r}`),R=r,n[t]=R;try{await e.saveMetadata(),W.log(`Bound lorebook to chat: ${R}`);await e.loadWorldInfo(R)||(W.log(),await e.saveWorldInfo(R,{entries:{}},!0)),L.info(`Chat lorebook "${R}" created and bound to this chat`,{timeOut:5e3})}catch(e){throw console.error("Failed to initialize lorebook:",e),R=null,new C.S_(`Failed to initialize lorebook: ${e.message}`)}return R})}async function P(e,t){return(0,C.Xc)("updateLorebookEntry",async()=>{if(W.log(`updateLorebookEntry called for: ${t}`),W.log("  Character data:",e),!R)return void W.log("No lorebook initialized, skipping entry update");const n=y.r.getContext(),r=b.W.getLorebookConfig(),a=[];if(e.physicalAge||e.mentalAge){const t=[];e.physicalAge&&t.push(`Physical: ${e.physicalAge}`),e.mentalAge&&t.push(`Mental: ${e.mentalAge}`),a.push(`**Age:** ${t.join(", ")}`)}e.physical&&a.push(`\\n**Physical Description:**\\n${e.physical}`),e.personality&&a.push(`\\n**Personality:**\\n${e.personality}`),e.sexuality&&a.push(`\\n**Sexuality:**\\n${e.sexuality}`),e.raceEthnicity&&a.push(`**Race/Ethnicity:** ${e.raceEthnicity}`),e.roleSkills&&a.push(`\\n**Role & Skills:**\\n${e.roleSkills}`),e.lastInteraction&&a.push(`\\n**Last Interaction with {{user}}:**\\n${e.lastInteraction}`),e.relationships&&e.relationships.length>0&&(a.push("\\n**Relationships:**"),e.relationships.forEach(e=>{a.push(`- ${e}`)}));const o=a.join("\\n"),i=[e.preferredName];e.aliases&&i.push(...e.aliases);let s=await n.loadWorldInfo(R);s||(W.log(),s={entries:{}});const c=b.W.getSetting("messageFrequency",10),l=Math.max(1,Math.floor(.75*c));let d=null;if(e.lorebookEntryId&&s.entries&&s.entries[e.lorebookEntryId]){d=e.lorebookEntryId;const t=s.entries[d];t.key=i,t.content=o,t.enabled=r.enabled,t.position=r.position,t.probability=r.probability,t.depth=r.depth,t.scanDepth=r.scanDepth,t.cooldown=l,W.log()}else{const t=w(),n={uid:t,key:i,keysecondary:[],comment:`Auto-generated entry for ${e.preferredName}`,content:o,constant:!1,selective:!0,contextConfig:{prefix:"",suffix:"",tokenBudget:0,reservedTokens:0,budgetPriority:400,trimDirection:"doNotTrim",insertionOrder:0,maximumTrimType:"sentence",insertionPosition:"before"},enabled:r.enabled,position:r.position,excludeRecursion:!1,preventRecursion:!1,delayUntilRecursion:!1,probability:r.probability,useProbability:!0,depth:r.depth,selectiveLogic:0,group:"",scanDepth:r.scanDepth,caseSensitive:null,matchWholeWords:null,useGroupScoring:null,automationId:"",role:0,vectorized:!1,sticky:0,cooldown:l,delay:0};s.entries[t]=n,e.lorebookEntryId=t,W.log()}try{await n.saveWorldInfo(R,s,!0);const t=await n.loadWorldInfo(R),r=d||e.lorebookEntryId;t&&t.entries&&t.entries[r]?W.log():console.error("[Name Tracker] WARNING: Lorebook verification failed - entries may not have been saved!"),W.log()}catch(e){throw console.error("[Name Tracker] Error saving lorebook:",e),W.log(),e}})}const U=(0,f.Xv)("processing"),X=new k.h("Message Processing");let F=null,Q=!1,Y=!1;async function J(e){return(0,C.Xc)("processAnalysisResults",async()=>{if(e&&Array.isArray(e)){U.log();for(const t of e)try{await H(t)}catch(e){console.error(`Error processing character ${t.name}:`,e)}}else U.log()})}async function H(e){return(0,C.Xc)("processCharacterData",async()=>{if(!e.name||""===e.name.trim())return void U.log();const t=e.name.trim();if((0,S.eY)(t))return void U.log();const n=t.toLowerCase().includes("{{char}}")||!0===e.isMainCharacter||"main"===e.role,r=(0,S._$)(t);if(r)await(0,S.t9)(r,e,!1,n),await P(r,r.preferredName),U.log();else{const t=await(0,S.rL)(e);if(t)await(0,S.t9)(t,e,!0,n),await P(t,t.preferredName),U.log();else{const t=await(0,S.OW)(e,n);await P(t,t.preferredName),U.log()}}})}async function q(e,t=!0){return(0,C.Xc)("harvestMessages",async()=>{if(!b.W.getSetting("enabled",!0))return void U.log();if("sillytavern"===b.W.getLLMConfig().source){if(!y.r.getContext().onlineStatus)return void X.warning("Please connect to an API (OpenAI, Claude, etc.) before analyzing messages")}const n=y.r.getContext();if(!n.chat||0===n.chat.length)return U.log(),void X.info("No messages in chat to analyze");const r=n.chat.length,a=Math.max(0,r-e),o=n.chat.slice(a,r),i=await O()-1e3;if(await M(o)>i){U.log();const e=[];let n=[],r=0;for(const t of o){const a=await M([t]);r+a>i&&n.length>0?(e.push(n),n=[t],r=a):(n.push(t),r+=a)}n.length>0&&e.push(n),t&&X.info(`Splitting into ${e.length} batches to fit context window`),Y=!1,G(0,e.length,"Starting analysis...");let s=0,c=0;const l=new Set;for(let t=0;t<e.length;t++){if(Y)return U.log(),K(),void X.warning("Analysis aborted");const n=e[t],r=a+e.slice(0,t).reduce((e,t)=>e+t.length,0),o=r+n.length;try{G(t+1,e.length,`Analyzing messages ${r+1}-${o}...`);const a=z(),i=await D(n,a);i.characters&&Array.isArray(i.characters)&&(await J(i.characters),i.characters.forEach(e=>l.add(e.name))),s++,t<e.length-1&&await new Promise(e=>setTimeout(e,500))}catch(e){console.error(`Error processing batch ${t+1}:`,e),c++;if(!confirm(`Batch ${t+1} failed.\\n\\nError: ${e.message}\\n\\nContinue with remaining batches?`))break}}K();const d=`Analysis complete!\\n\\nBatches processed: ${s}/${e.length}\\nUnique characters found: ${l.size}\\nFailed batches: ${c}`;return void(c>0?X.warning(d,{timeOut:8e3}):X.success(d,{timeOut:8e3}))}t&&X.info(`Analyzing ${o.length} messages for character information...`);try{const e=z(),n=await D(o,e);U.log(),n.characters&&Array.isArray(n.characters)?(await J(n.characters),t&&X.success(`Found ${n.characters.length} character(s) in messages`)):U.log()}catch(e){console.error("Error during harvest:",e),X.error(`Analysis failed: ${e.message}`)}})}function G(e,t,n=""){const r="name_tracker_progress",a=$(`.${r}`);if(a.length>0)return n&&a.find(".title").text(n),a.find(".progress").text(e),a.find(".total").text(t),void a.find("progress").val(e).attr("max",t);const o=$(`\n        <div class="${r} name_tracker_progress_bar flex-container justifyspacebetween alignitemscenter" style="\n            padding: 10px;\n            margin: 5px 0;\n            background: var(--SmartThemeBlurTintColor);\n            border: 1px solid var(--SmartThemeBorderColor);\n            border-radius: 5px;\n        ">\n            <div class="title" style="flex: 1; font-weight: bold;">${n||"Name Tracker Scan"}</div>\n            <div style="margin: 0 10px;">(<span class="progress">${e}</span> / <span class="total">${t}</span>)</div>\n            <progress value="${e}" max="${t}" style="flex: 2; margin: 0 10px;"></progress>\n            <button class="menu_button fa-solid fa-stop" title="Abort scan" style="padding: 5px 10px;"></button>\n        </div>\n    `);o.find("button").on("click",function(){Y=!0,K(),X.warning("Scan aborted by user")}),$("#sheld").append(o)}function K(){const e=$(".name_tracker_progress");e.length>0&&e.fadeOut(300,function(){$(this).remove()})}const Z=(0,f.Xv)("ui"),V=new k.h("UI Management");function ee(){return(0,C.Xc)("updateCharacterList",()=>{const e=$("#name_tracker_character_list");if(0===e.length)return void Z.log();const t=b.W.getCharacters();if(0===Object.keys(t).length)return void e.html('\n                <div class="name_tracker_no_characters">\n                    <p style="text-align: center; color: var(--SmartThemeQuoteColor);">\n                        No characters tracked yet. Start a conversation and character information will be extracted automatically!\n                    </p>\n                </div>\n            ');const n=Object.values(t).sort((e,t)=>e.isMainChar&&!t.isMainChar?-1:!e.isMainChar&&t.isMainChar?1:e.preferredName.localeCompare(t.preferredName));let r='<div class="name_tracker_character_list">';for(const e of n){const t=e.isMainChar?'<i class="fa-solid fa-user"></i>':"",n=e.ignored?'<span class="char-ignored-badge">IGNORED</span>':"",a=(0,S.pp)(e)?'<span class="char-review-badge">NEEDS REVIEW</span>':"",o=e.aliases&&e.aliases.length>0?`<div class="char-aliases">Aliases: ${v(e.aliases.join(", "))}</div>`:"",i=e.relationships&&e.relationships.length>0?`<div class="char-relationships">Relationships: ${v(e.relationships.join("; "))}</div>`:"",s=e.lastUpdated?new Date(e.lastUpdated).toLocaleString():"Never";r+=`\n                <div class="name_tracker_character_item" data-character="${v(e.preferredName)}">\n                    <div class="char-header">\n                        <span class="char-name">\n                            ${t}\n                            ${v(e.preferredName)}\n                            ${n}\n                            ${a}\n                        </span>\n                        <div class="char-actions">\n                            <button class="char-action-btn char-action-edit" data-name="${v(e.preferredName)}" title="Edit lorebook entry">\n                                <i class="fa-solid fa-edit"></i>\n                            </button>\n                            <button class="char-action-btn char-action-view" data-name="${v(e.preferredName)}" title="View in lorebook">\n                                <i class="fa-solid fa-book"></i>\n                            </button>\n                            <button class="char-action-btn char-action-merge" data-name="${v(e.preferredName)}" title="Merge with another character">\n                                <i class="fa-solid fa-code-merge"></i>\n                            </button>\n                            <button class="char-action-btn char-action-ignore" data-name="${v(e.preferredName)}" title="${e.ignored?"Unignore":"Ignore"} character">\n                                <i class="fa-solid ${e.ignored?"fa-eye":"fa-eye-slash"}"></i>\n                            </button>\n                        </div>\n                    </div>\n                    ${o}\n                    ${i}\n                    <div class="char-metadata">\n                        <span>Confidence: ${e.confidence}%</span>\n                        <span>Updated: ${s}</span>\n                    </div>\n                </div>\n            `}r+="</div>",e.html(r)})}function te(){return(0,C.Xc)("updateStatusDisplay",()=>{const e=$("#name_tracker_status_display");if(0===e.length)return;const t=b.W.getCharacters(),n=Object.keys(t).length,r=b.W.getSetting("messageCounter",0),a=b.W.getSetting("lastScannedMessageId",-1),o=b.W.getSetting("messageFrequency",10),i=y.r.getContext(),s=i?.chat?.length||0,c=Math.max(0,s-a),l=r>0?` (${r} analyzed)`:"",d=i.chat?i.chat.length:0,g=`\n            <div class="name_tracker_status">\n                <div class="status-item">\n                    <strong>Characters tracked:</strong> ${n}${l}\n                </div>\n                <div class="status-item">\n                    <strong>Messages in chat:</strong> ${d}\n                </div>\n                <div class="status-item">\n                    <strong>Last scanned message:</strong> ${a>=0?a+1:"None"}\n                </div>\n                <div class="status-item">\n                    <strong>Pending messages:</strong> ${c}\n                </div>\n                <div class="status-item">\n                    <strong>Messages until next scan:</strong> ${Math.max(0,o-(d-a))}\n                </div>\n            </div>\n        `;e.html(g)})}function ne(){return(0,C.Xc)("showCharacterListModal",()=>{const e=Object.values(b.W.getCharacters()||{});let t="";if(0===e.length)t='<p style="text-align: center; color: var(--SmartThemeQuoteColor);">No characters tracked yet</p>';else{e.sort((e,t)=>e.isMainChar&&!t.isMainChar?-1:!e.isMainChar&&t.isMainChar?1:e.preferredName.localeCompare(t.preferredName)),t='<div style="max-height: 400px; overflow-y: auto;">';for(const n of e){const e=[];n.isMainChar&&e.push('<span style="background: var(--SmartThemeBodyColor); padding: 2px 6px; border-radius: 3px; font-size: 0.85em; margin-left: 5px;">MAIN</span>'),n.ignored&&e.push('<span style="background: var(--black70a); padding: 2px 6px; border-radius: 3px; font-size: 0.85em; margin-left: 5px;">IGNORED</span>'),(0,S.pp)(n)&&e.push('<span style="background: var(--crimsonDark); padding: 2px 6px; border-radius: 3px; font-size: 0.85em; margin-left: 5px;">NEEDS REVIEW</span>');const r=n.aliases&&n.aliases.length>0?`<div style="font-size: 0.9em; color: var(--SmartThemeQuoteColor); margin-top: 3px;">Aliases: ${v(n.aliases.join(", "))}</div>`:"";t+=`\n                    <div style="padding: 10px; margin: 5px 0; background: var(--SmartThemeBlurTintColor); border: 1px solid var(--SmartThemeBorderColor); border-radius: 5px;">\n                        <div style="font-weight: bold;">\n                            ${n.isMainChar?'<i class="fa-solid fa-user" style="margin-right: 5px;"></i>':""}\n                            ${v(n.preferredName)}\n                            ${e.join("")}\n                        </div>\n                        ${r}\n                    </div>\n                `}t+="</div>"}const n=`\n            <div class="name-tracker-character-modal">\n                <h3 style="margin-top: 0;">Tracked Characters (${e.length})</h3>\n                ${t}\n                <div style="margin-top: 15px; text-align: center;">\n                    <button class="menu_button" onclick="$('#name_tracker_settings').find('.inline-drawer-toggle').click(); $(this).closest('.popup').remove();">\n                        <i class="fa-solid fa-gear"></i> Open Settings\n                    </button>\n                </div>\n            </div>\n        `,r=y.r.getContext();r.callGenericPopup(n,r.POPUP_TYPE.TEXT,"",{wider:!0,okButton:"Close"})})}function re(){return(0,C.Xc)("initializeUIHandlers",()=>{$(document).on("click",".char-action-merge",async function(){const e=$(this).data("name");await async function(e){return(0,C.Xc)("showMergeDialog",async()=>{const t=b.W.getCharacters(),n=Object.keys(t).filter(t=>t!==e);if(0===n.length)return void V.warning("No other characters to merge with");const r=prompt(`Merge "${e}" into which character? Available: ${n.join(", ")}`);r&&t[r]?(await(0,S.lF)(e,r),ee(),te()):r&&V.error("Invalid target character name")})}(e)}),$(document).on("click",".char-action-ignore",function(){const e=$(this).data("name");(0,S.el)(e),ee(),te()}),$(document).on("click",".char-action-view",async function(){const e=$(this).data("name");await async function(e){return(0,C.Xc)("viewInLorebook",async()=>{if(!b.W.getCharacter(e))throw new C.S_("Character not found");if(!R)return void L.warning("No active chat or lorebook");const t=y.r.getContext();"function"==typeof t.openWorldInfoEditor?(await t.openWorldInfoEditor(R),L.success(`Opened lorebook for ${e}`)):($("#WorldInfo").click(),L.info(`Please select "${R}" from the World Info panel`))})}(e)}),$(document).on("click",".char-action-edit",async function(){const e=$(this).data("name");await async function(e){return(0,C.Xc)("showEditLorebookModal",async()=>{const t=b.W.getCharacter(e);if(!t)return void V.error("Character not found");const n=[e,...t.aliases||[]].join(", "),r=`\n            <div class="lorebook-entry-editor">\n                <h3>Edit Lorebook Entry: ${v(e)}</h3>\n                \n                <div class="editor-section">\n                    <label for="entry-keys">Keys (comma-separated):</label>\n                    <input type="text" id="entry-keys" class="text_pole" value="${v(n)}" \n                           placeholder="${v(e)}, aliases, nicknames">\n                    <small>These words trigger this entry in the chat context</small>\n                </div>\n                \n                <div class="editor-section">\n                    <label for="entry-content">Entry Content:</label>\n                    <textarea id="entry-content" rows="10" class="text_pole" \n                              placeholder="Description, personality, background, relationships...">${v(t.notes||"")}</textarea>\n                    <small>This will be injected into context when keys are mentioned</small>\n                </div>\n                \n                <div class="editor-section">\n                    <label for="entry-relationships">Relationships:</label>\n                    <textarea id="entry-relationships" rows="3" class="text_pole" \n                              placeholder="Friend of Alice; Enemy of Bob; Works for XYZ Corp">${v((t.relationships||[]).join("; "))}</textarea>\n                    <small>One relationship per line or semicolon-separated</small>\n                </div>\n            </div>\n        `,a=$(`\n            <div class="nametracker-modal" style="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: var(--SmartThemeBlurTintColor);\n                border: 1px solid var(--SmartThemeBorderColor);\n                border-radius: 10px;\n                padding: 20px;\n                max-width: 600px;\n                width: 90%;\n                max-height: 80vh;\n                overflow-y: auto;\n                z-index: 9999;\n                box-shadow: 0 4px 20px rgba(0,0,0,0.5);\n            ">\n                ${r}\n                <div style="margin-top: 20px; text-align: right;">\n                    <button class="menu_button" id="entry-save">Save</button>\n                    <button class="menu_button" id="entry-cancel">Cancel</button>\n                </div>\n            </div>\n        `),o=$('\n            <div class="nametracker-overlay" style="\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.7);\n                z-index: 9998;\n            "></div>\n        ');$("body").append(o).append(a);const i=()=>{a.remove(),o.remove()};a.find("#entry-save").on("click",async()=>{const n=a.find("#entry-keys").val().split(",").map(e=>e.trim()).filter(e=>e),r=a.find("#entry-content").val(),o=a.find("#entry-relationships").val().split(/[;\\n]/).map(e=>e.trim()).filter(e=>e),s=n[0]||e,c=n.slice(1);t.preferredName=s,t.aliases=c,t.notes=r,t.relationships=o,s!==e&&b.W.removeCharacter(e),b.W.setCharacter(s,t),ee(),te(),V.success(`Updated lorebook entry for ${s}`),i()}),a.find("#entry-cancel").on("click",i),o.on("click",i)})}(e)}),Z.log()})}function ae(e,t,n,r=null,a=""){return(0,C.Xc)("addMenuButton",()=>{const o=$(`\n            <div class="list-group-item flex-container flexGap5 interactable ${a}" title="${r||e}" tabindex="0">\n                <i class="${t}"></i>\n                <span>${e}</span>\n            </div>\n        `),i=$("#extensionsMenu");i.length?(o.appendTo(i),o.on("click",()=>n())):console.error("[Name Tracker] Could not find the extensions menu")})}function oe(){return(0,C.Xc)("toggleAutoHarvest",()=>{const e=b.W.getSetting("autoAnalyze",!0);b.W.setSetting("autoAnalyze",!e),$("#name_tracker_auto_analyze").prop("checked",!e);const t=$("#extensionsMenu .name-tracker-toggle-harvest");e?t.find("i").removeClass("fa-toggle-on").addClass("fa-toggle-off"):t.find("i").removeClass("fa-toggle-off").addClass("fa-toggle-on"),te(),V.success("Auto-harvest "+(e?"disabled":"enabled"))})}async function ie(){return(0,C.Xc)("openChatLorebook",async()=>{const e=y.r.getContext(),t=e.chatMetadata?.world_info;t?"function"==typeof e.openWorldInfoEditor?await e.openWorldInfoEditor(t):($("#WorldInfo").click(),V.info(`Please select "${t}" from the World Info panel`)):V.warning("No active chat or lorebook")})}function se(){return(0,C.Xc)("initializeMenuButtons",()=>{ae("Toggle Auto-Harvest",b.W.getSetting("autoAnalyze",!0)?"fa-solid fa-toggle-on":"fa-solid fa-toggle-off",oe,"Toggle automatic character harvesting on/off","name-tracker-toggle-harvest"),ae("View Characters","fa-solid fa-users",ne,"View all tracked characters"),ae("Open Chat Lorebook","fa-solid fa-book",ie,"Open the Name Tracker chat lorebook in the World Info editor"),Z.log()})}function ce(){return(0,C.Xc)("bindSettingsHandlers",()=>{$("#name_tracker_enabled").on("input",e=>{b.W.setSetting("enabled",e.target.checked),te()}),$("#name_tracker_auto_analyze").on("input",e=>{b.W.setSetting("autoAnalyze",e.target.checked),te()}),$("#name_tracker_message_frequency").on("input",e=>{b.W.setSetting("messageFrequency",parseInt(e.target.value)||10),te()}),$("#name_tracker_llm_source").on("change",e=>{b.W.setSetting("llmSource",e.target.value)}),$("#name_tracker_ollama_endpoint").on("input",e=>{b.W.setSetting("ollamaEndpoint",e.target.value)}),$("#name_tracker_ollama_model").on("change",e=>{b.W.setSetting("ollamaModel",e.target.value)}),$("#name_tracker_load_models").on("click",async()=>{try{await async function(){return(0,C.Xc)("loadOllamaModels",async()=>{const e=b.W.getSetting("ollamaEndpoint","http://localhost:11434");B.log();try{const t=await fetch(`${e}/api/tags`);if(!t.ok)throw new Error(`Failed to connect to Ollama: ${t.statusText}`);const n=await t.json();return T=n.models||[],B.log(),T}catch(e){throw console.error("Error loading Ollama models:",e),I.error("Failed to load Ollama models. Check endpoint and try again."),e}})}(),V.success("Ollama models loaded")}catch(e){Z.log(),V.error("Failed to load Ollama models")}}),$("#name_tracker_confidence_threshold").on("input",e=>{b.W.setSetting("confidenceThreshold",parseInt(e.target.value)||70)}),$("#name_tracker_lorebook_position").on("change",e=>{b.W.setSetting("lorebookPosition",parseInt(e.target.value)||0)}),$("#name_tracker_lorebook_depth").on("input",e=>{b.W.setSetting("lorebookDepth",parseInt(e.target.value)||1)}),$("#name_tracker_lorebook_cooldown").on("input",e=>{b.W.setSetting("lorebookCooldown",parseInt(e.target.value)||5)}),$("#name_tracker_lorebook_probability").on("input",e=>{b.W.setSetting("lorebookProbability",parseInt(e.target.value)||100)}),$("#name_tracker_lorebook_enabled").on("input",e=>{b.W.setSetting("lorebookEnabled",e.target.checked)}),$("#name_tracker_debug_mode").on("input",e=>{b.W.setSetting("debugMode",e.target.checked)}),$("#name_tracker_manual_analyze").on("click",async()=>{const e=b.W.getSetting("messageFrequency",10);await q(e,!0),ee(),te()}),$("#name_tracker_scan_all").on("click",async()=>{await async function(){return(0,C.Xc)("scanEntireChat",async()=>{const e=y.r.getContext();if(!e.chat||0===e.chat.length)return void X.warning("No chat messages to scan");if("sillytavern"===b.W.getLLMConfig().source&&!e.onlineStatus)return void X.warning("Please connect to an API (OpenAI, Claude, etc.) before analyzing messages");const t=e.chat.length,n=await O()-1e3,r=[];let a=[],o=0;for(let i=0;i<t;i++){const t=e.chat[i],s=await M([t]);o+s>n&&a.length>0?(r.push(a),a=[t],o=s):(a.push(t),o+=s)}a.length>0&&r.push(a);const i=r.length;if(!confirm(`This will analyze all ${t} messages in ${i} batches. This may take a while. Continue?`))return;Y=!1,G(0,i,"Starting batch scan...");let s=0,c=0;const l=new Set;for(let e=0;e<i;e++){if(Y){U.log();break}const t=r[e],n=r.slice(0,e).reduce((e,t)=>e+t.length,0),a=n+t.length;try{G(e+1,i,`Processing messages ${n+1}-${a}...`);const r=z(),o=await D(t,r);o.characters&&Array.isArray(o.characters)&&(await J(o.characters),o.characters.forEach(e=>l.add(e.name))),s++,e<i-1&&await new Promise(e=>setTimeout(e,1e3))}catch(t){if(console.error(`Error processing batch ${e+1}:`,t),c++,!confirm(`Batch ${e+1} failed.\\n\\nError: ${t.message}\\n\\nContinue with remaining batches?`))break}}K(),b.W.setSetting("lastScannedMessageId",t-1);const d=`Full chat scan complete!\\n\\nMessages: ${t}\\nBatches: ${s}/${i}\\nCharacters found: ${l.size}\\nFailed: ${c}`;c>0?X.warning(d,{timeOut:1e4}):X.success(d,{timeOut:1e4})})}(),ee(),te()}),$("#name_tracker_create_character").on("click",()=>{!async function(){(0,C.Xc)("showCreateCharacterModal",async()=>{const e=prompt("Enter character name:");if(e&&e.trim())try{await(0,S.g9)(e.trim()),ee(),te()}catch(e){V.error(e.message)}})}()}),$("#name_tracker_clear_cache").on("click",()=>{F=[],Q=!1,U.log(),V.info("Cache and processing queue cleared")}),$("#name_tracker_undo_merge").on("click",async()=>{const{undoLastMerge:e}=await Promise.resolve().then(n.bind(n,551));await e()&&(ee(),te())}),$("#name_tracker_purge_entries").on("click",()=>{!async function(){(0,C.Xc)("showPurgeConfirmation",async()=>{const e=b.W.getCharacters(),t=Object.keys(e).length;if(0!==t){if(confirm(`This will delete all ${t} tracked characters and their lorebook entries.\\n\\nThis action cannot be undone!\\n\\nContinue?`))try{const e=await(0,S.vu)();ee(),te(),V.success(`Purged ${e} characters`)}catch(e){V.error(`Failed to purge characters: ${e.message}`)}}else V.info("No characters to purge")})}()}),$("#name_tracker_edit_prompt").on("click",()=>{!async function(){(0,C.Xc)("showSystemPromptEditor",async()=>{const e=b.W.getSetting("systemPrompt")||"",t=$(`\n            <div class="nametracker-modal" style="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: var(--SmartThemeBlurTintColor);\n                border: 1px solid var(--SmartThemeBorderColor);\n                border-radius: 10px;\n                padding: 20px;\n                max-width: 700px;\n                width: 90%;\n                max-height: 80vh;\n                overflow-y: auto;\n                z-index: 9999;\n                box-shadow: 0 4px 20px rgba(0,0,0,0.5);\n            ">\n                <h3 style="margin-top: 0;">Edit System Prompt</h3>\n                <p>Customize the system prompt used for character analysis. Leave blank to use default.</p>\n                <textarea id="system_prompt_editor" rows="20" style="width: 100%; margin: 10px 0;" \n                          placeholder="Enter custom system prompt or leave blank for default...">${v(e)}</textarea>\n                <div style="margin-top: 20px; text-align: right;">\n                    <button class="menu_button" id="system_prompt_save">Save</button>\n                    <button class="menu_button" id="system_prompt_reset">Reset to Default</button>\n                    <button class="menu_button" id="system_prompt_cancel">Cancel</button>\n                </div>\n            </div>\n        `),n=$('\n            <div class="nametracker-overlay" style="\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.7);\n                z-index: 9998;\n            "></div>\n        ');$("body").append(n).append(t);const r=()=>{t.remove(),n.remove()};t.find("#system_prompt_save").on("click",()=>{const e=t.find("#system_prompt_editor").val().trim();b.W.setSetting("systemPrompt",e||null),V.success("System prompt updated"),r()}),t.find("#system_prompt_reset").on("click",()=>{t.find("#system_prompt_editor").val(""),b.W.setSetting("systemPrompt",null),V.success("Reset to default system prompt"),r()}),t.find("#system_prompt_cancel").on("click",r),n.on("click",r)})}()}),Z.log()})}function le(){return(0,C.Xc)("updateUI",()=>{$("#name_tracker_enabled").prop("checked",b.W.getSetting("enabled",!0)),$("#name_tracker_auto_analyze").prop("checked",b.W.getSetting("autoAnalyze",!0)),$("#name_tracker_message_frequency").val(b.W.getSetting("messageFrequency",10)),$("#name_tracker_llm_source").val(b.W.getSetting("llmSource","sillytavern")),$("#name_tracker_ollama_endpoint").val(b.W.getSetting("ollamaEndpoint","http://localhost:11434")),$("#name_tracker_ollama_model").val(b.W.getSetting("ollamaModel","")),$("#name_tracker_confidence_threshold").val(b.W.getSetting("confidenceThreshold",70)),$("#name_tracker_lorebook_position").val(b.W.getSetting("lorebookPosition",0)),$("#name_tracker_lorebook_depth").val(b.W.getSetting("lorebookDepth",1)),$("#name_tracker_lorebook_cooldown").val(b.W.getSetting("lorebookCooldown",5)),$("#name_tracker_lorebook_probability").val(b.W.getSetting("lorebookProbability",100)),$("#name_tracker_lorebook_enabled").prop("checked",b.W.getSetting("lorebookEnabled",!0)),$("#name_tracker_debug_mode").prop("checked",b.W.getSetting("debugMode",!1)),ee(),te(),Z.log()})}console.log("[STnametracker] Main index.js: Import validation"),console.log("[STnametracker] Main index.js: initializeLorebook import =",typeof j,j),console.log("[STnametracker] Main index.js: initializeUIHandlers import =",typeof re,re),console.log("[STnametracker] Main index.js: initializeMenuButtons import =",typeof se,se),console.log("[STnametracker] Main index.js: bindSettingsHandlers import =",typeof ce,ce),console.log("[STnametracker] Main index.js: updateUI import =",typeof le,le);const de="STnametracker",ge=`scripts/extensions/third-party/${de}`;const he=f.Ay.createModuleLogger("Main");const me=new class{constructor(){this.initialized=!1,this.modules=new Map}async initialize(){return console.log("[STnametracker] Enter initialize() method"),C.r_.withErrorBoundary("Main",async()=>{console.log("[STnametracker] Inside error boundary"),this.initialized?console.log("[STnametracker] Already initialized, skipping"):(console.log("[STnametracker] Starting initialization sequence"),he.log("Starting Name Tracker Extension v2.1.0"),console.log("[STnametracker] Step 1: Initializing core systems..."),await this.initializeCore(),console.log("[STnametracker] Step 1: Core systems completed"),console.log("[STnametracker] Step 2: Initializing feature modules..."),await this.initializeModules(),console.log("[STnametracker] Step 2: Feature modules completed"),console.log("[STnametracker] Step 3: Initializing UI..."),await this.initializeUI(),console.log("[STnametracker] Step 3: UI completed"),console.log("[STnametracker] Step 4: Registering event listeners..."),this.registerEventListeners(),console.log("[STnametracker] Step 4: Event listeners completed"),this.initialized=!0,console.log("[STnametracker] Marking as initialized"),he.log("Name Tracker Extension initialized successfully"),console.log("[STnametracker] Full initialization sequence completed successfully"))},{retries:2,fallback:async e=>(he.error("Failed to initialize extension:",e),k.A.error("Failed to initialize","Extension Error"),!1)})}async initializeCore(){console.log("[STnametracker] initializeCore: Starting..."),he.debug("Initializing core systems..."),console.log("[STnametracker] initializeCore: Connecting debug system..."),f.Ay.isDebugEnabled=()=>b.A.isDebugMode(),console.log("[STnametracker] initializeCore: Debug system connected"),console.log("[STnametracker] initializeCore: Initializing settings manager..."),await b.A.initialize(),console.log("[STnametracker] initializeCore: Settings manager initialized"),this.setupErrorRecovery(),he.debug("Core systems initialized")}async initializeModules(){he.debug("Initializing feature modules..."),console.log("[STnametracker] initializeModules: Starting module initialization"),console.log("[STnametracker] initializeModules: Checking import of initializeLorebook..."),console.log("[STnametracker] initializeModules: initializeLorebook =",typeof j,j);try{console.log("[STnametracker] initializeModules: About to call initializeLorebook()..."),await j(),console.log("[STnametracker] initializeModules: initializeLorebook() completed successfully"),he.debug("Feature modules initialized")}catch(e){throw console.error("[STnametracker] initializeModules: Error in initializeLorebook:",e),he.error("Failed to initialize feature modules:",e),e}}async initializeUI(){console.log("[STnametracker] initializeUI: Starting UI initialization..."),he.debug("Initializing UI...");try{console.log("[STnametracker] initializeUI: Loading settings HTML from:",`${ge}/settings.html`);const e=await $.get(`${ge}/settings.html`);console.log("[STnametracker] initializeUI: Settings HTML loaded, length:",e.length),console.log("[STnametracker] initializeUI: Finding #extensions_settings element...");const t=$("#extensions_settings");console.log("[STnametracker] initializeUI: Target element found:",t.length>0),t.append(e),console.log("[STnametracker] initializeUI: Settings HTML appended"),console.log("[STnametracker] initializeUI: Initializing UI handlers..."),re(),console.log("[STnametracker] initializeUI: UI handlers initialized"),console.log("[STnametracker] initializeUI: Initializing menu buttons..."),se(),console.log("[STnametracker] initializeUI: Menu buttons initialized"),console.log("[STnametracker] initializeUI: Binding settings handlers..."),ce(),console.log("[STnametracker] initializeUI: Settings handlers bound"),console.log("[STnametracker] initializeUI: Updating UI..."),le(),console.log("[STnametracker] initializeUI: UI updated"),he.debug("UI initialized")}catch(e){throw he.error("Failed to initialize UI:",e),e}}registerEventListeners(){he.debug("Registering event listeners...");try{const e=y.A.getContext(),t=e.eventSource,n=e.event_types;if(!t||!n)return void he.warn("SillyTavern event system not available");t.on(n.MESSAGE_RECEIVED,async e=>{he.debug("Message received event:",e)}),t.on(n.MESSAGE_SENT,async e=>{he.debug("Message sent event:",e)}),t.on(n.CHAT_CHANGED,async()=>{he.debug("Chat changed event received"),await b.A.onChatChanged()}),he.debug("Event listeners registered")}catch(e){he.error("Failed to register event listeners:",e)}}setupErrorRecovery(){C.r_.registerRecoveryStrategy("NETWORK_ERROR",async e=>(he.warn("Attempting network error recovery"),await C.r_.delay(2e3),k.A.info("Retrying network operation..."),null)),C.r_.registerRecoveryStrategy("DATA_FORMAT_ERROR",async e=>(he.warn("Data format error, clearing cache"),null)),C.r_.onCriticalError(e=>{he.error("Critical error occurred:",e)})}getStatus(){return{initialized:this.initialized,context:y.A.getStatus(),settings:b.A.getStatus(),debug:f.Ay.getPerformanceSummary(),errors:C.r_.getRecentErrors(5).length}}async shutdown(){return C.r_.withErrorBoundary("Main",async()=>{he.log("Shutting down Name Tracker Extension"),this.initialized=!1,f.Ay.clear(),he.log("Extension shutdown complete")},{silent:!0})}};jQuery(async()=>{console.log("[STnametracker] jQuery ready, starting extension load...");try{console.log("[STnametracker] Logger available, initializing..."),he.log("Name Tracker Extension loading..."),console.log("[STnametracker] Setting up extension_settings..."),window.extension_settings||(console.log("[STnametracker] Creating window.extension_settings"),window.extension_settings={}),console.log("[STnametracker] Current extension_settings keys:",Object.keys(window.extension_settings)),window.extension_settings[de]=window.extension_settings[de]||{},console.log("[STnametracker] Extension settings initialized"),console.log("[STnametracker] Starting main initialization..."),await me.initialize(),console.log("[STnametracker] Main initialization completed"),window.nameTrackerExtension=me,window.ntDebug={status:()=>me.getStatus(),errors:()=>C.r_.getRecentErrors(),settings:()=>window.extension_settings?.[de]||{},chatData:()=>b.A.getChatData(),clear:()=>f.Ay.clear()},he.log("Name Tracker Extension loaded successfully"),console.log("[STnametracker] Extension loaded. Use ntDebug.status() for diagnostics.")}catch(e){console.error("[STnametracker] Failed to initialize:",e),k.A.error("Extension failed to load","Critical Error")}})})();
//# sourceMappingURL=index.js.map